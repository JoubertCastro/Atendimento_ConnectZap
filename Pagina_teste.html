<!-- Arquivo: Pagina_enviar_boletos.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ConnectZap ‚Äî Enviar boletos (PDF)</title>
  <link rel="icon" href="https://joubertcastro.github.io/ConnectZap/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --primary:#2563eb;
      --accent:#22c55e;
      --bg:#f3f4f6;
      --content-bg:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#e5e7eb;
      --link:#2563eb;
      --hover:#f1f5f9;
      --ghost-bg:#f3f4f6;
      --ring: rgba(37,99,235,.28);
      --btn-radius: 12px;
      --card-radius: 16px;
      --font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --font-size: 14px;
    }
    html{ font-size: var(--font-size); }
    body{ font-family: var(--font-family); background: var(--bg); color: var(--text); }
    *{ outline-color: var(--ring); }

    .card{ background:var(--content-bg); border:1px solid var(--border); border-radius: var(--card-radius); }
    .btn{
      border-radius: var(--btn-radius);
      transition: transform .06s ease, filter .15s ease, background .15s ease, box-shadow .15s ease;
      position: relative;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }
    .btn-primary{ background: var(--primary); color:#fff; }
    .btn-primary:hover{ filter: brightness(.96); }
    .btn-neutral{ background: var(--ghost-bg); border:1px solid var(--border); color: var(--text); }
    .btn-neutral:hover{ background: var(--hover); }
    .btn-danger{ background:#dc2626; color:#fff; }
    .btn-danger:hover{ filter: brightness(.96); }

    .label{ display:block; font-size:12px; color: var(--muted); margin-bottom: 4px; }
    .input{
      width:100%;
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background:#fff;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .input:focus{ box-shadow: 0 0 0 3px var(--ring); border-color: color-mix(in srgb, var(--primary) 55%, var(--border)); }
    .hint{ font-size:12px; color: var(--muted); }

    .pill{
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--ghost-bg) 80%, white);
      border-radius: 9999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 800;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .pill-success{
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
      background: color-mix(in srgb, var(--accent) 14%, var(--ghost-bg));
      color: #065f46;
    }
    .pill-fail{
      border-color: color-mix(in srgb, #dc2626 55%, var(--border));
      background: color-mix(in srgb, #dc2626 12%, var(--ghost-bg));
      color: #7f1d1d;
    }
    .pill-warn{
      border-color: color-mix(in srgb, #d97706 55%, var(--border));
      background: color-mix(in srgb, #d97706 10%, var(--ghost-bg));
      color: #7c2d12;
    }

    .alert{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: var(--content-bg);
    }
    .alert-danger{
      border-left: 6px solid #dc2626;
      background: color-mix(in srgb, #dc2626 8%, var(--content-bg));
    }
    .alert-info{
      border-left: 6px solid var(--primary);
      background: color-mix(in srgb, var(--primary) 8%, var(--content-bg));
    }

    /* Modal */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.60);
      z-index: 50;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modal-inner{
      width: min(460px, 96vw);
      background: var(--content-bg);
      border:1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      overflow:hidden;
    }

    .table-soft{
      width:100%;
      border:1px solid var(--border);
      border-radius: 12px;
      overflow:hidden;
    }
    .table-soft th,.table-soft td{
      border-top:1px solid var(--border);
      padding: 10px;
      font-size: 13px;
    }
    .table-soft thead th{
      background: var(--ghost-bg);
      color: var(--muted);
      border-top:none;
      font-weight: 800;
      text-align:left;
    }

    .btn-loading::after{
      content:"";
      position:absolute;
      right: 10px;
      top:50%;
      width:14px;
      height:14px;
      margin-top:-7px;
      border-radius:9999px;
      border:2px solid rgba(255,255,255,.55);
      border-top-color: rgba(255,255,255,1);
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .link{ color: var(--link); text-decoration: underline; }
  </style>
</head>

<body class="min-h-screen">
  <header class="max-w-5xl mx-auto px-4 pt-6">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <h1 class="text-2xl font-extrabold">üìÑ Envio de boletos (PDF)</h1>
        <p class="text-sm" style="color:var(--muted)">
          P√°gina de uso <strong>exclusivo</strong> para envio de boleto em <strong>PDF</strong>.
        </p>
      </div>

      <div class="flex items-center gap-2 shrink-0">
        <button id="btnLoginTop" class="btn btn-primary px-4 py-2">Login</button>
        <button id="btnLogoutTop" class="btn btn-danger px-4 py-2 hidden">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-10 pt-4 space-y-4">
    <!-- Banner cr√≠tico -->
    <div class="alert alert-danger">
      <div class="font-extrabold">‚ö†Ô∏è Aten√ß√£o</div>
      <div class="text-sm mt-1">
        Antes de enviar, <strong>confira o PDF</strong> e confirme no checkbox de autoriza√ß√£o.
        Este fluxo registra envio como mensagem avulsa e pode criar/reservar conversa automaticamente.
      </div>
    </div>

    <!-- Card do operador -->
    <section class="card p-5">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <div class="text-xs" style="color:var(--muted)">Operador</div>
          <div class="text-lg font-extrabold" id="opNome">‚Äî</div>
          <div class="text-sm" style="color:var(--muted)">Carteira: <span class="font-semibold" id="opCarteira">‚Äî</span></div>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <span class="pill" id="pillAuth"><span>üîí</span> Deslogado</span>
          <span class="pill" id="pillStep"><span>1</span> Preencha os dados</span>
        </div>
      </div>

      <div id="opAviso" class="mt-3 text-sm hidden" style="color:#b45309"></div>
    </section>

    <!-- Buscar por c√≥digo + Form do boleto -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Busca por c√≥digo -->
      <div class="card p-5">
        <div class="flex items-start justify-between gap-2">
          <div>
            <h2 class="text-lg font-extrabold">üîé Buscar telefone pelo c√≥digo</h2>
            <p class="text-sm mt-1" style="color:var(--muted)">
              Use o <strong>c√≥digo do cliente</strong> para listar telefones do SIC e selecionar um. Se preferir, preencha manualmente no formul√°rio ao lado.
            </p>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="label">Base</label>
            <select id="baseSelect" class="input">
              <option value="bd5">BD5</option>
              <option value="bd4">BD4</option>
              <option value="bd7">BD7</option>
              <option value="bd8">BD8</option>
            </select>
            <p id="baseLockHint" class="hint mt-1 hidden">Definida pelo seu perfil.</p>
          </div>

          <div class="md:col-span-2">
            <label class="label">C√≥digo do cliente</label>
            <div class="flex gap-2">
              <input id="codigoInput" class="input flex-1" placeholder="Ex: 123456" inputmode="numeric" pattern="[0-9]*" />
              <button id="btnBuscar" class="btn btn-neutral px-4 py-2">Buscar</button>
            </div>
            <p class="hint mt-1">Ap√≥s buscar, selecione um telefone para preencher automaticamente o envio.</p>
          </div>
        </div>

        <div id="buscaBox" class="mt-4 hidden">
          <div id="buscaMsg" class="text-sm" style="color:var(--muted)">‚Äî</div>
          <div id="resultWrap" class="mt-3 hidden">
            <div class="overflow-x-auto">
              <table class="table-soft">
                <thead>
                  <tr>
                    <th class="w-44">Telefone</th>
                    <th>Nome</th>
                    <th class="w-28 text-right">A√ß√£o</th>
                  </tr>
                </thead>
                <tbody id="resultTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Form do boleto -->
      <div class="card p-5">
        <h2 class="text-lg font-extrabold">üì® Enviar boleto (PDF)</h2>
        <p class="text-sm mt-1" style="color:var(--muted)">
          Preencha os dados abaixo. O <strong>upload do PDF</strong> s√≥ ser√° liberado ap√≥s os campos obrigat√≥rios.
        </p>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="md:col-span-2">
            <label class="label">Telefone</label>
            <input id="telInput" class="input" placeholder="Ex: 61999999999 ou 5561999999999" inputmode="numeric" />
            <p class="hint mt-1">Voc√™ pode selecionar via busca no sic ou preencher manualmente.</p>
          </div>

          <div class="md:col-span-2">
            <label class="label">Nome</label>
            <input id="nomeInput" class="input" placeholder="Ex: Jos√© da Silva" />
          </div>

          <div>
            <label class="label">Valor do boleto</label>
            <input id="valorInput" class="input" placeholder="Ex: R$ 123,45" />
          </div>

          <div>
            <label class="label">Vencimento</label>
            <input id="vencInput" class="input" placeholder="Ex: 22/02/2026" />
          </div>
        </div>

        <hr class="my-4" style="border-color:var(--border)">

        <!-- Upload -->
        <div class="flex flex-col gap-2">
          <div class="flex items-center justify-between gap-2">
            <div>
              <div class="font-bold">1) Upload do PDF</div>
              <div class="text-sm" style="color:var(--muted)">Selecione o arquivo do boleto para gerar o link e pr√©-visualizar.</div>
            </div>
            <div class="shrink-0">
              <input id="pdfInput" type="file" accept="application/pdf" class="hidden">
              <button id="btnUpload" class="btn btn-primary px-4 py-2" disabled>Selecionar PDF</button>
            </div>
          </div>

          <div id="uploadInfo" class="text-sm hidden"></div>

          <!-- Preview -->
          <div id="previewBox" class="hidden mt-2">
            <div class="alert alert-info">
              <div class="font-extrabold">2) Pr√©-visualiza√ß√£o</div>
              <div class="text-sm mt-1" style="color:var(--muted)">
                Confira se o documento √© o correto. Se o preview n√£o abrir, use o link abaixo.
              </div>

              <div class="mt-3 grid grid-cols-1 gap-3">
                <div class="flex items-center justify-between gap-2 flex-wrap">
                  <div class="text-sm">
                    <span class="font-bold">Arquivo:</span> <span id="previewFilename">‚Äî</span>
                  </div>
                  <a id="previewLink" class="link text-sm" href="#" target="_blank" rel="noopener noreferrer">Abrir em nova aba</a>
                </div>

                <div class="border rounded-xl overflow-hidden" style="border-color:var(--border)">
                  <iframe id="previewFrame" src="about:blank" class="w-full" style="height: 320px;"></iframe>
                </div>

                <label class="flex items-start gap-3">
                  <input id="confirmChk" type="checkbox" class="mt-1">
                  <span class="text-sm">
                    <span class="font-extrabold">Confirmar envio:</span>
                    Declaro que o PDF est√° correto e autorizo o envio para o telefone informado.
                  </span>
                </label>

                <div class="flex items-center gap-2 flex-wrap">
                  <button id="btnEnviar" class="btn btn-primary px-5 py-2" disabled>Enviar boleto</button>
                  <button id="btnLimpar" class="btn btn-neutral px-4 py-2">Limpar</button>
                  <span id="statusPill" class="pill hidden">‚Äî</span>
                </div>

                <div id="statusMsg" class="text-sm hidden" style="color:var(--muted)"></div>
              </div>
            </div>
          </div>

          <!-- Nota -->
          <p class="hint mt-2">
            Dica: Leia atentamente os campos (Telefone/Nome/Valor/Vencimento), o sistema pedir√° uma confirma√ß√£o antes de enviar.
          </p>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL DE LOGIN -->
  <div id="modalLogin" class="modal" aria-live="polite" aria-modal="true" role="dialog">
    <div class="modal-inner">
      <div class="p-4 border-b flex items-center justify-between" style="border-color:var(--border)">
        <h3 id="loginTitle" class="font-extrabold">Identifique-se</h3>
        <button class="btn btn-neutral px-2 py-1 text-xs" id="btnCloseLogin" aria-label="Fechar">‚úñ</button>
      </div>

      <div class="p-4 space-y-3">
        <div class="space-y-1">
          <label class="block text-sm" style="color:var(--muted)">C√≥digo do agente</label>
          <input id="loginCodigoAgente" inputmode="numeric" pattern="[0-9]*" class="input" placeholder="Ex: 101" autocomplete="username" />
        </div>

        <!-- Modo LOGIN -->
        <div id="loginSection" class="space-y-2">
          <div class="space-y-1">
            <label class="block text-sm" style="color:var(--muted)">Senha</label>
            <input id="loginSenha" type="password" class="input" placeholder="Sua senha" autocomplete="current-password" />
          </div>
          <div class="flex items-center justify-between">
            <p id="loginHint" class="text-xs" style="color:var(--muted)">Seja bem-vindo(a) ao ConnectZap.</p>
            <button id="btnLoginCriarSenha" type="button" class="text-xs" style="color:var(--link)">Criar/trocar senha</button>
          </div>
        </div>

        <!-- Modo CRIAR/TROCAR SENHA -->
        <div id="senhaSection" class="hidden space-y-3">
          <div id="senhaAtualWrap" class="hidden space-y-1">
            <label class="block text-sm" style="color:var(--muted)">Senha atual</label>
            <input id="senhaAtual" type="password" class="input" placeholder="Sua senha atual" autocomplete="current-password" />
          </div>

          <div class="space-y-1">
            <label class="block text-sm" style="color:var(--muted)">Nova senha</label>
            <input id="novaSenha" type="password" class="input" placeholder="M√≠nimo 8 caracteres" autocomplete="new-password" />
          </div>

          <div class="space-y-1">
            <label class="block text-sm" style="color:var(--muted)">Confirmar nova senha</label>
            <input id="confirmarSenha" type="password" class="input" placeholder="Repita a nova senha" autocomplete="new-password" />
          </div>

          <p id="senhaHint" class="text-xs" style="color:var(--muted)">Sua senha expira a cada 90 dias.</p>
        </div>

        <div id="loginErro" class="text-sm text-red-600 hidden" role="alert" aria-live="polite"></div>
      </div>

      <div class="p-4 border-t flex items-center justify-end gap-2" style="border-color:var(--border)">
        <button id="btnLoginBack" class="btn btn-neutral px-3 py-2 text-sm hidden" type="button">Voltar</button>
        <button class="btn btn-neutral px-3 py-2 text-sm" id="btnCancelLogin" type="button">Cancelar</button>
        <button id="btnDoLogin" class="btn btn-primary px-4 py-2 text-sm" type="button">Entrar</button>
      </div>
    </div>
  </div>

  <script>
    /** ================= CONFIG (mesmo padr√£o da p√°gina de agentes) ================= */
    const FILA_API   = (window.FILA_API   || "https://whatsapp-webhook-production-9a27.up.railway.app/api").replace(/\/+$/, '');
    const CONV_API   = (window.CONV_API   || "https://conversas-api-production.up.railway.app").replace(/\/+$/, '');
    const ESTRAT_API = (window.ESTRAT_API || "https://consultasic-production.up.railway.app").replace(/\/+$/, '');

    /** Phone IDs (para escolher automaticamente o primeiro da carteira do agente) */
    const phoneIdMap = {
      "977152815488698": "ConnectZap",
      "805610009301153": "Banco PAN",
      "727586317113885": "Recovery PJ",
      "802977069563598": "Recovery",
      "927805693760003": "Recovery Preventivo",
      "897647883433681": "Recovery Manuten√ß√£o",
      "821562937700669": "Mercado Pago Cobran√ßa",
      "779797401888141": "DivZero_P2",
      "922259637643727": "DivZero_LP",
      "829210283602406": "Arc4U",
      "905309685992125": "Arc4U Veiculos",
      "713021321904495": "Serasa",
      "803535039503723": "Mercado Pago Vendas"
    };
    const carteiraToPhoneIds = Object.entries(phoneIdMap).reduce((acc, [pid, nome]) => {
      acc[nome] = (acc[nome] || []).concat([pid]);
      return acc;
    }, {});

    /** ================= Estado ================= */
    let agente = { codigo:null, nome:null, carteira:null, origem_bd:null, permite_envio_individual:true };

    let buscaRows = [];
    let uploaded = { file_url:null, filename:null };
    let lastPayloadFingerprint = "";

    /** ================= DOM ================= */
    const opNome = document.getElementById('opNome');
    const opCarteira = document.getElementById('opCarteira');
    const opAviso = document.getElementById('opAviso');

    const pillAuth = document.getElementById('pillAuth');
    const pillStep = document.getElementById('pillStep');

    const btnLoginTop = document.getElementById('btnLoginTop');
    const btnLogoutTop = document.getElementById('btnLogoutTop');

    const baseSelect = document.getElementById('baseSelect');
    const baseLockHint = document.getElementById('baseLockHint');
    const codigoInput = document.getElementById('codigoInput');
    const btnBuscar = document.getElementById('btnBuscar');
    const buscaBox = document.getElementById('buscaBox');
    const buscaMsg = document.getElementById('buscaMsg');
    const resultWrap = document.getElementById('resultWrap');
    const resultTbody = document.getElementById('resultTbody');

    const telInput = document.getElementById('telInput');
    const nomeInput = document.getElementById('nomeInput');
    const valorInput = document.getElementById('valorInput');
    const vencInput = document.getElementById('vencInput');

    const pdfInput = document.getElementById('pdfInput');
    const btnUpload = document.getElementById('btnUpload');
    const uploadInfo = document.getElementById('uploadInfo');

    const previewBox = document.getElementById('previewBox');
    const previewFrame = document.getElementById('previewFrame');
    const previewLink = document.getElementById('previewLink');
    const previewFilename = document.getElementById('previewFilename');

    const confirmChk = document.getElementById('confirmChk');
    const btnEnviar = document.getElementById('btnEnviar');
    const btnLimpar = document.getElementById('btnLimpar');
    const statusPill = document.getElementById('statusPill');
    const statusMsg = document.getElementById('statusMsg');

    /** ================= Utils ================= */
    function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
    function isLogged(){ try{ return !!localStorage.getItem('agente_codigo'); } catch { return false; } }

    function normalizeMsisdnBR(v){
      let d = String(v||"").replace(/\D+/g,"");
      if(!d) return "";
      if(!d.startsWith("55")) d = "55" + d;
      return d;
    }

    function formatTelefoneBR(msisdn){
      const d = String(msisdn||"").replace(/\D+/g,"");
      let x = d;
      if(x.startsWith("55")) x = x.slice(2);
      if(x.length < 10) return msisdn || "";
      const dd = x.slice(0,2);
      const num = x.slice(2);
      if(num.length === 9) return `(${dd}) ${num.slice(0,5)}-${num.slice(5)}`;
      if(num.length === 8) return `(${dd}) ${num.slice(0,4)}-${num.slice(4)}`;
      return `(${dd}) ${num}`;
    }

    function pickDefaultPhoneId(){
      const ids = (carteiraToPhoneIds[agente?.carteira] || []).map(String);
      return ids.length ? ids[0] : "";
    }

    function setPill(el, kind, text){
      el.classList.remove('pill-success','pill-fail','pill-warn');
      if(kind === 'success') el.classList.add('pill-success');
      if(kind === 'fail') el.classList.add('pill-fail');
      if(kind === 'warn') el.classList.add('pill-warn');
      el.innerHTML = text;
    }

    function showStatus(kind, title, msg){
      statusPill.classList.remove('hidden');
      setPill(statusPill, kind, title);
      if(msg){
        statusMsg.classList.remove('hidden');
        statusMsg.textContent = msg;
      }else{
        statusMsg.classList.add('hidden');
        statusMsg.textContent = '';
      }
    }

    function hideStatus(){
      statusPill.classList.add('hidden');
      statusMsg.classList.add('hidden');
      statusMsg.textContent = '';
    }

    function payloadFingerprint(){
      const p = {
        tel: normalizeMsisdnBR(telInput.value),
        nome: (nomeInput.value||"").trim(),
        valor: (valorInput.value||"").trim(),
        venc: (vencInput.value||"").trim(),
        file: uploaded.file_url || ""
      };
      return JSON.stringify(p);
    }

    function updateStepPill(){
      if(!isLogged()){
        pillStep.innerHTML = `<span>0</span> Fa√ßa login`;
        return;
      }
      const hasFields = hasRequiredFields();
      if(!hasFields){
        pillStep.innerHTML = `<span>1</span> Preencha os dados`;
        return;
      }
      if(hasFields && !uploaded.file_url){
        pillStep.innerHTML = `<span>2</span> Fa√ßa upload do PDF`;
        return;
      }
      if(uploaded.file_url && !confirmChk.checked){
        pillStep.innerHTML = `<span>3</span> Confirme o envio`;
        return;
      }
      pillStep.innerHTML = `<span>4</span> Pronto para enviar`;
    }

    function hasRequiredFields(){
      const tel = normalizeMsisdnBR(telInput.value);
      const nome = (nomeInput.value||"").trim();
      const valor = (valorInput.value||"").trim();
      const venc = (vencInput.value||"").trim();
      return tel.length >= 12 && !!nome && !!valor && !!venc;
    }

    function updateUploadEnabled(){
      const ok = isLogged() && hasRequiredFields();
      btnUpload.disabled = !ok;
      if(!ok){
        // qualquer altera√ß√£o invalida confirma√ß√£o e envio
        confirmChk.checked = false;
        btnEnviar.disabled = true;
      }
      updateStepPill();
    }

    function resetUploaded(keepFields=false){
      uploaded = { file_url:null, filename:null };
      previewBox.classList.add('hidden');
      previewFrame.src = "about:blank";
      previewLink.href = "#";
      previewFilename.textContent = "‚Äî";
      confirmChk.checked = false;
      btnEnviar.disabled = true;
      if(!keepFields){
        telInput.value = "";
        nomeInput.value = "";
        valorInput.value = "";
        vencInput.value = "";
      }
      hideStatus();
      uploadInfo.classList.add('hidden');
      uploadInfo.textContent = "";
      uploadInfo.style.color = "var(--muted)";
      lastPayloadFingerprint = payloadFingerprint();
      updateUploadEnabled();
    }

    /** =================== Login =================== */
    const modalLogin = document.getElementById('modalLogin');
    const loginTitle = document.getElementById('loginTitle');
    const loginCodigoAgente = document.getElementById('loginCodigoAgente');
    const loginSenha = document.getElementById('loginSenha');
    const loginErro = document.getElementById('loginErro');

    const loginSection = document.getElementById('loginSection');
    const senhaSection = document.getElementById('senhaSection');
    const senhaAtualWrap = document.getElementById('senhaAtualWrap');
    const senhaAtual = document.getElementById('senhaAtual');
    const novaSenha = document.getElementById('novaSenha');
    const confirmarSenha = document.getElementById('confirmarSenha');

    const btnLoginCriarSenha = document.getElementById('btnLoginCriarSenha');
    const btnLoginBack = document.getElementById('btnLoginBack');
    const btnDoLogin = document.getElementById('btnDoLogin');
    const btnCloseLogin = document.getElementById('btnCloseLogin');
    const btnCancelLogin = document.getElementById('btnCancelLogin');

    let loginMode = 'login'; // 'login' | 'create' | 'change'

    function openLogin(){
      modalLogin.style.display = 'flex';
      clearLoginError();
      setLoginMode('login');
      setTimeout(()=> loginCodigoAgente.focus(), 50);
    }
    function closeLogin(){
      modalLogin.style.display = 'none';
      clearLoginError();
    }
    function showLoginError(msg){
      loginErro.textContent = msg || 'Falha ao autenticar.';
      loginErro.classList.remove('hidden');
    }
    function clearLoginError(){
      loginErro.textContent = '';
      loginErro.classList.add('hidden');
    }

    function setLoginMode(mode){
      loginMode = mode;
      clearLoginError();

      if(mode === 'login'){
        loginTitle.textContent = 'Identifique-se';
        loginSection.classList.remove('hidden');
        senhaSection.classList.add('hidden');
        senhaAtualWrap.classList.add('hidden');
        btnLoginBack.classList.add('hidden');
        btnDoLogin.textContent = 'Entrar';
        btnLoginCriarSenha.classList.remove('hidden');
        return;
      }

      loginSection.classList.add('hidden');
      senhaSection.classList.remove('hidden');
      btnLoginBack.classList.remove('hidden');
      btnLoginCriarSenha.classList.add('hidden');

      if(mode === 'create'){
        loginTitle.textContent = 'Criar senha';
        senhaAtualWrap.classList.add('hidden');
        btnDoLogin.textContent = 'Salvar senha';
        return;
      }
      if(mode === 'change'){
        loginTitle.textContent = 'Trocar senha';
        senhaAtualWrap.classList.remove('hidden');
        btnDoLogin.textContent = 'Trocar senha';
      }
    }

    function normalizeApiError(j, fallback){
      if(!j) return fallback;
      return j.erro || j.error || j.message || fallback;
    }

    function persistAgenteFromPayload(codigo, a){
      localStorage.setItem('agente_codigo', String(codigo));
      localStorage.setItem('agente_nome', a?.nome || `Agente ${codigo}`);
      localStorage.setItem('agente_carteira', a?.carteira || 'ConnectZap');
      localStorage.setItem('agente_origem_bd', a?.origem_bd || '');
      localStorage.setItem('agente_permite_envio_individual', String(!!a?.permite_envio_individual));
    }

    async function legacyLoginByCode(codigo){
      const r = await fetch(`${FILA_API}/agentes/${encodeURIComponent(codigo)}`);
      const j = await r.json();
      if(!j.ok) throw new Error(normalizeApiError(j,'Agente n√£o encontrado'));
      persistAgenteFromPayload(codigo, j.agente || {});
      closeLogin();
      await boot();
    }

    function shouldSwitchToCreate(msg){ return /sem\s+senha|nao\s+possui\s+senha|sem\s+senha\s+cadastrada/i.test(msg||''); }
    function shouldSwitchToChange(msg){ return /expirad|expirou|senha\s+expirada/i.test(msg||''); }

    async function attemptLogin(){
      const codigoRaw = (loginCodigoAgente.value||'').trim();
      const senha = (loginSenha.value||'').trim();

      if(!codigoRaw || !/^\d+$/.test(codigoRaw)){ showLoginError('Informe um c√≥digo num√©rico v√°lido.'); return; }
      const codigo = Number(codigoRaw);

      if(!senha){
        showLoginError('Informe sua senha.');
        return;
      }

      try{
        const r = await fetch(`${FILA_API}/agentes/login`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ codigo_do_agente: codigo, senha })
        });

        if(r.status === 404 || r.status === 405){
          return await legacyLoginByCode(codigo);
        }

        let j=null; try{ j = await r.json(); } catch { j=null; }
        if(!r.ok || !j?.ok){
          const msg = normalizeApiError(j,'Falha ao autenticar');
          if(shouldSwitchToCreate(msg)){ setLoginMode('create'); novaSenha.focus(); return; }
          if(shouldSwitchToChange(msg)){ setLoginMode('change'); senhaAtual.focus(); return; }
          showLoginError(msg);
          return;
        }

        persistAgenteFromPayload(codigo, j.agente || {});
        closeLogin();
        await boot();
      }catch(e){
        showLoginError(e?.message || 'Falha ao autenticar.');
      }
    }

    async function submitSenha(){
      const codigoRaw = (loginCodigoAgente.value||'').trim();
      if(!codigoRaw || !/^\d+$/.test(codigoRaw)){ showLoginError('Informe um c√≥digo num√©rico v√°lido.'); return; }
      const codigo = Number(codigoRaw);

      const senha_atual = (senhaAtual.value||'').trim();
      const nova = (novaSenha.value||'').trim();
      const conf = (confirmarSenha.value||'').trim();

      if(!nova){ showLoginError('Informe a nova senha.'); return; }
      if(nova.length < 8){ showLoginError('A nova senha deve ter pelo menos 8 caracteres.'); return; }
      if(nova !== conf){ showLoginError('A confirma√ß√£o n√£o confere com a nova senha.'); return; }
      if(loginMode === 'change' && !senha_atual){ showLoginError('Informe a senha atual para trocar a senha.'); return; }

      const payload = { nova_senha: nova, confirmar_senha: conf };
      if(loginMode === 'change') payload.senha_atual = senha_atual;

      try{
        const r = await fetch(`${FILA_API}/agentes/${encodeURIComponent(codigo)}/senha`,{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        let j=null; try{ j=await r.json(); } catch { j=null; }
        if(!r.ok || !j?.ok){
          showLoginError(normalizeApiError(j,'Erro ao salvar senha'));
          return;
        }

        loginSenha.value = nova;
        setLoginMode('login');
        await attemptLogin();
      }catch(e){
        showLoginError(e?.message || 'Erro ao salvar senha.');
      }
    }

    async function loginPrimary(){
      clearLoginError();
      btnDoLogin.disabled = true;
      try{
        if(loginMode === 'login') await attemptLogin();
        else await submitSenha();
      }finally{
        btnDoLogin.disabled = false;
      }
    }

    btnCloseLogin.onclick = closeLogin;
    btnCancelLogin.onclick = closeLogin;
    btnDoLogin.onclick = loginPrimary;
    btnLoginBack.onclick = ()=> setLoginMode('login');

    btnLoginCriarSenha.addEventListener('click', async ()=>{
      clearLoginError();
      const codigoRaw = (loginCodigoAgente.value||'').trim();
      if(!codigoRaw || !/^\d+$/.test(codigoRaw)){
        showLoginError('Informe o c√≥digo do agente para criar/trocar a senha.');
        loginCodigoAgente.focus();
        return;
      }
      const codigo = Number(codigoRaw);
      try{
        const r = await fetch(`${FILA_API}/agentes/${encodeURIComponent(codigo)}`);
        const j = await r.json();
        if(j?.ok){
          const a = j.agente || {};
          if(a.tem_senha === false){ setLoginMode('create'); novaSenha.focus(); return; }
          setLoginMode('change'); senhaAtual.focus(); return;
        }
      }catch{}
      setLoginMode('create'); novaSenha.focus();
    });

    [loginCodigoAgente, loginSenha, senhaAtual, novaSenha, confirmarSenha].forEach(el=>{
      el.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){ e.preventDefault(); loginPrimary(); }
      });
    });

    /** =================== Boot / UI do operador =================== */
    function applyOperadorUI(){
      const logged = isLogged();
      btnLoginTop.classList.toggle('hidden', logged);
      btnLogoutTop.classList.toggle('hidden', !logged);

      if(!logged){
        agente = { codigo:null, nome:null, carteira:null, origem_bd:null, permite_envio_individual:true };
        opNome.textContent = '‚Äî';
        opCarteira.textContent = '‚Äî';
        setPill(pillAuth, 'fail', 'üîí Deslogado');
        updateStepPill();
        return;
      }

      agente.codigo = localStorage.getItem('agente_codigo');
      agente.nome = localStorage.getItem('agente_nome') || `Agente ${agente.codigo}`;
      agente.carteira = localStorage.getItem('agente_carteira') || 'ConnectZap';
      agente.origem_bd = (localStorage.getItem('agente_origem_bd') || '').trim().toLowerCase();
      agente.permite_envio_individual = (String(localStorage.getItem('agente_permite_envio_individual')||'true').toLowerCase() === 'true');

      opNome.textContent = `${agente.nome} (#${agente.codigo})`;
      opCarteira.textContent = agente.carteira;
      setPill(pillAuth, 'success', '‚úÖ Logado');

      // trava base pela origem_bd (igual padr√£o)
      if(agente.origem_bd){
        const hasOpt = Array.from(baseSelect.options).some(o => String(o.value).toLowerCase() === agente.origem_bd);
        if(!hasOpt){
          const opt = document.createElement('option');
          opt.value = agente.origem_bd;
          opt.textContent = agente.origem_bd.toUpperCase();
          baseSelect.appendChild(opt);
        }
        baseSelect.value = agente.origem_bd;
        baseSelect.disabled = true;
        baseSelect.classList.add('opacity-70','cursor-not-allowed');
        baseSelect.title = 'Origem definida pelo seu perfil';
        baseLockHint.classList.remove('hidden');
      }else{
        baseSelect.disabled = false;
        baseSelect.classList.remove('opacity-70','cursor-not-allowed');
        baseSelect.title = '';
        baseLockHint.classList.add('hidden');
      }

      updateUploadEnabled();
      updateStepPill();
    }

    async function boot(){
      applyOperadorUI();

      // se logado, valida/atualiza dados do agente no backend (para garantir carteira e origem_bd)
      if(isLogged()){
        try{
          const r = await fetch(`${FILA_API}/agentes/${encodeURIComponent(localStorage.getItem('agente_codigo'))}`);
          const j = await r.json();
          if(j?.ok){
            persistAgenteFromPayload(localStorage.getItem('agente_codigo'), j.agente || {});
            applyOperadorUI();
          }
        }catch{}
      }
    }

    btnLoginTop.onclick = openLogin;
    btnLogoutTop.onclick = ()=>{
      try{
        localStorage.removeItem('agente_codigo');
        localStorage.removeItem('agente_nome');
        localStorage.removeItem('agente_carteira');
        localStorage.removeItem('agente_origem_bd');
        localStorage.removeItem('agente_permite_envio_individual');
      }catch{}
      resetUploaded(false);
      applyOperadorUI();
      openLogin();
    };

    /** =================== Busca por c√≥digo (SIC) =================== */
    async function pesquisarPorCodigo(){
      if(!isLogged()){
        openLogin(); return;
      }

      const base = (baseSelect.value||'').trim();
      const codigo = (codigoInput.value||'').trim();

      buscaBox.classList.remove('hidden');
      resultWrap.classList.add('hidden');
      buscaMsg.textContent = '‚è≥ Buscando cadastro...';
      buscaRows = [];
      resultTbody.innerHTML = '';

      if(!base || !codigo){
        buscaMsg.textContent = 'Informe a base e o c√≥digo do cliente.';
        return;
      }

      try{
        const url = `${ESTRAT_API}/api/estrategias/pesquisa/${encodeURIComponent(base)}/${encodeURIComponent(codigo)}`;
        const res = await fetch(url, { method:'GET', mode:'cors', credentials:'omit', cache:'no-store' });

        if(!res.ok){
          const t = await res.text().catch(()=> '');
          throw new Error(`Falha ao buscar cadastro (${res.status}): ${t}`);
        }

        const data = await res.json();
        const rows = Array.isArray(data) ? data : (Array.isArray(data?.dados) ? data.dados : []);
        const norm = rows.map(r => ({
          raw: r,
          tel: normalizeMsisdnBR(r.TELEFONE || r.telefone || r.to_msisdn || r.to || ''),
          nome: (r.PrimeiroNome || r.primeiro_nome || r.nome || '').trim()
        })).filter(x => x.tel && x.tel.length >= 12);

        if(!norm.length){
          buscaMsg.textContent = 'Nenhum telefone encontrado para esse c√≥digo.';
          return;
        }

        buscaRows = norm;
        buscaMsg.textContent = `‚úÖ ${norm.length} telefone(s) encontrado(s). Selecione um para preencher.`;

        resultTbody.innerHTML = '';
        norm.forEach((x, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="font-mono">${escapeHtml(formatTelefoneBR(x.tel))}</td>
            <td>${escapeHtml(x.nome || '‚Äî')}</td>
            <td class="text-right">
              <button class="btn btn-neutral px-3 py-1 text-xs" type="button" data-i="${i}">Selecionar</button>
            </td>
          `;
          tr.querySelector('button').onclick = () => {
            telInput.value = x.tel;
            if(x.nome) nomeInput.value = x.nome;
            // qualquer sele√ß√£o muda o fingerprint => pede reconfirma√ß√£o
            confirmChk.checked = false;
            btnEnviar.disabled = true;
            updateUploadEnabled();
            hideStatus();
          };
          resultTbody.appendChild(tr);
        });

        resultWrap.classList.remove('hidden');
      }catch(err){
        buscaMsg.textContent = `‚ùå ${err?.message || 'Falha ao buscar cadastro.'}`;
      }
    }

    btnBuscar.onclick = pesquisarPorCodigo;
    codigoInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); pesquisarPorCodigo(); } });

    /** =================== Upload do PDF (S3 presigned via backend) =================== */
    btnUpload.onclick = ()=> pdfInput.click();

    async function doUploadPdf(file){
      if(!file) return;

      if(file.type !== 'application/pdf'){
        uploadInfo.classList.remove('hidden');
        uploadInfo.style.color = '#b91c1c';
        uploadInfo.textContent = 'Somente arquivos PDF s√£o permitidos.';
        return;
      }

      if(!hasRequiredFields()){
        uploadInfo.classList.remove('hidden');
        uploadInfo.style.color = '#b91c1c';
        uploadInfo.textContent = 'Preencha Telefone, Nome, Valor e Vencimento antes do upload.';
        return;
      }

      // invalida confirma√ß√£o anterior
      confirmChk.checked = false;
      btnEnviar.disabled = true;
      hideStatus();

      btnUpload.disabled = true;
      btnUpload.classList.add('btn-loading');
      uploadInfo.classList.remove('hidden');
      uploadInfo.style.color = 'var(--muted)';
      uploadInfo.textContent = '‚è≥ Gerando link de upload...';

      try{
        // 1) presign
        const r = await fetch(`${CONV_API}/api/upload/pdf`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ filename: file.name })
        });
        const j = await r.json().catch(()=> null);
        if(!r.ok || !j?.ok){
          throw new Error(j?.erro || `Falha ao gerar URL (HTTP ${r.status})`);
        }

        uploadInfo.textContent = '‚è≥ Enviando PDF para o armazenamento...';

        // 2) PUT no S3
        const put = await fetch(j.upload_url, {
          method:'PUT',
          headers:{ 'Content-Type':'application/pdf' },
          body: file
        });
        if(!put.ok){
          const txt = await put.text().catch(()=> '');
          throw new Error(`Falha no upload (S3): HTTP ${put.status} ${txt?.slice(0,200) || ''}`);
        }

        // 3) salva e mostra preview
        uploaded.file_url = j.file_url;
        uploaded.filename = file.name;

        previewFilename.textContent = file.name;
        previewLink.href = uploaded.file_url;
        previewFrame.src = uploaded.file_url;

        previewBox.classList.remove('hidden');

        uploadInfo.style.color = '#065f46';
        uploadInfo.textContent = '‚úÖ Upload conclu√≠do. Confira o PDF e confirme o envio.';

        lastPayloadFingerprint = payloadFingerprint();
        updateStepPill();
      }catch(err){
        uploadInfo.style.color = '#b91c1c';
        uploadInfo.textContent = `‚ùå ${err?.message || 'Falha no upload.'}`;
        uploaded = { file_url:null, filename:null };
        previewBox.classList.add('hidden');
        previewFrame.src = "about:blank";
        previewLink.href = "#";
        previewFilename.textContent = "‚Äî";
        confirmChk.checked = false;
      }finally{
        btnUpload.classList.remove('btn-loading');
        btnUpload.disabled = !hasRequiredFields();
        pdfInput.value = '';
        updateStepPill();
      }
    }

    pdfInput.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      await doUploadPdf(f);
    });

    /** =================== Confirma√ß√£o e Envio =================== */
    function canSendNow(){
      if(!isLogged()) return false;
      if(!hasRequiredFields()) return false;
      if(!uploaded.file_url) return false;
      if(!confirmChk.checked) return false;
      return true;
    }

    function syncSendEnabled(){
      // se alterou dados ap√≥s upload, pede reconfirma√ß√£o
      const nowFP = payloadFingerprint();
      if(uploaded.file_url && lastPayloadFingerprint && nowFP !== lastPayloadFingerprint){
        confirmChk.checked = false;
      }

      btnEnviar.disabled = !canSendNow();
      updateStepPill();
    }

    [telInput, nomeInput, valorInput, vencInput].forEach(el=>{
      el.addEventListener('input', ()=>{
        updateUploadEnabled();
        syncSendEnabled();
      });
    });

    confirmChk.addEventListener('change', ()=>{
      syncSendEnabled();
      if(confirmChk.checked) lastPayloadFingerprint = payloadFingerprint();
    });

    async function enviarBoleto(){
      hideStatus();

      if(!isLogged()){ openLogin(); return; }
      if(!hasRequiredFields()){ showStatus('fail','Falha','Preencha Telefone, Nome, Valor e Vencimento.'); return; }
      if(!uploaded.file_url){ showStatus('fail','Falha','Fa√ßa o upload do PDF antes de enviar.'); return; }
      if(!confirmChk.checked){ showStatus('warn','Aten√ß√£o','Confirme o envio no checkbox antes de enviar.'); return; }

      const to = normalizeMsisdnBR(telInput.value);
      const nome = (nomeInput.value||"").trim();
      const valor = (valorInput.value||"").trim();
      const venc = (vencInput.value||"").trim();

      const phone_id = pickDefaultPhoneId(); // simples: primeiro phone_id da carteira
      if(!phone_id){
        showStatus('fail','Falha','N√£o consegui identificar o phone_id da carteira do operador. Verifique o mapeamento.');
        return;
      }

      const payload = {
        telefone: to,
        to: to,
        nome: nome,
        valor: valor,
        vencimento: venc,
        file_url: uploaded.file_url,
        original_filename: uploaded.filename || "boleto.pdf",
        phone_id: phone_id,

        codigo_do_agente: parseInt(agente?.codigo || 0, 10) || null,
        nome_agente: agente?.nome || null,
        carteira: agente?.carteira || null,
        agente: {
          codigo_do_agente: parseInt(agente?.codigo || 0, 10) || null,
          nome_agente: agente?.nome || null,
          carteira: agente?.carteira || null,
          phone_id: phone_id
        }
      };

      btnEnviar.disabled = true;
      btnEnviar.classList.add('btn-loading');

      try{
        showStatus('warn','Enviando','Aguardando resposta da API...');

        const r = await fetch(`${CONV_API}/api/envio_individual/enviar_boleto`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        const j = await r.json().catch(()=> null);
        if(!r.ok || !j?.ok){
          const msg = j?.erro || j?.message || `Falha no envio (HTTP ${r.status})`;
          showStatus('fail','Falha', msg);
          return;
        }

        const msgId = j?.msg_id ? ` ‚Ä¢ msg_id: ${j.msg_id}` : '';
        showStatus('success','Sucesso', `Boleto enviado com sucesso.${msgId}`);

        // p√≥s-sucesso: trava confirma√ß√£o para evitar reenvio sem inten√ß√£o
        confirmChk.checked = false;
        btnEnviar.disabled = true;

        // mant√©m campos, mas permite novo upload se quiser reenviar corrigindo o arquivo
        lastPayloadFingerprint = payloadFingerprint();
        updateStepPill();
      }catch(err){
        showStatus('fail','Falha', err?.message || 'Erro de rede / CORS ao enviar.');
      }finally{
        btnEnviar.classList.remove('btn-loading');
        syncSendEnabled();
      }
    }

    btnEnviar.onclick = enviarBoleto;

    btnLimpar.onclick = ()=>{
      // limpa tudo
      buscaRows = [];
      buscaBox.classList.add('hidden');
      resultWrap.classList.add('hidden');
      buscaMsg.textContent = '‚Äî';
      codigoInput.value = '';
      resetUploaded(false);
      updateStepPill();
    };

    /** =================== Init =================== */
    btnLoginTop.addEventListener('click', openLogin);
    window.addEventListener('load', async ()=>{
      await boot();
      if(!isLogged()) openLogin();
      updateUploadEnabled();
      syncSendEnabled();
      updateStepPill();
    });
  </script>
</body>
</html>
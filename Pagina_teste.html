<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ConnectZap ‚Äî Agentes</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px}

  /* ========= Bal√µes (iguais ao Supervisor) ========= */
  .msg{
    display:inline-block;
    max-width:min(70%, 560px);
    padding:10px 14px 18px;
    margin:6px 0;
    position:relative;
    border-radius:18px;
    word-break:break-word;
    overflow-wrap:anywhere;
    white-space:normal;
    box-shadow:0 1px 2px rgba(0,0,0,.10);
    transition:background .18s ease;
  }
  @media (max-width:768px){ .msg{ max-width:86%; } }

  .msg.enviada{
    align-self:flex-end;
    background:linear-gradient(120deg, var(--bubble-out-g1,#dcf8c6), var(--bubble-out-g2,#b8f0a4));
    color:#111827;
  }
  .msg.recebida{
    align-self:flex-start;
    background:var(--bubble-in-bg,#fff);
    border:1px solid var(--bubble-in-border,#e2e8f0);
  }
  .msg .hora{
    position:absolute; right:8px; bottom:4px;
    font-size:11px; color:#4b5563;
  }

  /* Caudas */
  .msg.enviada::after, .msg.recebida::after{
    content:""; position:absolute; bottom:0; width:14px; height:14px;
    clip-path:polygon(0 0, 100% 0, 0 100%);
  }
  .msg.enviada::after{
    right:-7px;
    background:linear-gradient(120deg, var(--bubble-out-g1,#dcf8c6), var(--bubble-out-g2,#b8f0a4));
  }
  .msg.recebida::after{
    left:-7px;
    background:var(--bubble-in-bg,#fff);
    border-left:1px solid var(--bubble-in-border,#e2e8f0);
    border-bottom:1px solid var(--bubble-in-border,#e2e8f0);
  }

  /* Bot√£o responder */
  .msg .btn-responder{
    position:absolute; top:6px; right:6px;
    font-size:14px; color:#4b5563; opacity:0; transition:opacity .2s;
  }
  .msg.recebida:hover .btn-responder{ opacity:1; }

  /* M√≠dia no bal√£o */
  .msg img.thumb{ max-width:280px; height:auto; border-radius:12px; border:1px solid #e5e7eb; cursor:pointer; }

  /* Separador de dia */
  .dia{text-align:center;margin:12px 0;font-size:12px;color:#888}

  .ticket-selected{background:#f0f9ff !important}
  .badge{background:#22c55e;color:#fff;font-size:10px;font-weight:700;border-radius:9999px;padding:2px 6px;min-width:18px;text-align:center}
  .dot{width:10px;height:10px;border-radius:9999px;display:inline-block;margin-right:6px}
  .dot.online{background:#16a34a}.dot.offline{background:#9ca3af}

  /* ====== Cart√£o de mensagem de sistema ====== */
  .msg.system{background:#f8fafc; border:1px dashed #cbd5e1; align-self:center; max-width:80%}
  .msg.system::after{ display:none; }
  .sys-title{font-weight:700; font-size:.9rem; display:flex; align-items:center; gap:.5rem}
  .sys-body{font-size:.92rem; color:#334155}
  .sys-meta{font-size:.75rem; color:#64748b}
  .sys-pill{display:inline-block; font-size:.7rem; font-weight:700; padding:.1rem .4rem; border-radius:9999px; background:#eef2ff; color:#3730a3}
</style>
</head>
<body class="h-screen flex bg-gray-100">

<!-- Sidebar: Minhas conversas -->
<aside class="w-1/3 lg:w-1/4 bg-white border-r flex flex-col">
  <div class="p-3 border-b">
    <div class="flex items-center justify-between gap-2">
      <div class="min-w-0">
        <div class="text-xs text-gray-500">Agente</div>
        <div id="agenteNome" class="font-semibold truncate">‚Äî</div>
        <div class="text-xs text-gray-500">Carteira: <span id="agenteCarteira">‚Äî</span></div>
        <div class="text-xs text-gray-500">Status: <span id="agenteStatus"><span class="dot offline"></span>Offline</span></div>

        <!-- NOVO: indicador de limite -->
        <div class="mt-1 text-xs">
          <span class="text-gray-500">Tickets:</span>
          <span id="badgeAtivos" class="badge bg-emerald-500">0</span>
          <span class="text-gray-500 mx-1">/</span>
          <span id="badgeLimite" class="badge bg-gray-500">‚àû</span>
        </div>
      </div>

      <div class="flex flex-col items-end gap-2">
        <!-- Toggle Online/Offline -->
        <button id="btnToggleOnline"
                class="px-3 py-2 text-sm rounded-md bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 flex items-center gap-2"
                disabled>
          <svg id="toggleSpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <span id="toggleLabel">Ficar online</span>
        </button>
        <!-- Pegar proxima -->
        <button id="btnPegarProxima"
                class="px-3 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
                disabled>
          <svg id="pegarSpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <span id="pegarLabel">Pegar pr√≥xima</span>
        </button>
        <!-- Pedir prioridade -->
        <button id="btnPrioridade" class="px-3 py-2 text-sm rounded-md text-white disabled:opacity-50" disabled>Pedir prioridade</button>
        <!-- Logout -->
        <button id="btnLogout" class="px-3 py-1 text-xs bg-gray-100 rounded-md hover:bg-gray-200">Logout</button>
      </div>
    </div>

    <!-- NOVO: √°rea de aviso de limite -->
    <div id="msgAviso" class="mt-2 text-xs text-amber-600 hidden"></div>
    <div id="msgLimite" class="mt-1 text-xs text-red-600 hidden"></div>
  </div>

  <div class="p-2 border-b">
    <input id="buscaTicket" class="w-full p-2 border rounded-md text-sm" placeholder="üîç Buscar nas minhas conversas" oninput="filtrarTickets(this.value)"/>
  </div>

  <ul id="listaTickets" class="flex-1 overflow-y-auto"></ul>

  <div class="p-2 text-xs text-gray-500 border-t">
    Apenas conversas da sua carteira. ‚ÄúPegar pr√≥xima‚Äù usa ordem por √∫ltima mensagem <em>recebida</em>.
  </div>
</aside>

<!-- Main: Chat -->
<main class="flex-1 flex flex-col">
  <div class="flex items-center justify-between p-3 border-b bg-white">
    <div class="min-w-0">
      <div id="tituloConversa" class="font-bold text-lg truncate">Selecione um ticket</div>
      <div id="subInfo" class="text-sm text-gray-500 truncate"></div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnLiberar"
              class="px-3 py-2 text-sm bg-gray-100 rounded-md hover:bg-gray-200 disabled:opacity-50"
              disabled>Liberar</button>

      <div class="relative">
        <button id="btnConcluir"
                class="px-3 py-2 text-sm bg-emerald-600 text-white rounded-md hover:bg-emerald-700 disabled:opacity-50"
                disabled>Concluir</button>

        <div id="menuConcluir"
            class="hidden absolute right-0 mt-2 w-64 bg-white border rounded-lg shadow-lg z-20">
        </div>
      </div>
    </div>
  </div>

  <div id="chat" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-1 bg-gray-50">
    <p id="loading" class="text-center text-gray-500">Pegue uma conversa para iniciar‚Ä¶</p>
  </div>
  <div id="digitando" class="px-4 text-left hidden">Digitando‚Ä¶</div>

  <div id="respostaPreview" class="hidden px-3 py-2 border-t bg-gray-50 text-sm flex justify-between items-center">
    <div class="truncate max-w-[80%]">
      <span class="font-semibold">Respondendo:</span> <span id="respostaTexto" class="text-gray-600"></span>
    </div>
    <button onclick="cancelarResposta()" class="text-red-500 text-xs">‚úñ</button>
  </div>

  <div class="p-3 border-t flex space-x-2 bg-white items-center">
    <input type="file" id="fileInput" accept="application/pdf" class="hidden" onchange="enviarPDF(event)">
    <button onclick="document.getElementById('fileInput').click()" class="bg-blue-500 text-white px-3 py-2 rounded-md hover:bg-blue-600">üìù PDF</button>
    <textarea id="textoMensagem" rows="1" class="flex-1 border rounded-md p-2 resize-none" placeholder="Digite uma mensagem‚Ä¶" disabled></textarea>
    <button id="btnEnviar" onclick="enviarMensagem()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 disabled:opacity-50" disabled>Enviar</button>
  </div>
</main>

<!-- Modal imagem -->
<div id="imageModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50">
  <span id="closeModal" class="absolute top-4 right-6 text-white text-3xl cursor-pointer">&times;</span>
  <img id="modalImg" src="" alt="Imagem" class="max-h-[90%] max-w-[90%] rounded-lg shadow-lg">
</div>

<!-- NOVO: Modal de prioridade -->
<div id="priorityModal" class="hidden fixed inset-0 z-50">
  <div class="absolute inset-0 bg-black/60" onclick="fecharPriorityModal()"></div>
  <div class="relative mx-auto mt-24 w-[95%] max-w-md bg-white rounded-xl shadow-xl border">
    <div class="p-4 border-b flex items-center justify-between">
      <h3 class="font-semibold">Pedir prioridade</h3>
      <button class="text-gray-500" onclick="fecharPriorityModal()">‚úñ</button>
    </div>
    <div class="p-4 space-y-3">
      <label class="block text-sm text-gray-600">Telefone do cliente</label>
      <input id="priorityTelefone" class="w-full p-2 border rounded-md" placeholder="Ex: 61999999999 ou 5561999999999"/>
      <p class="text-xs text-gray-500">Aten√ß√£o: informe um telefone valido DDD + 8/9 Digitos.</p>
      <div id="priorityInfo" class="text-sm text-gray-700 hidden"></div>
      <div id="priorityErro" class="text-sm text-red-600 hidden"></div>
    </div>
    <div class="p-4 border-t flex items-center justify-end gap-2">
      <button class="px-3 py-2 text-sm bg-gray-100 rounded hover:bg-gray-200" onclick="fecharPriorityModal()">Cancelar</button>
      <button id="btnPriorityBuscar" class="px-3 py-2 text-sm bg-purple-600 text-white rounded-md hover:bg-purple-700 flex items-center gap-2">
        <svg id="prioritySpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <span id="priorityBtnLabel">Buscar e solicitar</span>
      </button>
    </div>
  </div>
</div>

<script>
/** ====== Config de APIs ====== */
const FILA_API = (window.FILA_API || "https://whatsapp-webhook-production-9a27.up.railway.app/api").replace(/\/+$/,'');
const CONV_API = (window.CONV_API || "https://conversas-api-production.up.railway.app").replace(/\/+$/,'');
const LOGOUT_REDIRECT = window.LOGOUT_REDIRECT || null;

/** ====== Mapeamento carteira -> phone_id ====== */
const phoneIdMap = {
  "828473960349364": "ConnectZap",
  "805610009301153": "Banco PAN",
  "727586317113885": "Recovery PJ",
  "864779140046932": "Recovery PF",
  "873637622491517": "Mercado Pago Cobran√ßa",
  "779797401888141": "DivZero",
  "829210283602406": "Arc4U",
  "713021321904495": "Serasa",
  "803535039503723": "Mercado Pago Vendas"
};
const carteiraToPhoneId = Object.fromEntries(Object.entries(phoneIdMap).map(([id,nome]) => [nome, id]));

/** ====== Estado ====== */
let agente = { codigo: null, nome: null, carteira: null, origem: null, online: false };
let tickets = [];              // minhas conversas
let selecionado = null;        // contato atual
let renderedKeys = new Set();  // dedupe no chat
let lastTimestampMs = null;
let lastDayRendered = null;
let pollingContatos = null;
let pollingMensagens = null;
let isModalOpen = false;
let userTyping = false;
let respostaMsgId = null;

/* NOVO: controle de limite */
let limitPerAgent = 0;         // 0 = sem limite
let ativosCount = 0;           // qtd de tickets em andamento do agente

/** ====== Constantes de documento ====== */
const DOC_PREVIEW_MAX = 2 * 1024 * 1024;

const elAgenteNome = document.getElementById("agenteNome");
const elAgenteCarteira = document.getElementById("agenteCarteira");
const elAgenteStatus = document.getElementById("agenteStatus");
const elMsgAviso = document.getElementById("msgAviso");
const elMsgLimite = document.getElementById("msgLimite");
const elListaTickets = document.getElementById("listaTickets");
const elTitulo = document.getElementById("tituloConversa");
const elSubInfo = document.getElementById("subInfo");
const chat = document.getElementById("chat");
const textarea = document.getElementById("textoMensagem");
const btnEnviar = document.getElementById("btnEnviar");
const btnPegarProxima = document.getElementById("btnPegarProxima");
const btnPrioridade = document.getElementById("btnPrioridade");
const btnLiberar = document.getElementById("btnLiberar");
const btnConcluir = document.getElementById("btnConcluir");
const menuConcluir = document.getElementById("menuConcluir");
const digitando = document.getElementById("digitando");
const btnLogout = document.getElementById("btnLogout");
const btnToggleOnline = document.getElementById("btnToggleOnline");

const badgeAtivos = document.getElementById("badgeAtivos");
const badgeLimite = document.getElementById("badgeLimite");

// Modal prioridade elements
const priorityModal = document.getElementById('priorityModal');
const priorityTelefone = document.getElementById('priorityTelefone');
const priorityInfo = document.getElementById('priorityInfo');
const priorityErro = document.getElementById('priorityErro');
const btnPriorityBuscar = document.getElementById('btnPriorityBuscar');
const prioritySpinner = document.getElementById('prioritySpinner');
const priorityBtnLabel = document.getElementById('priorityBtnLabel');

const MOTIVOS_CONCLUSAO = [
  "Realizou negocia√ß√£o",
  "Solicitou 2¬™ via de boleto",
  "Recusou a proposta",
  "D√∫vidas gerais",
  "Cliente ficou inativo",
];

function renderMenuConcluir() {
  menuConcluir.innerHTML = MOTIVOS_CONCLUSAO.map(m => `
    <button type="button"
            data-motivo="${m}"
            class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">
      ${m}
    </button>
  `).join("");
  menuConcluir.querySelectorAll("button[data-motivo]").forEach(btn => {
    btn.onclick = async () => {
      const motivo = btn.getAttribute("data-motivo");
      await concluirAtendimento(motivo);
      fecharMenuConcluir();
    };
  });
}

function abrirMenuConcluir() {
  if (!selecionado || btnConcluir.disabled) return;
  menuConcluir.classList.remove("hidden");
  document.addEventListener("click", clickForaMenuConcluir, { capture: true });
}
function fecharMenuConcluir() {
  menuConcluir.classList.add("hidden");
  document.removeEventListener("click", clickForaMenuConcluir, { capture: true });
}
function clickForaMenuConcluir(e) {
  const within = menuConcluir.contains(e.target) || btnConcluir.contains(e.target);
  if (!within) fecharMenuConcluir();
}
btnConcluir.onclick = () => {
  if (menuConcluir.classList.contains("hidden")) abrirMenuConcluir();
  else fecharMenuConcluir();
};
renderMenuConcluir();

/** ====== Util ====== */
function qsParam(name){ return new URLSearchParams(location.search).get(name); }
function escapeHtml(s){
  if(!s) return "";
  return s.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
}
function gerarCor(nome){ let h=0; for(const c of (nome||"U")) h=c.charCodeAt(0)+((h<<5)-h); return `hsl(${h%360},70%,60%)`; }
function keyLocal(){ return `cz:tickets:${agente.codigo}:${agente.carteira}`; }
function saveTickets(){ localStorage.setItem(keyLocal(), JSON.stringify(tickets)); }
function loadTickets(){ try{ tickets = JSON.parse(localStorage.getItem(keyLocal())||"[]")||[]; }catch{ tickets=[]; } }
function setStatus(online){
  elAgenteStatus.innerHTML = online ? '<span class="dot online"></span>Online' : '<span class="dot offline"></span>Offline';
  agente.online = !!online;

  btnPegarProxima.disabled = !online || (limitPerAgent>0 && ativosCount>=limitPerAgent);
  btnPrioridade.disabled   = !online || (limitPerAgent>0 && ativosCount>=limitPerAgent);

  // estilo do Prioridade
  if(!btnPrioridade.disabled){
    btnPrioridade.classList.remove('bg-gray-200','text-gray-500','hover:bg-gray-200','cursor-not-allowed');
    btnPrioridade.classList.add('bg-purple-600','text-white','hover:bg-purple-700');
  }else{
    btnPrioridade.classList.remove('bg-purple-600','text-white','hover:bg-purple-700');
    btnPrioridade.classList.add('bg-gray-200','text-gray-500','hover:bg-gray-200','cursor-not-allowed');
  }

  const toggleLabel = document.getElementById("toggleLabel");
  btnToggleOnline.disabled = false;

  if(agente.online){
    toggleLabel.textContent = "Ficar offline";
    btnToggleOnline.classList.remove("bg-green-600","hover:bg-green-700","text-white");
    btnToggleOnline.classList.add("bg-gray-100");
  }else{
    toggleLabel.textContent = "Ficar online";
    btnToggleOnline.classList.add("bg-green-600","text-white","hover:bg-green-700");
    btnToggleOnline.classList.remove("bg-gray-100");
  }
}

function bytesToHuman(n){
  if(!n && n !== 0) return "";
  const u=["B","KB","MB","GB","TB"];
  let i=0, s=n;
  while(s>=1024 && i<u.length-1){ s/=1024; i++; }
  return `${s.toFixed(s>=10||i===0?0:1)} ${u[i]}`;
}

/* Heur√≠stica de dire√ß√£o */
function isIncoming(m){
  const s = (m.status || "").toLowerCase();
  if (typeof m.from_me === "boolean") return !m.from_me;
  if (m.direction) return String(m.direction).toLowerCase().startsWith("in");
  if (["in","received","incoming"].includes(s)) return true;
  if (["out","sent","delivered","read","outgoing"].includes(s)) return false;
  return s === "in";
}

/** ====== BOOT ====== */
async function boot(){
  agente.codigo  = localStorage.getItem("agente_codigo") || qsParam("codigo") || null;
  agente.origem  = localStorage.getItem("agente_origem") || qsParam("origem") || null;

  if(!agente.codigo){
    const cod = prompt("Informe seu c√≥digo de agente:");
    if(!cod) return; agente.codigo = String(parseInt(cod,10));
  }

  try{
    const r = await fetch(`${FILA_API}/agentes/${encodeURIComponent(agente.codigo)}`);
    const j = await r.json();
    if(!j.ok) throw new Error(j.erro||"Agente n√£o encontrado");
    agente.nome = j.agente.nome;
    agente.carteira = j.agente.carteira;
    localStorage.setItem("agente_codigo", agente.codigo);
    localStorage.setItem("agente_nome", agente.nome);
    localStorage.setItem("agente_carteira", agente.carteira);
    elAgenteNome.textContent = `${agente.nome} (#${agente.codigo})`;
    elAgenteCarteira.textContent = agente.carteira;

    await verificarOnline();

    // minhas conversas (para contagem inicial)
    try{
      const url = `${CONV_API}/api/tickets/minhas?agente=${encodeURIComponent(agente.codigo)}&carteira=${encodeURIComponent(agente.carteira)}`;
      const r2 = await fetch(url);
      if (r2.ok) {
        tickets = await r2.json();
        saveTickets();
      }
    }catch(_){}

    renderTickets();

    if(pollingContatos) clearInterval(pollingContatos);
    pollingContatos = setInterval(refreshOrdemCarteira, 5000);
    await refreshOrdemCarteira();

    // NOVO: carrega limite e atualiza badge
    await refreshAtivosELimite();

    if(!tickets.length) btnPegarProxima.disabled = !agente.online || (limitPerAgent>0 && ativosCount>=limitPerAgent);
  }catch(e){
    elMsgAviso.classList.remove("hidden");
    elMsgAviso.textContent = "Falha ao carregar agente. Verifique seu c√≥digo ou API.";
  }
}

async function verificarOnline(){
  try{
    const r = await fetch(`${FILA_API}/fila/status?carteira=${encodeURIComponent(agente.carteira)}`);
    const lista = await r.json();
    const achou = Array.isArray(lista) && lista.some(x => String(x.codigo_do_agente) === String(agente.codigo));
    setStatus(achou);
    if(!achou){
      elMsgAviso.classList.remove("hidden");
      elMsgAviso.textContent = "Voc√™ est√° OFFLINE nesta carteira. Use ‚ÄúFicar online‚Äù para entrar na fila.";
    }else{
      elMsgAviso.classList.add("hidden"); elMsgAviso.textContent = "";
    }
  }catch(e){ setStatus(false); }
}

/** ====== Ordem por carteira ====== */
let ordemCache = [];
async function refreshOrdemCarteira(){
  const phoneId = carteiraToPhoneId[agente.carteira];
  if(!phoneId) return;
  try{
    const res = await fetch(`${CONV_API}/api/conversas/contatos`);
    const contatos = await res.json();
    const filtrados = (contatos||[]).filter(c => c.phone_id === phoneId);
    filtrados.sort((a,b) => {
      const ai = a.status === 'in', bi = b.status === 'in';
      if(ai!==bi) return bi - ai;
      return new Date(b.data_hora) - new Date(a.data_hora);
    });
    ordemCache = filtrados;
  }catch(e){ console.error("Falha ao atualizar ordem", e); }
}

/** ====== NOVO: Ativos & Limite ====== */
async function refreshAtivosELimite(){
  // ativos = minhas conversas atuais
  try{
    const url = `${CONV_API}/api/tickets/minhas?agente=${encodeURIComponent(agente.codigo)}&carteira=${encodeURIComponent(agente.carteira)}`;
    const r = await fetch(url);
    const rows = r.ok ? await r.json() : [];
    ativosCount = Array.isArray(rows) ? rows.length : 0;
  }catch{ ativosCount = tickets.length; }

  // limite por carteira
  try{
    const j = await fetch(`${CONV_API}/api/supervisao/tickets-limit?carteira=${encodeURIComponent(agente.carteira)}`).then(r=>r.json());
    limitPerAgent = Number(j.limit_per_agent || 0);
  }catch{ limitPerAgent = 0; }

  renderAtivosLimiteUI();
}

function renderAtivosLimiteUI(){
  badgeAtivos.textContent = String(ativosCount);
  badgeLimite.textContent = limitPerAgent > 0 ? String(limitPerAgent) : "‚àû";

  const atingiu = (limitPerAgent > 0 && ativosCount >= limitPerAgent);

  // msg de limite
  if(atingiu){
    elMsgLimite.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido. Conclua ou libere um atendimento para continuar.`;
    elMsgLimite.classList.remove("hidden");
  }else{
    elMsgLimite.classList.add("hidden"); elMsgLimite.textContent = "";
  }

  // aplicar no estado dos bot√µes (respeitando se est√° online)
  btnPegarProxima.disabled = !agente.online || atingiu;
  btnPrioridade.disabled   = !agente.online || atingiu;

  if(!btnPrioridade.disabled){
    btnPrioridade.classList.remove('bg-gray-200','text-gray-500','hover:bg-gray-200','cursor-not-allowed');
    btnPrioridade.classList.add('bg-purple-600','text-white','hover:bg-purple-700');
  }else{
    btnPrioridade.classList.remove('bg-purple-600','text-white','hover:bg-purple-700');
    btnPrioridade.classList.add('bg-gray-200','text-gray-500','hover:bg-gray-200','cursor-not-allowed');
  }
}

/** ====== Toggle Online/Offline ====== */
btnToggleOnline.onclick = async () => {
  if(!agente.carteira || !agente.codigo) return;

  const toggleSpinner = document.getElementById('toggleSpinner');
  const toggleLabel = document.getElementById('toggleLabel');

  elMsgAviso.classList.add("hidden"); elMsgAviso.textContent = "";

  const indoOnline = !agente.online;

  btnToggleOnline.disabled = true;
  toggleSpinner.classList.remove('hidden');
  toggleLabel.textContent = indoOnline ? 'Entrando‚Ä¶' : 'Saindo‚Ä¶';

  try{
    if(indoOnline){
      const r = await fetch(`${FILA_API}/fila/online`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo,10), carteira: agente.carteira })
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.erro||"Erro ao entrar online");
      setStatus(true);
      await refreshOrdemCarteira();
      await refreshAtivosELimite();
    }else{
      const r = await fetch(`${FILA_API}/fila/offline`, {
        method:"DELETE",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo,10), carteira: agente.carteira })
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.erro||"Erro ao ficar offline");
      setStatus(false);
    }
  }catch(e){
    elMsgAviso.classList.remove("hidden");
    elMsgAviso.textContent = (e?.message||"Falha ao alterar status");
  }finally{
    toggleSpinner.classList.add('hidden');
    toggleLabel.textContent = agente.online ? 'Ficar offline' : 'Ficar online';
    btnToggleOnline.disabled = false;
  }
};

/** ====== Distribui√ß√£o local ====== */
btnPegarProxima.onclick = async () => {
  if (!agente.online) { alert("Voc√™ est√° offline. Clique em ‚ÄúFicar online‚Äù."); return; }

  // checagem local do limite (UX mais r√°pida)
  if (limitPerAgent > 0 && ativosCount >= limitPerAgent) {
    elMsgLimite.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido. Conclua/libere um antes de pegar outro.`;
    elMsgLimite.classList.remove('hidden');
    renderAtivosLimiteUI();
    return;
  }

  const spinner = document.getElementById('pegarSpinner');
  const label = document.getElementById('pegarLabel');

  btnPegarProxima.disabled = true;
  spinner.classList.remove('hidden');
  label.textContent = 'Buscando‚Ä¶';

  try {
    const r = await fetch(`${CONV_API}/api/tickets/claim`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        codigo_do_agente: parseInt(agente.codigo,10),
        carteira: agente.carteira
      })
    });

    const j = await r.json().catch(()=>({ok:false, erro:'Falha na resposta'}));

    // Tratar limite atingido pelo backend
    if (r.status === 409 && j && (j.limit_per_agent !== undefined)) {
      limitPerAgent = Number(j.limit_per_agent || 0);
      ativosCount   = Number(j.ativos || ativosCount);
      elMsgLimite.textContent = j.erro || `Limite de ${limitPerAgent} atingido.`;
      elMsgLimite.classList.remove('hidden');
      renderAtivosLimiteUI();
      return;
    }

    if (!r.ok || !j.ok) {
      alert(j.erro || "Sem conversas dispon√≠veis.");
      return;
    }

    // sucesso
    if (!tickets.find(t => t.remetente === j.ticket.remetente && t.phone_id === j.ticket.phone_id)) {
      tickets.unshift(j.ticket);
      saveTickets();
    }
    renderTickets();
    abrirTicket(j.ticket);

    // atualiza contagem (ganhou 1)
    ativosCount++;
    renderAtivosLimiteUI();

  } catch (e) {
    alert("Falha ao pegar pr√≥xima.");
  } finally {
    spinner.classList.add('hidden');
    label.textContent = 'Pegar pr√≥xima';
    btnPegarProxima.disabled = !agente.online || (limitPerAgent>0 && ativosCount>=limitPerAgent);
  }
};


// ====== NOVO: Pedir prioridade (respeitando limite) ======
btnPrioridade.onclick = () => {
  if(!agente.online){ alert('Voc√™ est√° offline. Clique em ‚ÄúFicar online‚Äù.'); return; }
  if(limitPerAgent>0 && ativosCount>=limitPerAgent){
    elMsgLimite.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido. Conclua/libere um antes de solicitar prioridade.`;
    elMsgLimite.classList.remove('hidden');
    return;
  }
  abrirPriorityModal();
};

function abrirPriorityModal(){
  isModalOpen = true;
  priorityInfo.classList.add('hidden');
  priorityErro.classList.add('hidden');
  priorityTelefone.value = '';
  priorityModal.classList.remove('hidden');
  setTimeout(()=>priorityTelefone.focus(), 50);
}
function fecharPriorityModal(){
  isModalOpen = false;
  priorityModal.classList.add('hidden');
}

priorityTelefone.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); btnPriorityBuscar.click(); }
});
document.addEventListener('keydown', (e)=>{
  if(!priorityModal.classList.contains('hidden') && e.key === 'Escape'){
    fecharPriorityModal();
  }
});

function normalizarTelefone(raw){
  let d = String(raw || '').replace(/\D/g, '');
  if (!d) return '';
  if (!d.startsWith('55')) d = '55' + d;
  const m = d.match(/^55(\d{2})(\d{8,9})(.*)$/);
  if (m) {
    const ddd = m[1]; let numero = m[2]; const tail = m[3] || '';
    if (numero.length === 9 && numero.startsWith('9')) numero = numero.slice(1);
    d = '55' + ddd + numero + tail;
  }
  return d;
}

async function findContatoNaOrdem(remetente){
  let c = (ordemCache||[]).find(x => String(x.remetente) === String(remetente));
  if(c) return c;
  try{
    const r = await fetch(`${CONV_API}/api/conversas/contatos`);
    const all = await r.json();
    const phoneId = carteiraToPhoneId[agente.carteira];
    c = (all||[]).find(x => x.phone_id===phoneId && String(x.remetente)===String(remetente));
    return c || null;
  }catch{ return null; }
}

btnPriorityBuscar.onclick = async () => {
  priorityInfo.classList.add('hidden');
  priorityErro.classList.add('hidden');

  // bloqueio no limite (UX)
  if(limitPerAgent>0 && ativosCount>=limitPerAgent){
    priorityErro.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido. Conclua/libere um antes de solicitar prioridade.`;
    priorityErro.classList.remove('hidden');
    return;
  }

  const nrm = normalizarTelefone(priorityTelefone.value);
  if(nrm.length < 11){
    priorityErro.textContent = 'Informe ao menos DDI (55) + DDD (2) + n√∫mero (8).';
    priorityErro.classList.remove('hidden');
    return;
  }

  priorityInfo.innerHTML = `Buscando por: <code>${nrm}</code>`;
  priorityInfo.classList.remove('hidden');

  const phoneIdCarteira = carteiraToPhoneId[agente.carteira];
  await findContatoNaOrdem(nrm);

  btnPriorityBuscar.disabled = true;
  prioritySpinner.classList.remove('hidden');
  priorityBtnLabel.textContent = 'Solicitando‚Ä¶';
  try{
    const body = {
      codigo_do_agente: parseInt(agente.codigo,10),
      carteira: agente.carteira,
      remetente: nrm,
      phone_id: phoneIdCarteira,
      prioridade: true
    };
    const r = await fetch(`${CONV_API}/api/tickets/claim`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const data = await r.json().catch(()=>({ok:false, erro:'Falha na resposta'}));

    // limite atingido no backend
    if (r.status === 409 && data && (data.limit_per_agent !== undefined)) {
      limitPerAgent = Number(data.limit_per_agent || 0);
      ativosCount   = Number(data.ativos || ativosCount);
      priorityErro.textContent = data.erro || `Limite de ${limitPerAgent} atingido.`;
      priorityErro.classList.remove('hidden');
      await refreshAtivosELimite();
      return;
    }

    if(r.ok && data && data.ok && data.ticket){
      priorityInfo.innerHTML = `<span class="text-emerald-700 font-medium">Prioridade concedida.</span> Abrindo o ticket‚Ä¶`;

      if(!tickets.find(t => t.remetente === data.ticket.remetente && t.phone_id === data.ticket.phone_id)){
        tickets.unshift(data.ticket);
        saveTickets();
        renderTickets();
      }
      fecharPriorityModal();
      abrirTicket(data.ticket);

      // atualiza contagem
      ativosCount++;
      renderAtivosLimiteUI();
      return;
    }

    if(data && (data.assigned_to || data.atendimento)){
      const owner = data.assigned_to || data.atendimento;
      priorityErro.innerHTML = `Outro agente j√° est√° atendendo: <strong>${escapeHtml(owner.nome||'‚Äî')}</strong> (#${escapeHtml(String(owner.codigo||'‚Äî'))}).`;
      priorityErro.classList.remove('hidden');
      return;
    }

    if(r.status === 404){
      priorityErro.textContent = 'Contato n√£o est√° na fila desta carteira.';
      priorityErro.classList.remove('hidden');
      return;
    }

    const msg = (data && (data.erro||data.message)) || 'N√£o foi poss√≠vel conceder prioridade.';
    priorityErro.textContent = msg;
    priorityErro.classList.remove('hidden');
  }
  catch(e){
    priorityErro.textContent = 'Falha ao solicitar prioridade.';
    priorityErro.classList.remove('hidden');
  }
  finally{
    btnPriorityBuscar.disabled = false;
    prioritySpinner.classList.add('hidden');
    priorityBtnLabel.textContent = 'Buscar e solicitar';
  }
};

/** ====== Libera√ß√£o / Conclus√£o / Logout ====== */
btnLiberar.onclick = async () => {
  if(!selecionado) return;
  try{
    const r = await fetch(`${CONV_API}/api/tickets/liberar`, {
      method: "DELETE",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        codigo_do_agente: parseInt(agente.codigo,10),
        remetente: selecionado.remetente,
        phone_id: selecionado.phone_id
      })
    });
    const j = await r.json();
    if(!r.ok || !j.ok){ alert(j.erro || "N√£o foi poss√≠vel liberar."); return; }
    tickets = tickets.filter(t => !(t.remetente===selecionado.remetente && t.phone_id===selecionado.phone_id));
    saveTickets(); renderTickets(); limparChat();
    elTitulo.textContent = "Selecione um ticket"; elSubInfo.textContent = ""; btnLiberar.disabled = true; btnConcluir.disabled = true; fecharMenuConcluir();

    // liberou -> diminui 1 e atualiza UI
    if(ativosCount>0) ativosCount--;
    renderAtivosLimiteUI();

  }catch(e){ alert("Erro ao liberar."); }
};

btnLogout.onclick = async () => {
  try{
    await fetch(`${FILA_API}/fila/offline`, {
      method:"DELETE",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo,10), carteira: agente.carteira })
    }).catch(()=>{});
  }catch(_){}

  try{
    localStorage.removeItem("agente_codigo");
    localStorage.removeItem("agente_nome");
    localStorage.removeItem("agente_carteira");
    localStorage.removeItem("agente_origem");
    Object.keys(localStorage).forEach(k => { if(k.startsWith("cz:tickets:")) localStorage.removeItem(k); });
  }catch(_){}

  if(pollingContatos) clearInterval(pollingContatos);
  if(pollingMensagens) clearInterval(pollingMensagens);
  setStatus(false);
  tickets = []; renderTickets(); limparChat();
  elTitulo.textContent = "Selecione um ticket"; elSubInfo.textContent = ""; btnLiberar.disabled = true;

  if(LOGOUT_REDIRECT){ window.location.href = LOGOUT_REDIRECT; }
  else { window.location.reload(); }
};

/** ====== Concluir ====== */
async function concluirAtendimento(motivo) {
  if (!selecionado) return;
  try {
    btnConcluir.disabled = true;

    const r = await fetch(`${CONV_API}/api/tickets/concluir`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        codigo_do_agente: parseInt(agente.codigo, 10),
        remetente: selecionado.remetente,
        phone_id: selecionado.phone_id,
        motivo
      })
    });
    const j = await r.json();
    if (!r.ok || !j.ok) {
      alert(j.erro || "N√£o foi poss√≠vel concluir.");
      btnConcluir.disabled = false;
      return;
    }

    // remove da lista e limpa UI
    tickets = tickets.filter(t => !(t.remetente === selecionado.remetente && t.phone_id === selecionado.phone_id));
    saveTickets();
    renderTickets();
    limparChat();
    elTitulo.textContent = "Selecione um ticket";
    elSubInfo.textContent = "";
    btnLiberar.disabled = true;
    btnConcluir.disabled = true;
    selecionado = null;

    // concluiu -> diminui 1 e atualiza UI
    if(ativosCount>0) ativosCount--;
    renderAtivosLimiteUI();
  } catch (e) {
    alert("Erro ao concluir.");
    btnConcluir.disabled = false;
  }
}

/** ====== Lista de tickets ====== */
function renderTickets(filtro=""){
  const q = (filtro||"").toLowerCase().trim();
  elListaTickets.innerHTML = "";
  tickets.forEach(t => {
    const nome = t.nome_exibicao || t.remetente;
    const ultima = t.mensagem_final ? t.mensagem_final.slice(0,70) : "";
    const hora = t.data_hora ? new Date(t.data_hora).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}) : "";
    const hay = `${nome} ${t.remetente}`.toLowerCase();
    if(q && !hay.includes(q)) return;

    const li = document.createElement("li");
    li.className = "flex items-center p-3 hover:bg-gray-100 cursor-pointer border-b";
    li.onclick = () => abrirTicket(t);
    li.innerHTML = `
      <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 font-medium" style="background:${gerarCor(nome)};color:#fff;">
        ${(nome||"U").charAt(0).toUpperCase()}
      </div>
      <div class="flex-1 min-w-0">
        <div class="font-semibold truncate">${escapeHtml(nome)}</div>
        <div class="text-sm text-gray-600 truncate">${escapeHtml(ultima)}</div>
      </div>
      <div class="text-xs text-gray-400 pl-2">${hora}</div>
    `;
    if(selecionado && selecionado.remetente === t.remetente) li.classList.add("ticket-selected");
    elListaTickets.appendChild(li);
  });
}
function filtrarTickets(v){ renderTickets(v); }

/** ====== Abrir chat ====== */
async function abrirTicket(t){
  selecionado = t;
  renderTickets();
  elTitulo.textContent = t.nome_exibicao ? `${t.nome_exibicao} (${t.remetente})` : t.remetente;
  elSubInfo.textContent = `conta: ${phoneIdMap[t.phone_id]||t.phone_id}`;
  textarea.disabled = false; textarea.focus(); btnEnviar.disabled = true; btnLiberar.disabled = false; btnConcluir.disabled = false;

  lastTimestampMs = null; lastDayRendered = null; renderedKeys.clear(); chat.innerHTML = "";

  await carregarMensagens(false);

  if(pollingMensagens) clearInterval(pollingMensagens);
  pollingMensagens = setInterval(() => {
    if(!userTyping && !isModalOpen && selecionado) carregarMensagens(true);
  }, 5000);
}

textarea.addEventListener("input", () => {
  textarea.style.height = "auto";
  textarea.style.height = textarea.scrollHeight + "px";
  btnEnviar.disabled = textarea.value.trim().length === 0;
  digitando.style.display = textarea.value.trim() ? "block" : "none";
});
textarea.addEventListener("keydown", e => {
  if(e.key === "Enter" && !e.shiftKey){ e.preventDefault(); if(!btnEnviar.disabled) enviarMensagem(); }
});

async function carregarMensagens(incremental=true){
  if(!selecionado) return;
  let url = `${CONV_API}/api/conversas/${encodeURIComponent(selecionado.remetente)}`;
  if(selecionado.phone_id) url += `?phone_id=${encodeURIComponent(selecionado.phone_id)}`;
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error("Erro hist√≥rico");
    const msgs = await r.json();
    msgs.sort((a,b) => new Date(a.data_hora) - new Date(b.data_hora));

    if(!incremental){ chat.innerHTML = ""; lastTimestampMs = null; lastDayRendered = null; renderedKeys.clear(); }

    const isNearBottom = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 200;
    msgs.forEach(m => renderMsg(m, incremental));
    if(isNearBottom) chat.scrollTo({ top: chat.scrollHeight, behavior: "smooth" });
  }catch(e){ console.error(e); }
}

function renderMsg(m, incremental){
  const tMs = new Date(m.data_hora).getTime();
  const key = `${m.data_hora}|${m.status}|${m.mensagem_final||m.tipo||""}`;
  if(renderedKeys.has(key)) return;
  if(incremental && lastTimestampMs!==null && tMs<=lastTimestampMs) return;

  const dia = new Date(m.data_hora).toLocaleDateString("pt-BR", { timeZone:"America/Sao_Paulo" });
  if(!lastDayRendered || lastDayRendered!==dia){
    const sep = document.createElement("div"); sep.className = "dia"; sep.textContent = `‚Äî ${dia} ‚Äî`;
    chat.appendChild(sep); lastDayRendered = dia;
  }

  const hora = new Date(m.data_hora).toLocaleTimeString("pt-BR", {hour:"2-digit",minute:"2-digit", timeZone:"America/Sao_Paulo"});
  const incoming = isIncoming(m);
  const div = document.createElement("div");
  div.className = `msg ${incoming ? 'recebida' : 'enviada'}`;

  if(m.tipo==="imagem" || m.mensagem_final==="[image]"){
    div.innerHTML = `<div class="text-gray-600 italic">[imagem recebida]</div>
      <button class="btn-olhinho text-blue-600 underline mt-1">üëÅ Ver imagem</button>
      <span class="hora">${hora}</span>`;
    const btn = div.querySelector(".btn-olhinho");
    if(!m.msg_id){ btn.disabled=true; btn.textContent="Imagem indispon√≠vel"; }
    else btn.onclick = () => carregarImagem(div, btn, m.msg_id);

  }else if(m.tipo==="audio" || m.mensagem_final==="[audio]"){
    div.innerHTML = `<div class="text-gray-600 italic">[√°udio recebido]</div>
      <button class="btn-audio text-blue-600 underline mt-1">‚ñ∂ Reproduzir √°udio</button>
      <span class="hora">${hora}</span>`;
    const btn = div.querySelector(".btn-audio");
    if(!m.msg_id){ btn.disabled=true; btn.textContent="√Åudio indispon√≠vel"; }
    else btn.onclick = () => carregarAudio(div, btn, m.msg_id);

  }else if(m.tipo==="document" || m.mensagem_final==="[document]"){
    div.innerHTML = `<div class="text-gray-600 italic">[documento recebido]</div>
      <button class="btn-doc text-blue-600 underline mt-1">üìé Ver documento</button>
      <span class="hora">${hora}</span>`;
    const btn = div.querySelector(".btn-doc");
    if(!m.msg_id){ btn.disabled=true; btn.textContent="Documento indispon√≠vel"; }
    else btn.onclick = () => carregarDocumento(div, btn, m.msg_id);

  }else if(typeof m.mensagem_final === "string" && m.mensagem_final.startsWith("üìé PDF:")){
    const lines = m.mensagem_final.split("\n");
    const filename = (lines[0]||"").replace("üìé PDF:","").trim() || "Arquivo";
    const link = (lines[1]||"").replace("üîó","").trim();
    div.innerHTML = `
      <div class="flex items-start gap-2">
        <div class="text-xl leading-none">üìÑ</div>
        <div class="min-w-0">
          <div class="font-semibold">${escapeHtml(filename)}</div>
          ${link ? `<a href="${escapeHtml(link)}" target="_blank" class="text-blue-600 underline break-all">Abrir/baixar</a>` : `<span class="text-slate-500">sem link</span>`}
        </div>
      </div>
      <span class="hora">${hora}</span>
    `;

  }else if(m.tipo==="emoji" || m.mensagem_final==="[reaction]"){
    const wrap = document.createElement("div"); wrap.className = "flex items-center gap-2";
    const emojiEl = document.createElement("span"); emojiEl.className="text-2xl"; emojiEl.textContent="üôÇ";
    const label = document.createElement("span"); label.className="text-gray-600 italic"; label.textContent="enviou um emote";
    wrap.appendChild(emojiEl); wrap.appendChild(label); div.appendChild(wrap);
    const horaSpan = document.createElement("span"); horaSpan.className="hora"; horaSpan.textContent=hora; div.appendChild(horaSpan);
    if(m.msg_id){
      fetch(`${CONV_API}/api/conversas/emoji/${encodeURIComponent(m.msg_id)}`)
        .then(r=>r.json()).then(j=>{ if(j.ok&&j.emoji) emojiEl.textContent = j.emoji; else label.textContent = "emoji n√£o carregado"; })
        .catch(()=>label.textContent="falha ao carregar emoji");
    }

  }else if(m.tipo==="system" || m.mensagem_final==="[system]"){
    div.className = "msg system";
    div.innerHTML = `
      <div class="sys-title"><span>‚ÑπÔ∏è Evento do sistema</span> <span class="sys-pill">carregando‚Ä¶</span></div>
      <div class="sys-body mt-1">Obtendo detalhes‚Ä¶</div>
      <div class="sys-meta mt-1"></div>
      <span class="hora">${hora}</span>
    `;
    if(!m.msg_id){
      div.querySelector(".sys-body").textContent = "Detalhes indispon√≠veis (sem msg_id).";
      const pill = div.querySelector(".sys-pill"); if(pill) pill.textContent = "indispon√≠vel";
    }else{
      (async ()=>{
        try{
          const r = await fetch(`${CONV_API}/api/conversas/system/${encodeURIComponent(m.msg_id)}`);
          const j = await r.json();
          const pill = div.querySelector(".sys-pill");
          const bodyEl = div.querySelector(".sys-body");
          const metaEl = div.querySelector(".sys-meta");

          if(!j.ok){
            if(pill) pill.textContent = "erro";
            bodyEl.textContent = j.erro || "Falha ao obter detalhes do evento.";
            return;
          }

          if(pill) pill.textContent = j.type || "system";

          if(j.type==="user_changed_number" && j.old_wa_id && j.wa_id){
            bodyEl.innerHTML = `
              O cliente alterou o n√∫mero:<br>
              <span class="font-semibold">${escapeHtml(j.old_wa_id)}</span>
              <span class="mx-1">‚Üí</span>
              <span class="font-semibold">${escapeHtml(j.wa_id)}</span>
            `;
          }else{
            bodyEl.textContent = j.body || "Evento de sistema recebido.";
          }

          const src = j.from || j.old_wa_id || "";
          const pid = j.phone_id ? ` ‚Ä¢ conta: ${escapeHtml(j.phone_id)}` : "";
          metaEl.textContent = `${src ? "Origem: "+src : ""}${pid}`;
        }catch(e){
          const pill = div.querySelector(".sys-pill"); if(pill) pill.textContent = "erro";
          div.querySelector(".sys-body").textContent = "Falha ao carregar detalhes do evento.";
        }
      })();
    }

  }else{
    div.innerHTML = `<div>${escapeHtml(m.mensagem_final||"")}</div><span class="hora">${hora}</span>`;
  }

  if(incoming && !(m.tipo==="system" || m.mensagem_final==="[system]")){
    const btn = document.createElement("button");
    btn.className = "btn-responder"; btn.title="Responder"; btn.innerHTML="‚Ü©";
    btn.onclick = () => responderMensagem(m.msg_id, m.mensagem_final||"");
    div.appendChild(btn);
  }

  chat.appendChild(div);
  renderedKeys.add(key);
  if(lastTimestampMs===null || tMs>lastTimestampMs) lastTimestampMs = tMs;
}

async function carregarImagem(div, btn, msg_id){
  btn.disabled=true; btn.textContent="‚è≥ Carregando‚Ä¶";
  try{
    const r = await fetch(`${CONV_API}/api/conversas/image/${encodeURIComponent(msg_id)}`);
    const j = await r.json();
    if(j.ok && j.data_uri){
      const img = document.createElement("img");
      img.src = j.data_uri; img.alt="Imagem"; img.className="thumb mt-2";
      img.onclick = () => abrirModalImagem(j.data_uri);
      div.insertBefore(img, btn); btn.remove();
    }else throw new Error(j.erro||"Resposta inv√°lida");
  }catch{ alert("Erro ao carregar imagem"); btn.disabled=false; btn.textContent="üëÅ Ver imagem"; }
}
async function carregarAudio(div, btn, msg_id){
  btn.disabled=true; btn.textContent="‚è≥ Carregando‚Ä¶";
  try{
    const r = await fetch(`${CONV_API}/api/conversas/audio/${encodeURIComponent(msg_id)}`);
    const j = await r.json();
    if(j.ok && j.data_uri){
      const audio = document.createElement("audio");
      audio.src = j.data_uri; audio.controls = true; audio.className="mt-2 w-full max-w-xs";
      div.insertBefore(audio, btn); btn.remove();
    }else throw new Error(j.erro||"Resposta inv√°lida");
  }catch{ alert("Erro ao carregar √°udio"); btn.disabled=false; btn.textContent="‚ñ∂ Reproduzir √°udio"; }
}

/** üîπ Documento */
async function carregarDocumento(div, btn, msg_id){
  btn.disabled = true; btn.textContent = "‚è≥ Carregando‚Ä¶";
  try{
    const r = await fetch(`${CONV_API}/api/conversas/document/${encodeURIComponent(msg_id)}`);
    const j = await r.json();
    if(!j.ok) throw new Error(j.erro || "Falha no backend");

    const filename = j.filename || "arquivo";
    const mime = j.mime_type || "application/octet-stream";
    const size = j.size_bytes ?? null;

    const box = document.createElement("div");
    box.className = "mt-2 space-y-1";

    if(mime.startsWith("application/pdf") && j.data_uri && (size === null || size <= DOC_PREVIEW_MAX)){
      const preview = document.createElement("embed");
      preview.src = j.data_uri;
      preview.type = mime;
      preview.className = "w-[260px] h-[200px] rounded border";
      box.appendChild(preview);

      const meta = document.createElement("div");
      meta.className = "text-xs text-slate-600";
      const link = `${CONV_API}/api/conversas/document/${encodeURIComponent(msg_id)}/download`;
      meta.innerHTML = `<div class="font-semibold truncate">${escapeHtml(filename)}</div>
                        <div>${size?bytesToHuman(size):""}</div>
                        <a href="${link}" target="_blank" class="text-blue-600 underline">Abrir/baixar</a>`;
      box.appendChild(meta);
    }else{
      const link = `${CONV_API}/api/conversas/document/${encodeURIComponent(msg_id)}/download`;
      const row = document.createElement("div");
      row.className = "flex items-start gap-2";
      row.innerHTML = `
        <div class="text-xl leading-none">üìé</div>
        <div class="min-w-0">
          <div class="font-semibold truncate">${escapeHtml(filename)}</div>
          <div class="text-xs text-slate-600">${escapeHtml(mime)} ${size?("‚Ä¢ "+bytesToHuman(size)):""}</div>
          <a href="${link}" target="_blank" class="text-blue-600 underline break-all">Baixar documento</a>
        </div>`;
      box.appendChild(row);
    }

    div.insertBefore(box, btn);
    btn.remove();
  }catch(e){
    console.error(e);
    alert("Erro ao carregar documento");
    btn.disabled = false; btn.textContent = "üìé Ver documento";
  }
}

function responderMensagem(msgId, conteudo){
  respostaMsgId = msgId || null;
  document.getElementById("respostaTexto").innerText = (conteudo||"").slice(0,50);
  document.getElementById("respostaPreview").classList.remove("hidden");
  textarea.focus();
}
function cancelarResposta(){
  respostaMsgId = null;
  document.getElementById("respostaPreview").classList.add("hidden");
  document.getElementById("respostaTexto").innerText = "";
}

async function enviarMensagem(){
  if(!selecionado) return;
  const texto = textarea.value.trim(); if(!texto) return;
  userTyping = true; btnEnviar.disabled = true;
  try{
    const body = { texto, phone_id: selecionado.phone_id, msg_id: respostaMsgId || null };
    const r = await fetch(`${CONV_API}/api/conversas/${encodeURIComponent(selecionado.remetente)}`, {
      method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)
    });
    const j = await r.json();
    if(j.ok){
      textarea.value=""; textarea.style.height="auto"; cancelarResposta();
      await carregarMensagens(true);
    }else{ alert("Erro ao enviar: "+(j.erro||JSON.stringify(j))); }
  }catch(e){ alert("Erro ao enviar mensagem. Verifique rede/CORS."); }
  finally{ userTyping=false; btnEnviar.disabled = textarea.value.trim().length===0; }
}

async function enviarPDF(event){
  const file = event.target.files[0];
  if(!file) return;
  if(!selecionado) { alert("Abra um ticket antes de enviar PDF."); return; }
  if(file.type!=="application/pdf"){ alert("Somente arquivos PDF s√£o permitidos."); return; }
  try{
    const res = await fetch(`${CONV_API}/api/upload/pdf`, {
      method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({filename:file.name})
    });
    const j = await res.json();
    if(!j.ok){ alert("Erro ao gerar URL: "+j.erro); return; }
    await fetch(j.upload_url, { method:"PUT", headers:{"Content-Type":"application/pdf"}, body:file });

    const send = await fetch(`${CONV_API}/api/conversas/${encodeURIComponent(selecionado.remetente)}`, {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ phone_id: selecionado.phone_id, file_url: j.file_url, original_filename: file.name })
    });
    const sj = await send.json();
    if(sj.ok) await carregarMensagens(true); else alert("Erro ao enviar PDF: "+(sj.erro||JSON.stringify(sj)));
  }catch(e){ alert("Erro ao enviar PDF"); }
  finally{ event.target.value=""; }
}

/** ====== Modal imagem ====== */
const imageModal = document.getElementById("imageModal");
const modalImg = document.getElementById("modalImg");
const closeModal = document.getElementById("closeModal");
function abrirModalImagem(src){ isModalOpen=true; modalImg.src=src; imageModal.classList.remove("hidden"); }
closeModal.onclick = fecharModal; imageModal.onclick = e => { if(e.target===imageModal) fecharModal(); };
function fecharModal(){ imageModal.classList.add("hidden"); modalImg.src=""; isModalOpen=false; }

/** ====== Helpers visuais ====== */
function limparChat(){ chat.innerHTML = '<p id="loading" class="text-center text-gray-500">Pegue uma conversa para iniciar‚Ä¶</p>'; }

/** ====== Init ====== */
document.getElementById("buscaTicket").addEventListener("input", e => filtrarTickets(e.target.value));
boot();

/* NOVO: refresh peri√≥dico do badge de limite/ativos */
setInterval(refreshAtivosELimite, 15000);
</script>
</body>
</html>

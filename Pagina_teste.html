<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ConnectZap ‚Äî Agentes</title>
  <link rel="icon" href="https://joubertcastro.github.io/ConnectZap/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #3b82f6;
      --accent: #22c55e;
      --bg: #f3f4f6;
      --sidebar-bg: #ffffff;
      --content-bg: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --link: #2563eb;
      --ghost-bg: #f3f4f6;
      --ring: rgba(59, 130, 246, .35);
      --bubble-out-g1: #dcf8c6;
      --bubble-out-g2: #b8f0a4;
      --bubble-out-fg: #111827;
      --bubble-in-bg: #fff;
      --bubble-in-border: #e2e8f0;
      --bubble-in-fg: #0f172a;
      --bubble-radius: 18px;
      --btn-radius: 10px;
      --card-radius: 16px;
      --font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --font-size: 14px;
      --chat-wallpaper-opacity: 0;
      --hover: #f1f5f9;
      --hover-strong: #e2e8f0;
      --input-bg: #ffffff;
      --input-fg: var(--text);
      --scrollbar: #cbd5e1;
      --ticket-selected-bg: #f0f9ff;
      --reply-bg: rgba(0, 0, 0, .06);
      --reply-border: rgba(0, 0, 0, .08);
      --reply-fg: #334155;
    }

    * {
      outline-color: var(--ring)
    }

    html {
      font-size: var(--font-size)
    }

    body {
      font-family: var(--font-family);
      color: var(--text);
      background: var(--bg)
    }

    .card {
      background: var(--content-bg);
      border: 1px solid var(--border);
      border-radius: var(--card-radius)
    }

    .btn {
      border-radius: var(--btn-radius);
      transition: transform .06s ease, filter .15s ease, box-shadow .15s ease;
      position: relative;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn[disabled] {
      opacity: .6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff
    }

    .btn-primary:hover {
      filter: brightness(.95)
    }

    .btn-ghost {
      background: var(--ghost-bg)
    }

    .btn-ghost:hover {
      background: var(--hover)
    }

    .btn-neutral {
      background: var(--ghost-bg);
      color: var(--text);
      border: 1px solid var(--border)
    }

    .btn-neutral:hover {
      background: var(--hover)
    }

    .btn-danger {
      background: #dc2626;
      color: #fff;
    }

    .btn-danger:hover {
      filter: brightness(.95);
    }

    .sidebar {
      background: var(--sidebar-bg);
      border-color: var(--border)
    }

    .topbar {
      background: var(--content-bg);
      border-color: var(--border)
    }

    .ticket-selected {
      background: var(--ticket-selected-bg) !important
    }

    .badge {
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      border-radius: 9999px;
      padding: 2px 6px;
      min-width: 18px;
      text-align: center
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 9999px;
      display: inline-block;
      margin-right: 6px
    }

    .dot.online {
      background: #16a34a
    }

    .dot.offline {
      background: #9ca3af
    }

    .msg {
      display: inline-block;
      max-width: min(70%, 560px);
      padding: 10px 14px 18px;
      margin: 6px 0;
      position: relative;
      border-radius: var(--bubble-radius);
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .10);
      transition: background .18s ease, border-color .18s ease, color .18s ease
    }

    @media (max-width:768px) {
      .msg {
        max-width: 86%
      }
    }

    .msg.enviada {
      align-self: flex-end;
      background: linear-gradient(120deg, var(--bubble-out-g1), var(--bubble-out-g2));
      color: var(--bubble-out-fg)
    }

    .msg.recebida {
      align-self: flex-start;
      background: var(--bubble-in-bg);
      border: 1px solid var(--bubble-in-border);
      color: var(--bubble-in-fg)
    }

    .msg .hora {
      position: absolute;
      right: 8px;
      bottom: 4px;
      font-size: 11px;
      color: var(--muted)
    }

    .msg.enviada::after,
    .msg.recebida::after {
      content: "";
      position: absolute;
      bottom: 0;
      width: 14px;
      height: 14px;
      clip-path: polygon(0 0, 100% 0, 0 100%)
    }

    .msg.enviada::after {
      right: -7px;
      background: linear-gradient(120deg, var(--bubble-out-g1), var(--bubble-out-g2))
    }

    .msg.recebida::after {
      left: -7px;
      background: var(--bubble-in-bg);
      border-left: 1px solid var(--bubble-in-border);
      border-bottom: 1px solid var(--bubble-in-border)
    }

    .msg img.thumb {
      max-width: 280px;
      height: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor: pointer
    }

    .msg audio {
      width: 320px;
      display: block
    }

    .dia {
      text-align: center;
      margin: 12px 0;
      font-size: 12px;
      color: var(--muted)
    }

    .reply-btn {
      position: absolute;
      top: 4px;
      right: 6px;
      width: 22px;
      height: 22px;
      border-radius: 9999px;
      display: grid;
      place-items: center;
      background: var(--reply-bg);
      color: var(--reply-fg);
      border: 1px solid var(--reply-border);
      opacity: 0;
      transition: opacity .15s, transform .06s;
      font-size: 12px;
      line-height: 1;
      cursor: pointer
    }

    .msg:hover .reply-btn {
      opacity: 1
    }

    .reply-btn:active {
      transform: scale(.96)
    }

    .reply-btn svg {
      width: 14px;
      height: 14px
    }

    textarea {
      background: var(--input-bg);
      color: var(--input-fg);
      border-color: var(--border) !important
    }

    textarea::placeholder {
      color: color-mix(in srgb, var(--muted) 85%, var(--bg))
    }

    input[type="text"],
    input[type="search"],
    input[type="color"],
    input[type="file"],
    input[type="date"],
    select {
      background: var(--input-bg);
      color: var(--input-fg);
      border-color: var(--border) !important
    }

    *::-webkit-scrollbar {
      width: 10px;
      height: 10px
    }

    *::-webkit-scrollbar-thumb {
      background: var(--scrollbar);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box
    }

    *::-webkit-scrollbar-track {
      background: transparent
    }

    .mini-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 56px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 10px 6px;
      background: #0b1220;
      color: #e5e7eb;
      z-index: 70;
      border-right: 1px solid #111827
    }

    .mini-sidebar .btn-mini {
      width: 44px;
      height: 44px;
      display: grid;
      place-items: center;
      border-radius: 12px;
      background: transparent;
      transition: background .2s, transform .06s;
      cursor: pointer
    }

    .mini-sidebar .btn-mini:hover {
      background: #111827
    }

    .mini-sidebar .btn-mini.active {
      background: #2563eb;
      color: #fff
    }

    .mini-sidebar .btn-mini.locked {
      opacity: .55;
      position: relative;
    }

    .mini-sidebar .btn-mini.locked::after {
      content: 'üîí';
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 10px;
      opacity: .9;
    }

    .with-mini {
      margin-left: 56px
    }

    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: min(430px, 96%);
      height: 100%;
      background: var(--content-bg);
      border-left: 1px solid var(--border);
      box-shadow: -12px 0 24px rgba(0, 0, 0, .08);
      transform: translateX(100%);
      transition: transform .25s ease;
      z-index: 60
    }

    .drawer.open {
      transform: translateX(0)
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      align-items: center;
      justify-content: center
    }

    .modal-inner {
      background: var(--content-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: min(420px, 94%);
      box-shadow: 0 10px 30px rgba(0, 0, 0, .14)
    }

    .bar-soft {
      background: var(--ghost-bg)
    }

    .ticket-item:hover {
      background: var(--hover)
    }

    .pill {
      border: 1px solid var(--border);
      background: var(--ghost-bg);
      padding: 4px 8px;
      border-radius: 9999px;
      font-size: 12px
    }

    .section-title {
      color: var(--text)
    }

    .muted {
      color: var(--muted)
    }

    .extrato {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .extrato-item+.extrato-item {
      border-top: 1px solid var(--border)
    }

    .extrato-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: transparent;
      color: var(--text);
      transition: background .15s ease;
      text-align: left
    }

    .extrato-header:hover {
      background: var(--hover)
    }

    .extrato-meta {
      font-size: 12px;
      color: var(--muted)
    }

    .extrato-chevron {
      color: var(--muted)
    }

    .extrato-content {
      padding: 0 12px 12px 12px
    }

    .table-soft {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden
    }

    .table-soft th,
    .table-soft td {
      border: 1px solid var(--border);
      padding: 8px
    }

    .table-soft thead tr {
      background: var(--ghost-bg);
      color: var(--muted)
    }

    .table-soft tbody tr:hover {
      background: color-mix(in srgb, var(--ghost-bg) 60%, transparent)
    }

    .chart-sm {
      height: 160px !important;
      max-height: 160px;
    }

    .notice {
      border: 1px solid var(--border);
      background: var(--content-bg);
      border-radius: 14px;
      padding: 12px;
      transition: background .15s ease, border-color .15s ease, box-shadow .15s ease, color .15s ease;
      color: var(--text);
    }

    .notice.unread {
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary) 25%, transparent);
    }

    .notice-head {
      display: flex;
      align-items: start;
      justify-content: space-between;
      gap: 8px;
    }

    .notice-left {
      display: flex;
      gap: 10px;
      align-items: start;
    }

    .sev {
      width: 10px;
      height: 100%;
      min-height: 36px;
      border-radius: 6px;
      margin-top: 2px;
    }

    .sev-success {
      background: #3b82f6;
    }

    .sev-info {
      background: #16a34a;
    }

    .sev-warn {
      background: #d97706;
    }

    .sev-crit {
      background: #dc2626;
    }

    .notice-title {
      font-weight: 600;
      line-height: 1.2;
      color: var(--text);
    }

    .notice-meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .notice-tags .tag {
      font-size: 11px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--ghost-bg) 85%, transparent);
      border-radius: 9999px;
      padding: 2px 8px;
      color: var(--text);
    }

    .notice-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .notice-actions button {
      font-size: 12px;
      border: 1px solid var(--border);
      padding: 4px 8px;
      border-radius: 8px;
      background: var(--ghost-bg);
      color: var(--text);
    }

    .notice-actions button:hover {
      background: var(--hover);
    }

    .notice-body {
      margin-top: 8px;
      color: var(--text);
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .notice.crit {
      border-left: 8px solid #dc2626 !important;
      background: color-mix(in srgb, #dc2626 12%, var(--content-bg));
    }

    .crit-badge {
      display: inline-block;
      margin-left: 8px;
      padding: 2px 6px;
      font-size: 10px;
      line-height: 1;
      font-weight: 800;
      border-radius: 9999px;
      background: #dc2626;
      color: #fff;
      vertical-align: middle;
    }

    .hero {
      border: 1px solid var(--border);
      border-left: 6px solid #dc2626;
      background: color-mix(in srgb, #dc2626 6%, var(--content-bg));
      border-radius: 14px;
      padding: 12px;
    }

    .hero .title {
      font-weight: 700;
    }

    .hero .meta {
      font-size: 12px;
      color: var(--muted);
    }

    .hero .close {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px 8px;
      background: var(--ghost-bg);
      font-size: 12px;
      color: var(--text);
    }

    .hero .close:hover {
      background: var(--hover);
    }

    .filter-btn.active {
      outline: 2px solid var(--primary);
      outline-offset: -2px;
      background: color-mix(in srgb, var(--primary) 10%, var(--ghost-bg));
      color: var(--text);
    }

    /* ======= ENVIO INDIVIDUAL (CSS extra) ======= */
    .label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .input {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: var(--input-bg);
      color: var(--input-fg);
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }

    .input:focus {
      box-shadow: 0 0 0 3px var(--ring);
      border-color: color-mix(in srgb, var(--primary) 55%, var(--border));
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
    }

    .codeblock {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: color-mix(in srgb, var(--ghost-bg) 70%, var(--content-bg));
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: var(--text);
      overflow: auto;
    }

    .alert {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: var(--content-bg);
    }

    .alert-warn {
      border-left: 6px solid #d97706;
      background: color-mix(in srgb, #d97706 10%, var(--content-bg));
    }

    .btn-sm {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .btn-loading::after {
      content: "";
      position: absolute;
      right: 10px;
      top: 50%;
      width: 14px;
      height: 14px;
      margin-top: -7px;
      border-radius: 9999px;
      border: 2px solid rgba(255, 255, 255, .55);
      border-top-color: rgba(255, 255, 255, 1);
      animation: spin .8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .pill-state {
      border: 1px solid var(--border);
      border-radius: 9999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 800;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      user-select: none;
      white-space: nowrap;
    }

    .pill-success {
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
      background: color-mix(in srgb, var(--accent) 16%, var(--ghost-bg));
      color: color-mix(in srgb, #065f46 90%, var(--text));
    }

    .pill-fail {
      border-color: color-mix(in srgb, #dc2626 55%, var(--border));
      background: color-mix(in srgb, #dc2626 14%, var(--ghost-bg));
      color: color-mix(in srgb, #7f1d1d 90%, var(--text));
    }

    .pill-neutral {
      border-color: color-mix(in srgb, var(--primary) 45%, var(--border));
      background: color-mix(in srgb, var(--primary) 12%, var(--ghost-bg));
      color: color-mix(in srgb, #1e3a8a 90%, var(--text));
    }

    .result-meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .result-meta code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      padding: 1px 6px;
      border: 1px solid var(--border);
      border-radius: 9999px;
      background: color-mix(in srgb, var(--ghost-bg) 70%, var(--content-bg));
      color: var(--text);
    }

    /* Theme presets */
    .preset {
      cursor: pointer;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--ghost-bg) 85%, var(--content-bg));
      border-radius: 14px;
      padding: 10px;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      user-select: none;
    }

    .preset:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, .08);
      border-color: color-mix(in srgb, var(--primary) 40%, var(--border));
    }

    .preset.active {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
  </style>
</head>

<body class="h-screen flex with-mini">

  <!-- Mini Sidebar -->
  <nav id="appSidebar" class="mini-sidebar select-none hidden">
    <button id="tabBtnHome" class="btn-mini active transition-transform active:scale-95" title="Home" aria-label="Home"
      aria-current="page">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M3 10.5L12 3l9 7.5" />
        <path d="M5 10.5V21h6v-5h2v5h6V10.5" />
      </svg>
      <span class="sr-only">Home</span>
    </button>

    <button id="tabBtnConversas" class="btn-mini transition-transform active:scale-95" title="Conversas"
      aria-label="Conversas" data-requires-login>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="3" y="5" width="18" height="12" rx="4" ry="4" />
        <path d="M7 17v4l4-4" />
        <circle cx="9" cy="11" r="1.2" fill="currentColor" stroke="none" />
        <circle cx="12" cy="11" r="1.2" fill="currentColor" stroke="none" />
        <circle cx="15" cy="11" r="1.2" fill="currentColor" stroke="none" />
      </svg>
      <span class="sr-only">Conversas</span>
    </button>

    <button id="tabBtnEnvioIndividual" class="btn-mini hidden transition-transform active:scale-95"
      title="Envio individual" aria-label="Envio individual">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
        stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5" aria-hidden="true">
        <path d="M22 2 11 13" />
        <path d="m22 2-7 20-4-9-9-4Z" />
      </svg>
      <span class="sr-only">Envio individual</span>
    </button>

    <button id="tabBtnRelatorio" class="btn-mini transition-transform active:scale-95" title="Relat√≥rio"
      aria-label="Relat√≥rio" data-requires-login>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M4 19.5h16" />
        <path d="M7 19.5V10" />
        <path d="M12 19.5V5" />
        <path d="M17 19.5v-8" />
      </svg>
      <span class="sr-only">Relat√≥rio</span>
    </button>
  </nav>

  <!-- Tabs Wrapper -->
  <div id="tabsWrapper" class="flex-1 flex flex-col hidden">

    <!-- HOME -->
    <section id="tabHome" class="flex-1 p-6">
      <div class="max-w-4xl mx-auto">
        <div class="card p-6">
          <h1 class="text-2xl font-bold">Bem-vindo(a) üëã</h1>
          <p class="muted mt-2">Ol√° <span id="homeAgenteNome" class="font-semibold">‚Äî</span>!</p>
          <p class="muted">Carteira: <span id="homeAgenteCarteira" class="font-semibold">‚Äî</span></p>

          <div id="homeAvisoHero" class="mt-4 hidden">
            <div class="hero flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="title" id="heroTitle">‚Äî</div>
                <div class="meta mt-1" id="heroMeta">‚Äî</div>
                <div class="mt-2 text-sm" id="heroBody">‚Äî</div>
              </div>
              <div class="flex items-start gap-2 shrink-0">
                <button id="heroMarkRead" class="close">Marcar como lido</button>
                <button id="heroDismiss" class="close">Dispensar</button>
              </div>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="p-4 border rounded-lg" style="border-color:var(--border)">
              <div class="text-sm muted mb-1">Status</div>
              <div id="homeStatus" class="font-medium"><span class="dot offline"></span>Offline</div>
              <div class="mt-3 flex flex-wrap gap-2">
                <button id="btnToggleOnline"
                  class="btn px-3 py-2 text-white disabled:opacity-50 flex items-center gap-2 bg-green-600 hover:bg-green-700"
                  disabled aria-live="polite" aria-pressed="false">
                  <svg id="toggleSpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" aria-hidden="true">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
                      fill="none"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                  </svg>
                  <span id="toggleLabel">Ficar online</span>
                </button>
                <button id="btnLogout" class="btn btn-primary px-3 py-2">Login</button>
              </div>

              <div class="mt-3">
                <div class="text-sm muted mb-1">Pendentes na sua fila</div>
                <div class="flex items-center gap-2">
                  <span id="homePendentesBadge" class="badge" style="background:#64748b">‚Äî</span>
                  <span class="text-xs muted">atualiza a cada 60s</span>
                </div>
              </div>

              <div id="homeAviso" class="mt-2 text-xs text-amber-600 hidden" role="alert" aria-live="polite"></div>
            </div>

            <div class="p-4 border rounded-lg" style="border-color:var(--border)">
              <div class="flex items-center justify-between">
                <div class="text-sm muted mb-1">Atalhos</div>
              </div>
              <div class="flex flex-wrap gap-2 mt-1">
                <button id="goToConversas1" class="btn btn-primary px-4 py-2">Ir para Conversas</button>
                <button id="goToRelatorio1" class="btn btn-neutral px-4 py-2">Ver Relat√≥rio</button>
              </div>
            </div>
          </div>

          <div class="mt-6">
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2">
                <h2 class="text-lg font-semibold">üì¢ Painel de Avisos</h2>
                <span id="avisosCountPill" class="pill">‚Äî</span>
              </div>
              <div class="flex items-center gap-2">
                <button class="btn btn-neutral px-2 py-1 text-xs filter-btn active"
                  data-avisos-filter="all">Todos</button>
                <button class="btn btn-neutral px-2 py-1 text-xs filter-btn" data-avisos-filter="unread"
                  style="display:none">N√£o lidos</button>
                <button id="btnAvisoRefresh" class="btn btn-primary px-3 py-2 text-sm">Atualizar</button>
              </div>
            </div>
            <div id="avisosResumo" class="text-sm muted mt-1">‚Äî</div>
            <div id="avisosWrap" class="mt-3 space-y-2"></div>
          </div>

        </div>
      </div>
    </section>

    <!-- CONVERSAS -->
    <section id="tabConversas" class="hidden h-full flex">
      <aside class="sidebar w-1/3 lg:w-1/4 border-r flex flex-col">
        <div class="p-3 border-b topbar">
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0">
              <div class="text-xs muted">Agente</div>
              <div id="agenteNome" class="font-semibold truncate">‚Äî</div>
              <div class="text-xs muted">Carteira: <span id="agenteCarteira">‚Äî</span></div>
              <div class="text-xs muted">Status: <span id="agenteStatus"><span class="dot offline"></span>Offline</span>
              </div>
              <div class="mt-1 text-xs">
                <span class="muted">Tickets:</span>
                <span id="badgeAtivos" class="badge">0</span>
                <span class="muted mx-1">/</span>
                <span id="badgeLimite" class="badge" style="background:#64748b">‚àû</span>
              </div>
            </div>
            <div class="flex flex-col items-end gap-2">
              <button id="btnPegarProxima"
                class="btn btn-primary px-3 py-2 text-sm text-white disabled:opacity-50 flex items-center gap-2"
                disabled>
                <svg id="pegarSpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" aria-hidden="true">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none">
                  </circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a 8 8 0 018-8v 4a 4 4 0 00-4 4H4z"></path>
                </svg>
                <span id="pegarLabel">Pegar pr√≥xima</span>
              </button>
              <button id="btnPrioridade" class="btn px-3 py-2 text-sm rounded-md text-white disabled:opacity-50"
                disabled style="background: rebeccapurple">Pedir prioridade</button>
              <button id="btnTheme" class="mt-2 btn btn-ghost px-3 py-1 text-xs" aria-haspopup="true"
                aria-controls="themeDrawer">üé® Tema</button>
            </div>
          </div>
          <div id="msgAviso" class="mt-2 text-xs text-amber-600 hidden" role="alert" aria-live="polite"></div>
          <div id="msgLimite" class="mt-1 text-xs text-red-600 hidden" role="alert" aria-live="polite"></div>
        </div>

        <ul id="listaTickets" class="flex-1 overflow-y-auto" aria-label="Minhas conversas"></ul>

        <div class="p-2 text-xs muted border-t topbar">
          Apenas conversas da sua carteira. ‚ÄúPegar pr√≥xima‚Äù usa ordem por √∫ltima mensagem <em>recebida</em>.
        </div>
      </aside>

      <main class="flex-1 flex flex-col">
        <div class="flex items-center justify-between p-3 border-b topbar">
          <div class="min-w-0">
            <div id="tituloConversa" class="font-bold text-lg truncate">Selecione um ticket</div>
            <div id="subInfo" class="text-sm muted truncate"></div>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnLiberar" class="btn btn-neutral px-3 py-2 text-sm disabled:opacity-50"
              disabled>Liberar</button>
            <div class="relative">
              <button id="btnConcluir" class="btn px-3 py-2 text-sm text-white disabled:opacity-50"
                style="background:var(--accent)" disabled aria-haspopup="true" aria-expanded="false">Concluir</button>
              <div id="menuConcluir" class="hidden absolute right-0 mt-2 w-64 border rounded-lg shadow-lg z-20"
                style="background: var(--content-bg); border-color: var(--border)"></div>
            </div>
          </div>
        </div>

        <div class="relative flex-1 overflow-hidden">
          <div id="chat" class="relative h-full p-4 overflow-y-auto flex flex-col space-y-1" role="log"
            aria-live="polite">
            <p id="loading" class="text-center muted">Pegue uma conversa para iniciar‚Ä¶</p>
          </div>
        </div>

        <div id="digitando" class="px-4 text-left hidden text-sm muted" aria-live="polite">Digitando‚Ä¶</div>

        <div id="respostaPreview" class="hidden px-3 py-2 border-t bar-soft text-sm flex justify-between items-center"
          style="border-color:var(--border)">
          <div class="truncate max-w-[80%]">
            <span class="font-semibold">Respondendo:</span> <span id="respostaTexto" class="muted"></span>
          </div>
          <button onclick="cancelarResposta()" class="text-red-500 text-xs" aria-label="Cancelar resposta">‚úñ</button>
        </div>

        <div class="p-3 border-t topbar flex space-x-2 items-center">
          <input type="file" id="fileInput" accept="application/pdf" class="hidden" onchange="enviarPDF(event)">
          <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary px-3 py-2">üìù PDF</button>
          <textarea id="textoMensagem" rows="1" class="flex-1 border rounded-md p-2 resize-none"
            style="border-color:var(--border)" placeholder="Digite uma mensagem‚Ä¶" disabled></textarea>
          <button id="btnEnviar" class="btn px-4 py-2 text-white disabled:opacity-50" style="background:var(--accent)"
            disabled>Enviar</button>
        </div>
      </main>

      <!-- Modal imagem -->
      <div id="imageModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50"
        aria-modal="true" role="dialog">
        <span id="closeModal" class="absolute top-4 right-6 text-white text-3xl cursor-pointer"
          aria-label="Fechar imagem">&times;</span>
        <img id="modalImg" src="" alt="Imagem" class="max-h-[90%] max-w-[90%] rounded-lg shadow-lg">
      </div>

      <!-- Modal prioridade -->
      <div id="priorityModal" class="hidden fixed inset-0 z-50" aria-modal="true" role="dialog">
        <div class="absolute inset-0 bg-black/60" onclick="fecharPriorityModal()" aria-hidden="true"></div>
        <div class="relative mx-auto mt-24 w-[95%] max-w-md rounded-xl shadow-xl border"
          style="background: var(--content-bg); border-color: var(--border)">
          <div class="p-4 border-b flex items-center justify-between" style="border-color:var(--border)">
            <h3 class="font-semibold">Pedir prioridade</h3>
            <button class="muted" onclick="fecharPriorityModal()" aria-label="Fechar">‚úñ</button>
          </div>
          <div class="p-4 space-y-3">
            <label class="block text-sm muted">Telefone do cliente</label>
            <input id="priorityTelefone" class="w-full p-2 border rounded-md"
              placeholder="Ex: 61999999999 ou 5561999999999" autocomplete="off" inputmode="numeric" pattern="[0-9]*" />
            <p class="text-xs muted">Aten√ß√£o: informe um telefone v√°lido DDD + 8/9 d√≠gitos.</p>
            <div id="priorityInfo" class="text-sm" style="color:var(--text)"></div>
            <div id="priorityErro" class="text-sm text-red-600 hidden" role="alert" aria-live="polite"></div>
          </div>
          <div class="p-4 border-t flex items-center justify-end gap-2" style="border-color:var(--border)">
            <button class="btn btn-neutral px-3 py-2 text-sm" onclick="fecharPriorityModal()">Cancelar</button>
            <button id="btnPriorityBuscar"
              class="px-3 py-2 text-sm text-white rounded-md hover:bg-purple-700 flex items-center gap-2"
              style="background: rebeccapurple">
              <svg id="prioritySpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" aria-hidden="true">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none">
                </circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a 8 8 0 018-8v4a 4 4 0 00-4 4H4z"></path>
              </svg>
              <span id="priorityBtnLabel">Buscar e solicitar</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Theme Drawer -->
      <div id="themeDrawer" class="drawer" aria-hidden="true">
        <div class="h-full flex flex-col">
          <div class="p-4 border-b flex items-center justify-between" style="border-color:var(--border)">
            <h3 class="font-semibold">üé® Seu tema</h3>
            <div class="flex items-center gap-2">
              <button id="btnThemeExport" class="btn btn-ghost px-2 py-1 text-xs">Salvar no meu computador</button>
              <label class="btn btn-ghost px-2 py-1 text-xs cursor-pointer">Importar um tema salvo <input id="importTheme"
                  type="file" accept="application/json" class="hidden"></label>
              <button id="btnThemeClose" class="btn btn-ghost px-2 py-1 text-xs" aria-label="Fechar">‚úñ</button>
            </div>
          </div>

          <div class="p-4 overflow-y-auto space-y-6">
            <section>
              <div class="text-xs muted mb-2">Temas r√°pidos</div>
              <div class="grid grid-cols-2 gap-2">
                <div class="preset" data-preset="corporate">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#0ea5e9,#2563eb)"></div>
                  <div class="mt-1 text-xs">Corporate</div>
                </div>
                <div class="preset" data-preset="ocean">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#06b6d4,#10b981)"></div>
                  <div class="mt-1 text-xs">Ocean</div>
                </div>
                <div class="preset" data-preset="sunset">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#fb923c,#ef4444)"></div>
                  <div class="mt-1 text-xs">Sunset</div>
                </div>
                <div class="preset" data-preset="dark">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#0b1220,#374151)"></div>
                  <div class="mt-1 text-xs">Dark</div>
                </div>
                <div class="preset" data-preset="minimal">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#f8fafc,#e2e8f0)"></div>
                  <div class="mt-1 text-xs">Minimal</div>
                </div>
                <div class="preset" data-preset="funky">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#a78bfa,#ec4899)"></div>
                  <div class="mt-1 text-xs">Funky</div>
                </div>
              </div>
            </section>

            <hr style="border-color:var(--border)">

            <section>
              <div class="text-xs muted mb-2">Personalizar</div>

              <div class="grid grid-cols-2 gap-3">
                <label class="block"><span class="text-xs muted">Bot√£o PDF</span><input id="tPrimary" type="color"
                    class="w-full h-10 border rounded" value="#3b82f6"></label>
                <label class="block"><span class="text-xs muted">Bot√£o Concluir</span><input id="tAccent" type="color"
                    class="w-full h-10 border rounded" value="#22c55e"></label>
                <label class="block"><span class="text-xs muted">Barra lateral</span><input id="tSidebar" type="color"
                    class="w-full h-10 border rounded" value="#ffffff"></label>
                <label class="block"><span class="text-xs muted">Cabe√ßalho</span><input id="tContentBg" type="color"
                    class="w-full h-10 border rounded" value="#ffffff"></label>
                <label class="block"><span class="text-xs muted">Cor de fundo</span><input id="tBg" type="color"
                    class="w-full h-10 border rounded" value="#f3f4f6"></label>
                <label class="block"><span class="text-xs muted">Texto</span><input id="tText" type="color"
                    class="w-full h-10 border rounded" value="#0f172a"></label>
              </div>

              <div class="grid grid-cols-2 gap-3 mt-3">
                <label class="block"><span class="text-xs muted">Minha mensagem cor 1</span><input id="tOutG1"
                    type="color" class="w-full h-10 border rounded" value="#dcf8c6"></label>
                <label class="block"><span class="text-xs muted">Minha mensagem cor 2</span><input id="tOutG2"
                    type="color" class="w-full h-10 border rounded" value="#b8f0a4"></label>
                <label class="block"><span class="text-xs muted">Cliente mensagem cor</span><input id="tInBg" type="color"
                    class="w-full h-10 border rounded" value="#ffffff"></label>
                <label class="block"><span class="text-xs muted">Cliente mensagem bordas</span><input id="tInBorder"
                    type="color" class="w-full h-10 border rounded" value="#e2e8f0"></label>
                <label class="block"><span class="text-xs muted">Canto arredondado dos bal√µes</span><input id="tRadius"
                    type="range" min="8" max="28" value="18" class="w-full"></label>
              </div>

              <div class="grid grid-cols-1 gap-3 mt-3">
                <label class="block"><span class="text-xs muted">Opacidade do fundo</span><input id="tBgOp" type="range"
                    min="0" max="1" step="0.05" value="0"></label>
              </div>

              <div class="grid grid-cols-2 gap-3 mt-3">
                <label class="block"><span class="text-xs muted">Tamanho base</span>
                  <select id="tFontSize" class="w-full p-2 border rounded">
                    <option value="13px">13px</option>
                    <option value="14px" selected>14px</option>
                    <option value="15px">15px</option>
                    <option value="16px">16px</option>
                  </select>
                </label>
                <label class="block"><span class="text-xs muted">Canto arredondado dos bot√µes</span><input id="tBtnRadius"
                    type="range" min="6" max="16" value="10" class="w-full"></label>
                <label class="block"><span class="text-xs muted">Canto arredondado dos cards de aviso</span><input
                    id="tCardRadius" type="range" min="10" max="24" value="16" class="w-full"></label>
              </div>

              <div class="flex items-center justify-between mt-4">
                <div class="flex items-center gap-2">
                  <button id="btnRandom" class="btn btn-ghost px-3 py-2">üé≤ Surpreenda-me</button>
                  <button id="btnReset" class="btn btn-ghost px-3 py-2">‚Ü∫ Voltar ao padr√£o</button>
                </div>
                <button id="btnSaveTheme" class="btn btn-primary px-4 py-2">Salvar</button>
              </div>
            </section>
          </div>
        </div>
      </div>
    </section>

    <!-- ENVIO INDIVIDUAL -->
    <section id="tabEnvioIndividual" class="hidden flex-1 p-6">
      <div class="max-w-6xl mx-auto space-y-4">
        <div class="card p-6">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="text-xl font-bold">Envio individual</h2>
              <p class="muted mt-1">Envio r√°pido de template fixo <span class="font-semibold">ligacao_caiu</span></p>
            </div>
          </div>

          <div class="mt-4">
            <div class="card p-4">
              <div class="flex items-center justify-between gap-2">
                <h3 class="font-semibold">Dados do cliente</h3>
              </div>

              <!-- Phone ID (obrigat√≥rio) - escondido -->
              <input id="envIndPhoneId" type="hidden" />

              <!-- (opcional) debug interno -->
              <div class="hidden">
                Phone ID: <span id="envIndPhoneIdLabel">‚Äî</span> <span id="envIndPhoneIdHint"></span>
              </div>

              <div class="mt-3 grid md:grid-cols-2 gap-3">
                <div class="md:col-span-2">
                  <label class="label">Buscar cadastro</label>

                  <div class="grid md:grid-cols-3 gap-2">
                    <div>
                      <label class="label text-xs muted">Base</label>
                      <select id="envIndBase" class="input">
                        <option value="bd5">BD5</option>
                        <option value="bd4">BD4</option>
                        <option value="bd7">BD7</option>
                        <option value="bd8">BD8</option>
                      </select>
                      <p id="envIndBaseHint" class="mt-1 text-xs text-slate-500 hidden">Definida pelo seu perfil.</p>
                    </div>

                    <div class="md:col-span-2">
                      <label class="label text-xs muted">C√≥digo do cliente</label>
                      <div class="flex flex-wrap gap-2">
                        <input id="envIndCodigo" class="input flex-1" placeholder="Ex: 123456" />
                        <button id="btnEnvIndBuscar" class="btn btn-ghost px-4 py-2" type="button">Buscar</button>
                      </div>
                      <p class="hint mt-1">Pesquise o cadastro usando o codigo interno e selecione o telefone que deseja
                        usar.</p>
                    </div>
                  </div>

                  <div id="envIndBuscaBox" class="mt-3 hidden">
                    <div id="envIndBuscaMsg" class="text-sm muted">‚Äî</div>

                    <div id="envIndResultadosWrap" class="mt-3 hidden">
                      <div class="flex items-center flex-wrap gap-2">
                        <span class="text-sm muted">Selecionado:</span>
                        <span id="envIndTelefoneEscolhido" class="pill-state pill-neutral">Nenhum</span>
                        <span id="envIndNomeEscolhido" class="text-sm muted"></span>
                      </div>

                      <div class="mt-2 overflow-x-auto">
                        <table class="table-soft">
                          <thead>
                            <tr>
                              <th class="w-40">Telefone</th>
                              <th>Nome</th>
                              <th class="w-28 text-right">A√ß√£o</th>
                            </tr>
                          </thead>
                          <tbody id="envIndResultados"></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="md:col-span-2">
                  <div class="alert"
                    style="border-left:6px solid var(--primary);background:color-mix(in srgb, var(--primary) 8%, var(--content-bg));">
                    <div class="text-sm font-semibold">Pr√©via do que ser√° enviado</div>
                    <div class="text-sm mt-1" id="envIndPreview">
                      Ol√°, <span class="font-semibold">cliente</span>! Perdemos a sua liga√ß√£o. Se estiver dispon√≠vel,
                      responda aqui para continuar.
                    </div>
                  </div>
                </div>

                <div class="md:col-span-2 flex flex-wrap gap-2 pt-1">
                  <button id="btnEnvIndEnviar" class="btn btn-primary px-4 py-2" type="button">Enviar mensagem</button>
                  <button id="btnEnvIndLimpar" class="btn btn-ghost px-4 py-2" type="button">Limpar</button>
                </div>

                <div class="md:col-span-2">
                  <div id="envIndStatusWrap" class="hidden mt-2">
                    <div class="flex items-center gap-2">
                      <span class="text-sm muted">Status:</span>
                      <span id="envIndStatusPill" class="pill-state pill-neutral">‚Äî</span>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <div id="envIndSemPermissao" class="hidden mt-4 alert alert-warn">
            <div class="font-semibold">Sem permiss√£o</div>
            <div class="muted">Seu usu√°rio n√£o possui <code>permite_envio_individual</code> habilitado.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RELAT√ìRIO -->
    <section id="tabRelatorio" class="hidden p-4">
      <div class="max-w-6xl mx-auto space-y-4">
        <div class="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
          <div>
            <h2 class="text-xl font-semibold section-title">Relat√≥rio Individual</h2>
            <div class="text-sm muted" id="relatorioPeriodo">Hoje</div>
          </div>

          <div class="flex flex-wrap gap-2 items-end">
            <div class="flex flex-col">
              <label class="text-xs muted">In√≠cio</label>
              <input id="relStart" type="date" class="border rounded px-2 py-1" />
            </div>
            <div class="flex flex-col">
              <label class="text-xs muted">Fim</label>
              <input id="relEnd" type="date" class="border rounded px-2 py-1" />
            </div>

            <div class="flex gap-1">
              <button class="btn btn-neutral px-2 py-1 text-xs" data-qk="hoje">Hoje</button>
              <button class="btn btn-neutral px-2 py-1 text-xs" data-qk="ontem">Ontem</button>
              <button class="btn btn-neutral px-2 py-1 text-xs" data-qk="7d">7d</button>
              <button class="btn btn-neutral px-2 py-1 text-xs" data-qk="30d">30d</button>
            </div>

            <div id="relAgenteLock" class="pill select-none" title="Agente aplicado ao filtro">
              Agente: <span id="relAgentePill">‚Äî</span>
            </div>

            <button id="btnRefreshRel" class="btn btn-primary px-3 py-2 text-sm">Atualizar</button>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="card p-4">
            <div class="text-xs muted">Em atendimento</div>
            <div id="kpiEm" class="text-2xl font-bold">0</div>
          </div>
          <div class="card p-4">
            <div class="text-xs muted">Conclu√≠dos</div>
            <div id="kpiConc" class="text-2xl font-bold">0</div>
          </div>
          <div class="card p-4">
            <div class="text-xs muted">TMA</div>
            <div class="text-2xl font-bold"><span id="kpiTma">‚Äî</span><span class="text-sm muted"> min</span></div>
          </div>
          <div class="card p-4">
            <div class="text-xs muted">1¬™ resposta</div>
            <div class="text-2xl font-bold"><span id="kpiFRT">‚Äî</span><span class="text-sm muted"> seg</span></div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 items-start">
          <div class="card p-4 lg:col-span-2">
            <div class="flex items-center justify-between">
              <div class="font-semibold">Extrato de motivos (por dia)</div>
              <button id="btnExtratoRefresh" class="btn btn-neutral px-3 py-1 text-xs">Atualizar extrato</button>
            </div>
            <div id="extratoWrap" class="mt-3 extrato"></div>
          </div>

          <div class="space-y-3">
            <div class="card p-4">
              <div class="font-semibold">Distribui√ß√£o por status</div>
              <div class="mt-3"><canvas id="pieStatus" class="chart-sm"></canvas></div>
            </div>

            <div class="card p-4">
              <div class="font-semibold">Motivos de conclus√£o</div>
              <div class="mt-3"><canvas id="pieMotivos" class="chart-sm"></canvas></div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- MODAL DE LOGIN -->
  <div id="modalLogin" class="modal">
    <div class="modal-inner">
      <div class="p-4 border-b flex items-center justify-between" style="border-color:var(--border)">
        <h3 class="font-semibold">Identifique-se</h3>
        <button class="btn btn-ghost px-2 py-1 text-xs" onclick="fecharModalLogin()" aria-label="Fechar">‚úñ</button>
      </div>
      <div class="p-4 space-y-3">
        <label class="block text-sm muted">Informe seu c√≥digo de agente</label>
        <input id="loginCodigoAgente" inputmode="numeric" pattern="[0-9]*" class="w-full p-2 border rounded-md"
          placeholder="Ex: 101" />
        <p class="text-xs muted">Seja bem-vindo(a) ao ConnectZap.</p>
        <div id="loginErro" class="text-sm text-red-600 hidden" role="alert" aria-live="polite"></div>
      </div>
      <div class="p-4 border-t flex items-center justify-end gap-2" style="border-color:var(--border)">
        <button class="btn btn-neutral px-3 py-2 text-sm" onclick="fecharModalLogin()">Cancelar</button>
        <button id="btnDoLogin" class="px-3 py-2 text-sm text-white rounded-md"
          style="background:var(--primary)">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- MODAL DE FEEDBACK CURTO -->
  <div id="modalFeedback" class="modal" aria-live="polite" aria-modal="true" role="dialog">
    <div class="modal-inner">
      <div class="p-4 border-b flex items-center justify-between" style="border-color:var(--border)">
        <h3 id="feedbackTitle" class="font-semibold">Aviso</h3>
        <button class="btn btn-ghost px-2 py-1 text-xs" onclick="fecharModalFeedback()" aria-label="Fechar">‚úñ</button>
      </div>
      <div class="p-5">
        <p id="feedbackMsg" class="text-sm"></p>
      </div>
      <div class="p-3 border-t flex items-center justify-end" style="border-color:var(--border)">
        <button class="btn btn-primary px-3 py-2 text-sm" onclick="fecharModalFeedback()">Ok</button>
      </div>
    </div>
  </div>

  <script>
    /** ============== CONFIG / APIs ============== */
    const FILA_API = (window.FILA_API || "https://whatsapp-webhook-production-9a27.up.railway.app/api").replace(/\/+$/, '');
    const CONV_API = (window.CONV_API || "https://conversas-api-production.up.railway.app").replace(/\/+$/, '');
    const API_BASE = (window.API_BASE || "https://dashboard-production-4c05.up.railway.app").replace(/\/+$/, '');
    const ESTRAT_API = (window.ESTRAT_API || "https://consultasic-production.up.railway.app").replace(/\/+$/, '');
    const LOGOUT_REDIRECT = window.LOGOUT_REDIRECT || null;
    const NOTICES_API = () => `${FILA_API}/painel/avisos_agentes${agente?.carteira ? `?carteira=${encodeURIComponent(agente.carteira)}` : ''}`;

    /** ============== CARTEIRAS / Phone IDs ============== */
    const phoneIdMap = {
      "789025174304270": "ConnectZap",
      "805610009301153": "Banco PAN",
      "727586317113885": "Recovery PJ",
      "802977069563598": "Recovery PF",
      "938298879357445": "Recovery Preventivo",
      "897647883433681": "Recovery Manuten√ß√£o",
      "821562937700669": "Mercado Pago Cobran√ßa",
      "779797401888141": "DivZero",
      "829210283602406": "Arc4U",
      "905309685992125": "Arc4U Veiculos",
      "713021321904495": "Serasa",
      "803535039503723": "Mercado Pago Vendas"
    };
    const carteiraToPhoneIds = Object.entries(phoneIdMap).reduce((acc, [ids, nome]) => {
      const parts = String(ids).split(',').map(s => s.trim()).filter(Boolean);
      acc[nome] = Array.from(new Set([...(acc[nome] || []), ...parts]));
      return acc;
    }, {});

    /** ============== ESTADO ============== */
    let agente = { codigo: null, nome: null, carteira: null, origem: null, origem_bd: null, online: false };
    let tickets = [];
    let selecionado = null;
    let renderedKeys = new Set();
    let lastTimestampMs = null;
    let lastDayRendered = null;
    let pollingContatos = null;
    let pollingMensagens = null;
    let isModalOpen = false;
    let userTyping = false;
    let respostaMsgId = null;
    let limitPerAgent = 0;
    let ativosCount = 0;
    let unreadCountByKey = {};
    let lastContatoTsByKey = {};
    let ordemCache = [];
    let pieChart = null;
    let chartMotivos = null;
    let typingTimer = null;

    // Avisos
    let notices = [];
    let noticesFilter = 'all';
    let noticesReadSet = new Set();

    /** ============== UTILS ============== */
    const DOC_PREVIEW_MAX = 2 * 1024 * 1024;
    const POLL_ACTIVE_MS = 5000, POLL_HIDDEN_MS = 30000;
    const fmtHoraBR = new Intl.DateTimeFormat('pt-BR', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Sao_Paulo' });
    const fmtDataBR = new Intl.DateTimeFormat('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'America/Sao_Paulo' });
    function fmtYMD(d) { const z = n => String(n).padStart(2, '0'); return `${d.getFullYear()}-${z(d.getMonth() + 1)}-${z(d.getDate())}` }
    function qsParam(name) { return new URLSearchParams(location.search).get(name) }
    function escapeHtml(s) { if (!s) return ""; return s.replace(/[&<>"']/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch])) }
    const __colorCache = new Map();
    function gerarCor(nome) { const key = String(nome || "U"); if (__colorCache.has(key)) return __colorCache.get(key); let h = 0; for (const c of key) h = c.charCodeAt(0) + ((h << 5) - h); const v = `hsl(${h % 360},70%,60%)`; __colorCache.set(key, v); return v }
    function keyLocal() { return `cz:tickets:${agente.codigo}:${agente.carteira}` }
    let __lastSavedTicketsStr = "";
    function saveTickets() { try { const s = JSON.stringify(tickets); if (s !== __lastSavedTicketsStr) { localStorage.setItem(keyLocal(), s); __lastSavedTicketsStr = s } } catch { } }
    function loadTickets() { try { tickets = JSON.parse(localStorage.getItem(keyLocal()) || "[]") || [] } catch { tickets = [] } }
    function isIncoming(m) {
      const s = (m.status || "").toLowerCase();
      if (typeof m.from_me === "boolean") return !m.from_me;
      if (m.direction) return String(m.direction).toLowerCase().startsWith("in");
      if (["in", "received", "incoming"].includes(s)) return true;
      if (["out", "sent", "delivered", "read", "outgoing"].includes(s)) return false;
      return s === "in"
    }
    function storageKeys() {
      return {
        unread: `cz:unreadCount:${agente.codigo || 'anon'}:${agente.carteira || 'cart'}`,
        lastTs: `cz:lastContatoTs:${agente.codigo || 'anon'}:${agente.carteira || 'cart'}`
      }
    }
    function loadUnread() { try { const { unread, lastTs } = storageKeys(); unreadCountByKey = JSON.parse(localStorage.getItem(unread) || "{}"); lastContatoTsByKey = JSON.parse(localStorage.getItem(lastTs) || "{}") } catch { unreadCountByKey = {}; lastContatoTsByKey = {} } }
    function persistUnread() { try { const { unread, lastTs } = storageKeys(); localStorage.setItem(unread, JSON.stringify(unreadCountByKey)); localStorage.setItem(lastTs, JSON.stringify(lastContatoTsByKey)) } catch { } }
    function keyFrom(remetente, phone_id) { return `${remetente}|${phone_id || ''}` }
    function schedulePolls() {
      if (pollingContatos) clearInterval(pollingContatos);
      if (pollingMensagens) clearInterval(pollingMensagens);
      const gap = document.hidden ? POLL_HIDDEN_MS : POLL_ACTIVE_MS;
      pollingContatos = setInterval(refreshOrdemCarteira, gap);
      if (selecionado) {
        pollingMensagens = setInterval(() => { if (!userTyping && !isModalOpen && selecionado) carregarMensagens(true) }, gap);
      }
    }
    document.addEventListener('visibilitychange', schedulePolls);

    function hashId(s) { let h = 5381; for (let i = 0; i < s.length; i++) h = ((h << 5) + h) + s.charCodeAt(i); return String(h >>> 0); }

    // toast ‚Äúleve‚Äù (se voc√™ n√£o tiver um toast global)
    function toast(msg, type = "info") {
      const title = type === "success" ? "Sucesso" : type === "warning" ? "Aten√ß√£o" : "Aviso";
      showModalFeedback(msg, title, 1400);
    }

    /** ============== DOM ============== */
    const elHomeNome = document.getElementById('homeAgenteNome');
    const elHomeCart = document.getElementById('homeAgenteCarteira');
    const elHomeStatus = document.getElementById('homeStatus');
    const elHomeAviso = document.getElementById('homeAviso');

    const heroWrap = document.getElementById('homeAvisoHero');
    const heroTitle = document.getElementById('heroTitle');
    const heroMeta = document.getElementById('heroMeta');
    const heroBody = document.getElementById('heroBody');
    const heroDismiss = document.getElementById('heroDismiss');
    const heroMarkRead = document.getElementById('heroMarkRead');

    const kpiEm = document.getElementById('kpiEm');
    const kpiConc = document.getElementById('kpiConc');
    const kpiTma = document.getElementById('kpiTma');
    const kpiFRT = document.getElementById('kpiFRT');
    const btnRefreshRel = document.getElementById('btnRefreshRel');
    const relStart = document.getElementById('relStart');
    const relEnd = document.getElementById('relEnd');
    const relPeriodo = document.getElementById('relatorioPeriodo');
    const relAgentePill = document.getElementById('relAgentePill');
    const btnExtratoRefresh = document.getElementById('btnExtratoRefresh');
    const extratoWrap = document.getElementById('extratoWrap');

    const elAgenteNome = document.getElementById("agenteNome");
    const elAgenteCarteira = document.getElementById("agenteCarteira");
    const elAgenteStatus = document.getElementById("agenteStatus");
    const elMsgAviso = document.getElementById("msgAviso");
    const elMsgLimite = document.getElementById("msgLimite");
    const elListaTickets = document.getElementById("listaTickets");
    const elTitulo = document.getElementById("tituloConversa");
    const elSubInfo = document.getElementById("subInfo");
    const chat = document.getElementById("chat");
    const textarea = document.getElementById("textoMensagem");
    const btnEnviar = document.getElementById("btnEnviar");
    const btnPegarProxima = document.getElementById("btnPegarProxima");
    const btnPrioridade = document.getElementById("btnPrioridade");
    const btnLiberar = document.getElementById("btnLiberar");
    const btnConcluir = document.getElementById("btnConcluir");
    const menuConcluir = document.getElementById("menuConcluir");
    const digitando = document.getElementById("digitando");
    const badgeAtivos = document.getElementById("badgeAtivos");
    const badgeLimite = document.getElementById("badgeLimite");

    const btnToggleOnline = document.getElementById("btnToggleOnline");
    const btnLogout = document.getElementById("btnLogout");

    const tabBtnHome = document.getElementById('tabBtnHome');
    const tabBtnConversas = document.getElementById('tabBtnConversas');
    const tabBtnRelatorio = document.getElementById('tabBtnRelatorio');
    const tabBtnEnvioIndividual = document.getElementById('tabBtnEnvioIndividual');

    const tabHome = document.getElementById('tabHome');
    const tabConversas = document.getElementById('tabConversas');
    const tabRelatorio = document.getElementById('tabRelatorio');
    const tabEnvioIndividual = document.getElementById('tabEnvioIndividual');

    document.getElementById('goToConversas1').onclick = () => switchTab('conversas');
    document.getElementById('goToRelatorio1').onclick = () => switchTab('relatorio');

    // Avisos DOM
    const avisosWrap = document.getElementById('avisosWrap');
    const avisosResumo = document.getElementById('avisosResumo');
    const btnAvisoRefresh = document.getElementById('btnAvisoRefresh');
    const avisosCountPill = document.getElementById('avisosCountPill');

    /** ============== MENU CONCLUIR ============== */
    const MOTIVOS_CONCLUSAO = ["Realizou negocia√ß√£o", "Solicitou 2¬™ via de boleto", "Recusou a proposta", "D√∫vidas gerais", "Cliente ficou inativo"];
    function renderMenuConcluir() {
      menuConcluir.innerHTML = MOTIVOS_CONCLUSAO.map(m => `<button type="button" data-motivo="${m}" class="w-full text-left px-3 py-2 text-sm" style="border-bottom:1px solid var(--border)">${m}</button>`).join("");
      menuConcluir.querySelectorAll("button[data-motivo]").forEach(btn => {
        btn.onmouseenter = () => btn.style.background = getCss('--hover');
        btn.onmouseleave = () => btn.style.background = 'transparent';
        btn.onclick = async () => { await concluirAtendimento(btn.getAttribute("data-motivo")); fecharMenuConcluir(); };
      });
    }
    function abrirMenuConcluir() { if (!selecionado || btnConcluir.disabled) return; menuConcluir.classList.remove("hidden"); btnConcluir.setAttribute("aria-expanded", "true"); document.addEventListener("click", clickForaMenuConcluir, { capture: true }) }
    function fecharMenuConcluir() { menuConcluir.classList.add("hidden"); btnConcluir.setAttribute("aria-expanded", "false"); document.removeEventListener("click", clickForaMenuConcluir, { capture: true }) }
    function clickForaMenuConcluir(e) { const within = menuConcluir.contains(e.target) || btnConcluir.contains(e.target); if (!within) fecharMenuConcluir() }
    btnConcluir.onclick = () => { menuConcluir.classList.contains("hidden") ? abrirMenuConcluir() : fecharMenuConcluir() };
    renderMenuConcluir();

    /** ============== LIBERAR / CONCLUIR ============== */
    let msgsCtrl = null;

    btnLiberar.onclick = async () => {
      if (!selecionado) return;
      try {
        const r = await fetch(`${CONV_API}/api/tickets/liberar`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            codigo_do_agente: parseInt(agente.codigo || '0', 10),
            remetente: selecionado.remetente,
            phone_id: selecionado.phone_id
          })
        });
        const j = await r.json();
        if (!r.ok || !j.ok) { alert(j.erro || "N√£o foi poss√≠vel liberar."); return; }

        const k = keyFrom(selecionado.remetente, selecionado.phone_id);
        delete unreadCountByKey[k];
        delete lastContatoTsByKey[k];
        persistUnread();

        tickets = tickets.filter((t) => (!(t.remetente === selecionado.remetente && t.phone_id === selecionado.phone_id)));
        saveTickets();
        renderTickets();
        limparChat();

        elTitulo.textContent = "Selecione um ticket";
        elSubInfo.textContent = "";
        btnLiberar.disabled = true;
        btnConcluir.disabled = true;
        fecharMenuConcluir();

        // remove sele√ß√£o + interrompe polling
        selecionado = null;
        if (msgsCtrl) { try { msgsCtrl.abort(); } catch { } }
        schedulePolls();

        if (ativosCount > 0) ativosCount--;
        renderAtivosLimiteUI();
      } catch (e) {
        alert("Erro ao liberar.");
      }
    };

    async function concluirAtendimento(motivo) {
      if (!selecionado) return;
      try {
        btnConcluir.disabled = true;
        const r = await fetch(`${CONV_API}/api/tickets/concluir`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            codigo_do_agente: parseInt(agente.codigo || '0', 10),
            remetente: selecionado.remetente,
            phone_id: selecionado.phone_id,
            motivo
          })
        });
        const j = await r.json();
        if (!r.ok || !j.ok) { alert(j.erro || "N√£o foi poss√≠vel concluir."); btnConcluir.disabled = false; return; }

        const k = keyFrom(selecionado.remetente, selecionado.phone_id);
        delete unreadCountByKey[k];
        delete lastContatoTsByKey[k];
        persistUnread();

        tickets = tickets.filter((t) => (!(t.remetente === selecionado.remetente && t.phone_id === selecionado.phone_id)));
        saveTickets();
        renderTickets();
        limparChat();

        elTitulo.textContent = "Selecione um ticket";
        elSubInfo.textContent = "";
        btnLiberar.disabled = true;
        btnConcluir.disabled = true;

        selecionado = null;
        if (msgsCtrl) { try { msgsCtrl.abort(); } catch { } }
        schedulePolls();

        if (ativosCount > 0) ativosCount--;
        renderAtivosLimiteUI();
      } catch (e) {
        alert("Erro ao concluir.");
        btnConcluir.disabled = false;
      }
    }

    /** ============== THEME (mantido) ============== */
    function themeKey() { return 'cz:theme:v2' }
    function defaultTheme() {
      return {
        primary: "#3b82f6", accent: "#22c55e", sidebar: "#ffffff", contentBg: "#ffffff", bg: "#f3f4f6", text: "#0f172a",
        muted: "#6b7280", border: "#e5e7eb", link: "#2563eb", ghostBg: "#f3f4f6",
        outG1: "#dcf8c6", outG2: "#b8f0a4", outFg: "#111827",
        inBg: "#ffffff", inBorder: "#e2e8f0", inFg: "#0f172a",
        bubbleRadius: 18, btnRadius: 10, cardRadius: 16, wallOp: 0, fontSize: "14px",
        ticketSelectedBg: "#f0f9ff", hover: "#f1f5f9", hoverStrong: "#e2e8f0",
        inputBg: "#ffffff", inputFg: "#0f172a", scrollbar: "#cbd5e1",
        replyBg: "rgba(0,0,0,.06)", replyBorder: "rgba(0,0,0,.08)", replyFg: "#334155"
      }
    }
    let currentTheme = defaultTheme();
    function applyTheme(t) {
      const r = document.documentElement.style;
      const base = defaultTheme();
      const x = { ...base, ...t };
      currentTheme = x;

      r.setProperty('--ticket-selected-bg', x.ticketSelectedBg);
      r.setProperty('--sidebar-bg', x.sidebar);
      r.setProperty('--content-bg', x.contentBg);
      r.setProperty('--bg', x.bg);
      r.setProperty('--text', x.text);
      r.setProperty('--muted', x.muted);
      r.setProperty('--border', x.border);
      r.setProperty('--link', x.link);
      r.setProperty('--ghost-bg', x.ghostBg);
      r.setProperty('--bubble-out-g1', x.outG1);
      r.setProperty('--bubble-out-g2', x.outG2);
      r.setProperty('--bubble-out-fg', x.outFg || '#111827');
      r.setProperty('--bubble-in-bg', x.inBg);
      r.setProperty('--bubble-in-border', x.inBorder);
      r.setProperty('--bubble-in-fg', x.inFg || '#0f172a');
      r.setProperty('--bubble-radius', x.bubbleRadius + 'px');
      r.setProperty('--btn-radius', x.btnRadius + 'px');
      r.setProperty('--card-radius', x.cardRadius + 'px');
      r.setProperty('--font-size', x.fontSize);
      r.setProperty('--chat-wallpaper-opacity', x.wallOp);
      r.setProperty('--scrollbar', x.scrollbar || '#cbd5e1');
      r.setProperty('--primary', x.primary);
      r.setProperty('--accent', x.accent);
      r.setProperty('--hover', x.hover || '#f1f5f9');
      r.setProperty('--hover-strong', x.hoverStrong || '#e2e8f0');
      r.setProperty('--input-bg', x.inputBg || x.contentBg);
      r.setProperty('--input-fg', x.inputFg || x.text);
      r.setProperty('--reply-bg', x.replyBg || 'rgba(0,0,0,.06)');
      r.setProperty('--reply-border', x.replyBorder || 'rgba(0,0,0,.08)');
      r.setProperty('--reply-fg', x.replyFg || '#334155');

      setTimeout(() => refreshKPIs(), 0);
    }
    function readThemeFromInputs() {
      return {
        primary: inputs.tPrimary.value, accent: inputs.tAccent.value, sidebar: inputs.tSidebar.value, contentBg: inputs.tContentBg.value,
        bg: inputs.tBg.value, text: inputs.tText.value, outG1: inputs.tOutG1.value, outG2: inputs.tOutG2.value,
        inBg: inputs.tInBg.value, inBorder: inputs.tInBorder.value,
        bubbleRadius: Number(inputs.tRadius.value || 18), wallOp: Number(inputs.tBgOp.value || 0),
        fontSize: String(inputs.tFontSize.value || '14px'),
        btnRadius: Number(inputs.tBtnRadius.value || 10), cardRadius: Number(inputs.tCardRadius.value || 16)
      }
    }
    function saveTheme(t) { try { localStorage.setItem(themeKey(), JSON.stringify(t)); } catch { } }
    function loadTheme() {
      try {
        const now = localStorage.getItem(themeKey());
        if (now) return JSON.parse(now);
        const old1 = localStorage.getItem(`cz:theme:${agente.codigo || 'anon'}`);
        if (old1) { localStorage.setItem(themeKey(), old1); return JSON.parse(old1) }
        const old2 = localStorage.getItem('cz:theme:anon');
        if (old2) { localStorage.setItem(themeKey(), old2); return JSON.parse(old2) }
      } catch { }
      return null;
    }

    const themeDrawer = document.getElementById('themeDrawer');
    const btnTheme = document.getElementById('btnTheme');
    const btnThemeClose = document.getElementById('btnThemeClose');
    const btnSaveTheme = document.getElementById('btnSaveTheme');
    const btnRandom = document.getElementById('btnRandom');
    const btnReset = document.getElementById('btnReset');
    const btnThemeExport = document.getElementById('btnThemeExport');
    const importTheme = document.getElementById('importTheme');
    const inputs = {
      tPrimary: document.getElementById('tPrimary'),
      tAccent: document.getElementById('tAccent'),
      tSidebar: document.getElementById('tSidebar'),
      tContentBg: document.getElementById('tContentBg'),
      tBg: document.getElementById('tBg'),
      tText: document.getElementById('tText'),
      tOutG1: document.getElementById('tOutG1'),
      tOutG2: document.getElementById('tOutG2'),
      tInBg: document.getElementById('tInBg'),
      tInBorder: document.getElementById('tInBorder'),
      tRadius: document.getElementById('tRadius'),
      tBgOp: document.getElementById('tBgOp'),
      tFontSize: document.getElementById('tFontSize'),
      tBtnRadius: document.getElementById('tBtnRadius'),
      tCardRadius: document.getElementById('tCardRadius')
    };
    function syncThemeInputs(t) {
      if (!t) return;
      try {
        if (inputs.tPrimary && t.primary) inputs.tPrimary.value = t.primary;
        if (inputs.tAccent && t.accent) inputs.tAccent.value = t.accent;
        if (inputs.tSidebar && t.sidebar) inputs.tSidebar.value = t.sidebar;
        if (inputs.tContentBg && t.contentBg) inputs.tContentBg.value = t.contentBg;
        if (inputs.tBg && t.bg) inputs.tBg.value = t.bg;
        if (inputs.tText && t.text) inputs.tText.value = t.text;
        if (inputs.tOutG1 && t.outG1) inputs.tOutG1.value = t.outG1;
        if (inputs.tOutG2 && t.outG2) inputs.tOutG2.value = t.outG2;
        if (inputs.tInBg && t.inBg) inputs.tInBg.value = t.inBg;
        if (inputs.tInBorder && t.inBorder) inputs.tInBorder.value = t.inBorder;
        if (inputs.tRadius && (t.bubbleRadius != null)) inputs.tRadius.value = String(t.bubbleRadius);
        if (inputs.tBgOp && (t.wallOp != null)) inputs.tBgOp.value = String(t.wallOp);
        if (inputs.tFontSize && (t.fontSize != null)) inputs.tFontSize.value = String(t.fontSize);
        if (inputs.tBtnRadius && (t.btnRadius != null)) inputs.tBtnRadius.value = String(t.btnRadius);
        if (inputs.tCardRadius && (t.cardRadius != null)) inputs.tCardRadius.value = String(t.cardRadius);
      } catch (_) { }
    }

    const THEME_PRESETS = {
      corporate: { primary: "#2563eb", accent: "#0ea5e9", outG1: "#0ea5e9", outG2: "#2563eb", bg: "#f3f4f6", sidebar: "#ffffff", contentBg: "#ffffff", text: "#0f172a" },
      ocean: { primary: "#06b6d4", accent: "#10b981", outG1: "#06b6d4", outG2: "#10b981", bg: "#f1f5f9", sidebar: "#ffffff", contentBg: "#ffffff", text: "#0f172a" },
      sunset: { primary: "#ef4444", accent: "#fb923c", outG1: "#fb923c", outG2: "#ef4444", bg: "#fff7ed", sidebar: "#ffffff", contentBg: "#ffffff", text: "#0f172a" },
      dark: {
        primary: "#60a5fa", accent: "#22c55e",
        sidebar: "#0b1220", contentBg: "#0f172a", bg: "#070b14",
        text: "#e5e7eb", muted: "#94a3b8", border: "rgba(255,255,255,.10)",
        link: "#60a5fa", ghostBg: "rgba(255,255,255,.06)",
        outG1: "#111827", outG2: "#374151", outFg: "#e5e7eb",
        inBg: "#0f172a", inBorder: "rgba(255,255,255,.12)", inFg: "#e5e7eb",
        ticketSelectedBg: "rgba(96,165,250,.18)"
      },
      minimal: { primary: "#0f172a", accent: "#334155", outG1: "#e2e8f0", outG2: "#f8fafc", bg: "#f8fafc", sidebar: "#ffffff", contentBg: "#ffffff", text: "#0f172a" },
      funky: { primary: "#a78bfa", accent: "#ec4899", outG1: "#a78bfa", outG2: "#ec4899", bg: "#faf5ff", sidebar: "#ffffff", contentBg: "#ffffff", text: "#0f172a" }
    };

    function setActivePreset(name) {
      document.querySelectorAll('.preset[data-preset]').forEach(el => {
        el.classList.toggle('active', (el.dataset.preset || '') === String(name || ''));
      });
    }
    function applyPreset(name) {
      const p = THEME_PRESETS[name];
      if (!p) return;
      const t = { ...defaultTheme(), ...p };
      applyTheme(t);
      saveTheme(t);
      syncThemeInputs(currentTheme);
      setActivePreset(name);
    }

    document.querySelectorAll('.preset[data-preset]').forEach(el => {
      el.setAttribute('role', 'button');
      el.setAttribute('tabindex', '0');
      el.addEventListener('click', () => applyPreset(el.dataset.preset));
      el.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); applyPreset(el.dataset.preset); } });
    });

    if (btnTheme) btnTheme.addEventListener('click', () => { syncThemeInputs(currentTheme); themeDrawer.classList.add('open'); });
    if (btnThemeClose) btnThemeClose.addEventListener('click', () => themeDrawer.classList.remove('open'));
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && themeDrawer.classList.contains('open')) themeDrawer.classList.remove('open') });

    [inputs.tPrimary, inputs.tAccent, inputs.tSidebar, inputs.tContentBg, inputs.tBg, inputs.tText, inputs.tOutG1, inputs.tOutG2, inputs.tInBg, inputs.tInBorder, inputs.tRadius, inputs.tBgOp, inputs.tFontSize, inputs.tBtnRadius, inputs.tCardRadius]
      .filter(Boolean).forEach(i => i.addEventListener('input', () => applyTheme(readThemeFromInputs())));

    if (btnSaveTheme) btnSaveTheme.addEventListener('click', () => { const t = readThemeFromInputs(); saveTheme(t); themeDrawer.classList.remove('open') });
    if (btnReset) btnReset.addEventListener('click', () => { const t = defaultTheme(); applyTheme(t); saveTheme(t); syncThemeInputs(currentTheme); setActivePreset(''); });
    if (btnRandom) btnRandom.addEventListener('click', () => {
      const rand = () => ('#' + Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0'));
      const b1 = rand(), b2 = rand();
      const t = {
        ...defaultTheme(),
        primary: rand(),
        accent: rand(),
        outG1: b1,
        outG2: b2,
        bg: '#f8fafc',
        bubbleRadius: 16 + Math.floor(Math.random() * 18),
        wallOp: Number((Math.random() * 0.25).toFixed(2)),
        btnRadius: 10 + Math.floor(Math.random() * 8),
        cardRadius: 14 + Math.floor(Math.random() * 8)
      };
      applyTheme(t);
      saveTheme(t);
      syncThemeInputs(currentTheme);
      setActivePreset('');
    });

    // Export/Import tema
    if (btnThemeExport) btnThemeExport.addEventListener('click', () => {
      try {
        const blob = new Blob([JSON.stringify(currentTheme, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'connectzap-tema.json';
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 500);
      } catch { }
    });
    if (importTheme) importTheme.addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      try {
        const t = JSON.parse(await f.text());
        applyTheme(t);
        saveTheme(t);
        syncThemeInputs(currentTheme);
        setActivePreset('');
        showModalFeedback('Tema importado.', 'Tema', 1200);
      } catch {
        showModalFeedback('Arquivo inv√°lido.', 'Tema', 1400);
      } finally {
        importTheme.value = "";
      }
    });

    /** ============== VISIBILIDADE DO APP ============== */
    function hideApp() {
      document.getElementById('appSidebar')?.classList.add('hidden');
      document.getElementById('tabsWrapper')?.classList.add('hidden');
    }
    function showApp() {
      document.getElementById('appSidebar')?.classList.remove('hidden');
      document.getElementById('tabsWrapper')?.classList.remove('hidden');
    }

    /** ============== LOGIN MODAL ============== */
    function isLogged() { try { return !!localStorage.getItem('agente_codigo') } catch { return false } }
    function abrirModalLogin() {
      const m = document.getElementById('modalLogin');
      m.style.display = 'flex';
      setTimeout(() => document.getElementById('loginCodigoAgente').focus(), 50);
      isModalOpen = true;
    }
    function fecharModalLogin() {
      const m = document.getElementById('modalLogin');
      m.style.display = 'none';
      const e = document.getElementById('loginErro');
      e.textContent = '';
      e.classList.add('hidden');
      isModalOpen = false;
    }

    async function login() {
      const codigo = (document.getElementById('loginCodigoAgente').value || '').trim();
      const erro = document.getElementById('loginErro');
      if (!codigo || !/^\d+$/.test(codigo)) { erro.textContent = 'Informe um c√≥digo num√©rico v√°lido.'; erro.classList.remove('hidden'); return }
      try {
        const r = await fetch(`${FILA_API}/agentes/${encodeURIComponent(codigo)}`);
        const j = await r.json();
        if (!j.ok) { throw new Error(j.erro || 'Agente n√£o encontrado') }

        localStorage.setItem("agente_codigo", String(codigo));
        localStorage.setItem("agente_nome", j.agente?.nome || `Agente ${codigo}`);
        localStorage.setItem("agente_carteira", j.agente?.carteira || 'ConnectZap');
        localStorage.setItem("agente_origem_bd", j.agente?.origem_bd || "");
        localStorage.setItem("agente_permite_envio_individual", String(!!j.agente?.permite_envio_individual));

        renderPermissaoEnvioIndividual();
        fecharModalLogin();
        showApp();

        await boot();
        switchTab('home');
        updateAuthButton();
      } catch (e) {
        erro.textContent = e?.message || 'Falha ao validar c√≥digo.';
        erro.classList.remove('hidden')
      }
    }
    document.getElementById('btnDoLogin').onclick = login;
    document.getElementById('loginCodigoAgente').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); login(); } });

    /** ============== MODAL FEEDBACK ============== */
    const modalFeedback = document.getElementById('modalFeedback');
    const feedbackTitle = document.getElementById('feedbackTitle');
    const feedbackMsg = document.getElementById('feedbackMsg');
    let feedbackTimer = null;

    function showModalFeedback(msg, title = 'Aviso', autocloseMs = 1200) {
      feedbackTitle.textContent = title;
      feedbackMsg.textContent = msg;
      modalFeedback.style.display = 'flex';
      if (feedbackTimer) { clearTimeout(feedbackTimer); feedbackTimer = null; }
      if (autocloseMs && autocloseMs > 0) {
        feedbackTimer = setTimeout(() => fecharModalFeedback(), autocloseMs);
      }
    }
    function fecharModalFeedback() {
      modalFeedback.style.display = 'none';
      if (feedbackTimer) { clearTimeout(feedbackTimer); feedbackTimer = null; }
    }

    /** ============== PERMISS√ÉO ENVIO INDIVIDUAL ============== */
    function _bool(v) {
      if (typeof v === 'boolean') return v;
      if (v === null || v === undefined) return false;
      const s = String(v).trim().toLowerCase();
      return s === '1' || s === 'true' || s === 'sim' || s === 'yes';
    }
    function hasPermEnvioIndividual() {
      return _bool(localStorage.getItem('agente_permite_envio_individual'));
    }
    function renderPermissaoEnvioIndividual() {
      const ok = hasPermEnvioIndividual();
      if (tabBtnEnvioIndividual) tabBtnEnvioIndividual.classList.toggle('hidden', !ok);
      const warn = document.getElementById('envIndSemPermissao');
      if (warn) warn.classList.toggle('hidden', ok);
      if (!ok && tabEnvioIndividual && !tabEnvioIndividual.classList.contains('hidden')) {
        switchTab('home');
      }
      const btnSend = document.getElementById('btnEnvIndEnviar');
      if (btnSend) btnSend.disabled = !ok;
    }

    /** ============== Bot√£o Login/Logout din√¢mico ============== */
    function updateAuthButton() {
      const logged = isLogged();
      if (!btnLogout) return;
      btnLogout.classList.remove('btn-neutral', 'btn-primary', 'btn-danger');
      if (logged) {
        btnLogout.textContent = "Logout";
        btnLogout.classList.add('btn', 'btn-danger');
        btnLogout.onclick = doLogout;
      } else {
        btnLogout.textContent = "Login";
        btnLogout.classList.add('btn', 'btn-primary');
        btnLogout.onclick = () => abrirModalLogin();
      }
    }

    function toggleLoginLocks() {
      const locked = !isLogged();
      [tabBtnConversas, tabBtnRelatorio, tabBtnEnvioIndividual].forEach(btn => {
        if (!btn) return;
        if (locked) btn.classList.add('locked'); else btn.classList.remove('locked');
        btn.setAttribute('aria-disabled', locked ? 'true' : 'false');
        btn.title = locked
          ? 'Fa√ßa login para acessar'
          : (btn === tabBtnConversas ? 'Conversas' : (btn === tabBtnRelatorio ? 'Relat√≥rio' : 'Envio individual'));
      });
    }

    /** ============== TABS ============== */
    function bindTabsOnce() {
      if (tabBtnHome) tabBtnHome.onclick = () => switchTab('home');
      if (tabBtnConversas) tabBtnConversas.onclick = () => { if (!isLogged()) { abrirModalLogin(); return; } switchTab('conversas'); };
      if (tabBtnRelatorio) tabBtnRelatorio.onclick = () => { if (!isLogged()) { abrirModalLogin(); return; } switchTab('relatorio'); };
      if (tabBtnEnvioIndividual) tabBtnEnvioIndividual.onclick = () => { if (!isLogged()) { abrirModalLogin(); return; } switchTab('envio_individual'); };
    }
    bindTabsOnce();

    function switchTab(tab) {
      if (['conversas', 'relatorio', 'envio_individual'].includes(tab) && !isLogged()) {
        abrirModalLogin();
        return;
      }

      if (tab === 'envio_individual' && !hasPermEnvioIndividual()) {
        const warn = document.getElementById('envIndSemPermissao');
        if (warn) warn.classList.remove('hidden');
        showModalFeedback('Seu usu√°rio n√£o possui permiss√£o para Envio individual.', 'Sem permiss√£o', 1400);
        tab = 'home';
      }

      [tabHome, tabConversas, tabRelatorio, tabEnvioIndividual].filter(Boolean).forEach(el => el.classList.add('hidden'));
      [tabBtnHome, tabBtnConversas, tabBtnRelatorio, tabBtnEnvioIndividual].filter(Boolean).forEach(btn => btn.classList.remove('active'));

      if (tab === 'home') { tabHome.classList.remove('hidden'); tabBtnHome.classList.add('active'); }
      else if (tab === 'conversas') { tabConversas.classList.remove('hidden'); tabBtnConversas.classList.add('active'); }
      else if (tab === 'relatorio') { tabRelatorio.classList.remove('hidden'); tabBtnRelatorio.classList.add('active'); }
      else if (tab === 'envio_individual') { tabEnvioIndividual.classList.remove('hidden'); tabBtnEnvioIndividual.classList.add('active'); envIndSyncFromConversa(); }
      else { tabHome.classList.remove('hidden'); tabBtnHome.classList.add('active'); }
    }

    /** ============== ENVIO INDIVIDUAL (ligacao_caiu) ‚Äî AJUSTADO ============== */
    let __envIndBound = false;
    let envIndContatoSelecionado = null;
    let envIndBuscaRows = [];

    function normalizeMsisdnBR(v) {
      if (!v) return "";
      let digits = String(v).replace(/\D+/g, "");
      if (!digits) return "";
      if (!digits.startsWith("55")) digits = "55" + digits;
      return digits;
    }
    function firstNameOf(n) {
      const s = String(n || '').trim();
      if (!s) return '';
      return s.split(/\s+/)[0] || s;
    }
    function pickDefaultPhoneId() {
      const ids = (carteiraToPhoneIds[agente?.carteira] || []).map(String);
      return ids.length ? ids[0] : '';
    }
    function envIndSetPreview() {
      const nome = firstNameOf(envIndContatoSelecionado?.primeiro_nome)
        || firstNameOf(selecionado?.nome_exibicao)
        || 'cliente';
      const el = document.getElementById('envIndPreview');
      if (!el) return;
      el.innerHTML = `Ol√°, <span class="font-semibold">${escapeHtml(nome)}</span>! Perdemos a sua liga√ß√£o. Se estiver dispon√≠vel, responda aqui para continuar.`;
    }
    function envIndUpdatePhoneIdLabel(phone_id) {
      const el = document.getElementById('envIndPhoneIdLabel');
      const hint = document.getElementById('envIndPhoneIdHint');
      if (!el) return;
      const pid = String(phone_id || '').trim();
      if (!pid) {
        el.textContent = '‚Äî';
        if (hint) hint.textContent = 'n√£o identificado';
        return;
      }
      const nome = phoneIdMap[pid] || '';
      el.textContent = nome ? `${pid} (${nome})` : pid;
      if (hint) hint.textContent = 'preenchido automaticamente';
    }

    function envIndSetResultCompact(payload) {
      const wrap = document.getElementById('envIndStatusWrap');
      const pill = document.getElementById('envIndStatusPill');

      const obj = payload || {};
      const statusKind = obj.__kind || 'neutral'; // success | fail | neutral
      const statusText = obj.__statusText || '‚Äî';

      if (pill) {
        pill.classList.remove('pill-success', 'pill-fail', 'pill-neutral');
        pill.classList.add(statusKind === 'success' ? 'pill-success' : statusKind === 'fail' ? 'pill-fail' : 'pill-neutral');
        pill.textContent = statusText;
      }

      if (wrap) {
        const shouldShow = !(statusKind === 'neutral' && (statusText === '‚Äî' || !statusText));
        wrap.classList.toggle('hidden', !shouldShow);
      }
    }
    function envIndResetResultUI() { envIndSetResultCompact({ __kind: 'neutral', __statusText: '‚Äî' }); }

    function formatTelefoneBR(msisdn) {
      const d = String(msisdn || '').replace(/\D+/g, '');
      let x = d;
      if (x.startsWith('55')) x = x.slice(2);
      if (x.length < 10) return msisdn || '';
      const dd = x.slice(0, 2);
      const num = x.slice(2);
      if (num.length === 9) return `(${dd}) ${num.slice(0, 5)}-${num.slice(5)}`;
      if (num.length === 8) return `(${dd}) ${num.slice(0, 4)}-${num.slice(4)}`;
      return `(${dd}) ${num}`;
    }
    function envIndUpdateChosenUI() {
      const pill = document.getElementById('envIndTelefoneEscolhido');
      const nomeEl = document.getElementById('envIndNomeEscolhido');

      const tel = envIndContatoSelecionado?.to_msisdn ? formatTelefoneBR(envIndContatoSelecionado.to_msisdn) : '';
      const nome = firstNameOf(envIndContatoSelecionado?.primeiro_nome);

      if (pill) {
        pill.classList.remove('pill-success', 'pill-fail', 'pill-neutral');
        pill.classList.add(tel ? 'pill-success' : 'pill-neutral');
        pill.textContent = tel || 'Nenhum';
      }
      if (nomeEl) nomeEl.textContent = nome ? `‚Ä¢ ${nome}` : '';
    }
    function envIndResetBuscaUI() {
      envIndBuscaRows = [];
      envIndContatoSelecionado = null;

      const box = document.getElementById('envIndBuscaBox');
      const msg = document.getElementById('envIndBuscaMsg');
      const wrap = document.getElementById('envIndResultadosWrap');
      const tbody = document.getElementById('envIndResultados');

      if (box) box.classList.add('hidden');
      if (msg) msg.textContent = '‚Äî';
      if (wrap) wrap.classList.add('hidden');
      if (tbody) tbody.innerHTML = '';
      envIndUpdateChosenUI();
      envIndSetPreview();
    }
    function envIndRenderResultados(rows) {
      const tbody = document.getElementById('envIndResultados');
      const wrap = document.getElementById('envIndResultadosWrap');
      if (!tbody || !wrap) return;

      tbody.innerHTML = '';
      rows.forEach((r, i) => {
        const tel = normalizeMsisdnBR(r.TELEFONE || r.telefone || r.to_msisdn || r.to || '');
        const nome = firstNameOf(r.PrimeiroNome || r.primeiro_nome || r.nome || '');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="font-mono text-sm">${escapeHtml(formatTelefoneBR(tel))}</td>
          <td class="text-sm">${escapeHtml(nome || '‚Äî')}</td>
          <td class="text-right">
            <button class="btn btn-ghost btn-sm" type="button" onclick="envIndSelectFromBusca(${i})">Selecionar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      wrap.classList.remove('hidden');
    }
    function envIndSelectFromBusca(i) {
      const r = envIndBuscaRows?.[i];
      if (!r) return;

      const tel = normalizeMsisdnBR(r.TELEFONE || r.telefone || '');
      const nome = firstNameOf(r.PrimeiroNome || r.primeiro_nome || r.nome || '');

      envIndContatoSelecionado = { to_msisdn: tel, primeiro_nome: nome, __raw: r, __from: 'busca' };
      envIndUpdateChosenUI();
      envIndSetPreview();
    }
    async function pesquisarCadastroEnvInd() {
      const base = (document.getElementById('envIndBase')?.value || '').trim();
      const codigo = (document.getElementById('envIndCodigo')?.value || '').trim();

      const box = document.getElementById('envIndBuscaBox');
      const msg = document.getElementById('envIndBuscaMsg');
      const wrap = document.getElementById('envIndResultadosWrap');

      if (box) box.classList.remove('hidden');
      if (msg) msg.textContent = '‚è≥ Buscando cadastro...';
      if (wrap) wrap.classList.add('hidden');

      envIndBuscaRows = [];
      envIndContatoSelecionado = null;
      envIndUpdateChosenUI();
      envIndSetPreview();

      if (!base || !codigo) { if (msg) msg.textContent = 'Informe a base e o c√≥digo do cliente.'; return; }

      try {
        const url = `${ESTRAT_API}/api/estrategias/pesquisa/${encodeURIComponent(base)}/${encodeURIComponent(codigo)}`;
        const res = await fetch(url, { method: 'GET', mode: 'cors', credentials: 'omit', cache: 'no-store' });
        if (!res.ok) { const t = await res.text(); throw new Error(`Falha ao buscar cadastro (${res.status}): ${t}`); }

        const data = await res.json();
        const rows = Array.isArray(data) ? data : (Array.isArray(data?.dados) ? data.dados : []);
        const norm = rows
          .map(r => ({
            ...r,
            TELEFONE: normalizeMsisdnBR(r.TELEFONE || r.telefone || r.to_msisdn || r.to || ''),
            PrimeiroNome: firstNameOf(r.PrimeiroNome || r.primeiro_nome || r.nome || '')
          }))
          .filter(r => r.TELEFONE && r.TELEFONE.length >= 12);

        if (!norm.length) { if (msg) msg.textContent = 'Nenhum telefone encontrado para esse c√≥digo.'; envIndBuscaRows = []; return; }

        envIndBuscaRows = norm;
        if (msg) msg.textContent = `‚úÖ ${norm.length} telefone(s) encontrado(s). Selecione um para enviar.`;
        envIndRenderResultados(norm);
      } catch (err) {
        if (msg) msg.textContent = `‚ùå ${err?.message || 'Falha ao buscar cadastro.'}`;
      }
    }

    function envIndSyncFromConversa() {
      const phoneIdEl = document.getElementById('envIndPhoneId');
      if (phoneIdEl && !phoneIdEl.value && selecionado?.phone_id) phoneIdEl.value = String(selecionado.phone_id || '');

      if (!envIndContatoSelecionado && selecionado?.remetente) {
        const tel = normalizeMsisdnBR(selecionado.remetente || '');
        const nome = firstNameOf(selecionado.nome_exibicao || '');
        if (tel) envIndContatoSelecionado = { to_msisdn: tel, primeiro_nome: nome, __from: 'conversa' };
      }

      envIndUpdateChosenUI();
      envIndUpdatePhoneIdLabel(phoneIdEl?.value || '');
      envIndSetPreview();
    }

    async function postJson(url, payload) {
      const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      let j = null;
      try { j = await r.json(); } catch { }
      return { r, j };
    }

    // ‚úÖ AJUSTE PRINCIPAL AQUI:
    // - "reservarConversaPosLigacaoCaiu" agora roda DEPOIS de envio bem sucedido
    // - vari√°vel "telefone" indefinida foi corrigida (usa to_msisdn)
    async function enviarLigacaoCaiu() {
      if (!hasPermEnvioIndividual()) { showModalFeedback('Sem permiss√£o para Envio individual.', 'Sem permiss√£o', 1400); return; }

      const phoneIdEl = document.getElementById('envIndPhoneId');
      const btn = document.getElementById('btnEnvIndEnviar');

      const rawTel = (envIndContatoSelecionado?.to_msisdn || '').trim() || (selecionado?.remetente || '');
      const to_msisdn = normalizeMsisdnBR(rawTel);
      const primeiro_nome = firstNameOf(envIndContatoSelecionado?.primeiro_nome || '') || firstNameOf(selecionado?.nome_exibicao || '') || 'cliente';

      const phone_id = (phoneIdEl?.value || '').trim()
        || (selecionado?.phone_id ? String(selecionado.phone_id) : '')
        || pickDefaultPhoneId();

      if (!to_msisdn || to_msisdn.length < 12 || !phone_id) {
        envIndSetResultCompact({ __kind: 'fail', __statusText: 'Falha' });
        return;
      }

      const payload = { to_msisdn, phone_id, primeiro_nome, to: to_msisdn, telefone: to_msisdn, nome: primeiro_nome };

      envIndUpdatePhoneIdLabel(phone_id);

      const candidates = [
        `${FILA_API}/ligacao_caiu`,
        `${FILA_API}/api/ligacao_caiu`,
        `${FILA_API}/templates/ligacao_caiu`,
        `${FILA_API}/api/templates/ligacao_caiu`,
        `${CONV_API}/api/ligacao_caiu`,
        `${CONV_API}/api/envio_individual/ligacao_caiu`,
        `${CONV_API}/api/templates/ligacao_caiu`,
        `${CONV_API}/api/templates/ligacao_caiu/send`,
      ];

      try {
        if (btn) { btn.disabled = true; btn.classList.add('btn-loading'); }
        envIndSetResultCompact({ __kind: 'neutral', __statusText: 'Enviando‚Ä¶' });

        for (const url of candidates) {
          try {
            const { r, j } = await postJson(url, payload);

            const okByJson = !!(j && (j.ok === true || j.messages || j.msg_id || j.meta_response));
            const okByHttp = !!(r && r.ok);

            if (okByHttp || okByJson) {
              envIndSetResultCompact({ __kind: 'success', __statusText: 'Sucesso' });
              showModalFeedback('Template enviado com sucesso.', 'Envio individual', 1200);

              // ‚úÖ Agora sim: tenta reservar/criar conversa ap√≥s envio OK
              try {
                const reserva = await reservarConversaPosLigacaoCaiu(to_msisdn, phone_id);
                if (reserva.ok && reserva.warn) {
                  (window.toast ? toast(reserva.message || "Mensagem enviada ‚úÖ (outro operador j√° atende).", "warning")
                    : alert(reserva.message || "Mensagem enviada ‚úÖ (outro operador j√° atende)."));
                } else if (reserva.ok) {
                  (window.toast ? toast("Mensagem enviada ‚úÖ e conversa criada/reservada.", "success")
                    : alert("Mensagem enviada ‚úÖ e conversa criada/reservada."));
                }
              } catch (_) { /* n√£o bloqueia */ }

              return;
            }

            // se veio erro expl√≠cito, tenta pr√≥ximo endpoint
            if (j && (j.erro || j.error || j.message)) continue;

          } catch (err) {
            // tenta pr√≥ximo
          }
        }

        envIndSetResultCompact({ __kind: 'fail', __statusText: 'Falha' });
      } finally {
        if (btn) { btn.disabled = false; btn.classList.remove('btn-loading'); }
      }
    }

    async function reservarConversaPosLigacaoCaiu(telefone, phone_id) {
      const tel = normalizeMsisdnBR(telefone);
      if (!tel) return { ok: false, warn: true, message: "Telefone inv√°lido para reservar conversa." };

      const codigo = parseInt((agente && agente.codigo) ? agente.codigo : "0", 10);
      const carteira = (agente && agente.carteira) ? agente.carteira : "";

      const payload = {
        codigo_do_agente: codigo,
        carteira,
        remetente: tel,
        telefone: tel,
        phone_id: phone_id ? String(phone_id) : undefined
      };

      const headers = { "Content-Type": "application/json" };
      const token = (localStorage.getItem("token") || "").trim();
      if (token) headers["Authorization"] = `Bearer ${token}`;

      const endpoints = [
        `${CONV_API}/api/envio_individual/ligacao_caiu/reserva`,
        `${CONV_API}/api/tickets/claim`
      ];

      for (const url of endpoints) {
        try {
          const r = await fetch(url, { method: "POST", headers, body: JSON.stringify(payload) });
          if (r.status === 404) continue;

          let j = null;
          try { j = await r.json(); } catch { }

          if (r.ok) return { ok: true, warn: false, data: j };

          if (r.status === 409) {
            return {
              ok: true,
              warn: true,
              data: j,
              message: (j && (j.message || j.error)) || "Outro operador j√° est√° atendendo este cliente."
            };
          }

          return {
            ok: false,
            warn: true,
            data: j,
            message: (j && (j.message || j.error)) || `Falha ao reservar conversa (HTTP ${r.status}).`
          };
        } catch (e) { }
      }

      return { ok: false, warn: true, message: "N√£o foi poss√≠vel reservar/criar a conversa (rede/endpoint)." };
    }

    function initEnvioIndividual() {
      if (__envIndBound) return;
      __envIndBound = true;

      const btnSend = document.getElementById('btnEnvIndEnviar');
      const btnClear = document.getElementById('btnEnvIndLimpar');
      const btnBuscar = document.getElementById('btnEnvIndBuscar');
      const codigoEl = document.getElementById('envIndCodigo');
      const baseEl = document.getElementById('envIndBase');
      const phoneIdEl = document.getElementById('envIndPhoneId');

      let lockedOrigem = '';
      try {
        lockedOrigem = String(agente?.origem_bd || (localStorage.getItem('agente_origem_bd') || '')).trim().toLowerCase();
      } catch { lockedOrigem = ''; }

      if (baseEl) {
        const hintEl = document.getElementById('envIndBaseHint');
        if (lockedOrigem) {
          const hasOpt = Array.from(baseEl.options).some(o => String(o.value).toLowerCase() === lockedOrigem);
          if (!hasOpt) {
            const opt = document.createElement('option');
            opt.value = lockedOrigem;
            opt.textContent = lockedOrigem.toUpperCase();
            baseEl.appendChild(opt);
          }
          baseEl.value = lockedOrigem;
          baseEl.disabled = true;
          baseEl.classList.add('opacity-70', 'cursor-not-allowed');
          baseEl.title = 'Origem definida pelo seu perfil';
          if (hintEl) { hintEl.textContent = `Definida pelo seu perfil (${lockedOrigem.toUpperCase()}).`; hintEl.classList.remove('hidden'); }
        } else {
          baseEl.disabled = false;
          if (hintEl) hintEl.classList.add('hidden');
        }
      }

      if (btnSend) btnSend.addEventListener('click', enviarLigacaoCaiu);
      if (btnBuscar) btnBuscar.addEventListener('click', pesquisarCadastroEnvInd);
      if (codigoEl) codigoEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); pesquisarCadastroEnvInd(); } });

      if (btnClear) btnClear.addEventListener('click', () => {
        if (codigoEl) codigoEl.value = '';
        if (baseEl) {
          if (lockedOrigem) baseEl.value = lockedOrigem;
          else if (!baseEl.value) baseEl.value = 'bd5';
        }
        if (phoneIdEl) phoneIdEl.value = '';
        envIndResetBuscaUI();
        envIndResetResultUI();
      });

      envIndResetResultUI();
      envIndUpdateChosenUI();
      envIndSyncFromConversa();
      renderPermissaoEnvioIndividual();
    }

    /** ============== ONLINE/OFFLINE, LIMITES ============== */
    async function verificarOnline() {
      try {
        const r = await fetch(`${FILA_API}/fila/status?carteira=${encodeURIComponent(agente.carteira)}`);
        const lista = await r.json();
        const achou = Array.isArray(lista) && lista.some(x => String(x.codigo_do_agente) === String(agente.codigo));
        setStatus(achou);
        if (!achou) { elMsgAviso?.classList.add("hidden"); elHomeAviso.classList.remove("hidden"); elHomeAviso.textContent = "Voc√™ est√° OFFLINE nesta carteira. Use ‚ÄúFicar online‚Äù para entrar na fila."; }
        else { elHomeAviso.classList.add("hidden"); elHomeAviso.textContent = ""; }
      } catch (e) { setStatus(false) }
    }

    function setStatus(online) {
      agente.online = !!online;
      if (elAgenteStatus) elAgenteStatus.innerHTML = online ? '<span class="dot online"></span>Online' : '<span class="dot offline"></span>Offline';
      if (elHomeStatus) elHomeStatus.innerHTML = online ? '<span class="dot online"></span>Online' : '<span class="dot offline"></span>Offline';

      btnPegarProxima.disabled = !online || (limitPerAgent > 0 && ativosCount >= limitPerAgent);
      btnPrioridade.disabled = !online || (limitPerAgent > 0 && ativosCount >= limitPerAgent);

      const toggleLabel = document.getElementById("toggleLabel");
      if (btnToggleOnline) {
        btnToggleOnline.disabled = false;
        btnToggleOnline.setAttribute('aria-pressed', online ? 'true' : 'false');
        if (online) {
          if (toggleLabel) toggleLabel.textContent = "Ficar offline";
          btnToggleOnline.classList.remove("bg-green-600", "hover:bg-green-700", "text-white");
          btnToggleOnline.classList.add("btn-neutral");
        } else {
          if (toggleLabel) toggleLabel.textContent = "Ficar online";
          btnToggleOnline.classList.add("bg-green-600", "text-white", "hover:bg-green-700");
          btnToggleOnline.classList.remove("btn-neutral");
        }
      }
    }

    async function refreshOrdemCarteira() {
      if (!agente.carteira) return;
      const phoneIds = (carteiraToPhoneIds[agente.carteira] || []).map(String);
      if (!phoneIds.length) return;
      try {
        const res = await fetch(`${CONV_API}/api/conversas/contatos`);
        const contatos = await res.json();
        const filtrados = (contatos || []).filter(c => phoneIds.includes(String(c.phone_id)));

        filtrados.sort((a, b) => {
          const ai = a.status === 'in', bi = b.status === 'in';
          if (ai !== bi) return bi - ai;
          return new Date(b.data_hora) - new Date(a.data_hora)
        });

        ordemCache = filtrados;
        const ticketByKey = new Map((tickets || []).map(t => [keyFrom(t.remetente, t.phone_id), t]));
        filtrados.forEach(c => {
          const k = keyFrom(c.remetente, c.phone_id);
          const t = ticketByKey.get(k);
          if (!t) { lastContatoTsByKey[k] = +new Date(c.data_hora || 0); return; }
          const ts = +new Date(c.data_hora || 0);
          const prev = lastContatoTsByKey[k] || 0;
          const isOpen = !!(selecionado && selecionado.remetente === c.remetente && selecionado.phone_id === c.phone_id);
          if (c.status === 'in' && ts > prev && !isOpen) { unreadCountByKey[k] = (unreadCountByKey[k] || 0) + 1; }
          lastContatoTsByKey[k] = ts;

          if (c.mensagem_final) t.mensagem_final = c.mensagem_final;
          else if (c.ultima_mensagem) t.mensagem_final = c.ultima_mensagem;
          if (c.data_hora) t.data_hora = c.data_hora;
        });

        persistUnread();
        saveTickets();
        renderTickets();
      } catch (e) { console.error("Falha ao atualizar ordem", e) }
    }

    async function refreshAtivosELimite() {
      try {
        const url = `${CONV_API}/api/tickets/minhas?agente=${encodeURIComponent(agente.codigo || '')}&carteira=${encodeURIComponent(agente.carteira || '')}`;
        const r = await fetch(url);
        const rows = r.ok ? await r.json() : [];
        ativosCount = Array.isArray(rows) ? rows.length : 0;
      } catch { ativosCount = tickets.length }

      try {
        const j = await fetch(`${CONV_API}/api/supervisao/tickets-limit?carteira=${encodeURIComponent(agente.carteira || '')}`).then(r => r.json());
        limitPerAgent = Number(j.limit_per_agent || 0);
      } catch { limitPerAgent = 0 }

      renderAtivosLimiteUI();
    }

    function renderAtivosLimiteUI() {
      badgeAtivos.textContent = String(ativosCount);
      badgeLimite.textContent = limitPerAgent > 0 ? String(limitPerAgent) : "‚àû";
      const atingiu = (limitPerAgent > 0 && ativosCount >= limitPerAgent);
      if (atingiu) {
        elMsgLimite.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido. Conclua ou libere um atendimento para continuar.`;
        elMsgLimite.classList.remove("hidden")
      } else {
        elMsgLimite.classList.add("hidden");
        elMsgLimite.textContent = ""
      }
      btnPegarProxima.disabled = !agente.online || atingiu;
      btnPrioridade.disabled = !agente.online || atingiu;
    }

    btnToggleOnline.onclick = async () => {
      if (!agente.carteira || !agente.codigo) { abrirModalLogin(); return; }
      const toggleSpinner = document.getElementById('toggleSpinner');
      const toggleLabel = document.getElementById('toggleLabel');

      elHomeAviso.classList.add("hidden");
      elHomeAviso.textContent = "";

      const indoOnline = !agente.online;
      btnToggleOnline.disabled = true;
      toggleSpinner.classList.remove('hidden');
      if (toggleLabel) toggleLabel.textContent = indoOnline ? 'Entrando‚Ä¶' : 'Saindo‚Ä¶';

      try {
        if (indoOnline) {
          const r = await fetch(`${FILA_API}/fila/online`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo, 10), carteira: agente.carteira })
          });
          const j = await r.json();
          if (!j.ok) throw new Error(j.erro || "Erro ao entrar online");
          setStatus(true);
          await refreshOrdemCarteira();
          await refreshAtivosELimite();
        } else {
          const r = await fetch(`${FILA_API}/fila/offline`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo, 10), carteira: agente.carteira })
          });
          const j = await r.json();
          if (!j.ok) throw new Error(j.erro || "Erro ao ficar offline");
          setStatus(false);
        }
      } catch (e) {
        elHomeAviso.classList.remove("hidden");
        elHomeAviso.textContent = (e?.message || "Falha ao alterar status");
      } finally {
        toggleSpinner.classList.add('hidden');
        if (toggleLabel) toggleLabel.textContent = agente.online ? 'Ficar offline' : 'Ficar online';
        btnToggleOnline.disabled = false;
      }
    };

    btnPegarProxima.onclick = async () => {
      if (!agente.online) { alert("Voc√™ est√° offline. V√° na Home e clique em ‚ÄúFicar online‚Äù."); return; }
      if (limitPerAgent > 0 && ativosCount >= limitPerAgent) { elMsgLimite.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido.`; elMsgLimite.classList.remove('hidden'); renderAtivosLimiteUI(); return; }
      const spinner = document.getElementById('pegarSpinner');
      const label = document.getElementById('pegarLabel');

      btnPegarProxima.disabled = true;
      spinner.classList.remove('hidden');
      label.textContent = 'Buscando‚Ä¶';

      try {
        const r = await fetch(`${CONV_API}/api/tickets/claim`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo, 10), carteira: agente.carteira })
        });
        const j = await r.json().catch(() => ({ ok: false, erro: 'Falha na resposta' }));

        if (r.status === 409 && j && (j.limit_per_agent !== undefined)) {
          limitPerAgent = Number(j.limit_per_agent || 0);
          ativosCount = Number(j.ativos || ativosCount);
          elMsgLimite.textContent = j.erro || `Limite de ${limitPerAgent} atingido.`;
          elMsgLimite.classList.remove('hidden');
          renderAtivosLimiteUI();
          return;
        }

        if (!r.ok || !j.ok) { alert(j.erro || "Sem conversas dispon√≠veis."); return; }

        if (!tickets.find(t => t.remetente === j.ticket.remetente && t.phone_id === j.ticket.phone_id)) {
          tickets.unshift(j.ticket);
          saveTickets();
        }
        renderTickets();
        await abrirTicket(j.ticket);
        ativosCount++;
        renderAtivosLimiteUI();
      } catch (e) {
        alert("Falha ao pegar pr√≥xima.");
      } finally {
        spinner.classList.add('hidden');
        label.textContent = 'Pegar pr√≥xima';
        btnPegarProxima.disabled = !agente.online || (limitPerAgent > 0 && ativosCount >= limitPerAgent);
      }
    };

    /** ============== PRIORIDADE (mantido) ============== */
    const priorityModal = document.getElementById('priorityModal');
    const priorityTelefone = document.getElementById('priorityTelefone');
    const priorityInfo = document.getElementById('priorityInfo');
    const priorityErro = document.getElementById('priorityErro');
    const btnPriorityBuscar = document.getElementById('btnPriorityBuscar');
    const prioritySpinner = document.getElementById('prioritySpinner');
    const priorityBtnLabel = document.getElementById('priorityBtnLabel');

    btnPrioridade.onclick = () => {
      if (!agente.online) { alert('Voc√™ est√° offline. V√° na Home e clique em ‚ÄúFicar online‚Äù.'); return }
      if (limitPerAgent > 0 && ativosCount >= limitPerAgent) { elMsgLimite.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido.`; elMsgLimite.classList.remove('hidden'); return; }
      abrirPriorityModal();
    }
    function abrirPriorityModal() { isModalOpen = true; priorityInfo.classList.add('hidden'); priorityErro.classList.add('hidden'); priorityTelefone.value = ''; priorityModal.classList.remove('hidden'); setTimeout(() => priorityTelefone.focus(), 50) }
    function fecharPriorityModal() { isModalOpen = false; priorityModal.classList.add('hidden') }
    priorityTelefone.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); btnPriorityBuscar.click() } })
    function normalizarTelefone(raw) {
      let d = String(raw || '').replace(/\D/g, '');
      if (!d) return '';
      if (!d.startsWith('55')) d = '55' + d;
      const m = d.match(/^55(\d{2})(\d{8,9})(.*)$/);
      if (m) {
        const ddd = m[1];
        let numero = m[2];
        const tail = m[3] || '';
        if (numero.length === 9 && numero.startsWith('9')) numero = numero.slice(1);
        d = '55' + ddd + numero + tail
      }
      return d
    }
    function phoneIdsForCarteira() { return (carteiraToPhoneIds[agente.carteira] || []).map(String) }
    function dedupe(arr) { return Array.from(new Set(arr.filter(Boolean))) }
    async function preferPhoneIdDoContato(remetente) {
      const hit = (ordemCache || []).find(x => String(x.remetente) === String(remetente));
      if (hit && hit.phone_id) return String(hit.phone_id);
      try {
        const r = await fetch(`${CONV_API}/api/conversas/contatos`);
        const all = await r.json();
        const ids = phoneIdsForCarteira();
        const c = (all || []).find(x => ids.includes(String(x.phone_id)) && String(x.remetente) === String(remetente));
        return c ? String(c.phone_id) : null;
      } catch { return null }
    }
    async function tentarClaimComIds(remetente, ids) {
      const candidatos = [];
      if (ids && ids.length) { candidatos.push(ids); ids.forEach(id => candidatos.push([id])); }
      else { candidatos.push([]) }
      for (const arr of candidatos) {
        const body = { codigo_do_agente: parseInt(agente.codigo, 10), carteira: agente.carteira, remetente, ...(arr.length ? { phone_id: arr } : {}), prioridade: true };
        const r = await fetch(`${CONV_API}/api/tickets/claim`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const data = await r.json().catch(() => ({ ok: false, erro: 'Falha na resposta' }));
        if (r.status === 404) continue;
        return data;
      }
      return { ok: false, erro: 'Contato n√£o est√° na fila desta carteira.' };
    }
    btnPriorityBuscar.onclick = async () => {
      priorityInfo.classList.add('hidden'); priorityErro.classList.add('hidden');
      if (limitPerAgent > 0 && ativosCount >= limitPerAgent) { priorityErro.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido.`; priorityErro.classList.remove('hidden'); return; }
      const nrm = normalizarTelefone(priorityTelefone.value);
      if (nrm.length < 11) { priorityErro.textContent = 'Informe ao menos DDI (55) + DDD (2) + n√∫mero (8).'; priorityErro.classList.remove('hidden'); return; }
      priorityInfo.innerHTML = `Buscando por: <code>${nrm}</code>`; priorityInfo.classList.remove('hidden');
      const preferido = await preferPhoneIdDoContato(nrm);
      const ordemIds = dedupe([preferido, ...phoneIdsForCarteira()]);
      btnPriorityBuscar.disabled = true; prioritySpinner.classList.remove('hidden'); priorityBtnLabel.textContent = 'Solicitando‚Ä¶';
      try {
        const data = await tentarClaimComIds(nrm, ordemIds);
        if (data && (data.limit_per_agent !== undefined)) { limitPerAgent = Number(data.limit_per_agent || 0); ativosCount = Number(data.ativos || ativosCount); priorityErro.textContent = data.erro || `Limite de ${limitPerAgent} atingido.`; priorityErro.classList.remove('hidden'); await refreshAtivosELimite(); return; }
        if (data && data.ok && data.ticket) {
          priorityInfo.innerHTML = `<span class="text-emerald-700 font-medium">Prioridade concedida.</span> Abrindo o ticket‚Ä¶`;
          if (!tickets.find(t => t.remetente === data.ticket.remetente && t.phone_id === data.ticket.phone_id)) { tickets.unshift(data.ticket); saveTickets(); renderTickets(); }
          fecharPriorityModal(); abrirTicket(data.ticket); ativosCount++; renderAtivosLimiteUI(); return;
        }
        if (data && (data.assigned_to || data.atendimento)) {
          const owner = data.assigned_to || data.atendimento;
          priorityErro.innerHTML = `Outro agente j√° est√° atendendo: <strong>${escapeHtml(owner.nome || '‚Äî')}</strong> (#${escapeHtml(String(owner.codigo || '‚Äî'))}).`;
          priorityErro.classList.remove('hidden'); return;
        }
        priorityErro.textContent = (data && (data.erro || data.message)) || 'N√£o foi poss√≠vel conceder prioridade.'; priorityErro.classList.remove('hidden');
      } catch (e) { priorityErro.textContent = 'Falha ao solicitar prioridade.'; priorityErro.classList.remove('hidden') }
      finally { btnPriorityBuscar.disabled = false; prioritySpinner.classList.add('hidden'); priorityBtnLabel.textContent = 'Buscar e solicitar' }
    };

    /** ============== LISTA / CHAT ============== */
    function getCss(varName) { return getComputedStyle(document.documentElement).getPropertyValue(varName).trim() }

    function renderTickets(filtro = "") {
      const q = (filtro || "").toLowerCase().trim();
      const frag = document.createDocumentFragment();
      elListaTickets.innerHTML = "";

      tickets.forEach(t => {
        const nome = t.nome_exibicao || t.remetente;
        const hay = `${nome} ${t.remetente}`.toLowerCase();
        if (q && !hay.includes(q)) return;

        const li = document.createElement("li");
        li.className = "ticket-item relative flex items-center p-3 cursor-pointer border-b";
        li.style.borderColor = getCss('--border');
        li.onclick = () => abrirTicket(t);

        const key = keyFrom(t.remetente, t.phone_id);
        const unread = unreadCountByKey[key] || 0;
        const badge = unread > 0 ? `<span class="badge absolute right-2 top-2">${unread}</span>` : "";
        const hora = t.data_hora ? fmtHoraBR.format(new Date(t.data_hora)) : "";

        li.innerHTML = `
          <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 font-medium" style="background:${gerarCor(nome)};color:#fff;">${(nome || "U").charAt(0).toUpperCase()}</div>
          <div class="flex-1 min-w-0">
            <div class="font-semibold truncate">${escapeHtml(nome)}</div>
            <div class="text-sm muted truncate">${escapeHtml(t.mensagem_final ? t.mensagem_final.slice(0, 70) : "")}</div>
          </div>
          <div class="text-xs muted pl-2">${hora}</div>
          ${badge}
        `;
        if (selecionado && selecionado.remetente === t.remetente && selecionado.phone_id === t.phone_id) li.classList.add("ticket-selected");
        frag.appendChild(li);
      });

      elListaTickets.appendChild(frag);
    }

    async function abrirTicket(t) {
      selecionado = t;

      const phoneIdEl = document.getElementById('envIndPhoneId');
      if (phoneIdEl && t?.phone_id) phoneIdEl.value = String(t.phone_id || '');
      envIndUpdatePhoneIdLabel(phoneIdEl?.value || '');
      envIndSetPreview();

      try {
        const k = keyFrom(t.remetente, t.phone_id);
        unreadCountByKey[k] = 0;
        lastContatoTsByKey[k] = Date.now();
        persistUnread();
      } catch { }

      renderTickets();

      elTitulo.textContent = t.nome_exibicao ? `${t.nome_exibicao} (${t.remetente})` : t.remetente;
      elSubInfo.textContent = `conta: ${phoneIdMap[t.phone_id] || t.phone_id}`;
      textarea.disabled = false;
      textarea.focus();
      btnEnviar.disabled = true;
      btnLiberar.disabled = false;
      btnConcluir.disabled = false;

      if (msgsCtrl) { try { msgsCtrl.abort() } catch { } }
      msgsCtrl = new AbortController();

      lastTimestampMs = null;
      lastDayRendered = null;
      renderedKeys.clear();
      chat.innerHTML = "";

      await carregarMensagens(false);
      schedulePolls();
      wireComposer();
    }

    async function carregarMensagens(incremental = true) {
      if (!selecionado) return;
      let url = `${CONV_API}/api/conversas/${encodeURIComponent(selecionado.remetente)}`;
      if (selecionado.phone_id) url += `?phone_id=${encodeURIComponent(selecionado.phone_id)}`;

      try {
        const r = await fetch(url, { signal: msgsCtrl?.signal });
        if (!r.ok) throw new Error("Erro hist√≥rico");
        const msgs = await r.json();
        msgs.sort((a, b) => new Date(a.data_hora) - new Date(b.data_hora));

        if (!incremental) { chat.innerHTML = ""; lastTimestampMs = null; lastDayRendered = null; renderedKeys.clear(); }

        const isNearBottom = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 200;
        msgs.forEach(m => renderMsg(m, incremental));
        if (isNearBottom) requestAnimationFrame(() => chat.scrollTo({ top: chat.scrollHeight, behavior: "smooth" }));
      } catch (e) {
        if (String(e?.name) !== "AbortError") console.error(e)
      }
    }

    function renderMsg(m, incremental) {
      const tMs = new Date(m.data_hora).getTime();
      const key = `${m.data_hora}|${m.status}|${m.mensagem_final || m.tipo || ""}`;
      if (renderedKeys.has(key)) return;
      if (incremental && lastTimestampMs !== null && tMs <= lastTimestampMs) return;

      const dia = fmtDataBR.format(new Date(m.data_hora));
      const hora = fmtHoraBR.format(new Date(m.data_hora));
      if (!lastDayRendered || lastDayRendered !== dia) {
        const sep = document.createElement("div");
        sep.className = "dia";
        sep.textContent = `‚Äî ${dia} ‚Äî`;
        chat.appendChild(sep);
        lastDayRendered = dia;
      }

      const incoming = isIncoming(m);
      const div = document.createElement("div");
      div.className = `msg ${incoming ? 'recebida' : 'enviada'}`;

      if (m.tipo === "imagem" || m.mensagem_final === "[image]") {
        div.innerHTML = `<div class="muted italic">[imagem recebida]</div><button class="btn-olhinho underline mt-1" style="color:var(--link)">üëÅ Ver imagem</button><span class="hora">${hora}</span>`;
        const btn = div.querySelector(".btn-olhinho");
        if (!m.msg_id) { btn.disabled = true; btn.textContent = "Imagem indispon√≠vel" }
        else btn.onclick = () => carregarImagem(div, btn, m.msg_id);
      } else if (m.tipo === "audio" || m.mensagem_final === "[audio]") {
        div.innerHTML = `<div class="muted italic">[√°udio recebido]</div><button class="btn-audio underline mt-1" style="color:var(--link)">‚ñ∂ Reproduzir √°udio</button><span class="hora">${hora}</span>`;
        const btn = div.querySelector(".btn-audio");
        if (!m.msg_id) { btn.disabled = true; btn.textContent = "√Åudio indispon√≠vel" }
        else btn.onclick = () => carregarAudio(div, btn, m.msg_id);
      } else if (m.tipo === "document" || m.mensagem_final === "[document]") {
        div.innerHTML = `<div class="muted italic">[documento recebido]</div><button class="btn-doc underline mt-1" style="color:var(--link)">üìé Ver documento</button><span class="hora">${hora}</span>`;
        const btn = div.querySelector(".btn-doc");
        if (!m.msg_id) { btn.disabled = true; btn.textContent = "Documento indispon√≠vel" }
        else btn.onclick = () => carregarDocumento(div, btn, m.msg_id);
      } else if (typeof m.mensagem_final === "string" && m.mensagem_final.startsWith("üìé PDF:")) {
        const lines = m.mensagem_final.split("\n");
        const filename = (lines[0] || "").replace("üìé PDF:", "").trim() || "Arquivo";
        const link = (lines[1] || "").replace("üîó", "").trim();
        div.innerHTML = `<div class="flex items-start gap-2"><div class="text-xl leading-none">üìÑ</div><div class="min-w-0"><div class="font-semibold">${escapeHtml(filename)}</div>${link ? `<a href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer" class="underline break-all" style="color:var(--link)">Abrir/baixar</a>` : `<span class="muted">sem link</span>`}</div></div><span class="hora">${hora}</span>`;
      } else {
        div.innerHTML = `<div>${escapeHtml(m.mensagem_final || "")}</div><span class="hora">${hora}</span>`;
      }

      chat.appendChild(div);
      renderedKeys.add(key);
      if (lastTimestampMs === null || tMs > lastTimestampMs) lastTimestampMs = tMs;
    }

    async function carregarImagem(div, btn, msg_id) {
      btn.disabled = true; btn.textContent = "‚è≥ Carregando‚Ä¶";
      try {
        const r = await fetch(`${CONV_API}/api/conversas/image/${encodeURIComponent(msg_id)}`);
        const j = await r.json();
        if (j.ok && j.data_uri) {
          const img = document.createElement("img");
          img.src = j.data_uri;
          img.alt = "Imagem";
          img.className = "thumb mt-2";
          img.loading = "lazy";
          img.decoding = "async";
          img.onclick = () => abrirModalImagem(j.data_uri);
          div.insertBefore(img, btn);
          btn.remove();
        } else throw new Error(j.erro || "Resposta inv√°lida");
      } catch {
        alert("Erro ao carregar imagem");
        btn.disabled = false; btn.textContent = "üëÅ Ver imagem";
      }
    }
    async function carregarAudio(div, btn, msg_id) {
      btn.disabled = true; btn.textContent = "‚è≥ Carregando‚Ä¶";
      try {
        const r = await fetch(`${CONV_API}/api/conversas/audio/${encodeURIComponent(msg_id)}`);
        const j = await r.json().catch(() => ({}));
        if (j.ok && j.data_uri) {
          const audio = document.createElement("audio");
          audio.controls = true;
          audio.src = j.data_uri;
          audio.className = "mt-2";
          div.insertBefore(audio, btn);
          btn.remove();
        } else if (j.ok && j.url) {
          const a = document.createElement("a");
          a.href = j.url;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = "Abrir √°udio";
          a.className = "underline mt-2 inline-block";
          a.style.color = "var(--link)";
          div.insertBefore(a, btn);
          btn.remove();
        } else throw new Error(j.erro || "Resposta inv√°lida");
      } catch {
        alert("Erro ao carregar √°udio");
        btn.disabled = false; btn.textContent = "‚ñ∂ Reproduzir √°udio";
      }
    }
    async function carregarDocumento(div, btn, msg_id) {
      btn.disabled = true; btn.textContent = "‚è≥ Carregando‚Ä¶";
      try {
        const r = await fetch(`${CONV_API}/api/conversas/document/${encodeURIComponent(msg_id)}`);
        const j = await r.json().catch(() => ({}));
        if (j.ok && j.url) {
          const a = document.createElement("a");
          a.href = j.url;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = "Abrir documento";
          a.className = "underline mt-2 inline-block";
          a.style.color = "var(--link)";
          div.insertBefore(a, btn);
          btn.remove();
        } else if (j.ok && j.data_uri) {
          const a = document.createElement("a");
          a.href = j.data_uri;
          a.download = "documento";
          a.textContent = "Baixar documento";
          a.className = "underline mt-2 inline-block";
          a.style.color = "var(--link)";
          div.insertBefore(a, btn);
          btn.remove();
        } else throw new Error(j.erro || "Resposta inv√°lida");
      } catch {
        alert("Erro ao carregar documento");
        btn.disabled = false; btn.textContent = "üìé Ver documento";
      }
    }

    // Modal imagem
    const imageModal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImg');
    const closeImgBtn = document.getElementById('closeModal');
    function abrirModalImagem(src) { try { isModalOpen = true; modalImg.src = src || ""; imageModal.classList.remove('hidden'); } catch { } }
    function fecharModalImagem() { try { imageModal.classList.add('hidden'); modalImg.src = ""; isModalOpen = false; } catch { } }
    if (closeImgBtn) closeImgBtn.addEventListener('click', fecharModalImagem);
    if (imageModal) imageModal.addEventListener('click', (e) => { if (e.target === imageModal) fecharModalImagem(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !imageModal.classList.contains('hidden')) fecharModalImagem(); });

    function responderMensagem(msgId, conteudo) {
      respostaMsgId = msgId || null;
      document.getElementById("respostaPreview").classList.remove("hidden");
      document.getElementById("respostaTexto").innerText = (conteudo || "").slice(0, 50);
      textarea.focus()
    }
    function cancelarResposta() { respostaMsgId = null; document.getElementById("respostaPreview").classList.add("hidden"); document.getElementById("respostaTexto").innerText = "" }

    // Composer
    function wireComposer() {
      textarea.removeEventListener('input', __onTextInput);
      textarea.removeEventListener('keydown', __onTextKeydown);
      btnEnviar.removeEventListener('click', enviarMensagem);

      textarea.addEventListener('input', __onTextInput);
      textarea.addEventListener('keydown', __onTextKeydown);
      btnEnviar.addEventListener('click', enviarMensagem);

      updateEnviarState();
    }
    function autoGrow() { textarea.style.height = 'auto'; textarea.style.height = Math.min(180, Math.max(38, textarea.scrollHeight)) + 'px' }
    function updateEnviarState() {
      const hasText = !!textarea.value.trim();
      btnEnviar.disabled = !hasText || !selecionado;
      if (hasText && selecionado) showTyping(); else hideTyping();
    }
    function showTyping() { digitando.classList.remove('hidden'); if (typingTimer) clearTimeout(typingTimer); typingTimer = setTimeout(hideTyping, 1200) }
    function hideTyping() { digitando.classList.add('hidden'); if (typingTimer) { clearTimeout(typingTimer); typingTimer = null } }
    function __onTextInput() { autoGrow(); updateEnviarState() }
    function __onTextKeydown(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if (!btnEnviar.disabled) enviarMensagem(); return false } showTyping() }

    async function enviarMensagem() {
      if (!selecionado) return;
      const texto = textarea.value.trim();
      if (!texto) return;

      userTyping = true;
      btnEnviar.disabled = true;

      try {
        const body = { texto, phone_id: selecionado.phone_id, msg_id: respostaMsgId || null };
        const r = await fetch(`${CONV_API}/api/conversas/${encodeURIComponent(selecionado.remetente)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if (j.ok) {
          textarea.value = "";
          autoGrow();
          cancelarResposta();
          hideTyping();
          await carregarMensagens(true);
        } else {
          alert("Erro ao enviar: " + (j.erro || JSON.stringify(j)));
        }
      } catch (e) {
        alert("Erro ao enviar mensagem. Verifique rede/CORS.");
      } finally {
        userTyping = false;
        updateEnviarState();
      }
    }

    function limparChat() {
      chat.innerHTML = `<p id="loading" class="text-center muted">Pegue uma conversa para iniciar‚Ä¶</p>`;
      textarea.value = "";
      textarea.disabled = true;
      btnEnviar.disabled = true;
      cancelarResposta();
    }

    /** ============== PDF (fallback robusto) ============== */
    async function enviarPDF(event) {
      if (!selecionado) { showModalFeedback('Selecione um ticket antes de enviar PDF.', 'PDF', 1400); return; }
      const file = event?.target?.files?.[0];
      if (!file) return;

      if (file.size > 25 * 1024 * 1024) { showModalFeedback('PDF muito grande (limite 25MB).', 'PDF', 1600); event.target.value = ""; return; }

      const form = new FormData();
      form.append('file', file);
      form.append('remetente', selecionado.remetente);
      form.append('phone_id', String(selecionado.phone_id || ''));

      const candidates = [
        `${CONV_API}/api/conversas/pdf`,
        `${CONV_API}/api/conversas/document`,
        `${API_BASE}/api/upload/pdf`,
        `${API_BASE}/api/upload/document`,
      ];

      try {
        showModalFeedback('Enviando PDF‚Ä¶', 'PDF', 900);
        for (const url of candidates) {
          try {
            const r = await fetch(url, { method: 'POST', body: form });
            if (r.status === 404) continue;
            const j = await r.json().catch(() => ({}));
            if (r.ok && (j.ok || j.url || j.link)) {
              showModalFeedback('PDF enviado.', 'PDF', 1200);
              await carregarMensagens(true);
              event.target.value = "";
              return;
            }
          } catch { }
        }
        alert('N√£o consegui enviar o PDF: endpoint n√£o encontrado/configurado.');
      } finally {
        event.target.value = "";
      }
    }

    /** ============== PAINEL DE AVISOS (m√≠nimo seguro) ============== */
    function noticesKey() { return `cz:notices_read:${agente?.carteira || 'cart'}:${agente?.codigo || 'anon'}` }
    function loadNoticesReadSet() {
      try {
        const raw = localStorage.getItem(noticesKey());
        const arr = raw ? JSON.parse(raw) : [];
        return new Set(Array.isArray(arr) ? arr : []);
      } catch { return new Set(); }
    }
    function persistNoticesReadSet() {
      try { localStorage.setItem(noticesKey(), JSON.stringify(Array.from(noticesReadSet))); } catch { }
    }
    function sevClass(n) {
      const s = String(n || '').toLowerCase();
      if (s.includes('crit')) return 'sev-crit';
      if (s.includes('warn')) return 'sev-warn';
      if (s.includes('info')) return 'sev-info';
      return 'sev-success';
    }
    function normalizeNotice(n) {
      const id = n.id || n.notice_id || n.uuid || hashId(JSON.stringify(n));
      const titulo = n.titulo || n.title || n.assunto || 'Aviso';
      const corpo = n.mensagem || n.body || n.texto || n.text || '';
      const created = n.created_at || n.data_hora || n.data || n.created || null;
      const nivel = n.nivel || n.severidade || n.level || (n.critico ? 'crit' : 'info');
      const tags = n.tags || n.carteiras || n.tag || [];
      return { id: String(id), titulo, corpo, created, nivel, tags };
    }
    function noticeIsRead(id) { return noticesReadSet.has(String(id)); }

    function renderHero() {
      if (!heroWrap) return;
      const unread = notices.filter(n => !noticeIsRead(n.id));
      if (!unread.length) { heroWrap.classList.add('hidden'); return; }

      // escolhe primeiro cr√≠tico ou o mais recente
      let pick = unread.find(n => String(n.nivel).toLowerCase().includes('crit')) || unread[0];
      heroWrap.classList.remove('hidden');
      heroTitle.textContent = pick.titulo || 'Aviso';
      heroMeta.textContent = pick.created ? `Publicado em ${fmtDataBR.format(new Date(pick.created))}` : 'Publicado agora';
      heroBody.textContent = pick.corpo || '';

      heroDismiss.onclick = () => { heroWrap.classList.add('hidden'); };
      heroMarkRead.onclick = () => {
        noticesReadSet.add(String(pick.id));
        persistNoticesReadSet();
        renderNotices();
        renderHero();
      };
    }

    function renderNotices() {
      if (!avisosWrap) return;

      const all = notices || [];
      const unread = all.filter(n => !noticeIsRead(n.id));
      const showUnreadFilterBtn = document.querySelector('[data-avisos-filter="unread"]');
      if (showUnreadFilterBtn) showUnreadFilterBtn.style.display = unread.length ? '' : 'none';

      avisosCountPill.textContent = `${unread.length}/${all.length}`;
      avisosResumo.textContent = all.length ? `${unread.length} n√£o lido(s).` : 'Nenhum aviso dispon√≠vel.';

      const list = (noticesFilter === 'unread') ? unread : all;

      avisosWrap.innerHTML = '';
      list.forEach(n => {
        const isRead = noticeIsRead(n.id);
        const wrap = document.createElement('div');
        wrap.className = `notice ${isRead ? '' : 'unread'} ${String(n.nivel).toLowerCase().includes('crit') ? 'crit' : ''}`;

        const createdTxt = n.created ? `${fmtDataBR.format(new Date(n.created))} ${fmtHoraBR.format(new Date(n.created))}` : '';
        const tagsArr = Array.isArray(n.tags) ? n.tags : (n.tags ? [String(n.tags)] : []);

        wrap.innerHTML = `
          <div class="notice-head">
            <div class="notice-left">
              <div class="sev ${sevClass(n.nivel)}"></div>
              <div class="min-w-0">
                <div class="notice-title">${escapeHtml(n.titulo)} ${String(n.nivel).toLowerCase().includes('crit') ? '<span class="crit-badge">CR√çTICO</span>' : ''}</div>
                <div class="notice-meta">
                  ${createdTxt ? `<span>üïí ${escapeHtml(createdTxt)}</span>` : ''}
                  <span>üÜî ${escapeHtml(n.id)}</span>
                </div>
                ${tagsArr.length ? `<div class="notice-tags mt-2">${tagsArr.map(t => `<span class="tag">${escapeHtml(String(t))}</span>`).join(' ')}</div>` : ''}
              </div>
            </div>
            <div class="notice-actions">
              <button type="button" data-act="read">Marcar lido</button>
              <button type="button" data-act="dismiss">Dispensar</button>
            </div>
          </div>
          <div class="notice-body">${escapeHtml(n.corpo || '')}</div>
        `;

        wrap.querySelector('[data-act="read"]').onclick = () => {
          noticesReadSet.add(String(n.id));
          persistNoticesReadSet();
          renderNotices();
          renderHero();
        };
        wrap.querySelector('[data-act="dismiss"]').onclick = () => {
          // "dispensar" aqui √© s√≥ esconder localmente (n√£o remove do backend)
          noticesReadSet.add(String(n.id));
          persistNoticesReadSet();
          renderNotices();
          renderHero();
        };

        avisosWrap.appendChild(wrap);
      });

      document.querySelectorAll('.filter-btn[data-avisos-filter]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.avisosFilter === noticesFilter);
      });
    }

    async function loadNoticesAndRender() {
      try {
        const r = await fetch(NOTICES_API(), { cache: 'no-store' });
        const j = await r.json().catch(() => ([]));
        const arr = Array.isArray(j) ? j : (Array.isArray(j?.avisos) ? j.avisos : []);
        notices = arr.map(normalizeNotice);
      } catch {
        notices = [];
      }
      renderNotices();
      renderHero();
    }

    if (btnAvisoRefresh) btnAvisoRefresh.onclick = loadNoticesAndRender;
    document.querySelectorAll('.filter-btn[data-avisos-filter]').forEach(btn => {
      btn.addEventListener('click', () => {
        noticesFilter = btn.dataset.avisosFilter || 'all';
        renderNotices();
      });
    });

    /** ============== RELAT√ìRIO (fallback robusto) ============== */
    function ensurePieCharts() {
      const ctx1 = document.getElementById('pieStatus')?.getContext?.('2d');
      const ctx2 = document.getElementById('pieMotivos')?.getContext?.('2d');
      if (!ctx1 || !ctx2) return;

      if (!pieChart) {
        pieChart = new Chart(ctx1, { type: 'pie', data: { labels: [], datasets: [{ data: [] }] }, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
      }
      if (!chartMotivos) {
        chartMotivos = new Chart(ctx2, { type: 'pie', data: { labels: [], datasets: [{ data: [] }] }, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
      }
    }

    async function fetchFirstJson(urls) {
      for (const url of urls) {
        try {
          const r = await fetch(url, { cache: 'no-store' });
          if (r.status === 404) continue;
          const j = await r.json().catch(() => null);
          if (r.ok && j != null) return { ok: true, url, data: j };
        } catch { }
      }
      return { ok: false, url: null, data: null };
    }

    function setRelPeriodoLabel() {
      const a = relStart.value, b = relEnd.value;
      if (!a || !b) { relPeriodo.textContent = '‚Äî'; return; }
      relPeriodo.textContent = (a === b) ? `Dia ${a}` : `${a} ‚Üí ${b}`;
    }

    async function refreshKPIs() {
      try {
        ensurePieCharts();
        if (!agente?.codigo) return;

        setRelPeriodoLabel();

        const start = relStart?.value || fmtYMD(new Date());
        const end = relEnd?.value || start;

        const urls = [
          `${API_BASE}/api/relatorio/agente?codigo=${encodeURIComponent(agente.codigo)}&inicio=${encodeURIComponent(start)}&fim=${encodeURIComponent(end)}`,
          `${CONV_API}/api/relatorio/agente?codigo=${encodeURIComponent(agente.codigo)}&inicio=${encodeURIComponent(start)}&fim=${encodeURIComponent(end)}`,
          `${API_BASE}/api/relatorio/individual?agente=${encodeURIComponent(agente.codigo)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`,
          `${CONV_API}/api/relatorio/individual?agente=${encodeURIComponent(agente.codigo)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`
        ];

        const res = await fetchFirstJson(urls);

        // fallback simples
        let em = 0, conc = 0, tma = null, frt = null;
        let statusDist = null, motivosDist = null, extrato = null;

        if (res.ok) {
          const j = res.data;

          em = Number(j.em_atendimento ?? j.em ?? j.ativos ?? 0) || 0;
          conc = Number(j.concluidos ?? j.conc ?? j.finalizados ?? 0) || 0;

          const tmaMin = j.tma_min ?? j.tma ?? j.tma_media_min;
          const frtSeg = j.frt_seg ?? j.frt ?? j.primeira_resposta_seg;

          tma = (tmaMin == null) ? null : Number(tmaMin);
          frt = (frtSeg == null) ? null : Number(frtSeg);

          statusDist = j.status_dist || j.distribuicao_status || j.pie_status || null;
          motivosDist = j.motivos_dist || j.distribuicao_motivos || j.pie_motivos || null;
          extrato = j.extrato || j.motivos_por_dia || null;
        }

        kpiEm.textContent = String(em);
        kpiConc.textContent = String(conc);
        kpiTma.textContent = (tma == null || Number.isNaN(tma)) ? '‚Äî' : String(Math.round(tma));
        kpiFRT.textContent = (frt == null || Number.isNaN(frt)) ? '‚Äî' : String(Math.round(frt));

        // pie charts
        if (pieChart) {
          const map = statusDist && typeof statusDist === 'object' ? statusDist : { "Em atendimento": em, "Conclu√≠dos": conc };
          pieChart.data.labels = Object.keys(map);
          pieChart.data.datasets[0].data = Object.values(map).map(x => Number(x) || 0);
          pieChart.update();
        }
        if (chartMotivos) {
          const map = motivosDist && typeof motivosDist === 'object' ? motivosDist : {};
          chartMotivos.data.labels = Object.keys(map);
          chartMotivos.data.datasets[0].data = Object.values(map).map(x => Number(x) || 0);
          chartMotivos.update();
        }

        // extrato
        renderExtrato(extrato);

      } catch (e) {
        console.warn("Falha no relat√≥rio:", e);
      }
    }

    function renderExtrato(data) {
      if (!extratoWrap) return;

      if (!data) {
        extratoWrap.innerHTML = `<div class="p-3 text-sm muted">Sem dados.</div>`;
        return;
      }

      // formatos aceitos: array de dias, ou objeto { "2025-12-01": {...} }
      let days = [];
      if (Array.isArray(data)) {
        days = data;
      } else if (typeof data === 'object') {
        days = Object.entries(data).map(([dia, v]) => ({ dia, ...(typeof v === 'object' ? v : { total: v }) }));
      }

      if (!days.length) {
        extratoWrap.innerHTML = `<div class="p-3 text-sm muted">Sem dados.</div>`;
        return;
      }

      extratoWrap.innerHTML = '';
      days.forEach((row, idx) => {
        const dia = row.dia || row.data || row.day || `Dia ${idx + 1}`;
        const motivos = row.motivos || row.itens || row.items || row;
        const details = (typeof motivos === 'object' && !Array.isArray(motivos))
          ? Object.entries(motivos).filter(([k]) => !['dia', 'data', 'day'].includes(k)).map(([k, v]) => `${k}: ${v}`).join('\n')
          : '';

        const item = document.createElement('div');
        item.className = 'extrato-item';
        item.innerHTML = `
          <button class="extrato-header" type="button" aria-expanded="false">
            <div class="min-w-0">
              <div class="font-semibold">${escapeHtml(String(dia))}</div>
              <div class="extrato-meta">${details ? escapeHtml(details.split('\n')[0]) : '‚Äî'}</div>
            </div>
            <div class="extrato-chevron">‚ñæ</div>
          </button>
          <div class="extrato-content hidden">
            <pre class="codeblock">${escapeHtml(details || '‚Äî')}</pre>
          </div>
        `;
        const btn = item.querySelector('.extrato-header');
        const content = item.querySelector('.extrato-content');
        btn.onclick = () => {
          const open = !content.classList.contains('hidden');
          content.classList.toggle('hidden', open);
          btn.setAttribute('aria-expanded', open ? 'false' : 'true');
        };
        extratoWrap.appendChild(item);
      });
    }

    if (btnRefreshRel) btnRefreshRel.onclick = refreshKPIs;
    if (btnExtratoRefresh) btnExtratoRefresh.onclick = refreshKPIs;
    document.querySelectorAll('[data-qk]').forEach(b => {
      b.addEventListener('click', () => {
        const qk = b.dataset.qk;
        const now = new Date();
        const ymd = fmtYMD(now);
        const minusDays = (n) => { const d = new Date(now); d.setDate(d.getDate() - n); return fmtYMD(d); };

        if (qk === 'hoje') { relStart.value = ymd; relEnd.value = ymd; }
        if (qk === 'ontem') { relStart.value = minusDays(1); relEnd.value = minusDays(1); }
        if (qk === '7d') { relStart.value = minusDays(6); relEnd.value = ymd; }
        if (qk === '30d') { relStart.value = minusDays(29); relEnd.value = ymd; }

        refreshKPIs();
      });
    });

    /** ============== PENDENTES NA FILA (Home) ‚Äî 60s ============== */
    const PENDENTES_REFRESH_MS = 60000;
    let pendentesInterval = null;

    function PENDENTES_API_CANDIDATES() {
      const cart = agente?.carteira || '';
      const params = cart ? `?carteira=${encodeURIComponent(cart)}` : '';
      return [
        `${FILA_API}/fila/pendentes${params}`,
        `${FILA_API}/fila/pendentes_por_carteira${params}`
      ];
    }
    function extractPendentesCount(payload) {
      if (payload == null) return null;
      if (typeof payload === 'number') return payload;
      if (Array.isArray(payload)) {
        const cart = agente?.carteira;
        let row = null;
        if (cart) {
          row = payload.find(r =>
            (r && (
              (r.carteira && String(r.carteira) === String(cart)) ||
              (r.fila && String(r.fila) === String(cart)) ||
              (r.nome && String(r.nome) === String(cart))
            )));
        }
        if (!row && payload.length === 1) row = payload[0];
        if (row) {
          for (const k of ['pendentes', 'qtd', 'qtde', 'total', 'count', 'qtd_pendentes']) {
            const v = Number(row[k]);
            if (!Number.isNaN(v)) return v;
          }
        }
        const nums = payload.map(x => Number(x)).filter(v => !Number.isNaN(v));
        if (nums.length) return nums.reduce((a, b) => a + b, 0);
        return null;
      }
      if (typeof payload === 'object') {
        for (const k of ['pendentes', 'qtd', 'qtde', 'total', 'count', 'qtd_pendentes']) {
          const v = Number(payload[k]);
          if (!Number.isNaN(v) && v >= 0) return v;
        }
        const cart = agente?.carteira;
        if (cart && payload[cart] != null) {
          const v = Number(payload[cart]);
          if (!Number.isNaN(v)) return v;
        }
      }
      return null;
    }
    async function fetchPendentesFilaOnce() {
      if (!agente?.carteira) return null;
      const els = [document.getElementById('homePendentesBadge')].filter(Boolean);
      const setLoading = () => els.forEach(e => e && (e.textContent = '‚Ä¶'));
      const setVal = (n) => els.forEach(e => e && (e.textContent = String(n)));
      try {
        setLoading();
        const urls = PENDENTES_API_CANDIDATES();
        for (const url of urls) {
          try {
            const r = await fetch(url);
            if (!r.ok) continue;
            const j = await r.json();
            const n = extractPendentesCount(j);
            if (n != null) { setVal(n); return n; }
          } catch (_) { }
        }
        setVal('‚Äî');
        return null;
      } catch {
        setVal('‚Äî');
        return null;
      }
    }
    function initPendentesFila() {
      if (pendentesInterval) clearInterval(pendentesInterval);
      fetchPendentesFilaOnce();
      pendentesInterval = setInterval(fetchPendentesFilaOnce, PENDENTES_REFRESH_MS);
    }

    /** ============== BOOT ============== */
    async function boot() {
      const savedT = loadTheme();
      applyTheme(savedT || defaultTheme());
      try { syncThemeInputs(currentTheme); } catch (_) { }

      agente.codigo = localStorage.getItem("agente_codigo") || qsParam("codigo") || null;
      agente.origem = localStorage.getItem("agente_origem") || qsParam("origem") || 'web';

      updateAuthButton();
      toggleLoginLocks();

      const today = new Date();
      const ymd = fmtYMD(today);
      if (relStart) relStart.value = ymd;
      if (relEnd) relEnd.value = ymd;

      noticesReadSet = loadNoticesReadSet();

      if (!agente.codigo) {
        elHomeNome.textContent = '‚Äî';
        elHomeCart.textContent = '‚Äî';
        setStatus(false);
        relAgentePill.textContent = '‚Äî';
        await loadNoticesAndRender();
        abrirModalLogin();
        return;
      }

      try {
        const r = await fetch(`${FILA_API}/agentes/${encodeURIComponent(agente.codigo)}`);
        const j = await r.json();
        if (!j.ok) throw new Error(j.erro || "Agente n√£o encontrado");

        agente.nome = j.agente?.nome || localStorage.getItem("agente_nome") || `Agente ${agente.codigo}`;
        agente.carteira = j.agente?.carteira || localStorage.getItem("agente_carteira") || 'ConnectZap';
        agente.origem_bd = j.agente?.origem_bd || localStorage.getItem("agente_origem_bd") || "";

        localStorage.setItem("agente_nome", agente.nome);
        localStorage.setItem("agente_carteira", agente.carteira);
        localStorage.setItem("agente_origem_bd", agente.origem_bd || "");
        localStorage.setItem("agente_permite_envio_individual", String(!!j.agente?.permite_envio_individual));

        renderPermissaoEnvioIndividual();

        elAgenteNome.textContent = `${agente.nome} (#${agente.codigo})`;
        elAgenteCarteira.textContent = agente.carteira;
        elHomeNome.textContent = agente.nome;
        elHomeCart.textContent = agente.carteira;
        relAgentePill.textContent = `${agente.nome} (#${agente.codigo})`;

        loadUnread();
        await verificarOnline();

        try {
          const url = `${CONV_API}/api/tickets/minhas?agente=${encodeURIComponent(agente.codigo)}&carteira=${encodeURIComponent(agente.carteira)}`;
          const r2 = await fetch(url);
          if (r2.ok) { tickets = await r2.json(); saveTickets(); }
        } catch { }

        renderTickets();
        schedulePolls();
        await refreshOrdemCarteira();
        await refreshAtivosELimite();

        await refreshKPIs();
        await loadNoticesAndRender();
        initPendentesFila();

        wireComposer();
        initEnvioIndividual();
      } catch (e) {
        elHomeAviso.classList.remove("hidden");
        elHomeAviso.textContent = "Falha ao carregar agente. Verifique seu c√≥digo ou API.";
        await loadNoticesAndRender();
      }
    }

    /** ============== LOGOUT ============== */
    async function doLogout() {
      try { btnLogout.textContent = 'Saindo‚Ä¶'; btnLogout.disabled = true; } catch { }

      // tenta ficar offline, mas logout n√£o depende disso
      try {
        if (agente?.codigo && agente?.carteira) {
          await fetch(`${FILA_API}/fila/offline`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo, 10), carteira: agente.carteira })
          }).catch(() => null);
        }
      } catch { }

      // limpa timers/polls
      try { if (pollingContatos) clearInterval(pollingContatos); } catch { }
      try { if (pollingMensagens) clearInterval(pollingMensagens); } catch { }
      try { if (pendentesInterval) clearInterval(pendentesInterval); } catch { }
      try { if (msgsCtrl) msgsCtrl.abort(); } catch { }

      // limpa estado
      try {
        // mant√©m tema
        localStorage.removeItem("agente_codigo");
        localStorage.removeItem("agente_nome");
        localStorage.removeItem("agente_carteira");
        localStorage.removeItem("agente_origem_bd");
        localStorage.removeItem("agente_permite_envio_individual");
      } catch { }

      agente = { codigo: null, nome: null, carteira: null, origem: null, origem_bd: null, online: false };
      tickets = [];
      selecionado = null;
      renderedKeys = new Set();
      lastTimestampMs = null;
      lastDayRendered = null;

      // UI reset
      setStatus(false);
      elAgenteNome.textContent = '‚Äî';
      elAgenteCarteira.textContent = '‚Äî';
      elHomeNome.textContent = '‚Äî';
      elHomeCart.textContent = '‚Äî';
      relAgentePill.textContent = '‚Äî';
      limparChat();
      elListaTickets.innerHTML = '';
      renderPermissaoEnvioIndividual();
      toggleLoginLocks();

      hideApp();
      updateAuthButton();

      try { btnLogout.disabled = false; btnLogout.textContent = 'Login'; } catch { }

      if (LOGOUT_REDIRECT) { window.location.href = LOGOUT_REDIRECT; return; }
      abrirModalLogin();
    }

    /** ============== START ============== */
    document.addEventListener('DOMContentLoaded', async () => {
      if (isLogged()) showApp(); else hideApp();
      await boot();
      switchTab('home');
    });
  </script>
</body>

</html>
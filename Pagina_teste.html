<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ConnectZap ‚Äî Agentes (P√°gina de Teste)</title>
  <link rel="icon" href="https://joubertcastro.github.io/ConnectZap/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #3b82f6;
      --accent: #22c55e;
      --bg: #f3f4f6;
      --sidebar-bg: #ffffff;
      --content-bg: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --link: #2563eb;
      --ghost-bg: #f3f4f6;
      --ring: rgba(59, 130, 246, .35);
      --bubble-out-g1: #dcf8c6;
      --bubble-out-g2: #b8f0a4;
      --bubble-out-fg: #111827;
      --bubble-in-bg: #fff;
      --bubble-in-border: #e2e8f0;
      --bubble-in-fg: #0f172a;
      --bubble-radius: 18px;
      --btn-radius: 10px;
      --card-radius: 16px;
      --font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --font-size: 14px;
      --chat-wallpaper-opacity: 0;
      --scrollbar: #cbd5e1;
      --ticket-selected-bg: #f0f9ff;
    }

    * {
      outline-color: var(--ring)
    }

    html {
      font-size: var(--font-size)
    }

    body {
      font-family: var(--font-family);
      color: var(--text);
      background: var(--bg)
    }

    .card {
      background: var(--content-bg);
      border: 1px solid var(--border);
      border-radius: var(--card-radius)
    }

    .btn {
      border-radius: var(--btn-radius)
    }

    .btn-primary {
      background: var(--primary);
      color: #fff
    }

    .btn-primary:hover {
      filter: brightness(.95)
    }

    .btn-ghost {
      background: var(--ghost-bg)
    }

    .sidebar {
      background: var(--sidebar-bg);
      border-color: var(--border)
    }

    .topbar {
      background: var(--content-bg);
      border-color: var(--border)
    }

    .ticket-selected {
      background: var(--ticket-selected-bg) !important
    }

    .badge {
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      border-radius: 9999px;
      padding: 2px 6px;
      min-width: 18px;
      text-align: center
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 9999px;
      display: inline-block;
      margin-right: 6px
    }

    .dot.online {
      background: #16a34a
    }

    .dot.offline {
      background: #9ca3af
    }

    .msg {
      display: inline-block;
      max-width: min(70%, 560px);
      padding: 10px 14px 18px;
      margin: 6px 0;
      position: relative;
      border-radius: var(--bubble-radius);
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .10);
      transition: background .18s ease, border-color .18s ease, color .18s ease
    }

    @media (max-width:768px) {
      .msg {
        max-width: 86%
      }
    }

    .msg.enviada {
      align-self: flex-end;
      background: linear-gradient(120deg, var(--bubble-out-g1), var(--bubble-out-g2));
      color: var(--bubble-out-fg)
    }

    .msg.recebida {
      align-self: flex-start;
      background: var(--bubble-in-bg);
      border: 1px solid var(--bubble-in-border);
      color: var(--bubble-in-fg)
    }

    .msg .hora {
      position: absolute;
      right: 8px;
      bottom: 4px;
      font-size: 11px;
      color: var(--muted)
    }

    .msg.enviada::after,
    .msg.recebida::after {
      content: "";
      position: absolute;
      bottom: 0;
      width: 14px;
      height: 14px;
      clip-path: polygon(0 0, 100% 0, 0 100%)
    }

    .msg.enviada::after {
      right: -7px;
      background: linear-gradient(120deg, var(--bubble-out-g1), var(--bubble-out-g2))
    }

    .msg.recebida::after {
      left: -7px;
      background: var(--bubble-in-bg);
      border-left: 1px solid var(--bubble-in-border);
      border-bottom: 1px solid var(--bubble-in-border)
    }

    .msg img.thumb {
      max-width: 280px;
      height: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor: pointer
    }

    .msg audio {
      width: 320px;
      display: block
    }

    .dia {
      text-align: center;
      margin: 12px 0;
      font-size: 12px;
      color: var(--muted)
    }

    input[type="text"],
    input[type="search"],
    input[type="color"],
    input[type="file"],
    textarea,
    select {
      background: var(--content-bg);
      color: var(--text);
      border-color: var(--border) !important
    }

    input::placeholder,
    textarea::placeholder {
      color: color-mix(in srgb, var(--muted) 85%, var(--bg))
    }

    *::-webkit-scrollbar {
      width: 10px;
      height: 10px
    }

    *::-webkit-scrollbar-thumb {
      background: var(--scrollbar);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box
    }

    *::-webkit-scrollbar-track {
      background: transparent
    }

    /* Mini Sidebar */
    .mini-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 56px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 10px 6px;
      background: #0b1220;
      color: #e5e7eb;
      z-index: 70;
      border-right: 1px solid #111827
    }

    .mini-sidebar .btn-mini {
      width: 44px;
      height: 44px;
      display: grid;
      place-items: center;
      border-radius: 12px;
      background: transparent;
      transition: background .2s ease, transform .06s ease;
      cursor: pointer
    }

    .mini-sidebar .btn-mini:hover {
      background: #111827
    }

    .mini-sidebar .btn-mini.active {
      background: #2563eb;
      color: #fff
    }

    .with-mini {
      margin-left: 56px
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, .5);
      justify-content: center;
      align-items: center
    }

    .modal-content {
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      width: 320px;
      position: relative;
      border: 1px solid var(--border)
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 12px;
      cursor: pointer;
      font-size: 1.1rem;
      color: #555
    }

    /* Drawer */
    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: min(430px, 96%);
      height: 100%;
      background: var(--content-bg);
      border-left: 1px solid var(--border);
      box-shadow: -12px 0 24px rgba(0, 0, 0, .08);
      transform: translateX(100%);
      transition: transform .25s ease;
      z-index: 60
    }

    .drawer.open {
      transform: translateX(0)
    }
  </style>
</head>

<body class="h-screen flex with-mini">

  <!-- Mini Sidebar -->
  <nav class="mini-sidebar select-none">
    <div class="text-xs font-semibold mt-1">CZ</div>
    <button id="tabBtnHome" class="btn-mini active" title="Home" aria-label="Home">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
        <path
          d="M12 3.172 2.293 12.88a1 1 0 0 0 1.414 1.415L5 13.001V20a1 1 0 0 0 1 1h5v-6h2v6h5a 1 1 0 0 0 1-1v-6.999l1.293 1.294a1 1 0 0 0 1.414-1.415L12 3.172z" />
      </svg>
    </button>
    <button id="tabBtnConversas" class="btn-mini" title="Conversas" aria-label="Conversas">
      <svg xmlns="http://www.w33.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 2H4a2 2 0 0 0-2 2v14l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z" />
      </svg>
    </button>
    <button id="tabBtnRelatorio" class="btn-mini" title="Relat√≥rio" aria-label="Relat√≥rio">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
        <path d="M11 2a10 10 0 1 0 10 10h-8a2 2 0 0 1-2-2V2zM13 2.05V10h7.95A10.004 10.004 0 0 0 13 2.05z" />
      </svg>
    </button>
  </nav>

  <!-- Tabs Wrapper -->
  <div id="tabsWrapper" class="flex-1 flex flex-col">

    <!-- HOME -->
    <section id="tabHome" class="flex-1 p-6">
      <div class="max-w-3xl mx-auto">
        <div class="card p-6">
          <h1 class="text-2xl font-bold">Bem-vindo(a) üëã</h1>
          <p class="text-gray-600 mt-2">Ol√° <span id="homeAgenteNome" class="font-semibold">‚Äî</span>!</p>
          <p class="text-gray-600">Voc√™ est√° logado(a) na carteira <span id="homeAgenteCarteira"
              class="font-semibold">‚Äî</span>.</p>
          <div class="mt-4 p-4 rounded-lg border bg-gray-50">
            <p>Um √≥timo trabalho e boas conversas! üí¨</p>
          </div>
          <div class="mt-6 flex gap-2">
            <button id="goToConversas1" class="btn btn-primary px-4 py-2">Ir para Conversas</button>
            <button id="goToRelatorio1" class="btn px-4 py-2 bg-gray-100 hover:bg-gray-200">Ver Relat√≥rio</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CONVERSAS -->
    <section id="tabConversas" class="hidden h-full flex">
      <!-- Sidebar esquerda -->
      <aside class="sidebar w-1/3 lg:w-1/4 border-r flex flex-col">
        <div class="p-3 border-b topbar">
          <div class="flex items-center justify-between gap-2">
            <div class="min-w-0">
              <div class="text-xs text-gray-500">Agente</div>
              <div id="agenteNome" class="font-semibold truncate">‚Äî</div>
              <div class="text-xs text-gray-500">Carteira: <span id="agenteCarteira">‚Äî</span></div>
              <div class="text-xs text-gray-500">Status: <span id="agenteStatus"><span
                    class="dot offline"></span>Offline</span></div>
              <div class="mt-1 text-xs">
                <span class="text-gray-500">Tickets:</span>
                <span id="badgeAtivos" class="badge">0</span>
                <span class="text-gray-500 mx-1">/</span>
                <span id="badgeLimite" class="badge" style="background:#64748b">‚àû</span>
              </div>
            </div>
            <div class="flex flex-col items-end gap-2">
              <button id="btnToggleOnline"
                class="btn px-3 py-2 text-sm bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 flex items-center gap-2"
                disabled aria-live="polite" aria-pressed="false">
                <svg id="toggleSpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" aria-hidden="true">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none">
                  </circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
                <span id="toggleLabel">Ficar online</span>
              </button>
              <button id="btnPegarProxima"
                class="btn btn-primary px-3 py-2 text-sm text-white disabled:opacity-50 flex items-center gap-2"
                disabled>
                <svg id="pegarSpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" aria-hidden="true">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none">
                  </circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
                <span id="pegarLabel">Pegar pr√≥xima</span>
              </button>
              <button id="btnPrioridade" class="btn px-3 py-2 text-sm rounded-md text-white disabled:opacity-50"
                disabled style="background: rebeccapurple">Pedir prioridade</button>
              <div class="flex gap-2">
                <button id="btnTheme" class="btn btn-ghost px-3 py-1 text-xs" aria-haspopup="true"
                  aria-controls="themeDrawer">üé® Tema</button>
                <button id="btnLogout" class="btn btn-ghost px-3 py-1 text-xs">Logout</button>
              </div>
            </div>
          </div>
          <div id="msgAviso" class="mt-2 text-xs text-amber-600 hidden" role="alert" aria-live="polite"></div>
          <div id="msgLimite" class="mt-1 text-xs text-red-600 hidden" role="alert" aria-live="polite"></div>
        </div>

        <ul id="listaTickets" class="flex-1 overflow-y-auto" aria-label="Minhas conversas"></ul>

        <div class="p-2 text-xs text-gray-500 border-t topbar">
          Apenas conversas da sua carteira. ‚ÄúPegar pr√≥xima‚Äù usa ordem por √∫ltima mensagem <em>recebida</em>.
        </div>
      </aside>

      <!-- Chat principal -->
      <main class="flex-1 flex flex-col">
        <div class="flex items-center justify-between p-3 border-b topbar">
          <div class="min-w-0">
            <div id="tituloConversa" class="font-bold text-lg truncate">Selecione um ticket</div>
            <div id="subInfo" class="text-sm text-gray-500 truncate"></div>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnLiberar" class="btn px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 disabled:opacity-50"
              disabled>Liberar</button>
            <div class="relative">
              <button id="btnConcluir" class="btn px-3 py-2 text-sm text-white disabled:opacity-50"
                style="background:var(--accent)" disabled aria-haspopup="true" aria-expanded="false">Concluir</button>
              <div id="menuConcluir"
                class="hidden absolute right-0 mt-2 w-64 bg-white border rounded-lg shadow-lg z-20"></div>
            </div>
          </div>
        </div>

        <div class="relative flex-1 overflow-hidden">
          <div class="absolute inset-0" style="background:transparent"></div>
          <div id="chat" class="relative h-full p-4 overflow-y-auto flex flex-col space-y-1" role="log"
            aria-live="polite">
            <p id="loading" class="text-center text-gray-500">Pegue uma conversa para iniciar‚Ä¶</p>
          </div>
        </div>
        <div id="digitando" class="px-4 text-left hidden" aria-live="polite">Digitando‚Ä¶</div>

        <div id="respostaPreview"
          class="hidden px-3 py-2 border-t bg-gray-50 text-sm flex justify-between items-center">
          <div class="truncate max-w-[80%]">
            <span class="font-semibold">Respondendo:</span> <span id="respostaTexto" class="text-gray-600"></span>
          </div>
          <button onclick="cancelarResposta()" class="text-red-500 text-xs" aria-label="Cancelar resposta">‚úñ</button>
        </div>

        <div class="p-3 border-t topbar flex space-x-2 items-center">
          <input type="file" id="fileInput" accept="application/pdf" class="hidden" onchange="enviarPDF(event)">
          <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary px-3 py-2">üìù
            PDF</button>
          <textarea id="textoMensagem" rows="1" class="flex-1 border rounded-md p-2 resize-none"
            placeholder="Digite uma mensagem‚Ä¶" disabled></textarea>
          <button id="btnEnviar" onclick="enviarMensagem()" class="btn px-4 py-2 text-white disabled:opacity-50"
            style="background:var(--accent)" disabled>Enviar</button>
        </div>
      </main>

      <!-- Modal imagem -->
      <div id="imageModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50"
        aria-modal="true" role="dialog">
        <span id="closeModal" class="absolute top-4 right-6 text-white text-3xl cursor-pointer"
          aria-label="Fechar imagem">&times;</span>
        <img id="modalImg" src="" alt="Imagem" class="max-h-[90%] max-w-[90%] rounded-lg shadow-lg">
      </div>

      <!-- Modal prioridade -->
      <div id="priorityModal" class="hidden fixed inset-0 z-50" aria-modal="true" role="dialog">
        <div class="absolute inset-0 bg-black/60" onclick="fecharPriorityModal()" aria-hidden="true"></div>
        <div class="relative mx-auto mt-24 w-[95%] max-w-md bg-white rounded-xl shadow-xl border">
          <div class="p-4 border-b flex items-center justify-between">
            <h3 class="font-semibold">Pedir prioridade</h3>
            <button class="text-gray-500" onclick="fecharPriorityModal()" aria-label="Fechar">‚úñ</button>
          </div>
          <div class="p-4 space-y-3">
            <label class="block text-sm text-gray-600">Telefone do cliente</label>
            <input id="priorityTelefone" class="w-full p-2 border rounded-md"
              placeholder="Ex: 61999999999 ou 5561999999999" autocomplete="off" inputmode="numeric" pattern="[0-9]*" />
            <p class="text-xs text-gray-500">Aten√ß√£o: informe um telefone v√°lido DDD + 8/9 d√≠gitos.</p>
            <div id="priorityInfo" class="text-sm text-gray-700 hidden"></div>
            <div id="priorityErro" class="text-sm text-red-600 hidden" role="alert" aria-live="polite"></div>
          </div>
          <div class="p-4 border-t flex items-center justify-end gap-2">
            <button class="px-3 py-2 text-sm bg-gray-100 rounded hover:bg-gray-200"
              onclick="fecharPriorityModal()">Cancelar</button>
            <button id="btnPriorityBuscar"
              class="px-3 py-2 text-sm text-white rounded-md hover:bg-purple-700 flex items-center gap-2"
              style="background: rebeccapurple">
              <svg id="prioritySpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" aria-hidden="true">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none">
                </circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a 8 8 0 018-8v4a 4 4 0 00-4 4H4z"></path>
              </svg>
              <span id="priorityBtnLabel">Buscar e solicitar</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Theme Drawer -->
      <div id="themeDrawer" class="drawer" aria-hidden="true">
        <div class="h-full flex flex-col">
          <div class="p-4 border-b flex items-center justify-between">
            <h3 class="font-semibold">üé® Seu tema</h3>
            <div class="flex items-center gap-2">
              <button id="btnThemeExport" class="btn btn-ghost px-2 py-1 text-xs">Salvar no meu computador</button>
              <label class="btn btn-ghost px-2 py-1 text-xs cursor-pointer">Importar um tema salvo <input
                  id="importTheme" type="file" accept="application/json" class="hidden"></label>
              <button id="btnThemeClose" class="btn btn-ghost px-2 py-1 text-xs" aria-label="Fechar">‚úñ</button>
            </div>
          </div>
          <div class="p-4 overflow-y-auto space-y-6">
            <section>
              <div class="text-xs text-gray-500 mb-2">Temas r√°pidos</div>
              <div class="grid grid-cols-2 gap-2">
                <div class="preset" data-preset="corporate">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#0ea5e9,#2563eb)"></div>
                  <div class="mt-1 text-xs">Corporate</div>
                </div>
                <div class="preset" data-preset="ocean">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#06b6d4,#10b981)"></div>
                  <div class="mt-1 text-xs">Ocean</div>
                </div>
                <div class="preset" data-preset="sunset">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#fb923c,#ef4444)"></div>
                  <div class="mt-1 text-xs">Sunset</div>
                </div>
                <div class="preset" data-preset="dark">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#0b1220,#374151)"></div>
                  <div class="mt-1 text-xs">Dark</div>
                </div>
                <div class="preset" data-preset="minimal">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#f8fafc,#e2e8f0)"></div>
                  <div class="mt-1 text-xs">Minimal</div>
                </div>
                <div class="preset" data-preset="funky">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#a78bfa,#ec4899)"></div>
                  <div class="mt-1 text-xs">Funky</div>
                </div>
              </div>
            </section>
            <hr class="border-gray-200">
            <section>
              <div class="text-xs text-gray-500 mb-2">Personalizar</div>
              <div class="grid grid-cols-2 gap-3">
                <label class="block"><span class="text-xs text-gray-600">Bot√£o PDF</span><input id="tPrimary"
                    type="color" class="w-full h-10 border rounded" value="#3b82f6"></label>
                <label class="block"><span class="text-xs text-gray-600">Bot√£o Concluir</span><input id="tAccent"
                    type="color" class="w-full h-10 border rounded" value="#22c55e"></label>
                <label class="block"><span class="text-xs text-gray-600">Barra lateral</span><input id="tSidebar"
                    type="color" class="w-full h-10 border rounded" value="#ffffff"></label>
                <label class="block"><span class="text-xs text-gray-600">Cabe√ßalho</span><input id="tContentBg"
                    type="color" class="w-full h-10 border rounded" value="#ffffff"></label>
                <label class="block"><span class="text-xs text-gray-600">Cor de fundo</span><input id="tBg" type="color"
                    class="w-full h-10 border rounded" value="#f3f4f6"></label>
                <label class="block"><span class="text-xs text-gray-600">Texto</span><input id="tText" type="color"
                    class="w-full h-10 border rounded" value="#0f172a"></label>
              </div>
              <div class="grid grid-cols-2 gap-3 mt-3">
                <label class="block"><span class="text-xs text-gray-600">Minha mensagem cor 1</span><input id="tOutG1"
                    type="color" class="w-full h-10 border rounded" value="#dcf8c6"></label>
                <label class="block"><span class="text-xs text-gray-600">Minha mensagem cor 2</span><input id="tOutG2"
                    type="color" class="w-full h-10 border rounded" value="#b8f0a4"></label>
                <label class="block"><span class="text-xs text-gray-600">Cliente mensagem cor</span><input id="tInBg"
                    type="color" class="w-full h-10 border rounded" value="#ffffff"></label>
                <label class="block"><span class="text-xs text-gray-600">Cliente mensagem bordas</span><input
                    id="tInBorder" type="color" class="w-full h-10 border rounded" value="#e2e8f0"></label>
                <label class="block"><span class="text-xs text-gray-600">Canto arredondado dos bal√µes</span><input
                    id="tRadius" type="range" min="8" max="28" value="18" class="w-full"></label>
              </div>
              <div class="grid grid-cols-1 gap-3 mt-3">
                <label class="block"><span class="text-xs text-gray-600">Opacidade do fundo</span><input id="tBgOp"
                    type="range" min="0" max="1" step="0.05" value="0"></label>
              </div>
              <div class="grid grid-cols-2 gap-3 mt-3">
                <label class="block"><span class="text-xs text-gray-600">Tamanho base</span>
                  <select id="tFontSize" class="w-full p-2 border rounded">
                    <option value="13px">13px</option>
                    <option value="14px" selected>14px</option>
                    <option value="15px">15px</option>
                    <option value="16px">16px</option>
                  </select>
                </label>
                <label class="block"><span class="text-xs text-gray-600">Canto arredondado dos bot√µes</span><input
                    id="tBtnRadius" type="range" min="6" max="16" value="10" class="w-full"></label>
                <label class="block"><span class="text-xs text-gray-600">Canto arredondado dos cards</span><input
                    id="tCardRadius" type="range" min="10" max="24" value="16" class="w-full"></label>
              </div>
              <div class="flex items-center justify-between mt-4">
                <div class="flex items-center gap-2">
                  <button id="btnRandom" class="btn btn-ghost px-3 py-2">üé≤ Surpreenda-me</button>
                  <button id="btnReset" class="btn btn-ghost px-3 py-2">‚Ü∫ Voltar ao padr√£o</button>
                </div>
                <button id="btnSaveTheme" class="btn btn-primary px-4 py-2">Salvar</button>
              </div>
            </section>
          </div>
        </div>
      </div>
    </section>

    <!-- RELAT√ìRIO -->
    <section id="tabRelatorio" class="hidden p-4">
      <div class="max-w-6xl mx-auto space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Relat√≥rio ‚Äî Atendimentos</h2>
          <div class="text-sm text-gray-500" id="relatorioPeriodo">Hoje</div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="card p-4">
            <div class="text-xs text-gray-500">Em atendimento</div>
            <div id="kpiEm" class="text-2xl font-bold">0</div>
          </div>
          <div class="card p-4">
            <div class="text-xs text-gray-500">Conclu√≠dos</div>
            <div id="kpiConc" class="text-2xl font-bold">0</div>
          </div>
          <div class="card p-4">
            <div class="text-xs text-gray-500">TMA</div>
            <div class="text-2xl font-bold"><span id="kpiTma">‚Äî</span><span class="text-sm text-gray-500"> min</span>
            </div>
          </div>
          <div class="card p-4">
            <div class="text-xs text-gray-500">1¬™ resposta</div>
            <div class="text-2xl font-bold"><span id="kpiFRT">‚Äî</span><span class="text-sm text-gray-500"> seg</span>
            </div>
          </div>
        </div>
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Distribui√ß√£o por status</div><button id="btnRefreshRel"
              class="btn px-3 py-2 bg-gray-100 hover:bg-gray-200 text-sm">Atualizar</button>
          </div>
          <div class="mt-4"><canvas id="pieStatus" height="260"></canvas></div>
        </div>
      </div>
    </section>

  </div>

  <!-- Modal Login -->
  <div id="modalLogin" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="fecharModalLogin()">&times;</span>
      <h2 class="text-xl font-bold mb-4 text-center">Login</h2>
      <input type="email" id="email" placeholder="Email" class="w-full p-2 mb-3 border rounded" />
      <input type="password" id="senha" placeholder="Senha" class="w-full p-2 mb-3 border rounded" />
      <div class="flex items-center mb-3 text-sm"><input type="checkbox" id="aceitoTermos" class="mr-2"><label
          for="aceitoTermos">Eu li e aceito os <a
            href="https://joubertcastro.github.io/ConnectZap/Termos_de_Servico.html" target="_blank"
            class="text-blue-600 underline">Termos</a> e a <a
            href="https://joubertcastro.github.io/ConnectZap/Politica_de_privacidade.html" target="_blank"
            class="text-blue-600 underline">Privacidade</a>.</label></div>
      <button onclick="login()" class="w-full p-2 bg-blue-600 text-white rounded">Entrar</button>
      <div class="error text-red-600 text-center mt-2" id="erro"></div>
    </div>
  </div>

  <script>
    /** ====== CONFIG / APIs ====== */
    const FILA_API = (window.FILA_API || "https://whatsapp-webhook-production-9a27.up.railway.app/api").replace(/\/+$/, '');
    const CONV_API = (window.CONV_API || "https://conversas-api-production.up.railway.app").replace(/\/+$/, '');
    const LOGOUT_REDIRECT = window.LOGOUT_REDIRECT || null;

    /** ====== CARTEIRAS -> Phone IDs ====== */
    const phoneIdMap = {
      "828473960349364": "ConnectZap",
      "805610009301153": "Banco PAN",
      "727586317113885": "Recovery PJ",
      "864779140046932": "Recovery PF",
      "802977069563598": "Recovery PF",
      "873637622491517": "Mercado Pago Cobran√ßa",
      "821562937700669": "Mercado Pago Cobran√ßa",
      "779797401888141": "DivZero",
      "829210283602406": "Arc4U",
      "713021321904495": "Serasa",
      "803535039503723": "Mercado Pago Vendas"
    };
    const carteiraToPhoneIds = Object.entries(phoneIdMap).reduce((acc, [id, nome]) => {
      acc[nome] = acc[nome] || [];
      if (!acc[nome].includes(id)) acc[nome].push(id);
      return acc;
    }, {});

    /** ====== ESTADO ====== */
    let agente = { codigo: null, nome: null, carteira: null, origem: null, online: false };
    let tickets = []; let selecionado = null; let renderedKeys = new Set();
    let pollingContatos = null, pollingMensagens = null; let respostaMsgId = null;
    let limitPerAgent = 0; let ativosCount = 0;
    let unreadCountByKey = {}; let lastContatoTsByKey = {};
    let pieChart = null;

    /** ====== UTILS ====== */
    const POLL_ACTIVE_MS = 5000, POLL_HIDDEN_MS = 30000;
    const fmtHoraBR = new Intl.DateTimeFormat('pt-BR', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Sao_Paulo' });
    const fmtDataBR = new Intl.DateTimeFormat('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'America/Sao_Paulo' });
    function isIncoming(m) { const s = (m.status || '').toLowerCase(); if (typeof m.from_me === 'boolean') return !m.from_me; if (m.direction) return String(m.direction).toLowerCase().startsWith('in'); return ['in', 'received', 'incoming'].includes(s); }
    function keyFrom(remetente, phone_id) { return `${remetente}|${phone_id || ''}`; }
    function humanMin(seconds) { if (!seconds && seconds !== 0) return '‚Äî'; const m = seconds / 60; return m < 1 ? m.toFixed(1) : Math.round(m); }
    function humanSeg(seconds) { if (!seconds && seconds !== 0) return '‚Äî'; return Math.round(seconds); }
    function bytesToHuman(n) { if (n === undefined || n === null) return ''; const u = ['B', 'KB', 'MB', 'GB', 'TB']; let i = 0, s = n; while (s >= 1024 && i < u.length - 1) { s /= 1024; i++; } return `${s.toFixed(s >= 10 || i === 0 ? 0 : 1)} ${u[i]}`; }

    /** ====== DOM REFS ====== */
    // Home + Relat√≥rio
    const elHomeNome = document.getElementById('homeAgenteNome');
    const elHomeCart = document.getElementById('homeAgenteCarteira');
    const kpiEm = document.getElementById('kpiEm');
    const kpiConc = document.getElementById('kpiConc');
    const kpiTma = document.getElementById('kpiTma');
    const kpiFRT = document.getElementById('kpiFRT');
    const btnRefreshRel = document.getElementById('btnRefreshRel');

    // Conversas
    const elAgenteNome = document.getElementById("agenteNome");
    const elAgenteCarteira = document.getElementById("agenteCarteira");
    const elAgenteStatus = document.getElementById("agenteStatus");
    const elMsgAviso = document.getElementById("msgAviso");
    const elMsgLimite = document.getElementById("msgLimite");
    const elListaTickets = document.getElementById("listaTickets");
    const elTitulo = document.getElementById("tituloConversa");
    const elSubInfo = document.getElementById("subInfo");
    const chat = document.getElementById("chat");
    const textarea = document.getElementById("textoMensagem");
    const btnEnviar = document.getElementById("btnEnviar");
    const btnPegarProxima = document.getElementById("btnPegarProxima");
    const btnPrioridade = document.getElementById("btnPrioridade");
    const btnLiberar = document.getElementById("btnLiberar");
    const btnConcluir = document.getElementById("btnConcluir");
    const menuConcluir = document.getElementById("menuConcluir");
    const digitando = document.getElementById("digitando");
    const btnLogout = document.getElementById("btnLogout");
    const btnToggleOnline = document.getElementById("btnToggleOnline");
    const badgeAtivos = document.getElementById("badgeAtivos");
    const badgeLimite = document.getElementById("badgeLimite");

    // Tabs & Mini-sidebar
    const tabBtnHome = document.getElementById('tabBtnHome');
    const tabBtnConversas = document.getElementById('tabBtnConversas');
    const tabBtnRelatorio = document.getElementById('tabBtnRelatorio');
    const tabHome = document.getElementById('tabHome');
    const tabConversas = document.getElementById('tabConversas');
    const tabRelatorio = document.getElementById('tabRelatorio');
    document.getElementById('goToConversas1').onclick = () => switchTab('conversas');
    document.getElementById('goToRelatorio1').onclick = () => switchTab('relatorio');

    // Theme Drawer
    const themeDrawer = document.getElementById('themeDrawer');
    const btnTheme = document.getElementById('btnTheme');
    const btnThemeClose = document.getElementById('btnThemeClose');
    const btnSaveTheme = document.getElementById('btnSaveTheme');
    const btnRandom = document.getElementById('btnRandom');
    const btnReset = document.getElementById('btnReset');
    const btnThemeExport = document.getElementById('btnThemeExport');
    const importTheme = document.getElementById('importTheme');
    const inputs = {
      tPrimary: document.getElementById('tPrimary'), tAccent: document.getElementById('tAccent'),
      tSidebar: document.getElementById('tSidebar'), tContentBg: document.getElementById('tContentBg'),
      tBg: document.getElementById('tBg'), tText: document.getElementById('tText'),
      tOutG1: document.getElementById('tOutG1'), tOutG2: document.getElementById('tOutG2'),
      tInBg: document.getElementById('tInBg'), tInBorder: document.getElementById('tInBorder'),
      tRadius: document.getElementById('tRadius'), tBgOp: document.getElementById('tBgOp'),
      tFontSize: document.getElementById('tFontSize'), tBtnRadius: document.getElementById('tBtnRadius'),
      tCardRadius: document.getElementById('tCardRadius')
    };

    /** ====== MENU CONCLUIR ====== */
    const MOTIVOS_CONCLUSAO = ["Realizou negocia√ß√£o", "Solicitou 2¬™ via de boleto", "Recusou a proposta", "D√∫vidas gerais", "Cliente ficou inativo"];
    function renderMenuConcluir() {
      menuConcluir.innerHTML = MOTIVOS_CONCLUSAO.map(m => `<button type="button" data-motivo="${m}" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">${m}</button>`).join("");
      menuConcluir.querySelectorAll("button[data-motivo]").forEach(btn => {
        btn.onclick = async () => { await concluirAtendimento(btn.getAttribute("data-motivo")); fecharMenuConcluir(); };
      });
    }
    function abrirMenuConcluir() { if (!selecionado || btnConcluir.disabled) return; menuConcluir.classList.remove("hidden"); btnConcluir.setAttribute("aria-expanded", "true"); document.addEventListener("click", clickForaMenuConcluir, { capture: true }); }
    function fecharMenuConcluir() { menuConcluir.classList.add("hidden"); btnConcluir.setAttribute("aria-expanded", "false"); document.removeEventListener("click", clickForaMenuConcluir, { capture: true }); }
    function clickForaMenuConcluir(e) { const within = menuConcluir.contains(e.target) || btnConcluir.contains(e.target); if (!within) fecharMenuConcluir(); }
    btnConcluir.onclick = () => { menuConcluir.classList.contains("hidden") ? abrirMenuConcluir() : fecharMenuConcluir(); };
    renderMenuConcluir();

    /** ====== THEME ====== */
    function themeKey() { return `cz:theme:${agente.codigo || 'anon'}`; }
    function defaultTheme() { return { primary: "#3b82f6", accent: "#22c55e", sidebar: "#ffffff", contentBg: "#ffffff", bg: "#f3f4f6", text: "#0f172a", muted: "#6b7280", border: "#e5e7eb", link: "#2563eb", ghostBg: "#f3f4f6", outG1: "#dcf8c6", outG2: "#b8f0a4", outFg: "#111827", inBg: "#ffffff", inBorder: "#e2e8f0", inFg: "#0f172a", bubbleRadius: 18, btnRadius: 10, cardRadius: 16, wallOp: 0, fontSize: "14px", ticketSelectedBg: "#f0f9ff" }; }
    function applyTheme(t) {
      const r = document.documentElement.style; const base = defaultTheme(); const x = { ...base, ...t };
      r.setProperty('--ticket-selected-bg', x.ticketSelectedBg);
      r.setProperty('--sidebar-bg', x.sidebar); r.setProperty('--content-bg', x.contentBg);
      r.setProperty('--bg', x.bg); r.setProperty('--text', x.text);
      r.setProperty('--muted', x.muted); r.setProperty('--border', x.border);
      r.setProperty('--link', x.link); r.setProperty('--ghost-bg', x.ghostBg);
      r.setProperty('--bubble-out-g1', x.outG1); r.setProperty('--bubble-out-g2', x.outG2); r.setProperty('--bubble-out-fg', x.outFg);
      r.setProperty('--bubble-in-bg', x.inBg); r.setProperty('--bubble-in-border', x.inBorder); r.setProperty('--bubble-in-fg', x.inFg);
      r.setProperty('--bubble-radius', x.bubbleRadius + 'px'); r.setProperty('--btn-radius', x.btnRadius + 'px'); r.setProperty('--card-radius', x.cardRadius + 'px');
      r.setProperty('--font-size', x.fontSize); r.setProperty('--chat-wallpaper-opacity', x.wallOp);
      r.setProperty('--scrollbar', x.scrollbar || '#cbd5e1'); r.setProperty('--primary', x.primary); r.setProperty('--accent', x.accent);
      // sync inputs
      inputs.tPrimary.value = x.primary; inputs.tAccent.value = x.accent; inputs.tSidebar.value = x.sidebar;
      inputs.tContentBg.value = x.contentBg; inputs.tBg.value = x.bg; inputs.tText.value = x.text;
      inputs.tOutG1.value = x.outG1; inputs.tOutG2.value = x.outG2; inputs.tInBg.value = x.inBg; inputs.tInBorder.value = x.inBorder;
      inputs.tRadius.value = x.bubbleRadius; inputs.tBgOp.value = x.wallOp; inputs.tFontSize.value = x.fontSize;
      inputs.tBtnRadius.value = x.btnRadius; inputs.tCardRadius.value = x.cardRadius;
    }
    function readThemeFromInputs() { return { primary: inputs.tPrimary.value, accent: inputs.tAccent.value, sidebar: inputs.tSidebar.value, contentBg: inputs.tContentBg.value, bg: inputs.tBg.value, text: inputs.tText.value, outG1: inputs.tOutG1.value, outG2: inputs.tOutG2.value, inBg: inputs.tInBg.value, inBorder: inputs.tInBorder.value, bubbleRadius: Number(inputs.tRadius.value || 18), wallOp: Number(inputs.tBgOp.value || 0), fontSize: String(inputs.tFontSize.value || '14px'), btnRadius: Number(inputs.tBtnRadius.value || 10), cardRadius: Number(inputs.tCardRadius.value || 16) }; }
    function saveTheme(t) { try { localStorage.setItem(themeKey(), JSON.stringify(t)); } catch { } }
    function loadTheme() { try { return JSON.parse(localStorage.getItem(themeKey()) || 'null'); } catch { return null; } }
    if (btnTheme) btnTheme.addEventListener('click', () => themeDrawer.classList.add('open'));
    if (btnThemeClose) btnThemeClose.addEventListener('click', () => themeDrawer.classList.remove('open'));
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && themeDrawer.classList.contains('open')) themeDrawer.classList.remove('open'); });
    [inputs.tPrimary, inputs.tAccent, inputs.tSidebar, inputs.tContentBg, inputs.tBg, inputs.tText, inputs.tOutG1, inputs.tOutG2, inputs.tInBg, inputs.tInBorder, inputs.tRadius, inputs.tBgOp, inputs.tFontSize, inputs.tBtnRadius, inputs.tCardRadius].forEach(i => { if (i) i.addEventListener('input', () => applyTheme(readThemeFromInputs())); });
    if (btnSaveTheme) btnSaveTheme.addEventListener('click', () => { const t = readThemeFromInputs(); saveTheme(t); themeDrawer.classList.remove('open'); });
    if (btnReset) btnReset.addEventListener('click', () => { const t = defaultTheme(); applyTheme(t); saveTheme(t); });
    if (btnRandom) btnRandom.addEventListener('click', () => { const rand = () => '#' + Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0'); const b1 = rand(), b2 = rand(); const t = { ...defaultTheme(), primary: rand(), accent: rand(), outG1: b1, outG2: b2, bg: '#f8fafc', wallOp: (Math.random() > .5 ? 0.8 : 0), bubbleRadius: 14 + Math.floor(Math.random() * 12), btnRadius: 8 + Math.floor(Math.random() * 6), cardRadius: 14 + Math.floor(Math.random() * 8) }; applyTheme(t); });

    /** ====== LOGIN B√ÅSICO ====== */
    function isLogged() { try { return !!JSON.parse(localStorage.getItem('usuario')); } catch { return false; } }
    function abrirModalLogin() { if (isLogged()) return; document.getElementById('modalLogin').style.display = 'flex'; }
    function fecharModalLogin() { document.getElementById('modalLogin').style.display = 'none'; document.getElementById('erro').textContent = ''; }
    async function login() {
      const email = document.getElementById('email').value; const senha = document.getElementById('senha').value; const aceito = document.getElementById('aceitoTermos').checked;
      const erroDiv = document.getElementById('erro');
      if (!email || !senha) { erroDiv.textContent = "Preencha todos os campos!"; return; }
      if (!aceito) { erroDiv.textContent = "Voc√™ deve aceitar os Termos e a Pol√≠tica."; return; }
      try {
        const res = await fetch(`${FILA_API}/login`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email, senha }) });
        const data = await res.json();
        if (data.ok) { localStorage.setItem("usuario", JSON.stringify(data.user)); fecharModalLogin(); boot(); switchTab('conversas'); }
        else { erroDiv.textContent = data.erro || "Erro ao fazer login"; }
      } catch { erroDiv.textContent = "Erro de conex√£o com o servidor"; }
    }

    /** ====== TABS ====== */
    function switchTab(tab) {
      [tabBtnHome, tabBtnConversas, tabBtnRelatorio].forEach(b => b.classList.remove('active'));
      tabHome.classList.add('hidden'); tabConversas.classList.add('hidden'); tabRelatorio.classList.add('hidden');
      if (tab === 'conversas') { tabBtnConversas.classList.add('active'); tabConversas.classList.remove('hidden'); }
      else if (tab === 'relatorio') { tabBtnRelatorio.classList.add('active'); tabRelatorio.classList.remove('hidden'); }
      else { tabBtnHome.classList.add('active'); tabHome.classList.remove('hidden'); }
    }
    tabBtnHome.onclick = () => switchTab('home');
    tabBtnConversas.onclick = () => switchTab('conversas');
    tabBtnRelatorio.onclick = () => switchTab('relatorio');

    /** ====== BOOT ====== */
    async function boot() {
      try {
        const u = JSON.parse(localStorage.getItem('usuario') || '{}');
        agente = { codigo: u.codigo || u.id || u.user_id || 0, nome: u.nome || u.name || u.email || 'Usu√°rio', carteira: u.carteira || 'ConnectZap', origem: 'web', online: false };
        elAgenteNome.textContent = agente.nome;
        elAgenteCarteira.textContent = agente.carteira;
        elHomeNome.textContent = agente.nome;
        elHomeCart.textContent = agente.carteira;
        badgeLimite.textContent = '‚àû';
        btnToggleOnline.disabled = false;
        btnPrioridade.disabled = false;
        // load theme
        const saved = loadTheme(); applyTheme(saved || defaultTheme());
        await refreshKPIs(); // relat√≥rio inicial
        schedulePolls();
      } catch (e) { console.error('boot error', e); }
    }

    /** ====== KPIs & Relat√≥rio ====== */
    async function refreshKPIs() {
      try {
        const codigo = encodeURIComponent(String(agente.codigo || ''));
        const url = `${FILA_API}/relatorio_hoje?agente=${codigo}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();
        if (typeof data.em_atendimento === 'number') kpiEm.textContent = String(data.em_atendimento); else kpiEm.textContent = '0';
        if (typeof data.concluidos === 'number') kpiConc.textContent = String(data.concluidos); else kpiConc.textContent = '0';
        kpiTma.textContent = humanMin(data.tma_segundos || 0);
        kpiFRT.textContent = humanSeg(data.primeira_resposta_seg || 0);
        // Pizza
        const ativos = Number(kpiEm.textContent) || 0, conc = Number(kpiConc.textContent) || 0, outros = Math.max(0, Number(data.outros || 0));
        const ctx = document.getElementById('pieStatus').getContext('2d');
        if (pieChart) pieChart.destroy();
        pieChart = new Chart(ctx, { type: 'pie', data: { labels: ['Em atendimento', 'Conclu√≠dos', 'Outros'], datasets: [{ data: [ativos, conc, outros] }] }, options: { responsive: true, plugins: { legend: { display: true } } } });
      } catch (e) {
        console.warn('Falha KPIs', e);
      }
    }
    btnRefreshRel.onclick = refreshKPIs;

    /** ====== POLLING ====== */
    function schedulePolls() {
      if (pollingContatos) clearInterval(pollingContatos);
      if (pollingMensagens) clearInterval(pollingMensagens);
      const gap = document.hidden ? POLL_HIDDEN_MS : POLL_ACTIVE_MS;
      pollingContatos = setInterval(() => {/* TODO: refresh fila/tickets se necess√°rio */ }, gap);
      if (selecionado) {
        pollingMensagens = setInterval(() => { carregarMensagens(true); }, gap);
      }
    }
    document.addEventListener('visibilitychange', schedulePolls);

    /** ====== A√á√ïES DE CONVERSA (stubs integr√°veis) ====== */
    btnToggleOnline.onclick = async () => {
      try {
        const wantOnline = !agente.online;
        btnToggleOnline.disabled = true; document.getElementById('toggleSpinner').classList.remove('hidden');
        const r = await fetch(`${FILA_API}/agentes/online`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ codigo: agente.codigo, online: wantOnline }) });
        const data = await r.json().catch(() => ({}));
        agente.online = !!(data.ok ? wantOnline : agente.online);
        elAgenteStatus.innerHTML = agente.online ? '<span class="dot online"></span>Online' : '<span class="dot offline"></span>Offline';
        document.getElementById('toggleSpinner').classList.add('hidden'); btnToggleOnline.disabled = false;
        document.getElementById('toggleLabel').textContent = agente.online ? 'Ficar offline' : 'Ficar online';
      } catch { document.getElementById('toggleSpinner').classList.add('hidden'); btnToggleOnline.disabled = false; }
    };

    btnPegarProxima.onclick = async () => {
      try {
        btnPegarProxima.disabled = true; document.getElementById('pegarSpinner').classList.remove('hidden');
        const r = await fetch(`${FILA_API}/fila/pegar_proxima`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ agente: agente.codigo, carteira: agente.carteira }) });
        const data = await r.json();
        document.getElementById('pegarSpinner').classList.add('hidden'); btnPegarProxima.disabled = false;
        if (!data || !data.ok) { alert(data?.erro || 'Sem conversas na fila.'); return; }
        abrirConversa(data.ticket);
      } catch (e) {
        document.getElementById('pegarSpinner').classList.add('hidden'); btnPegarProxima.disabled = false;
      }
    };

    btnPrioridade.onclick = () => { document.getElementById('priorityModal').classList.remove('hidden'); };
    function fecharPriorityModal() { document.getElementById('priorityModal').classList.add('hidden'); }

    async function concluirAtendimento(motivo) {
      if (!selecionado) return;
      try {
        btnConcluir.disabled = true;
        await fetch(`${FILA_API}/fila/concluir`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ticket_id: selecionado.id, motivo }) });
        btnConcluir.disabled = false;
        selecionado = null; elTitulo.textContent = 'Selecione um ticket'; chat.innerHTML = '<p id="loading" class="text-center text-gray-500">Pegue uma conversa para iniciar‚Ä¶</p>';
      } catch { btnConcluir.disabled = false; }
    }

    function abrirConversa(ticket) {
      selecionado = ticket;
      elTitulo.textContent = `${ticket.nome || ticket.remetente || 'Cliente'} ‚Äî ${ticket.phone_id || ''}`;
      elSubInfo.textContent = ticket.telefone || '';
      btnEnviar.disabled = false; textarea.disabled = false; btnLiberar.disabled = false; btnConcluir.disabled = false;
      chat.innerHTML = ''; carregarMensagens(false);
    }

    async function carregarMensagens(append) {
      if (!selecionado) return;
      try {
        const url = `${CONV_API}/mensagens?telefone=${encodeURIComponent(selecionado.telefone)}&phone_id=${encodeURIComponent(selecionado.phone_id || '')}`;
        const r = await fetch(url); if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();
        if (!append) chat.innerHTML = '';
        for (const m of data || []) renderMsg(m);
        chat.scrollTop = chat.scrollHeight;
      } catch (e) { /* noop */ }
    }

    function renderMsg(m) {
      const div = document.createElement('div');
      div.className = `msg ${isIncoming(m) ? 'recebida' : 'enviada'}`;
      const txt = (m.text || m.body || m.caption || '');
      div.innerHTML = `<div>${txt}</div><div class="hora">${(m.hora || '')}</div>`;
      chat.appendChild(div);
    }

    async function enviarMensagem() {
      if (!selecionado) return;
      const txt = textarea.value.trim(); if (!txt) return;
      textarea.value = '';
      try {
        await fetch(`${CONV_API}/enviar_texto`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telefone: selecionado.telefone, phone_id: selecionado.phone_id, texto: txt }) });
        renderMsg({ text: txt, from_me: true, hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) });
        chat.scrollTop = chat.scrollHeight;
      } catch { }
    }

    async function enviarPDF(ev) {
      if (!selecionado) return;
      const f = ev.target.files[0]; if (!f) return;
      if (f.size > 2 * 1024 * 1024) { alert('PDF acima de 2MB.'); return; }
      const b64 = await f.arrayBuffer().then(b => btoa(String.fromCharCode(...new Uint8Array(b))));
      try {
        await fetch(`${CONV_API}/enviar_pdf`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telefone: selecionado.telefone, phone_id: selecionado.phone_id, nome: f.name, mime: f.type || 'application/pdf', base64: b64 }) });
        renderMsg({ text: `üìé PDF enviado (${f.name} ‚Ä¢ ${bytesToHuman(f.size)})`, from_me: true, hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) });
      } catch { }
    }

    /** ====== START ====== */
    async function startApp() {
      const saved = loadTheme(); applyTheme(saved || defaultTheme());
      if (!isLogged()) { abrirModalLogin(); return; }
      await boot();
      switchTab('conversas');
    }

    /** ====== LOGOUT ====== */
    btnLogout.onclick = () => {
      try { localStorage.removeItem('usuario'); } catch { }
      switchTab('home'); abrirModalLogin();
      if (LOGOUT_REDIRECT) location.href = LOGOUT_REDIRECT;
    };

    window.addEventListener('load', startApp);
  </script>
</body>

</html>
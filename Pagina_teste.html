<!DOCTYPE html>

<html lang="pt-BR">
<head><script>
// ConnectZap bootstrap error capture (mostra erro mesmo se a tela ficar branca)
window.__czErrors = window.__czErrors || [];
window.addEventListener('error', function(e){
  try{
    window.__czErrors.push({
      type: 'error',
      message: e && (e.message || e.type) || 'error',
      filename: e && e.filename,
      lineno: e && e.lineno,
      colno: e && e.colno
    });
  }catch(_){}
});
window.addEventListener('unhandledrejection', function(e){
  try{
    var reason = (e && e.reason) ? (e.reason.stack || e.reason.message || String(e.reason)) : 'unhandledrejection';
    window.__czErrors.push({ type: 'rejection', message: reason });
  }catch(_){}
});
</script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>ConnectZap ‚Äî Agentes</title>
<link href="https://joubertcastro.github.io/ConnectZap/favicon.ico" rel="icon"/>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root {
      --primary: #3b82f6;
      --accent: #22c55e;
      --bg: #f3f4f6;
      --sidebar-bg: #ffffff;
      --content-bg: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --link: #2563eb;
      --ghost-bg: #f3f4f6;
      --ring: rgba(59, 130, 246, .35);
      --bubble-out-g1: #dcf8c6;
      --bubble-out-g2: #b8f0a4;
      --bubble-out-fg: #111827;
      --bubble-in-bg: #fff;
      --bubble-in-border: #e2e8f0;
      --bubble-in-fg: #0f172a;
      --bubble-radius: 18px;
      --btn-radius: 10px;
      --card-radius: 16px;
      --font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --font-size: 14px;
      --chat-wallpaper-opacity: 0;
      --hover: #f1f5f9;
      --hover-strong: #e2e8f0;
      --input-bg: #ffffff;
      --input-fg: var(--text);
      --scrollbar: #cbd5e1;
      --ticket-selected-bg: #f0f9ff;
      --reply-bg: rgba(0, 0, 0, .06);
      --reply-border: rgba(0, 0, 0, .08);
      --reply-fg: #334155;
    }

    * {
      outline-color: var(--ring)
    }

    html {
      font-size: var(--font-size)
    }

    body {
      font-family: var(--font-family);
      color: var(--text);
      background: var(--bg)
    }

    .card {
      background: var(--content-bg);
      border: 1px solid var(--border);
      border-radius: var(--card-radius)
    }

    .btn {
      border-radius: var(--btn-radius);
      transition: transform .06s ease, filter .15s ease, box-shadow .15s ease;
      position: relative;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn[disabled] {
      opacity: .6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff
    }

    .btn-primary:hover {
      filter: brightness(.95)
    }

    .btn-ghost {
      background: var(--ghost-bg)
    }

    .btn-ghost:hover {
      background: var(--hover)
    }

    .btn-neutral {
      background: var(--ghost-bg);
      color: var(--text);
      border: 1px solid var(--border)
    }

    .btn-neutral:hover {
      background: var(--hover)
    }

    .btn-danger {
      background: #dc2626;
      color: #fff;
    }

    .btn-danger:hover {
      filter: brightness(.95);
    }

    .sidebar {
      background: var(--sidebar-bg);
      border-color: var(--border)
    }

    .topbar {
      background: var(--content-bg);
      border-color: var(--border)
    }

    .ticket-selected {
      background: var(--ticket-selected-bg) !important
    }

    .badge {
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      border-radius: 9999px;
      padding: 2px 6px;
      min-width: 18px;
      text-align: center
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 9999px;
      display: inline-block;
      margin-right: 6px
    }

    .dot.online {
      background: #16a34a
    }

    .dot.offline {
      background: #9ca3af
    }

    .msg {
      display: inline-block;
      max-width: min(70%, 560px);
      padding: 10px 14px 18px;
      margin: 6px 0;
      position: relative;
      border-radius: var(--bubble-radius);
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .10);
      transition: background .18s ease, border-color .18s ease, color .18s ease
    }

    @media (max-width:768px) {
      .msg {
        max-width: 86%
      }
    }

    .msg.enviada {
      align-self: flex-end;
      background: linear-gradient(120deg, var(--bubble-out-g1), var(--bubble-out-g2));
      color: var(--bubble-out-fg)
    }

    .msg.recebida {
      align-self: flex-start;
      background: var(--bubble-in-bg);
      border: 1px solid var(--bubble-in-border);
      color: var(--bubble-in-fg)
    }

    .msg .hora {
      position: absolute;
      right: 8px;
      bottom: 4px;
      font-size: 11px;
      color: var(--muted)
    }

    .msg.enviada::after,
    .msg.recebida::after {
      content: "";
      position: absolute;
      bottom: 0;
      width: 14px;
      height: 14px;
      clip-path: polygon(0 0, 100% 0, 0 100%)
    }

    .msg.enviada::after {
      right: -7px;
      background: linear-gradient(120deg, var(--bubble-out-g1), var(--bubble-out-g2))
    }

    .msg.recebida::after {
      left: -7px;
      background: var(--bubble-in-bg);
      border-left: 1px solid var(--bubble-in-border);
      border-bottom: 1px solid var(--bubble-in-border)
    }

    .msg img.thumb {
      max-width: 280px;
      height: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor: pointer
    }

    .msg audio {
      width: 320px;
      display: block
    }

    .dia {
      text-align: center;
      margin: 12px 0;
      font-size: 12px;
      color: var(--muted)
    }

    .reply-btn {
      position: absolute;
      top: 4px;
      right: 6px;
      width: 22px;
      height: 22px;
      border-radius: 9999px;
      display: grid;
      place-items: center;
      background: var(--reply-bg);
      color: var(--reply-fg);
      border: 1px solid var(--reply-border);
      opacity: 0;
      transition: opacity .15s, transform .06s;
      font-size: 12px;
      line-height: 1;
      cursor: pointer
    }

    .msg:hover .reply-btn {
      opacity: 1
    }

    .reply-btn:active {
      transform: scale(.96)
    }

    .reply-btn svg {
      width: 14px;
      height: 14px
    }

    textarea {
      background: var(--input-bg);
      color: var(--input-fg);
      border-color: var(--border) !important
    }

    textarea::placeholder {
      color: color-mix(in srgb, var(--muted) 85%, var(--bg))
    }

    input[type="text"],
    input[type="search"],
    input[type="color"],
    input[type="file"],
    input[type="date"],
    select {
      background: var(--input-bg);
      color: var(--input-fg);
      border-color: var(--border) !important
    }

    *::-webkit-scrollbar {
      width: 10px;
      height: 10px
    }

    *::-webkit-scrollbar-thumb {
      background: var(--scrollbar);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box
    }

    *::-webkit-scrollbar-track {
      background: transparent
    }

    .mini-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 56px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 10px 6px;
      background: #0b1220;
      color: #e5e7eb;
      z-index: 70;
      border-right: 1px solid #111827
    }

    .mini-sidebar .btn-mini {
      width: 44px;
      height: 44px;
      display: grid;
      place-items: center;
      border-radius: 12px;
      background: transparent;
      transition: background .2s, transform .06s;
      cursor: pointer
    }

    .mini-sidebar .btn-mini:hover {
      background: #111827
    }

    .mini-sidebar .btn-mini.active {
      background: #2563eb;
      color: #fff
    }

    .mini-sidebar .btn-mini.locked {
      opacity: .55;
      position: relative;
    }

    .mini-sidebar .btn-mini.locked::after {
      content: 'üîí';
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 10px;
      opacity: .9;
    }

    .with-mini {
      margin-left: 56px
    }

    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: min(430px, 96%);
      height: 100%;
      background: var(--content-bg);
      border-left: 1px solid var(--border);
      box-shadow: -12px 0 24px rgba(0, 0, 0, .08);
      transform: translateX(100%);
      transition: transform .25s ease;
      z-index: 60
    }

    .drawer.open {
      transform: translateX(0)
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      align-items: center;
      justify-content: center
    }

    .modal-inner {
      background: var(--content-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: min(420px, 94%);
      box-shadow: 0 10px 30px rgba(0, 0, 0, .14)
    }

    .bar-soft {
      background: var(--ghost-bg)
    }

    .ticket-item:hover {
      background: var(--hover)
    }

    .pill {
      border: 1px solid var(--border);
      background: var(--ghost-bg);
      padding: 4px 8px;
      border-radius: 9999px;
      font-size: 12px
    }

    /* Relat√≥rio */
    .section-title {
      color: var(--text)
    }

    .muted {
      color: var(--muted)
    }

    .extrato {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .extrato-item+.extrato-item {
      border-top: 1px solid var(--border)
    }

    .extrato-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: transparent;
      color: var(--text);
      transition: background .15s ease;
      text-align: left
    }

    .extrato-header:hover {
      background: var(--hover)
    }

    .extrato-meta {
      font-size: 12px;
      color: var(--muted)
    }

    .extrato-chevron {
      color: var(--muted)
    }

    .extrato-content {
      padding: 0 12px 12px 12px
    }

    .table-soft {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden
    }

    .table-soft th,
    .table-soft td {
      border: 1px solid var(--border);
      padding: 8px
    }

    .table-soft thead tr {
      background: var(--ghost-bg);
      color: var(--muted)
    }

    .table-soft tbody tr:hover {
      background: color-mix(in srgb, var(--ghost-bg) 60%, transparent)
    }

    .chart-sm {
      height: 160px !important;
      max-height: 160px;
    }

    /* ======= PAINEL DE AVISOS ======= */
    .notice {
      border: 1px solid var(--border);
      background: var(--content-bg);
      border-radius: 14px;
      padding: 12px;
      transition: background .15s ease, border-color .15s ease, box-shadow .15s ease, color .15s ease;
      color: var(--text);
    }

    .notice.unread {
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary) 25%, transparent);
    }

    .notice-head {
      display: flex;
      align-items: start;
      justify-content: space-between;
      gap: 8px;
    }

    .notice-left {
      display: flex;
      gap: 10px;
      align-items: start;
    }

    .sev {
      width: 10px;
      height: 100%;
      min-height: 36px;
      border-radius: 6px;
      margin-top: 2px;
    }

    .sev-success {
      background: #3b82f6;
    }

    .sev-info {
      background: #16a34a;
    }

    .sev-warn {
      background: #d97706;
    }

    .sev-crit {
      background: #dc2626;
    }

    .notice-title {
      font-weight: 600;
      line-height: 1.2;
      color: var(--text);
    }

    .notice-meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .notice-tags .tag {
      font-size: 11px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--ghost-bg) 85%, transparent);
      border-radius: 9999px;
      padding: 2px 8px;
      color: var(--text);
    }

    .notice-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .notice-actions button {
      font-size: 12px;
      border: 1px solid var(--border);
      padding: 4px 8px;
      border-radius: 8px;
      background: var(--ghost-bg);
      color: var(--text);
    }

    .notice-actions button:hover {
      background: var(--hover);
    }

    .notice-body {
      margin-top: 8px;
      color: var(--text);
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .notice.crit {
      border-left: 8px solid #dc2626 !important;
      background: color-mix(in srgb, #dc2626 12%, var(--content-bg));
    }

    .crit-badge {
      display: inline-block;
      margin-left: 8px;
      padding: 2px 6px;
      font-size: 10px;
      line-height: 1;
      font-weight: 800;
      border-radius: 9999px;
      background: #dc2626;
      color: #fff;
      vertical-align: middle;
    }

    .hero {
      border: 1px solid var(--border);
      border-left: 6px solid #dc2626;
      background: color-mix(in srgb, #dc2626 6%, var(--content-bg));
      border-radius: 14px;
      padding: 12px;
    }

    .hero .title {
      font-weight: 700;
    }

    .hero .meta {
      font-size: 12px;
      color: var(--muted);
    }

    .hero .close {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px 8px;
      background: var(--ghost-bg);
      font-size: 12px;
      color: var(--text);
    }

    .hero .close:hover {
      background: var(--hover);
    }

    .filter-btn.active {
      outline: 2px solid var(--primary);
      outline-offset: -2px;
      background: color-mix(in srgb, var(--primary) 10%, var(--ghost-bg));
      color: var(--text);
    }
  </style>
</head>
<body class="h-screen flex with-mini"><pre id="czFatalOverlay" style="display:none;position:fixed;z-index:999999;top:0;left:0;right:0;max-height:55vh;overflow:auto;background:#111;color:#fff;padding:12px;font-size:12px;white-space:pre-wrap;border-bottom:1px solid rgba(255,255,255,.12);"></pre><script>
(function(){
  function isDisplayed(el){
    if(!el) return false;
    try { return window.getComputedStyle(el).display !== 'none'; } catch(_) { return !!el.style && el.style.display !== 'none'; }
  }
  function showErrorsIfAny(){
    try{
      var list = window.__czErrors || [];
      if(!list.length) return;
      var box = document.getElementById('czFatalOverlay');
      if(!box) return;
      var out = list.map(function(it){
        var loc = (it.filename ? ('\n  ' + it.filename + ':' + (it.lineno||'') + ':' + (it.colno||'')) : '');
        return (it.type || 'err') + ': ' + (it.message || '') + loc;
      }).join('\n\n');
      box.textContent = out;
      box.style.display = 'block';
    }catch(_){}
  }

  // failsafe: se tudo ficar hidden e o modal n√£o aparecer, mostra o app + modal
  function rescueBlankScreen(){
    try{
      var sb = document.getElementById('appSidebar');
      var tw = document.getElementById('tabsWrapper');
      var modal = document.getElementById('modalLogin');
      var sbHidden = sb && sb.classList && sb.classList.contains('hidden');
      var twHidden = tw && tw.classList && tw.classList.contains('hidden');
      var modalVisible = isDisplayed(modal);

      if(sbHidden && twHidden && !modalVisible){
        sb.classList.remove('hidden');
        tw.classList.remove('hidden');
        if(modal) modal.style.display = 'flex';
      }
    }catch(_){}
  }

  window.addEventListener('DOMContentLoaded', function(){
    // espera um pouco porque o script principal remove 'hidden' no load()
    setTimeout(function(){
      rescueBlankScreen();
      showErrorsIfAny();
    }, 1200);
  });
})();
</script>
<!-- Mini Sidebar -->
<nav class="mini-sidebar select-none hidden" id="appSidebar">
<!-- Home -->
<button aria-current="page" aria-label="Home" class="btn-mini active transition-transform active:scale-95" id="tabBtnHome" title="Home">
<svg aria-hidden="true" class="h-5 w-5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M3 10.5L12 3l9 7.5"></path>
<path d="M5 10.5V21h6v-5h2v5h6V10.5"></path>
</svg>
<span class="sr-only">Home</span>
</button>
<!-- Conversas -->
<button aria-label="Conversas" class="btn-mini transition-transform active:scale-95" data-requires-login="" id="tabBtnConversas" title="Conversas">
<svg aria-hidden="true" class="h-5 w-5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<rect height="12" rx="4" ry="4" width="18" x="3" y="5"></rect>
<path d="M7 17v4l4-4"></path>
<circle cx="9" cy="11" fill="currentColor" r="1.2" stroke="none"></circle>
<circle cx="12" cy="11" fill="currentColor" r="1.2" stroke="none"></circle>
<circle cx="15" cy="11" fill="currentColor" r="1.2" stroke="none"></circle>
</svg>
<span class="sr-only">Conversas</span>
</button>
<!-- Relat√≥rio -->
<button aria-label="Relat√≥rio" class="btn-mini transition-transform active:scale-95" data-requires-login="" id="tabBtnRelatorio" title="Relat√≥rio">
<svg aria-hidden="true" class="h-5 w-5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M4 19.5h16"></path>
<path d="M7 19.5V10"></path>
<path d="M12 19.5V5"></path>
<path d="M17 19.5v-8"></path>
</svg>
<span class="sr-only">Relat√≥rio</span>
</button>
<!-- Envio individual -->
<button aria-label="Envio individual" class="btn-mini transition-transform active:scale-95 hidden" data-requires-login="" id="tabBtnEnvioIndividual" title="Envio individual">
<svg aria-hidden="true" class="h-5 w-5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M22 2L11 13"></path>
<path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
</svg>
<span class="sr-only">Envio individual</span>
</button>
</nav>
<!-- Tabs Wrapper -->
<div class="flex-1 flex flex-col hidden" id="tabsWrapper">
<!-- HOME -->
<section class="flex-1 p-6" id="tabHome">
<div class="max-w-4xl mx-auto">
<div class="card p-6">
<h1 class="text-2xl font-bold">Bem-vindo(a) üëã</h1>
<p class="muted mt-2">Ol√° <span class="font-semibold" id="homeAgenteNome">‚Äî</span>!</p>
<p class="muted">Carteira: <span class="font-semibold" id="homeAgenteCarteira">‚Äî</span></p>
<div class="mt-4 hidden" id="homeAvisoHero">
<div class="hero flex items-start justify-between gap-3">
<div class="min-w-0">
<div class="title" id="heroTitle">‚Äî</div>
<div class="meta mt-1" id="heroMeta">‚Äî</div>
<div class="mt-2 text-sm" id="heroBody">‚Äî</div>
</div>
<div class="flex items-start gap-2 shrink-0">
<button class="close" id="heroMarkRead">Marcar como lido</button>
<button class="close" id="heroDismiss">Dispensar</button>
</div>
</div>
</div>
<div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
<!-- STATUS / ONLINE -->
<div class="p-4 border rounded-lg" style="border-color:var(--border)">
<div class="text-sm muted mb-1">Status</div>
<div class="font-medium" id="homeStatus"><span class="dot offline"></span>Offline</div>
<div class="mt-3 flex flex-wrap gap-2">
<button aria-live="polite" aria-pressed="false" class="btn px-3 py-2 text-white disabled:opacity-50 flex items-center gap-2 bg-green-600 hover:bg-green-700" disabled="" id="btnToggleOnline">
<svg aria-hidden="true" class="hidden animate-spin h-4 w-4" id="toggleSpinner" viewbox="0 0 24 24">
<circle class="opacity-25" cx="12" cy="12" fill="none" r="10" stroke="currentColor" stroke-width="4"></circle>
<path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
</svg>
<span id="toggleLabel">Ficar online</span>
</button>
<button class="btn btn-primary px-3 py-2" id="btnLogout">Login</button>
</div>
<!-- PENDENTES NA FILA (Home / Status) -->
<div class="mt-3">
<div class="text-sm muted mb-1">Pendentes na sua fila</div>
<div class="flex items-center gap-2">
<span class="badge" id="homePendentesBadge" style="background:#64748b">‚Äî</span>
<span class="text-xs muted">atualiza a cada 60s</span>
</div>
</div>
<div aria-live="polite" class="mt-2 text-xs text-amber-600 hidden" id="homeAviso" role="alert"></div>
</div>
<!-- ATALHOS -->
<div class="p-4 border rounded-lg" style="border-color:var(--border)">
<div class="flex items-center justify-between">
<div class="text-sm muted mb-1">Atalhos</div>
</div>
<div class="flex flex-wrap gap-2 mt-1">
<button class="btn btn-primary px-4 py-2" id="goToConversas1">Ir para Conversas</button>
<button class="btn btn-neutral px-4 py-2" id="goToRelatorio1">Ver Relat√≥rio</button>
</div>
</div>
</div>
<!-- PAINEL DE AVISOS -->
<div class="mt-6">
<div class="flex items-center justify-between gap-2">
<div class="flex items-center gap-2">
<h2 class="text-lg font-semibold">üì¢ Painel de Avisos</h2>
<span class="pill" id="avisosCountPill">‚Äî</span>
</div>
<div class="flex items-center gap-2">
<button class="btn btn-neutral px-2 py-1 text-xs filter-btn active" data-avisos-filter="all">Todos</button>
<button class="btn btn-neutral px-2 py-1 text-xs filter-btn" data-avisos-filter="unread" style="display:none">N√£o lidos</button>
<button class="btn btn-primary px-3 py-2 text-sm" id="btnAvisoRefresh">Atualizar</button>
</div>
</div>
<div class="text-sm muted mt-1" id="avisosResumo">‚Äî</div>
<div class="mt-3 space-y-2" id="avisosWrap"></div>
</div>
<!-- /SUPER PAINEL DE AVISOS -->
</div>
</div>
</section>
<!-- CONVERSAS -->
<section class="hidden h-full flex" id="tabConversas">
<!-- Sidebar -->
<aside class="sidebar w-1/3 lg:w-1/4 border-r flex flex-col">
<div class="p-3 border-b topbar">
<div class="flex items-start justify-between gap-2">
<div class="min-w-0">
<div class="text-xs muted">Agente</div>
<div class="font-semibold truncate" id="agenteNome">‚Äî</div>
<div class="text-xs muted">Carteira: <span id="agenteCarteira">‚Äî</span></div>
<div class="text-xs muted">Status: <span id="agenteStatus"><span class="dot offline"></span>Offline</span>
</div>
<div class="mt-1 text-xs">
<span class="muted">Tickets:</span>
<span class="badge" id="badgeAtivos">0</span>
<span class="muted mx-1">/</span>
<span class="badge" id="badgeLimite" style="background:#64748b">‚àû</span>
</div>
</div>
<div class="flex flex-col items-end gap-2">
<button class="btn btn-primary px-3 py-2 text-sm text-white disabled:opacity-50 flex items-center gap-2" disabled="" id="btnPegarProxima">
<svg aria-hidden="true" class="hidden animate-spin h-4 w-4" id="pegarSpinner" viewbox="0 0 24 24">
<circle class="opacity-25" cx="12" cy="12" fill="none" r="10" stroke="currentColor" stroke-width="4">
</circle>
<path class="opacity-75" d="M4 12a 8 8 0 018-8v 4a 4 4 0 00-4 4H4z" fill="currentColor"></path>
</svg>
<span id="pegarLabel">Pegar pr√≥xima</span>
</button>
<button class="btn px-3 py-2 text-sm rounded-md text-white disabled:opacity-50" disabled="" id="btnPrioridade" style="background: rebeccapurple">Pedir prioridade</button>
<button aria-controls="themeDrawer" aria-haspopup="true" class="mt-2 btn btn-ghost px-3 py-1 text-xs" id="btnTheme">üé® Tema</button>
</div>
</div>
<div aria-live="polite" class="mt-2 text-xs text-amber-600 hidden" id="msgAviso" role="alert"></div>
<div aria-live="polite" class="mt-1 text-xs text-red-600 hidden" id="msgLimite" role="alert"></div>
</div>
<ul aria-label="Minhas conversas" class="flex-1 overflow-y-auto" id="listaTickets"></ul>
<div class="p-2 text-xs muted border-t topbar">
          Apenas conversas da sua carteira. ‚ÄúPegar pr√≥xima‚Äù usa ordem por √∫ltima mensagem <em>recebida</em>.
        </div>
</aside>
<!-- Chat -->
<main class="flex-1 flex flex-col">
<div class="flex items-center justify-between p-3 border-b topbar">
<div class="min-w-0">
<div class="font-bold text-lg truncate" id="tituloConversa">Selecione um ticket</div>
<div class="text-sm muted truncate" id="subInfo"></div>
</div>
<div class="flex items-center gap-2">
<button class="btn btn-neutral px-3 py-2 text-sm disabled:opacity-50" disabled="" id="btnLiberar">Liberar</button>
<div class="relative">
<button aria-expanded="false" aria-haspopup="true" class="btn px-3 py-2 text-sm text-white disabled:opacity-50" disabled="" id="btnConcluir" style="background:var(--accent)">Concluir</button>
<div class="hidden absolute right-0 mt-2 w-64 border rounded-lg shadow-lg z-20" id="menuConcluir" style="background: var(--content-bg); border-color: var(--border)"></div>
</div>
</div>
</div>
<div class="relative flex-1 overflow-hidden">
<div aria-live="polite" class="relative h-full p-4 overflow-y-auto flex flex-col space-y-1" id="chat" role="log">
<p class="text-center muted" id="loading">Pegue uma conversa para iniciar‚Ä¶</p>
</div>
</div>
<div aria-live="polite" class="px-4 text-left hidden text-sm muted" id="digitando">Digitando‚Ä¶</div>
<div class="hidden px-3 py-2 border-t bar-soft text-sm flex justify-between items-center" id="respostaPreview" style="border-color:var(--border)">
<div class="truncate max-w-[80%]">
<span class="font-semibold">Respondendo:</span> <span class="muted" id="respostaTexto"></span>
</div>
<button aria-label="Cancelar resposta" class="text-red-500 text-xs" onclick="cancelarResposta()">‚úñ</button>
</div>
<div class="p-3 border-t topbar flex space-x-2 items-center">
<input accept="application/pdf" class="hidden" id="fileInput" onchange="enviarPDF(event)" type="file"/>
<button class="btn btn-primary px-3 py-2" onclick="document.getElementById('fileInput').click()">üìù
            PDF</button>
<textarea class="flex-1 border rounded-md p-2 resize-none" disabled="" id="textoMensagem" placeholder="Digite uma mensagem‚Ä¶" rows="1" style="border-color:var(--border)"></textarea>
<button class="btn px-4 py-2 text-white disabled:opacity-50" disabled="" id="btnEnviar" style="background:var(--accent)">Enviar</button>
</div>
</main>
<!-- Modal imagem -->
<div aria-modal="true" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50" id="imageModal" role="dialog">
<span aria-label="Fechar imagem" class="absolute top-4 right-6 text-white text-3xl cursor-pointer" id="closeModal">√ó</span>
<img alt="Imagem" class="max-h-[90%] max-w-[90%] rounded-lg shadow-lg" id="modalImg" src=""/>
</div>
<!-- Modal prioridade -->
<div aria-modal="true" class="hidden fixed inset-0 z-50" id="priorityModal" role="dialog">
<div aria-hidden="true" class="absolute inset-0 bg-black/60" onclick="fecharPriorityModal()"></div>
<div class="relative mx-auto mt-24 w-[95%] max-w-md rounded-xl shadow-xl border" style="background: var(--content-bg); border-color: var(--border)">
<div class="p-4 border-b flex items-center justify-between" style="border-color:var(--border)">
<h3 class="font-semibold">Pedir prioridade</h3>
<button aria-label="Fechar" class="muted" onclick="fecharPriorityModal()">‚úñ</button>
</div>
<div class="p-4 space-y-3">
<label class="block text-sm muted">Telefone do cliente</label>
<input autocomplete="off" class="w-full p-2 border rounded-md" id="priorityTelefone" inputmode="numeric" pattern="[0-9]*" placeholder="Ex: 61999999999 ou 5561999999999">
<p class="text-xs muted">Aten√ß√£o: informe um telefone v√°lido DDD + 8/9 d√≠gitos.</p>
<div class="text-sm" id="priorityInfo" style="color:var(--text)"></div>
<div aria-live="polite" class="text-sm text-red-600 hidden" id="priorityErro" role="alert"></div>
</input></div>
<div class="p-4 border-t flex items-center justify-end gap-2" style="border-color:var(--border)">
<button class="btn btn-neutral px-3 py-2 text-sm" onclick="fecharPriorityModal()">Cancelar</button>
<button class="px-3 py-2 text-sm text-white rounded-md hover:bg-purple-700 flex items-center gap-2" id="btnPriorityBuscar" style="background: rebeccapurple">
<svg aria-hidden="true" class="hidden animate-spin h-4 w-4" id="prioritySpinner" viewbox="0 0 24 24">
<circle class="opacity-25" cx="12" cy="12" fill="none" r="10" stroke="currentColor" stroke-width="4">
</circle>
<path class="opacity-75" d="M4 12a 8 8 0 018-8v4a 4 4 0 00-4 4H4z" fill="currentColor"></path>
</svg>
<span id="priorityBtnLabel">Buscar e solicitar</span>
</button>
</div>
</div>
</div>
<!-- Theme Drawer -->
<div aria-hidden="true" class="drawer" id="themeDrawer">
<div class="h-full flex flex-col">
<div class="p-4 border-b flex items-center justify-between" style="border-color:var(--border)">
<h3 class="font-semibold">üé® Seu tema</h3>
<div class="flex items-center gap-2">
<button class="btn btn-ghost px-2 py-1 text-xs" id="btnThemeExport">Salvar no meu computador</button>
<label class="btn btn-ghost px-2 py-1 text-xs cursor-pointer">Importar um tema salvo <input accept="application/json" class="hidden" id="importTheme" type="file"/></label>
<button aria-label="Fechar" class="btn btn-ghost px-2 py-1 text-xs" id="btnThemeClose">‚úñ</button>
</div>
</div>
<div class="p-4 overflow-y-auto space-y-6">
<!-- Temas r√°pidos -->
<section>
<div class="text-xs muted mb-2">Temas r√°pidos</div>
<div class="grid grid-cols-2 gap-2">
<div class="preset" data-preset="corporate">
<div class="h-8 rounded" style="background:linear-gradient(90deg,#0ea5e9,#2563eb)"></div>
<div class="mt-1 text-xs">Corporate</div>
</div>
<div class="preset" data-preset="ocean">
<div class="h-8 rounded" style="background:linear-gradient(90deg,#06b6d4,#10b981)"></div>
<div class="mt-1 text-xs">Ocean</div>
</div>
<div class="preset" data-ppreset="sunset">
<div class="h-8 rounded" style="background:linear-gradient(90deg,#fb923c,#ef4444)"></div>
<div class="mt-1 text-xs">Sunset</div>
</div>
<div class="preset" data-preset="dark">
<div class="h-8 rounded" style="background:linear-gradient(90deg,#0b1220,#374151)"></div>
<div class="mt-1 text-xs">Dark</div>
</div>
<div class="preset" data-preset="minimal">
<div class="h-8 rounded" style="background:linear-gradient(90deg,#f8fafc,#e2e8f0)"></div>
<div class="mt-1 text-xs">Minimal</div>
</div>
<div class="preset" data-preset="funky">
<div class="h-8 rounded" style="background:linear-gradient(90deg,#a78bfa,#ec4899)"></div>
<div class="mt-1 text-xs">Funky</div>
</div>
</div>
</section>
<hr style="border-color:var(--border)"/>
<!-- Personalizar -->
<section>
<div class="text-xs muted mb-2">Personalizar</div>
<div class="grid grid-cols-2 gap-3">
<label class="block"><span class="text-xs muted">Bot√£o PDF</span><input class="w-full h-10 border rounded" id="tPrimary" type="color" value="#3b82f6"/></label>
<label class="block"><span class="text-xs muted">Bot√£o Concluir</span><input class="w-full h-10 border rounded" id="tAccent" type="color" value="#22c55e"/></label>
<label class="block"><span class="text-xs muted">Barra lateral</span><input class="w-full h-10 border rounded" id="tSidebar" type="color" value="#ffffff"/></label>
<label class="block"><span class="text-xs muted">Cabe√ßalho</span><input class="w-full h-10 border rounded" id="tContentBg" type="color" value="#ffffff"/></label>
<label class="block"><span class="text-xs muted">Cor de fundo</span><input class="w-full h-10 border rounded" id="tBg" type="color" value="#f3f4f6"/></label>
<label class="block"><span class="text-xs muted">Texto</span><input class="w-full h-10 border rounded" id="tText" type="color" value="#0f172a"/></label>
</div>
<div class="grid grid-cols-2 gap-3 mt-3">
<label class="block"><span class="text-xs muted">Minha mensagem cor 1</span><input class="w-full h-10 border rounded" id="tOutG1" type="color" value="#dcf8c6"/></label>
<label class="block"><span class="text-xs muted">Minha mensagem cor 2</span><input class="w-full h-10 border rounded" id="tOutG2" type="color" value="#b8f0a4"/></label>
<label class="block"><span class="text-xs muted">Cliente mensagem cor</span><input class="w-full h-10 border rounded" id="tInBg" type="color" value="#ffffff"/></label>
<label class="block"><span class="text-xs muted">Cliente mensagem bordas</span><input class="w-full h-10 border rounded" id="tInBorder" type="color" value="#e2e8f0"/></label>
<label class="block"><span class="text-xs muted">Canto arredondado dos bal√µes</span><input class="w-full" id="tRadius" max="28" min="8" type="range" value="18"/></label>
</div>
<div class="grid grid-cols-1 gap-3 mt-3">
<label class="block"><span class="text-xs muted">Opacidade do fundo</span><input id="tBgOp" max="1" min="0" step="0.05" type="range" value="0"/></label>
</div>
<div class="grid grid-cols-2 gap-3 mt-3">
<label class="block"><span class="text-xs muted">Tamanho base</span>
<select class="w-full p-2 border rounded" id="tFontSize">
<option value="13px">13px</option>
<option selected="" value="14px">14px</option>
<option value="15px">15px</option>
<option value="16px">16px</option>
</select>
</label>
<label class="block"><span class="text-xs muted">Canto arredondado dos bot√µes</span><input class="w-full" id="tBtnRadius" max="16" min="6" type="range" value="10"/></label>
<label class="block"><span class="text-xs muted">Canto arredondado dos cards de aviso</span><input class="w-full" id="tCardRadius" max="24" min="10" type="range" value="16"/></label>
</div>
<div class="flex items-center justify-between mt-4">
<div class="flex items-center gap-2">
<button class="btn btn-ghost px-3 py-2" id="btnRandom">üé≤ Surpreenda-me</button>
<button class="btn btn-ghost px-3 py-2" id="btnReset">‚Ü∫ Voltar ao padr√£o</button>
</div>
<button class="btn btn-primary px-4 py-2" id="btnSaveTheme">Salvar</button>
</div>
</section>
</div>
</div>
</div>
</section>
<!-- RELAT√ìRIO -->
<section class="hidden p-4" id="tabRelatorio">
<div class="max-w-6xl mx-auto space-y-4">
<div class="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
<div>
<h2 class="text-xl font-semibold section-title">Relat√≥rio Individual</h2>
<div class="text-sm muted" id="relatorioPeriodo">Hoje</div>
</div>
<!-- Filtros -->
<div class="flex flex-wrap gap-2 items-end">
<div class="flex flex-col">
<label class="text-xs muted">In√≠cio</label>
<input class="border rounded px-2 py-1" id="relStart" type="date">
</input></div>
<div class="flex flex-col">
<label class="text-xs muted">Fim</label>
<input class="border rounded px-2 py-1" id="relEnd" type="date">
</input></div>
<div class="flex gap-1">
<button class="btn btn-neutral px-2 py-1 text-xs" data-qk="hoje">Hoje</button>
<button class="btn btn-neutral px-2 py-1 text-xs" data-qk="ontem">Ontem</button>
<button class="btn btn-neutral px-2 py-1 text-xs" data-qk="7d">7d</button>
<button class="btn btn-neutral px-2 py-1 text-xs" data-qk="30d">30d</button>
</div>
<div class="pill select-none" id="relAgenteLock" title="Agente aplicado ao filtro">
              Agente: <span id="relAgentePill">‚Äî</span>
</div>
<button class="btn btn-primary px-3 py-2 text-sm" id="btnRefreshRel">Atualizar</button>
</div>
</div>
<!-- KPIs -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-3">
<div class="card p-4">
<div class="text-xs muted">Em atendimento</div>
<div class="text-2xl font-bold" id="kpiEm">0</div>
</div>
<div class="card p-4">
<div class="text-xs muted">Conclu√≠dos</div>
<div class="text-2xl font-bold" id="kpiConc">0</div>
</div>
<div class="card p-4">
<div class="text-xs muted">TMA</div>
<div class="text-2xl font-bold"><span id="kpiTma">‚Äî</span><span class="text-sm muted"> min</span></div>
</div>
<div class="card p-4">
<div class="text-xs muted">1¬™ resposta</div>
<div class="text-2xl font-bold"><span id="kpiFRT">‚Äî</span><span class="text-sm muted"> seg</span></div>
</div>
</div>
<!-- NOVO LAYOUT -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-3 items-start">
<!-- Extrato -->
<div class="card p-4 lg:col-span-2">
<div class="flex items-center justify-between">
<div class="font-semibold">Extrato de motivos (por dia)</div>
<button class="btn btn-neutral px-3 py-1 text-xs" id="btnExtratoRefresh">Atualizar extrato</button>
</div>
<div class="mt-3 extrato" id="extratoWrap"></div>
</div>
<!-- Coluna de gr√°ficos -->
<div class="space-y-3">
<div class="card p-4">
<div class="font-semibold">Distribui√ß√£o por status</div>
<div class="mt-3"><canvas class="chart-sm" id="pieStatus"></canvas></div>
</div>
<div class="card p-4">
<div class="font-semibold">Motivos de conclus√£o</div>
<div class="mt-3"><canvas class="chart-sm" id="pieMotivos"></canvas></div>
</div>
</div>
</div>
</div>
</section>
<section class="flex-1 p-6 hidden" id="tabEnvioIndividual">
<div class="max-w-4xl mx-auto">
<div class="card p-6">
<div class="flex items-start justify-between gap-3">
<div class="min-w-0">
<h2 class="text-xl font-bold">Envio individual ‚Äî Liga√ß√£o caiu</h2>
<p class="muted mt-1">Envia o template fixo e, se o cliente n√£o estiver em atendimento, puxa a conversa para a sua fila.</p>
</div>
<button class="btn btn-ghost px-3 py-2 text-sm" id="btnEnvIndIrParaConversa">Ir para Conversas</button>
</div>
<div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="md:col-span-2">
<label class="text-xs muted">Telefone (55DDDXXXXXXXX)</label>
<input autocomplete="off" class="input mt-1 w-full" id="envIndTelefone" placeholder="Ex: 5561999999999">
<div class="text-xs muted mt-1" id="envIndHint">Se voc√™ estiver com uma conversa aberta, o telefone √© preenchido automaticamente.</div>
</input></div>
<div>
<label class="text-xs muted">Phone ID</label>
<select class="input mt-1 w-full" id="envIndPhoneId"></select>
<div class="text-xs muted mt-1">Por padr√£o usamos o Phone ID da conversa (quando existir).</div>
</div>
</div>
<div class="mt-4 flex items-center gap-2">
<button class="btn btn-primary px-4 py-2 text-white disabled:opacity-50" id="btnEnvIndEnviar">Enviar template</button>
<span class="text-sm muted" id="envIndStatus"></span>
</div>
<details class="mt-4">
<summary class="text-sm link cursor-pointer">Ver detalhes do resultado</summary>
<pre class="mt-2 p-3 text-xs overflow-auto" id="envIndResult" style="max-height: 260px; border:1px solid var(--border); border-radius: 12px; background: var(--ghost-bg);"></pre>
</details>
</div>
</div>
</section>
</div>
<!-- MODAL DE LOGIN -->
<div class="modal" id="modalLogin">
<div class="modal-inner">
<div class="p-4 border-b flex items-center justify-between" style="border-color:var(--border)">
<h3 class="font-semibold">Identifique-se</h3>
<button aria-label="Fechar" class="btn btn-ghost px-2 py-1 text-xs" onclick="fecharModalLogin()">‚úñ</button>
</div>
<div class="p-4 space-y-3">
<label class="block text-sm muted">Informe seu c√≥digo de agente</label>
<input class="w-full p-2 border rounded-md" id="loginCodigoAgente" inputmode="numeric" pattern="[0-9]*" placeholder="Ex: 101">
<p class="text-xs muted">Seja bem-vindo(a) ao ConnectZap.</p>
<div aria-live="polite" class="text-sm text-red-600 hidden" id="loginErro" role="alert"></div>
</input></div>
<div class="p-4 border-t flex items-center justify-end gap-2" style="border-color:var(--border)">
<button class="btn btn-neutral px-3 py-2 text-sm" onclick="fecharModalLogin()">Cancelar</button>
<button class="px-3 py-2 text-sm text-white rounded-md" id="btnDoLogin" style="background:var(--primary)">Confirmar</button>
</div>
</div>
</div>
<!-- MODAL DE FEEDBACK CURTO (logout / login required) -->
<div aria-live="polite" aria-modal="true" class="modal" id="modalFeedback" role="dialog">
<div class="modal-inner">
<div class="p-4 border-b flex items-center justify-between" style="border-color:var(--border)">
<h3 class="font-semibold" id="feedbackTitle">Aviso</h3>
<button aria-label="Fechar" class="btn btn-ghost px-2 py-1 text-xs" onclick="fecharModalFeedback()">‚úñ</button>
</div>
<div class="p-5">
<p class="text-sm" id="feedbackMsg"></p>
</div>
<div class="p-3 border-t flex items-center justify-end" style="border-color:var(--border)">
<button class="btn btn-primary px-3 py-2 text-sm" onclick="fecharModalFeedback()">Ok</button>
</div>
</div>
</div>
<script>
    /** ============== CONFIG / APIs ============== */
    const FILA_API = (window.FILA_API || "https://whatsapp-webhook-production-9a27.up.railway.app/api").replace(/\/+$/, '');
    const CONV_API = (window.CONV_API || "https://conversas-api-production.up.railway.app").replace(/\/+$/, '');
    const API_BASE = (window.API_BASE || "https://dashboard-production-4c05.up.railway.app").replace(/\/+$/, '');
    const LOGOUT_REDIRECT = window.LOGOUT_REDIRECT || null;
    const NOTICES_API = () => `${FILA_API}/painel/avisos_agentes${agente?.carteira ? `?carteira=${encodeURIComponent(agente.carteira)}` : ''}`;

    /** ============== CARTEIRAS / Phone IDs ============== */
    const phoneIdMap = { "789025174304270": "ConnectZap", "805610009301153": "Banco PAN", "727586317113885": "Recovery PJ", "864779140046932": "Recovery PF", "802977069563598": "Recovery PF", "864779140046932,802977069563598": "Recovery PF", "873637622491517": "Mercado Pago Cobran√ßa", "821562937700669": "Mercado Pago Cobran√ßa", "873637622491517,821562937700669": "Mercado Pago Cobran√ßa", "779797401888141": "DivZero", "829210283602406": "Arc4U","905309685992125": "Arc4U Veiculos", "713021321904495": "Serasa", "803535039503723": "Mercado Pago Vendas" };
    const carteiraToPhoneIds = Object.entries(phoneIdMap).reduce((acc, [ids, nome]) => { const parts = String(ids).split(',').map(s => s.trim()).filter(Boolean); acc[nome] = Array.from(new Set([...(acc[nome] || []), ...parts])); return acc; }, {})

    /** ============== ESTADO ============== */
    let agente = { codigo: null, nome: null, carteira: null, origem: null, online: false };
    let tickets = []; let selecionado = null; let renderedKeys = new Set(); let lastTimestampMs = null; let lastDayRendered = null;
    let pollingContatos = null; let pollingMensagens = null; let isModalOpen = false; let userTyping = false; let respostaMsgId = null;
    let limitPerAgent = 0; let ativosCount = 0;
    let unreadCountByKey = {}; let lastContatoTsByKey = {};
    let ordemCache = []; let pieChart = null; // status
    let chartMotivos = null; // motivos
    let typingTimer = null;

    // Avisos
    let notices = [];
    let noticesFilter = 'all';
    let noticesReadSet = new Set();

    /** ============== UTILS ============== */
    const DOC_PREVIEW_MAX = 2 * 1024 * 1024;
    const POLL_ACTIVE_MS = 5000, POLL_HIDDEN_MS = 30000;
    const fmtHoraBR = new Intl.DateTimeFormat('pt-BR', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Sao_Paulo' });
    const fmtDataBR = new Intl.DateTimeFormat('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'America/Sao_Paulo' });
    function fmtYMD(d) { const z = n => String(n).padStart(2, '0'); return `${d.getFullYear()}-${z(d.getMonth() + 1)}-${z(d.getDate())}` }
    function qsParam(name) { return new URLSearchParams(location.search).get(name) }
    function escapeHtml(s) { if (!s) return ""; return s.replace(/[&<>"']/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch])) }
    const __colorCache = new Map(); function gerarCor(nome) { const key = String(nome || "U"); if (__colorCache.has(key)) return __colorCache.get(key); let h = 0; for (const c of key) h = c.charCodeAt(0) + ((h << 5) - h); const v = `hsl(${h % 360},70%,60%)`; __colorCache.set(key, v); return v }
    function keyLocal() { return `cz:tickets:${agente.codigo}:${agente.carteira}` }
    let __lastSavedTicketsStr = ""; function saveTickets() { try { const s = JSON.stringify(tickets); if (s !== __lastSavedTicketsStr) { localStorage.setItem(keyLocal(), s); __lastSavedTicketsStr = s } } catch { } }
    function loadTickets() { try { tickets = JSON.parse(localStorage.getItem(keyLocal()) || "[]") || [] } catch { tickets = [] } }
    function bytesToHuman(n) { if (n === undefined || n === null) return ''; const u = ['B', 'KB', 'MB', 'GB', 'TB']; let i = 0, s = n; while (s >= 1024 && i < u.length - 1) { s /= 1024; i++ } return `${s.toFixed(s >= 10 || i === 0 ? 0 : 1)} ${u[i]}` }
    function isIncoming(m) { const s = (m.status || "").toLowerCase(); if (typeof m.from_me === "boolean") return !m.from_me; if (m.direction) return String(m.direction).toLowerCase().startsWith("in"); if (["in", "received", "incoming"].includes(s)) return true; if (["out", "sent", "delivered", "read", "outgoing"].includes(s)) return false; return s === "in" }
    function storageKeys() {
      return { unread: `cz:unreadCount:${agente.codigo || 'anon'}:${agente.carteira || 'cart'}`, lastTs: `cz:lastContatoTs:${agente.codigo || 'anon'}:${agente.carteira || 'cart'}` }
    }
    function loadUnread() { try { const { unread, lastTs } = storageKeys(); unreadCountByKey = JSON.parse(localStorage.getItem(unread) || "{}"); lastContatoTsByKey = JSON.parse(localStorage.getItem(lastTs) || "{}") } catch { unreadCountByKey = {}; lastContatoTsByKey = {} } }
    function persistUnread() { try { const { unread, lastTs } = storageKeys(); localStorage.setItem(unread, JSON.stringify(unreadCountByKey)); localStorage.setItem(lastTs, JSON.stringify(lastContatoTsByKey)) } catch { } }
    function keyFrom(remetente, phone_id) { return `${remetente}|${phone_id || ''}` }
    function schedulePolls() { if (pollingContatos) clearInterval(pollingContatos); if (pollingMensagens) clearInterval(pollingMensagens); const gap = document.hidden ? POLL_HIDDEN_MS : POLL_ACTIVE_MS; pollingContatos = setInterval(refreshOrdemCarteira, gap); if (selecionado) { pollingMensagens = setInterval(() => { if (!userTyping && !isModalOpen && selecionado) carregarMensagens(true) }, gap) } }
    document.addEventListener('visibilitychange', schedulePolls);

    function timeAgo(iso) {
      if (!iso) return '';
      const now = new Date(), d = new Date(iso);
      const sec = Math.max(1, Math.floor((now - d) / 1000));
      if (sec < 60) return `${sec}s atr√°s`;
      const min = Math.floor(sec / 60); if (min < 60) return `${min}m atr√°s`;
      const h = Math.floor(min / 60); if (h < 24) return `${h}h atr√°s`;
      const days = Math.floor(h / 24); return `${days}d atr√°s`;
    }

    function betweenNow(starts_at, ends_at) {
      const now = new Date();
      const okStart = !starts_at || new Date(starts_at) <= now;
      const okEnd = !ends_at || new Date(ends_at) >= now;
      return okStart && okEnd;
    }

    function hashId(s) {
      // djb2
      let h = 5381; for (let i = 0; i < s.length; i++) h = ((h << 5) + h) + s.charCodeAt(i);
      return String(h >>> 0);
    }

    /** ============== DOM ============== */
    // Home
    const elHomeNome = document.getElementById('homeAgenteNome');
    const elHomeCart = document.getElementById('homeAgenteCarteira');
    const elHomeStatus = document.getElementById('homeStatus');
    const elHomeAviso = document.getElementById('homeAviso');
    const heroWrap = document.getElementById('homeAvisoHero');
    const heroTitle = document.getElementById('heroTitle');
    const heroMeta = document.getElementById('heroMeta');
    const heroBody = document.getElementById('heroBody');
    const heroDismiss = document.getElementById('heroDismiss');
    const heroMarkRead = document.getElementById('heroMarkRead');

    // Relat√≥rio
    const kpiEm = document.getElementById('kpiEm');
    const kpiConc = document.getElementById('kpiConc');
    const kpiTma = document.getElementById('kpiTma');
    const kpiFRT = document.getElementById('kpiFRT');
    const btnRefreshRel = document.getElementById('btnRefreshRel');
    const relStart = document.getElementById('relStart');
    const relEnd = document.getElementById('relEnd');
    const relPeriodo = document.getElementById('relatorioPeriodo');
    const relAgentePill = document.getElementById('relAgentePill');
    const btnExtratoRefresh = document.getElementById('btnExtratoRefresh');
    const extratoWrap = document.getElementById('extratoWrap');

    // Conversas
    const elAgenteNome = document.getElementById("agenteNome");
    const elAgenteCarteira = document.getElementById("agenteCarteira");
    const elAgenteStatus = document.getElementById("agenteStatus");
    const elMsgAviso = document.getElementById("msgAviso");
    const elMsgLimite = document.getElementById("msgLimite");
    const elListaTickets = document.getElementById("listaTickets");
    const elTitulo = document.getElementById("tituloConversa");
    const elSubInfo = document.getElementById("subInfo");
    const chat = document.getElementById("chat");
    const textarea = document.getElementById("textoMensagem");
    const btnEnviar = document.getElementById("btnEnviar");
    const btnPegarProxima = document.getElementById("btnPegarProxima");
    const btnPrioridade = document.getElementById("btnPrioridade");
    const btnLiberar = document.getElementById("btnLiberar");
    const btnConcluir = document.getElementById("btnConcluir");
    const menuConcluir = document.getElementById("menuConcluir");
    const digitando = document.getElementById("digitando");
    const badgeAtivos = document.getElementById("badgeAtivos");
    const badgeLimite = document.getElementById("badgeLimite");

    // Bot√µes Home
    const btnToggleOnline = document.getElementById("btnToggleOnline");
    const btnLogout = document.getElementById("btnLogout");

    // Tabs
    const tabBtnHome = document.getElementById('tabBtnHome');
    const tabBtnConversas = document.getElementById('tabBtnConversas');
    const tabBtnRelatorio = document.getElementById('tabBtnRelatorio');
    const tabBtnEnvioIndividual = document.getElementById('tabBtnEnvioIndividual');
    const tabHome = document.getElementById('tabHome');
    const tabConversas = document.getElementById('tabConversas');
    const tabRelatorio = document.getElementById('tabRelatorio');
    const tabEnvioIndividual = document.getElementById('tabEnvioIndividual');
    document.getElementById('goToConversas1').onclick = () => switchTab('conversas');
    document.getElementById('goToRelatorio1').onclick = () => switchTab('relatorio');

    // Avisos (DOM)
    const avisosWrap = document.getElementById('avisosWrap');
    const avisosResumo = document.getElementById('avisosResumo');
    const btnAvisoRefresh = document.getElementById('btnAvisoRefresh');
    const avisosCountPill = document.getElementById('avisosCountPill');

    /** ============== MENU CONCLUIR ============== */
    const MOTIVOS_CONCLUSAO = ["Realizou negocia√ß√£o", "Solicitou 2¬™ via de boleto", "Recusou a proposta", "D√∫vidas gerais", "Cliente ficou inativo"];
    function renderMenuConcluir() {
      menuConcluir.innerHTML = MOTIVOS_CONCLUSAO.map(m => `<button type="button" data-motivo="${m}" class="w-full text-left px-3 py-2 text-sm" style="border-bottom:1px solid var(--border)">${m}</button>`).join("");
      menuConcluir.querySelectorAll("button[data-motivo]").forEach(btn => {
        btn.onmouseenter = () => btn.style.background = getCss('--hover');
        btn.onmouseleave = () => btn.style.background = 'transparent';
        btn.onclick = async () => { await concluirAtendimento(btn.getAttribute("data-motivo")); fecharMenuConcluir(); };
      });
    }
    function abrirMenuConcluir() { if (!selecionado || btnConcluir.disabled) return; menuConcluir.classList.remove("hidden"); btnConcluir.setAttribute("aria-expanded", "true"); document.addEventListener("click", clickForaMenuConcluir, { capture: true }) }
    function fecharMenuConcluir() { menuConcluir.classList.add("hidden"); btnConcluir.setAttribute("aria-expanded", "false"); document.removeEventListener("click", clickForaMenuConcluir, { capture: true }) }
    function clickForaMenuConcluir(e) { const within = menuConcluir.contains(e.target) || btnConcluir.contains(e.target); if (!within) fecharMenuConcluir() }
    btnConcluir.onclick = () => { menuConcluir.classList.contains("hidden") ? abrirMenuConcluir() : fecharMenuConcluir() };
    renderMenuConcluir();

    /** ============== THEME ============== */
    function themeKey() { return 'cz:theme:v2' }
    function defaultTheme() {
      return { primary: "#3b82f6", accent: "#22c55e", sidebar: "#ffffff", contentBg: "#ffffff", bg: "#f3f4f6", text: "#0f172a", muted: "#6b7280", border: "#e5e7eb", link: "#2563eb", ghostBg: "#f3f4f6", outG1: "#dcf8c6", outG2: "#b8f0a4", outFg: "#111827", inBg: "#ffffff", inBorder: "#e2e8f0", inFg: "#0f172a", bubbleRadius: 18, btnRadius: 10, cardRadius: 16, wallOp: 0, fontSize: "14px", ticketSelectedBg: "#f0f9ff", hover: "#f1f5f9", hoverStrong: "#e2e8f0", inputBg: "#ffffff", inputFg: "#0f172a", scrollbar: "#cbd5e1", replyBg: "rgba(0,0,0,.06)", replyBorder: "rgba(0,0,0,.08)", replyFg: "#334155" }
    }
    function applyTheme(t) {
      const r = document.documentElement.style; const base = defaultTheme(); const x = { ...base, ...t };
      r.setProperty('--ticket-selected-bg', x.ticketSelectedBg);
      r.setProperty('--sidebar-bg', x.sidebar); r.setProperty('--content-bg', x.contentBg);
      r.setProperty('--bg', x.bg); r.setProperty('--text', x.text);
      r.setProperty('--muted', x.muted); r.setProperty('--border', x.border);
      r.setProperty('--link', x.link); r.setProperty('--ghost-bg', x.ghostBg);
      r.setProperty('--bubble-out-g1', x.outG1); r.setProperty('--bubble-out-g2', x.outG2); r.setProperty('--bubble-out-fg', x.outFg || '#111827');
      r.setProperty('--bubble-in-bg', x.inBg); r.setProperty('--bubble-in-border', x.inBorder); r.setProperty('--bubble-in-fg', x.inFg || '#0f172a');
      r.setProperty('--bubble-radius', x.bubbleRadius + 'px'); r.setProperty('--btn-radius', x.btnRadius + 'px'); r.setProperty('--card-radius', x.cardRadius + 'px');
      r.setProperty('--font-size', x.fontSize); r.setProperty('--chat-wallpaper-opacity', x.wallOp);
      r.setProperty('--scrollbar', x.scrollbar || '#cbd5e1'); r.setProperty('--primary', x.primary); r.setProperty('--accent', x.accent);
      r.setProperty('--hover', x.hover || '#f1f5f9'); r.setProperty('--hover-strong', x.hoverStrong || '#e2e8f0');
      r.setProperty('--input-bg', x.inputBg || x.contentBg); r.setProperty('--input-fg', x.inputFg || x.text);
      r.setProperty('--reply-bg', x.replyBg || 'rgba(0,0,0,.06)'); r.setProperty('--reply-border', x.replyBorder || 'rgba(0,0,0,.08)'); r.setProperty('--reply-fg', x.replyFg || '#334155');

      // Sincroniza com os inputs do drawer
      inputs.tPrimary.value = x.primary; inputs.tAccent.value = x.accent; inputs.tSidebar.value = x.sidebar;
      inputs.tContentBg.value = x.contentBg; inputs.tBg.value = x.bg; inputs.tText.value = x.text;
      inputs.tOutG1.value = x.outG1; inputs.tOutG2.value = x.outG2; inputs.tInBg.value = x.inBg; inputs.tInBorder.value = x.inBorder;
      inputs.tRadius.value = x.bubbleRadius; inputs.tBgOp.value = x.wallOp; inputs.tFontSize.value = x.fontSize;
      inputs.tBtnRadius.value = x.btnRadius; inputs.tCardRadius.value = x.cardRadius;

      // Atualiza gr√°ficos
      setTimeout(() => refreshKPIs(), 0);
    }
    function readThemeFromInputs() {
      return {
        primary: inputs.tPrimary.value, accent: inputs.tAccent.value, sidebar: inputs.tSidebar.value, contentBg: inputs.tContentBg.value,
        bg: inputs.tBg.value, text: inputs.tText.value, outG1: inputs.tOutG1.value, outG2: inputs.tOutG2.value, inBg: inputs.tInBg.value,
        inBorder: inputs.tInBorder.value, bubbleRadius: Number(inputs.tRadius.value || 18), wallOp: Number(inputs.tBgOp.value || 0),
        fontSize: String(inputs.tFontSize.value || '14px'), btnRadius: Number(inputs.tBtnRadius.value || 10), cardRadius: Number(inputs.tCardRadius.value || 16)
      }
    }
    function saveTheme(t) { try { localStorage.setItem(themeKey(), JSON.stringify(t)); } catch { } }
    function loadTheme() {
      try {
        const now = localStorage.getItem(themeKey()); if (now) return JSON.parse(now);
        const old1 = localStorage.getItem(`cz:theme:${agente.codigo || 'anon'}`); if (old1) { localStorage.setItem(themeKey(), old1); return JSON.parse(old1) }
        const old2 = localStorage.getItem('cz:theme:anon'); if (old2) { localStorage.setItem(themeKey(), old2); return JSON.parse(old2) }
      } catch { }
      return null;
    }

    const themeDrawer = document.getElementById('themeDrawer');
    const btnTheme = document.getElementById('btnTheme');
    const btnThemeClose = document.getElementById('btnThemeClose');
    const btnSaveTheme = document.getElementById('btnSaveTheme');
    const btnRandom = document.getElementById('btnRandom');
    const btnReset = document.getElementById('btnReset');
    const btnThemeExport = document.getElementById('btnThemeExport');
    const importTheme = document.getElementById('importTheme');
    const inputs = {
      tPrimary: document.getElementById('tPrimary'),
      tAccent: document.getElementById('tAccent'),
      tSidebar: document.getElementById('tSidebar'),
      tContentBg: document.getElementById('tContentBg'),
      tBg: document.getElementById('tBg'),
      tText: document.getElementById('tText'),
      tOutG1: document.getElementById('tOutG1'),
      tOutG2: document.getElementById('tOutG2'),
      tInBg: document.getElementById('tInBg'),
      tInBorder: document.getElementById('tInBorder'),
      tRadius: document.getElementById('tRadius'),
      tBgOp: document.getElementById('tBgOp'),
      tFontSize: document.getElementById('tFontSize'),
      tBtnRadius: document.getElementById('tBtnRadius'),
      tCardRadius: document.getElementById('tCardRadius')
    };
    if (btnTheme) btnTheme.addEventListener('click', () => themeDrawer.classList.add('open'));
    if (btnThemeClose) btnThemeClose.addEventListener('click', () => themeDrawer.classList.remove('open'));
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && themeDrawer.classList.contains('open')) themeDrawer.classList.remove('open') });
    [inputs.tPrimary, inputs.tAccent, inputs.tSidebar, inputs.tContentBg, inputs.tBg, inputs.tText, inputs.tOutG1, inputs.tOutG2, inputs.tInBg, inputs?.tInBorder, inputs.tRadius, inputs.tBgOp, inputs.tFontSize, inputs.tBtnRadius, inputs.tCardRadius]
      .filter(Boolean).forEach(i => i.addEventListener('input', () => applyTheme(readThemeFromInputs())));
    if (btnSaveTheme) btnSaveTheme.addEventListener('click', () => { const t = readThemeFromInputs(); saveTheme(t); themeDrawer.classList.remove('open') });
    if (btnReset) btnReset.addEventListener('click', () => { const t = defaultTheme(); applyTheme(t); saveTheme(t) });
    if (btnRandom) btnRandom.addEventListener('click', () => {
      const rand = () => ('#' + Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0'));
      const b1 = rand(), b2 = rand();
      const t = { ...defaultTheme(), primary: rand(), accent: rand(), outG1: b1, outG2: b2, bg: '#f8fafc', wallOp: (Math.random() > .5 ? .08 : 0), bubbleRadius: 14 + Math.floor(Math.random() * 12), btnRadius: 8 + Math.floor(Math.random() * 6), cardRadius: 14 + Math.floor(Math.random() * 8) };
      applyTheme(t)
    });

    /** ============== VISIBILIDADE DO APP (novo) ============== */
    function hideApp() {
      document.getElementById('appSidebar')?.classList.add('hidden');
      document.getElementById('tabsWrapper')?.classList.add('hidden');
    }
    function showApp() {
      document.getElementById('appSidebar')?.classList.remove('hidden');
      document.getElementById('tabsWrapper')?.classList.remove('hidden');
    }

    /** ============== LOGIN MODAL ============== */
    function isLogged() { try { return !!localStorage.getItem('agente_codigo') } catch { return false } }
    function abrirModalLogin() { const m = document.getElementById('modalLogin'); m.style.display = 'flex'; setTimeout(() => document.getElementById('loginCodigoAgente').focus(), 50); isModalOpen = true }
    function fecharModalLogin() { const m = document.getElementById('modalLogin'); m.style.display = 'none'; const e = document.getElementById('loginErro'); e.textContent = ''; e.classList.add('hidden'); isModalOpen = false }
    async function login() {
      const codigo = (document.getElementById('loginCodigoAgente').value || '').trim(); const erro = document.getElementById('loginErro');
      if (!codigo || !/^\d+$/.test(codigo)) { erro.textContent = 'Informe um c√≥digo num√©rico v√°lido.'; erro.classList.remove('hidden'); return }
      try {
        const r = await fetch(`${FILA_API}/agentes/${encodeURIComponent(codigo)}`); const j = await r.json();
        if (!j.ok) { throw new Error(j.erro || 'Agente n√£o encontrado') }
        localStorage.setItem("agente_codigo", String(codigo));
        localStorage.setItem("agente_nome", j.agente?.nome || `Agente ${codigo}`);
        localStorage.setItem("agente_carteira", j.agente?.carteira || 'ConnectZap');
        localStorage.setItem("agente_perm_envio_individual", j.agente?.permite_envio_individual ? "1" : "0");
        fecharModalLogin();
        showApp();                       
        await boot();                    
        switchTab('home');
        updateAuthButton();
      } catch (e) { erro.textContent = e?.message || 'Falha ao validar c√≥digo.'; erro.classList.remove('hidden') }
    }
    document.getElementById('btnDoLogin').onclick = login;
    document.getElementById('loginCodigoAgente').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); login(); } });

    /** ============== MODAL FEEDBACK (Logout / login required) ============== */
    const modalFeedback = document.getElementById('modalFeedback');
    const feedbackTitle = document.getElementById('feedbackTitle');
    const feedbackMsg = document.getElementById('feedbackMsg');
    let feedbackTimer = null;
    function showModalFeedback(msg, title = 'Aviso', autocloseMs = 1200) {
      feedbackTitle.textContent = title;
      feedbackMsg.textContent = msg;
      modalFeedback.style.display = 'flex';
      if (feedbackTimer) { clearTimeout(feedbackTimer); feedbackTimer = null; }
      if (autocloseMs && autocloseMs > 0) {
        feedbackTimer = setTimeout(() => fecharModalFeedback(), autocloseMs);
      }
    }
    function fecharModalFeedback() {
      modalFeedback.style.display = 'none';
      if (feedbackTimer) { clearTimeout(feedbackTimer); feedbackTimer = null; }
    }

    /** ============== PENDENTES NA FILA (Home) ‚Äî 60s ============== */
    const PENDENTES_REFRESH_MS = 60000;
    let pendentesInterval = null;

    function PENDENTES_API_CANDIDATES() {
      const cart = agente?.carteira || '';
      const params = cart ? `?carteira=${encodeURIComponent(cart)}` : '';
      return [
        `${FILA_API}/fila/pendentes${params}`,
        `${FILA_API}/fila/pendentes_por_carteira${params}`
      ];
    }
    function extractPendentesCount(payload) {
      if (payload == null) return null;
      if (typeof payload === 'number') return payload;
      if (Array.isArray(payload)) {
        const cart = agente?.carteira;
        let row = null;
        if (cart) {
          row = payload.find(r =>
          (r && (
            (r.carteira && String(r.carteira) === String(cart)) ||
            (r.fila && String(r.fila) === String(cart)) ||
            (r.nome && String(r.nome) === String(cart))
          )));
        }
        if (!row && payload.length === 1) row = payload[0];
        if (row) {
          for (const k of ['pendentes', 'qtd', 'qtde', 'total', 'count', 'qtd_pendentes']) {
            const v = Number(row[k]); if (!Number.isNaN(v)) return v;
          }
        }
        const nums = payload.map(x => Number(x)).filter(v => !Number.isNaN(v));
        if (nums.length) return nums.reduce((a, b) => a + b, 0);
        return null;
      }
      if (typeof payload === 'object') {
        for (const k of ['pendentes', 'qtd', 'qtde', 'total', 'count', 'qtd_pendentes']) {
          const v = Number(payload[k]); if (!Number.isNaN(v) && v >= 0) return v;
        }
        const cart = agente?.carteira;
        if (cart && payload[cart] != null) {
          const v = Number(payload[cart]); if (!Number.isNaN(v)) return v;
        }
      }
      return null;
    }
    async function fetchPendentesFilaOnce() {
      if (!agente?.carteira) return null;
      const els = [document.getElementById('homePendentesBadge'), document.getElementById('homePendentesBadge2')].filter(Boolean);
      const setLoading = () => els.forEach(e => e && (e.textContent = '‚Ä¶'));
      const setVal = (n) => els.forEach(e => e && (e.textContent = String(n)));
      try {
        setLoading();
        const urls = PENDENTES_API_CANDIDATES();
        for (const url of urls) {
          try {
            const r = await fetch(url);
            if (!r.ok) continue;
            const j = await r.json();
            const n = extractPendentesCount(j);
            if (n != null) { setVal(n); return n; }
          } catch (_) { }
        }
        setVal('‚Äî');
        return null;
      } catch {
        setVal('‚Äî');
        return null;
      }
    }
    function initPendentesFila() {
      if (pendentesInterval) clearInterval(pendentesInterval);
      fetchPendentesFilaOnce();
      pendentesInterval = setInterval(fetchPendentesFilaOnce, PENDENTES_REFRESH_MS);
    }

    /** ============== BOOT ============== */
    function getCss(varName) { return getComputedStyle(document.documentElement).getPropertyValue(varName).trim() }
    async function boot() {
      const savedT = loadTheme(); applyTheme(savedT || defaultTheme());

      // agente
      agente.codigo = localStorage.getItem("agente_codigo") || qsParam("codigo") || null;
      agente.origem = localStorage.getItem("agente_origem") || qsParam("origem") || 'web';

      updateAuthButton();
      toggleLoginLocks();
      try { renderPermissaoEnvioIndividual(); } catch (_) { }

      // datas padr√£o (hoje)
      const today = new Date(); const ymd = fmtYMD(today);
      relStart.value = ymd; relEnd.value = ymd;

      noticesReadSet = loadNoticesReadSet();

      if (!agente.codigo) {
        elHomeNome.textContent = '‚Äî'; elHomeCart.textContent = '‚Äî'; setStatus(false);
        relAgentePill.textContent = '‚Äî';
        await loadNoticesAndRender();
        return;
      }

      try {
        const r = await fetch(`${FILA_API}/agentes/${encodeURIComponent(agente.codigo)}`); const j = await r.json();
        if (!j.ok) throw new Error(j.erro || "Agente n√£o encontrado");
        agente.nome = j.agente?.nome || localStorage.getItem("agente_nome") || `Agente ${agente.codigo}`;
        agente.carteira = j.agente?.carteira || localStorage.getItem("agente_carteira") || 'ConnectZap';
        localStorage.setItem("agente_nome", agente.nome);
        localStorage.setItem("agente_carteira", agente.carteira);
        // Permiss√£o para Envio Individual (atualiza mesmo quando j√° estava logado)
        localStorage.setItem("agente_perm_envio_individual", j.agente?.permite_envio_individual ? "1" : "0");
        try { renderPermissaoEnvioIndividual(); } catch (_) { }

        elAgenteNome.textContent = `${agente.nome} (#${agente.codigo})`;
        elAgenteCarteira.textContent = agente.carteira;
        elHomeNome.textContent = agente.nome;
        elHomeCart.textContent = agente.carteira;
        relAgentePill.textContent = `${agente.nome} (#${agente.codigo})`;

        loadUnread();
        await verificarOnline();

        try {
          const url = `${CONV_API}/api/tickets/minhas?agente=${encodeURIComponent(agente.codigo)}&carteira=${encodeURIComponent(agente.carteira)}`;
          const r2 = await fetch(url); if (r2.ok) { tickets = await r2.json(); saveTickets(); }
        } catch { }

        renderTickets();
        schedulePolls();
        await refreshOrdemCarteira();
        await refreshAtivosELimite();
        if (!tickets.length) btnPegarProxima.disabled = !agente.online || (limitPerAgent > 0 && ativosCount >= limitPerAgent);

        // RELAT√ìRIO
        await refreshKPIs();

        // AVISOS
        await loadNoticesAndRender();

        // PENDENTES NA FILA (Home) ‚Äî inicia e mant√©m em 60s
        initPendentesFila();

        wireComposer();
      } catch (e) {
        elHomeAviso.classList.remove("hidden");
        elHomeAviso.textContent = "Falha ao carregar agente. Verifique seu c√≥digo ou API.";
        await loadNoticesAndRender();
      }
    }

    /** ============== Bot√£o Login/Logout din√¢mico ============== */
    function updateAuthButton() {
      const logged = isLogged();
      if (!btnLogout) return;
      // Reset classes base
      btnLogout.classList.remove('btn-neutral', 'btn-primary', 'btn-danger');
      if (logged) {
        btnLogout.textContent = "Logout";
        btnLogout.classList.add('btn', 'btn-danger');
        btnLogout.onclick = doLogout;
      } else {
        btnLogout.textContent = "Login";
        btnLogout.classList.add('btn', 'btn-primary');
        btnLogout.onclick = () => abrirModalLogin();
      }
    }

    // Trava visual nas abas que exigem login
    function toggleLoginLocks() {
      const locked = !isLogged();
      [tabBtnConversas, tabBtnRelatorio, tabBtnEnvioIndividual].forEach(btn => {
        if (!btn) return;
        if (locked) btn.classList.add('locked'); else btn.classList.remove('locked');
        btn.setAttribute('aria-disabled', locked ? 'true' : 'false');
        btn.title = locked ? 'Fa√ßa login para acessar' : (btn === tabBtnConversas ? 'Conversas' : (btn === tabBtnRelatorio ? 'Relat√≥rio' : 'Envio individual'));
      });
    }

    /** ============== TABS ============== */
    function switchTab(tab) {
      // Gate de login
      if ((tab === 'conversas' || tab === 'relatorio' || tab === 'envio_individual') && !isLogged()) {
        abrirModalLogin();
        showModalFeedback('Fa√ßa login para acessar Conversas e Relat√≥rio.', 'Acesso restrito', 1400);
        return;
      }
      [tabBtnHome, tabBtnConversas, tabBtnRelatorio, tabBtnEnvioIndividual].forEach(b => b && b.classList.remove('active'));
      tabHome.classList.add('hidden'); tabConversas.classList.add('hidden'); tabRelatorio.classList.add('hidden'); if (tabEnvioIndividual) tabEnvioIndividual.classList.add('hidden');
      if (tab === 'conversas') { tabBtnConversas.classList.add('active'); tabConversas.classList.remove('hidden') }
      else if (tab === 'relatorio') { tabBtnRelatorio.classList.add('active'); tabRelatorio.classList.remove('hidden') }
      else if (tab === 'envio_individual') {
        if (!hasPermEnvioIndividual()) {
          showModalFeedback('Seu usu√°rio n√£o tem permiss√£o para ‚ÄúEnvio individual‚Äù.', 'Acesso restrito', 1400);
          tabBtnHome.classList.add('active'); tabHome.classList.remove('hidden');
          return;
        }
        tabBtnEnvioIndividual && tabBtnEnvioIndividual.classList.add('active');
        tabEnvioIndividual && tabEnvioIndividual.classList.remove('hidden');
        try { envIndSyncFromConversa(); } catch (_) { }
      }
      else { tabBtnHome.classList.add('active'); tabHome.classList.remove('hidden') }
    }
    tabBtnHome.onclick = () => switchTab('home');
    tabBtnConversas.onclick = () => switchTab('conversas');
    tabBtnRelatorio.onclick = () => switchTab('relatorio');
    if (tabBtnEnvioIndividual) tabBtnEnvioIndividual.onclick = () => switchTab('envio_individual');


    /** ============== ENVIO INDIVIDUAL (Liga√ß√£o caiu) ============== */
    const envIndTelefone = document.getElementById('envIndTelefone');
    const envIndPhoneId = document.getElementById('envIndPhoneId');
    const btnEnvIndEnviar = document.getElementById('btnEnvIndEnviar');
    const envIndStatus = document.getElementById('envIndStatus');
    const envIndResult = document.getElementById('envIndResult');
    const btnEnvIndIrParaConversa = document.getElementById('btnEnvIndIrParaConversa');

    function hasPermEnvioIndividual() {
      //return localStorage.setItem("agente_perm_envio_individual", j.agente?.permite_envio_individual ? "1" : "0");
      return localStorage.getItem('agente_perm_envio_individual') === '1';
    }

    function renderPermissaoEnvioIndividual() {
      const ok = hasPermEnvioIndividual();
      if (tabBtnEnvioIndividual) tabBtnEnvioIndividual.classList.toggle('hidden', !ok);
      if (!ok && tabEnvioIndividual && !tabEnvioIndividual.classList.contains('hidden')) switchTab('home');
      if (ok) {
        try { envIndPopulatePhoneIds(selecionado ? selecionado.phone_id : null); } catch (_) { }
      }
      envIndUpdateSendState();
    }

    function envIndDedupe(arr) {
      return Array.from(new Set((arr || []).map(x => String(x)).filter(Boolean)));
    }

    function envIndPopulatePhoneIds(prefer) {
      if (!envIndPhoneId) return;
      const ids = envIndDedupe((typeof phoneIdsForCarteira === 'function') ? phoneIdsForCarteira() : (carteiraToPhoneIds[agente.carteira] || []).map(String));
      envIndPhoneId.innerHTML = ids.map(id => `<option value="${id}">${(phoneIdMap[id] || id)}</option>`).join('');
      const p = prefer ? String(prefer) : null;
      if (p && ids.includes(p)) envIndPhoneId.value = p;
      else if (ids.length) envIndPhoneId.value = ids[0];
    }

    function envIndSetStatus(msg, tone = 'muted', detailObj = null) {
      if (envIndStatus) {
        envIndStatus.textContent = msg || '';
        envIndStatus.classList.remove('muted', 'text-green-600', 'text-red-600', 'text-amber-600');
        if (tone === 'ok') envIndStatus.classList.add('text-green-600');
        else if (tone === 'err') envIndStatus.classList.add('text-red-600');
        else if (tone === 'warn') envIndStatus.classList.add('text-amber-600');
        else envIndStatus.classList.add('muted');
      }
      if (envIndResult && detailObj !== undefined) {
        envIndResult.textContent = detailObj ? JSON.stringify(detailObj, null, 2) : '';
      }
    }

    function envIndTelefoneAtual() {
      const raw = (envIndTelefone && envIndTelefone.value) ? envIndTelefone.value : (selecionado ? (selecionado.remetente || '') : '');
      if (typeof normalizarTelefone === 'function') return normalizarTelefone(raw);
      // fallback simples
      return String(raw || '').replace(/\D/g, '');
    }

    function envIndPhoneIdAtual() {
      if (selecionado && selecionado.phone_id) return String(selecionado.phone_id);
      if (envIndPhoneId && envIndPhoneId.value) return String(envIndPhoneId.value);
      const ids = (typeof phoneIdsForCarteira === 'function') ? phoneIdsForCarteira() : (carteiraToPhoneIds[agente.carteira] || []).map(String);
      return ids && ids.length ? String(ids[0]) : '';
    }

    function envIndSyncFromConversa() {
      if (!envIndTelefone || !envIndPhoneId) return;
      const tel = selecionado ? (selecionado.remetente || '') : '';
      if (tel) envIndTelefone.value = tel;
      envIndPopulatePhoneIds(selecionado ? selecionado.phone_id : null);
      envIndUpdateSendState();
    }

    function envIndUpdateSendState() {
      if (!btnEnvIndEnviar) return;
      const logged = isLogged();
      const allowed = hasPermEnvioIndividual();
      const tel = envIndTelefoneAtual();
      const hasTel = !!tel && String(tel).replace(/\D/g, '').length >= 11;
      btnEnvIndEnviar.disabled = !(logged && allowed && hasTel);
    }

    async function safeJson(r) { try { return await r.json(); } catch { return null; } }

    async function atualizarTicketsDoServidorEabrir(remetenteNorm) {
      try {
        const url = `${CONV_API}/api/tickets/minhas?agente=${encodeURIComponent(agente.codigo || '')}&carteira=${encodeURIComponent(agente.carteira || '')}`;
        const r = await fetch(url);
        if (r.ok) {
          tickets = await r.json();
          saveTickets();
          renderTickets();
          await refreshOrdemCarteira();
          await refreshAtivosELimite();
          const alvo = String(remetenteNorm || '').replace(/\D/g, '');
          const achado = (tickets || []).find(t => String(t.remetente || '').replace(/\D/g, '') === alvo);
          if (achado) {
            switchTab('conversas');
            await abrirTicket(achado);
          }
        }
      } catch (e) {
        console.error('Falha ao atualizar tickets', e);
      }
    }

    async function enviarLigacaoCaiu() {
      if (!hasPermEnvioIndividual()) { showModalFeedback('Seu usu√°rio n√£o tem permiss√£o para ‚ÄúEnvio individual‚Äù.', 'Acesso restrito', 1400); return; }

      const to_msisdn = envIndTelefoneAtual();
      const phone_id = envIndPhoneIdAtual();

      if (!to_msisdn || String(to_msisdn).replace(/\D/g, '').length < 11) {
        envIndSetStatus('Informe um telefone v√°lido.', 'warn', { to_msisdn });
        return;
      }
      if (!phone_id) {
        envIndSetStatus('N√£o foi poss√≠vel identificar o Phone ID da carteira.', 'warn', { carteira: agente.carteira });
        return;
      }

      // Envio do template fixo (tenta nos 2 backends, se estiverem separados)
      const payload = { to_msisdn, phone_id };
      const candidates = [
        `${FILA_API}/api/envio_individual/ligacao_caiu`,
        `${CONV_API}/api/envio_individual/ligacao_caiu`
      ];

      btnEnvIndEnviar && (btnEnvIndEnviar.disabled = true);
      envIndSetStatus('Enviando template‚Ä¶', 'muted', { payload, candidates });

      let sent = null;
      for (const url of candidates) {
        try {
          const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const j = await safeJson(r);
          if (r.ok && (j ? (j.ok === true || j.status === 'sent') : true)) { sent = { url, http_ok: r.ok, json: j }; break; }
        } catch (e) { /* tenta o pr√≥ximo */ }
      }

      if (!sent) {
        envIndSetStatus('Falha ao enviar o template. Verifique o backend/env.', 'err', { payload });
        envIndUpdateSendState();
        return;
      }

      // Depois do envio: tenta puxar a conversa pra fila (mesma ideia do "pedir prioridade")
      envIndSetStatus('Template enviado. Tentando puxar a conversa‚Ä¶', 'muted', sent);

      if (!agente.online) {
        envIndSetStatus('Template enviado. Voc√™ est√° offline, ent√£o n√£o puxei a conversa para a fila.', 'warn', sent);
        envIndUpdateSendState();
        return;
      }

      try {
        const body = { codigo_do_agente: parseInt(agente.codigo, 10), carteira: agente.carteira, remetente: to_msisdn };
        const r = await fetch(`${CONV_API}/api/tickets/claim`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const j = await safeJson(r);
        if (r.ok && j && j.ok) {
          envIndSetStatus('Conversa puxada com sucesso ‚úÖ', 'ok', { sent, claim: j });
          await atualizarTicketsDoServidorEabrir(to_msisdn);
        } else {
          const msg = (j && (j.erro || j.msg || j.message)) || 'N√£o foi poss√≠vel puxar a conversa.';
          envIndSetStatus(`Template enviado, mas n√£o puxei a conversa: ${msg}`, 'warn', { sent, claim: j, http: r.status });
        }
      } catch (e) {
        envIndSetStatus('Template enviado, mas falhou ao puxar a conversa (rede/CORS).', 'warn', { sent, erro: String(e) });
      } finally {
        envIndUpdateSendState();
      }
    }

    if (btnEnvIndIrParaConversa) btnEnvIndIrParaConversa.onclick = () => switchTab('conversas');
    if (envIndTelefone) envIndTelefone.addEventListener('input', envIndUpdateSendState);
    if (envIndPhoneId) envIndPhoneId.addEventListener('change', envIndUpdateSendState);
    if (btnEnvIndEnviar) btnEnvIndEnviar.onclick = enviarLigacaoCaiu;

    /** ============== ONLINE/OFFLINE, LIMITES ============== */
    async function verificarOnline() {
      try {
        const r = await fetch(`${FILA_API}/fila/status?carteira=${encodeURIComponent(agente.carteira)}`);
        const lista = await r.json();
        const achou = Array.isArray(lista) && lista.some(x => String(x.codigo_do_agente) === String(agente.codigo));
        setStatus(achou);
        if (!achou) { elMsgAviso?.classList.add("hidden"); elHomeAviso.classList.remove("hidden"); elHomeAviso.textContent = "Voc√™ est√° OFFLINE nesta carteira. Use ‚ÄúFicar online‚Äù para entrar na fila."; }
        else { elHomeAviso.classList.add("hidden"); elHomeAviso.textContent = ""; }
      } catch (e) { setStatus(false) }
    }
    function setStatus(online) {
      agente.online = !!online;
      if (elAgenteStatus) elAgenteStatus.innerHTML = online ? '<span class="dot online"></span>Online' : '<span class="dot offline"></span>Offline';
      if (elHomeStatus) elHomeStatus.innerHTML = online ? '<span class="dot online"></span>Online' : '<span class="dot offline"></span>Offline';
      btnPegarProxima.disabled = !online || (limitPerAgent > 0 && ativosCount >= limitPerAgent);
      btnPrioridade.disabled = !online || (limitPerAgent > 0 && ativosCount >= limitPerAgent);
      const toggleLabel = document.getElementById("toggleLabel");
      if (btnToggleOnline) {
        btnToggleOnline.disabled = false; btnToggleOnline.setAttribute('aria-pressed', online ? 'true' : 'false');
        if (online) {
          if (toggleLabel) toggleLabel.textContent = "Ficar offline";
          btnToggleOnline.classList.remove("bg-green-600", "hover:bg-green-700", "text-white");
          btnToggleOnline.classList.add("btn-neutral");
        } else {
          if (toggleLabel) toggleLabel.textContent = "Ficar online";
          btnToggleOnline.classList.add("bg-green-600", "text-white", "hover:bg-green-700");
          btnToggleOnline.classList.remove("btn-neutral");
        }
      }
    }
    async function refreshOrdemCarteira() {
      if (!agente.carteira) return;
      const phoneIds = (carteiraToPhoneIds[agente.carteira] || []).map(String);
      if (!phoneIds.length) return;
      try {
        const res = await fetch(`${CONV_API}/api/conversas/contatos`);
        const contatos = await res.json();
        const filtrados = (contatos || []).filter(c => phoneIds.includes(String(c.phone_id)));
        filtrados.sort((a, b) => { const ai = a.status === 'in', bi = b.status === 'in'; if (ai !== bi) return bi - ai; return new Date(b.data_hora) - new Date(a.data_hora) });
        ordemCache = filtrados;
        const ticketByKey = new Map((tickets || []).map(t => [keyFrom(t.remetente, t.phone_id), t]));
        filtrados.forEach(c => {
          const k = keyFrom(c.remetente, c.phone_id);
          const t = ticketByKey.get(k);
          if (!t) { lastContatoTsByKey[k] = +new Date(c.data_hora || 0); return; }
          const ts = +new Date(c.data_hora || 0);
          const prev = lastContatoTsByKey[k] || 0;
          const isOpen = !!(selecionado && selecionado.remetente === c.remetente && selecionado.phone_id === c.phone_id);
          if (c.status === 'in' && ts > prev && !isOpen) { unreadCountByKey[k] = (unreadCountByKey[k] || 0) + 1; }
          lastContatoTsByKey[k] = ts;
          if (c.mensagem_final) t.mensagem_final = c.mensagem_final;
          else if (c.ultima_mensagem) t.mensagem_final = c.ultima_mensagem;
          if (c.data_hora) t.data_hora = c.data_hora;
        });
        persistUnread(); saveTickets(); renderTickets();
      } catch (e) { console.error("Falha ao atualizar ordem", e) }
    }
    async function refreshAtivosELimite() {
      try {
        const url = `${CONV_API}/api/tickets/minhas?agente=${encodeURIComponent(agente.codigo || '')}&carteira=${encodeURIComponent(agente.carteira || '')}`;
        const r = await fetch(url); const rows = r.ok ? await r.json() : []; ativosCount = Array.isArray(rows) ? rows.length : 0;
      } catch { ativosCount = tickets.length }
      try {
        const j = await fetch(`${CONV_API}/api/supervisao/tickets-limit?carteira=${encodeURIComponent(agente.carteira || '')}`).then(r => r.json());
        limitPerAgent = Number(j.limit_per_agent || 0);
      } catch { limitPerAgent = 0 }
      renderAtivosLimiteUI();
    }
    function renderAtivosLimiteUI() {
      badgeAtivos.textContent = String(ativosCount);
      badgeLimite.textContent = limitPerAgent > 0 ? String(limitPerAgent) : "‚àû";
      const atingiu = (limitPerAgent > 0 && ativosCount >= limitPerAgent);
      if (atingiu) { elMsgLimite.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido. Conclua ou libere um atendimento para continuar.`; elMsgLimite.classList.remove("hidden") }
      else { elMsgLimite.classList.add("hidden"); elMsgLimite.textContent = "" }
      btnPegarProxima.disabled = !agente.online || atingiu;
      btnPrioridade.disabled = !agente.online || atingiu;
    }

    // Toggle online
    btnToggleOnline.onclick = async () => {
      if (!agente.carteira || !agente.codigo) { abrirModalLogin(); return; }
      const toggleSpinner = document.getElementById('toggleSpinner'); const toggleLabel = document.getElementById('toggleLabel');
      elHomeAviso.classList.add("hidden"); elHomeAviso.textContent = ""; const indoOnline = !agente.online;
      btnToggleOnline.disabled = true; toggleSpinner.classList.remove('hidden'); if (toggleLabel) toggleLabel.textContent = indoOnline ? 'Entrando‚Ä¶' : 'Saindo‚Ä¶';
      try {
        if (indoOnline) {
          const r = await fetch(`${FILA_API}/fila/online`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo, 10), carteira: agente.carteira }) });
          const j = await r.json(); if (!j.ok) throw new Error(j.erro || "Erro ao entrar online");
          setStatus(true); await refreshOrdemCarteira(); await refreshAtivosELimite();
        } else {
          const r = await fetch(`${FILA_API}/fila/offline`, { method: "DELETE", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo, 10), carteira: agente.carteira }) });
          const j = await r.json(); if (!j.ok) throw new Error(j.erro || "Erro ao ficar offline");
          setStatus(false);
        }
      } catch (e) { elHomeAviso.classList.remove("hidden"); elHomeAviso.textContent = (e?.message || "Falha ao alterar status") }
      finally { toggleSpinner.classList.add('hidden'); if (toggleLabel) toggleLabel.textContent = agente.online ? 'Ficar offline' : 'Ficar online'; btnToggleOnline.disabled = false; }
    };

    // Pegar pr√≥xima
    btnPegarProxima.onclick = async () => {
      if (!agente.online) { alert("Voc√™ est√° offline. V√° na Home e clique em ‚ÄúFicar online‚Äù."); return; }
      if (limitPerAgent > 0 && ativosCount >= limitPerAgent) { elMsgLimite.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido.`; elMsgLimite.classList.remove('hidden'); renderAtivosLimiteUI(); return; }
      const spinner = document.getElementById('pegarSpinner'); const label = document.getElementById('pegarLabel');
      btnPegarProxima.disabled = true; spinner.classList.remove('hidden'); label.textContent = 'Buscando‚Ä¶';
      try {
        const r = await fetch(`${CONV_API}/api/tickets/claim`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo, 10), carteira: agente.carteira }) });
        const j = await r.json().catch(() => ({ ok: false, erro: 'Falha na resposta' }));
        if (r.status === 409 && j && (j.limit_per_agent !== undefined)) {
          limitPerAgent = Number(j.limit_per_agent || 0); ativosCount = Number(j.ativos || ativosCount);
          elMsgLimite.textContent = j.erro || `Limite de ${limitPerAgent} atingido.`; elMsgLimite.classList.remove('hidden');
          renderAtivosLimiteUI(); return;
        }
        if (!r.ok || !j.ok) { alert(j.erro || "Sem conversas dispon√≠veis."); return; }
        if (!tickets.find(t => t.remetente === j.ticket.remetente && t.phone_id === j.ticket.phone_id)) { tickets.unshift(j.ticket); saveTickets(); }
        renderTickets(); abrirTicket(j.ticket); ativosCount++; renderAtivosLimiteUI();
      } catch (e) { alert("Falha ao pegar pr√≥xima."); }
      finally { spinner.classList.add('hidden'); label.textContent = 'Pegar pr√≥xima'; btnPegarProxima.disabled = !agente.online || (limitPerAgent > 0 && ativosCount >= limitPerAgent); }
    };

    // Prioridade
    const priorityModal = document.getElementById('priorityModal');
    const priorityTelefone = document.getElementById('priorityTelefone');
    const priorityInfo = document.getElementById('priorityInfo');
    const priorityErro = document.getElementById('priorityErro');
    const btnPriorityBuscar = document.getElementById('btnPriorityBuscar');
    const prioritySpinner = document.getElementById('prioritySpinner');
    const priorityBtnLabel = document.getElementById('priorityBtnLabel');
    btnPrioridade.onclick = () => {
      if (!agente.online) { alert('Voc√™ est√° offline. V√° na Home e clique em ‚ÄúFicar online‚Äù.'); return }
      if (limitPerAgent > 0 && ativosCount >= limitPerAgent) { elMsgLimite.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido.`; elMsgLimite.classList.remove('hidden'); return; }
      abrirPriorityModal();
    }
    function abrirPriorityModal() { isModalOpen = true; priorityInfo.classList.add('hidden'); priorityErro.classList.add('hidden'); priorityTelefone.value = ''; priorityModal.classList.remove('hidden'); setTimeout(() => priorityTelefone.focus(), 50) }
    function fecharPriorityModal() { isModalOpen = false; priorityModal.classList.add('hidden') }
    priorityTelefone.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); btnPriorityBuscar.click() } })
    function normalizarTelefone(raw) { let d = String(raw || '').replace(/\D/g, ''); if (!d) return ''; if (!d.startsWith('55')) d = '55' + d; const m = d.match(/^55(\d{2})(\d{8,9})(.*)$/); if (m) { const ddd = m[1]; let numero = m[2]; const tail = m[3] || ''; if (numero.length === 9 && numero.startsWith('9')) numero = numero.slice(1); d = '55' + ddd + numero + tail } return d }
    function phoneIdsForCarteira() { return (carteiraToPhoneIds[agente.carteira] || []).map(String) }
    function dedupe(arr) { return Array.from(new Set(arr.filter(Boolean))) }
    async function preferPhoneIdDoContato(remetente) {
      const hit = (ordemCache || []).find(x => String(x.remetente) === String(remetente));
      if (hit && hit.phone_id) return String(hit.phone_id);
      try {
        const r = await fetch(`${CONV_API}/api/conversas/contatos`); const all = await r.json();
        const ids = phoneIdsForCarteira(); const c = (all || []).find(x => ids.includes(String(x.phone_id)) && String(x.remetente) === String(remetente));
        return c ? String(c.phone_id) : null;
      } catch { return null }
    }
    async function tentarClaimComIds(remetente, ids) {
      const candidatos = [];
      if (ids && ids.length) { candidatos.push(ids); ids.forEach(id => candidatos.push([id])); }
      else { candidatos.push([]) }
      for (const arr of candidatos) {
        const body = { codigo_do_agente: parseInt(agente.codigo, 10), carteira: agente.carteira, remetente, ...(arr.length ? { phone_id: arr } : {}), prioridade: true };
        const r = await fetch(`${CONV_API}/api/tickets/claim`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const data = await r.json().catch(() => ({ ok: false, erro: 'Falha na resposta' }));
        if (r.status === 404) continue;
        return data;
      }
      return { ok: false, erro: 'Contato n√£o est√° na fila desta carteira.' };
    }
    btnPriorityBuscar.onclick = async () => {
      priorityInfo.classList.add('hidden'); priorityErro.classList.add('hidden');
      if (limitPerAgent > 0 && ativosCount >= limitPerAgent) { priorityErro.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido.`; priorityErro.classList.remove('hidden'); return; }
      const nrm = normalizarTelefone(priorityTelefone.value);
      if (nrm.length < 11) { priorityErro.textContent = 'Informe ao menos DDI (55) + DDD (2) + n√∫mero (8).'; priorityErro.classList.remove('hidden'); return; }
      priorityInfo.innerHTML = `Buscando por: <code>${nrm}</code>`; priorityInfo.classList.remove('hidden');
      const preferido = await preferPhoneIdDoContato(nrm);
      const ordemIds = dedupe([preferido, ...phoneIdsForCarteira()]);
      btnPriorityBuscar.disabled = true; prioritySpinner.classList.remove('hidden'); priorityBtnLabel.textContent = 'Solicitando‚Ä¶';
      try {
        const data = await tentarClaimComIds(nrm, ordemIds);
        if (data && (data.limit_per_agent !== undefined)) { limitPerAgent = Number(data.limit_per_agent || 0); ativosCount = Number(data.ativos || ativosCount); priorityErro.textContent = data.erro || `Limite de ${limitPerAgent} atingido.`; priorityErro.classList.remove('hidden'); await refreshAtivosELimite(); return; }
        if (data && data.ok && data.ticket) {
          priorityInfo.innerHTML = `<span class="text-emerald-700 font-medium">Prioridade concedida.</span> Abrindo o ticket‚Ä¶`;
          if (!tickets.find(t => t.remetente === data.ticket.remetente && t.phone_id === data.ticket.phone_id)) { tickets.unshift(data.ticket); saveTickets(); renderTickets(); }
          fecharPriorityModal(); abrirTicket(data.ticket); ativosCount++; renderAtivosLimiteUI(); return;
        }
        if (data && (data.assigned_to || data.atendimento)) {
          const owner = data.assigned_to || data.atendimento;
          priorityErro.innerHTML = `Outro agente j√° est√° atendendo: <strong>${escapeHtml(owner.nome || '‚Äî')}</strong> (#${escapeHtml(String(owner.codigo || '‚Äî'))}).`;
          priorityErro.classList.remove('hidden'); return;
        }
        priorityErro.textContent = (data && (data.erro || data.message)) || 'N√£o foi poss√≠vel conceder prioridade.'; priorityErro.classList.remove('hidden');
      } catch (e) { priorityErro.textContent = 'Falha ao solicitar prioridade.'; priorityErro.classList.remove('hidden') }
      finally { btnPriorityBuscar.disabled = false; prioritySpinner.classList.add('hidden'); priorityBtnLabel.textContent = 'Buscar e solicitar' }
    };

    /** ============== LISTA / CHAT ============== */
    function renderTickets(filtro = "") {
      const q = (filtro || "").toLowerCase().trim(); const frag = document.createDocumentFragment(); elListaTickets.innerHTML = "";
      tickets.forEach(t => {
        const nome = t.nome_exibicao || t.remetente; const hay = `${nome} ${t.remetente}`.toLowerCase(); if (q && !hay.includes(q)) return;
        const li = document.createElement("li"); li.className = "ticket-item relative flex items-center p-3 cursor-pointer border-b"; li.style.borderColor = getCss('--border'); li.onclick = () => abrirTicket(t);
        const key = keyFrom(t.remetente, t.phone_id); const unread = unreadCountByKey[key] || 0; const badge = unread > 0 ? `<span class="badge absolute right-2 top-2">${unread}</span>` : "";
        const hora = t.data_hora ? fmtHoraBR.format(new Date(t.data_hora)) : "";
        li.innerHTML = `
            <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 font-medium" style="background:${gerarCor(nome)};color:#fff;">${(nome || "U").charAt(0).toUpperCase()}</div>
            <div class="flex-1 min-w-0">
              <div class="font-semibold truncate">${escapeHtml(nome)}</div>
              <div class="text-sm muted truncate">${escapeHtml(t.mensagem_final ? t.mensagem_final.slice(0, 70) : "")}</div>
            </div>
            <div class="text-xs muted pl-2">${hora}</div>
            ${badge}
          `;
        if (selecionado && selecionado.remetente === t.remetente && selecionado.phone_id === t.phone_id) { li.classList.add("ticket-selected") }
        frag.appendChild(li);
      });
      elListaTickets.appendChild(frag);
    }

    let msgsCtrl = null;
    async function abrirTicket(t) {
      selecionado = t;
      try { if (typeof envIndSyncFromConversa === 'function') envIndSyncFromConversa(); } catch (_) { }
      try { const k = keyFrom(t.remetente, t.phone_id); unreadCountByKey[k] = 0; lastContatoTsByKey[k] = Date.now(); persistUnread(); } catch { }
      renderTickets();
      elTitulo.textContent = t.nome_exibicao ? `${t.nome_exibicao} (${t.remetente})` : t.remetente;
      elSubInfo.textContent = `conta: ${phoneIdMap[t.phone_id] || t.phone_id}`;
      textarea.disabled = false; textarea.focus(); btnEnviar.disabled = true; btnLiberar.disabled = false; btnConcluir.disabled = false;

      if (msgsCtrl) { try { msgsCtrl.abort() } catch { } }
      msgsCtrl = new AbortController();

      lastTimestampMs = null; lastDayRendered = null; renderedKeys.clear(); chat.innerHTML = "";
      await carregarMensagens(false);
      startMensagensPoll();
      wireComposer();
    }
    function startMensagensPoll() { schedulePolls() }

    async function carregarMensagens(incremental = true) {
      if (!selecionado) return;
      let url = `${CONV_API}/api/conversas/${encodeURIComponent(selecionado.remetente)}`; if (selecionado.phone_id) url += `?phone_id=${encodeURIComponent(selecionado.phone_id)}`;
      try {
        const r = await fetch(url, { signal: msgsCtrl?.signal }); if (!r.ok) throw new Error("Erro hist√≥rico");
        const msgs = await r.json(); msgs.sort((a, b) => new Date(a.data_hora) - new Date(b.data_hora));
        if (!incremental) { chat.innerHTML = ""; lastTimestampMs = null; lastDayRendered = null; renderedKeys.clear(); }
        const isNearBottom = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 200;
        msgs.forEach(m => renderMsg(m, incremental));
        if (isNearBottom) requestAnimationFrame(() => chat.scrollTo({ top: chat.scrollHeight, behavior: "smooth" }));
      } catch (e) { if (String(e?.name) !== "AbortError") console.error(e) }
    }

    function renderMsg(m, incremental) {
      const tMs = new Date(m.data_hora).getTime();
      const key = `${m.data_hora}|${m.status}|${m.mensagem_final || m.tipo || ""}`;
      if (renderedKeys.has(key)) return;
      if (incremental && lastTimestampMs !== null && tMs <= lastTimestampMs) return;

      const dia = fmtDataBR.format(new Date(m.data_hora));
      const hora = fmtHoraBR.format(new Date(m.data_hora));
      if (!lastDayRendered || lastDayRendered !== dia) { const sep = document.createElement("div"); sep.className = "dia"; sep.textContent = `‚Äî ${dia} ‚Äî`; chat.appendChild(sep); lastDayRendered = dia; }

      const incoming = isIncoming(m);
      const div = document.createElement("div"); div.className = `msg ${incoming ? 'recebida' : 'enviada'}`;

      if (m.tipo === "imagem" || m.mensagem_final === "[image]") {
        div.innerHTML = `<div class="muted italic">[imagem recebida]</div><button class="btn-olhinho underline mt-1" style="color:var(--link)">üëÅ Ver imagem</button><span class="hora">${hora}</span>`;
        const btn = div.querySelector(".btn-olhinho"); if (!m.msg_id) { btn.disabled = true; btn.textContent = "Imagem indispon√≠vel" } else btn.onclick = () => carregarImagem(div, btn, m.msg_id);
      } else if (m.tipo === "audio" || m.mensagem_final === "[audio]") {
        div.innerHTML = `<div class="muted italic">[√°udio recebido]</div><button class="btn-audio underline mt-1" style="color:var(--link)">‚ñ∂ Reproduzir √°udio</button><span class="hora">${hora}</span>`;
        const btn = div.querySelector(".btn-audio"); if (!m.msg_id) { btn.disabled = true; btn.textContent = "√Åudio indispon√≠vel" } else btn.onclick = () => carregarAudio(div, btn, m.msg_id);
      } else if (m.tipo === "document" || m.mensagem_final === "[document]") {
        div.innerHTML = `<div class="muted italic">[documento recebido]</div><button class="btn-doc underline mt-1" style="color:var(--link)">üìé Ver documento</button><span class="hora">${hora}</span>`;
        const btn = div.querySelector(".btn-doc"); if (!m.msg_id) { btn.disabled = true; btn.textContent = "Documento indispon√≠vel" } else btn.onclick = () => carregarDocumento(div, btn, m.msg_id);
      } else if (typeof m.mensagem_final === "string" && m.mensagem_final.startsWith("üìé PDF:")) {
        const lines = m.mensagem_final.split("\n"); const filename = (lines[0] || "").replace("üìé PDF:", "").trim() || "Arquivo"; const link = (lines[1] || "").replace("üîó", "").trim();
        div.innerHTML = `<div class="flex items-start gap-2"><div class="text-xl leading-none">üìÑ</div><div class="min-w-0"><div class="font-semibold">${escapeHtml(filename)}</div>${link ? `<a href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer" class="underline break-all" style="color:var(--link)">Abrir/baixar</a>` : `<span class="muted">sem link</span>`}</div></div><span class="hora">${hora}</span>`;
      } else if (m.tipo === "emoji" || m.mensagem_final === "[reaction]") {
        const wrap = document.createElement("div"); wrap.className = "flex items-center gap-2";
        const emojiEl = document.createElement("span"); emojiEl.className = "text-2xl"; emojiEl.textContent = "üôÇ";
        const label = document.createElement("span"); label.className = "muted italic"; label.textContent = "enviou um emote";
        wrap.appendChild(emojiEl); wrap.appendChild(label); div.appendChild(wrap);
        const horaSpan = document.createElement("span"); horaSpan.className = "hora"; horaSpan.textContent = hora; div.appendChild(horaSpan);
        if (m.msg_id) {
          fetch(`${CONV_API}/api/conversas/emoji/${encodeURIComponent(m.msg_id)}`).then(r => r.json())
            .then(j => { if (j.ok && j.emoji) emojiEl.textContent = j.emoji; else label.textContent = "emoji n√£o carregado"; })
            .catch(() => label.textContent = "falha ao carregar emoji");
        }
      } else if (m.tipo === "system" || m.mensagem_final === "[system]") {
        div.className = "msg system";
        div.innerHTML = `<div class="sys-title"><span>‚ÑπÔ∏è Evento do sistema</span> <span class="sys-pill">carregando‚Ä¶</span></div><div class="sys-body mt-1">Obtendo detalhes‚Ä¶</div><div class="sys-meta mt-1"></div><span class="hora">${hora}</span>`;
        if (!m.msg_id) { div.querySelector(".sys-body").textContent = "Detalhes indispon√≠veis (sem msg_id)."; const pill = div.querySelector(".sys-pill"); if (pill) pill.textContent = "indispon√≠vel"; }
        else {
          (async () => {
            try {
              const r = await fetch(`${CONV_API}/api/conversas/system/${encodeURIComponent(m.msg_id)}`); const j = await r.json();
              const pill = div.querySelector(".sys-pill"); const bodyEl = div.querySelector(".sys-body"); const metaEl = div.querySelector(".sys-meta");
              if (!j.ok) { if (pill) pill.textContent = "erro"; bodyEl.textContent = j.erro || "Falha ao obter detalhes do evento."; return; }
              if (pill) pill.textContent = j.type || "system";
              if (j.type === "user_changed_number" && j.old_wa_id && j.wa_id) { bodyEl.innerHTML = `O cliente alterou o n√∫mero:<br><span class="font-semibold">${escapeHtml(j.old_wa_id)}</span> <span class="mx-1">‚Üí</span> <span class="font-semibold">${escapeHtml(j.wa_id)}</span>`; }
              else { bodyEl.textContent = j.body || "Evento de sistema recebido." }
              const src = j.from || j.old_wa_id || ""; const pid = j.phone_id ? ` ‚Ä¢ conta: ${escapeHtml(j.phone_id)}` : ""; metaEl.textContent = `${src ? ("Origem: " + src) : ""}${pid}`;
            } catch (e) { const pill = div.querySelector(".sys-pill"); if (pill) pill.textContent = "erro"; div.querySelector(".sys-body").textContent = "Falha ao carregar detalhes do evento."; }
          })()
        }
      } else {
        div.innerHTML = `<div>${escapeHtml(m.mensagem_final || "")}</div><span class="hora">${hora}</span>`;
      }

      if (incoming && !(m.tipo === "system" || m.mensagem_final === "[system]")) {
        const btn = document.createElement("button");
        btn.className = "reply-btn"; btn.title = "Responder"; btn.setAttribute("aria-label", "Responder");
        btn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 8V5l-7 7 7 7v-3h4c3.314 0 6 2.686 6 6v-2c0-4.418-3.582-8-8-8h-2z"/></svg>`;
        btn.onclick = (ev) => { ev.stopPropagation(); responderMensagem(m.msg_id, m.mensagem_final || "") };
        div.appendChild(btn);
      }
      chat.appendChild(div); renderedKeys.add(key); if (lastTimestampMs === null || tMs > lastTimestampMs) lastTimestampMs = tMs;
    }

    async function carregarImagem(div, btn, msg_id) {
      btn.disabled = true; btn.textContent = "‚è≥ Carregando‚Ä¶";
      try {
        const r = await fetch(`${CONV_API}/api/conversas/image/${encodeURIComponent(msg_id)}`); const j = await r.json();
        if (j.ok && j.data_uri) {
          const img = document.createElement("img"); img.src = j.data_uri; img.alt = "Imagem"; img.className = "thumb mt-2"; img.loading = "lazy"; img.decoding = "async";
          img.onclick = () => abrirModalImagem(j.data_uri); div.insertBefore(img, btn); btn.remove();
        }
        else throw new Error(j.erro || "Resposta inv√°lida");
      } catch { alert("Erro ao carregar imagem"); btn.disabled = false; btn.textContent = "üëÅ Ver imagem" }
    }
    async function carregarAudio(div, btn, msg_id) {
      btn.disabled = true; btn.textContent = "‚è≥ Carregando‚Ä¶";
      try {
        const r = await fetch(`${CONV_API}/api/conversas/audio/${encodeURIComponent(msg_id)}`); const j = await r.json();
        if (j.ok && j.data_uri) { const audio = document.createElement("audio"); audio.src = j.data_uri; audio.controls = true; audio.preload = "metadata"; audio.className = "mt-2"; div.insertBefore(audio, btn); btn.remove() }
        else throw new Error(j.erro || "Resposta inv√°lida");
      } catch { alert("Erro ao carregar √°udio"); btn.disabled = false; btn.textContent = "‚ñ∂ Reproduzir √°udio" }
    }
    async function carregarDocumento(div, btn, msg_id) {
      btn.disabled = true; btn.textContent = "‚è≥ Carregando‚Ä¶";
      try {
        const r = await fetch(`${CONV_API}/api/conversas/document/${encodeURIComponent(msg_id)}`); const j = await r.json();
        if (!j.ok) throw new Error(j.erro || "Falha no backend");
        const filename = j.filename || "arquivo"; const mime = j.mime_type || "application/octet-stream"; const size = j.size_bytes ?? null;
        const box = document.createElement("div"); box.className = "mt-2 space-y-1";
        if (mime.startsWith("application/pdf") && j.data_uri && (size === null || size <= DOC_PREVIEW_MAX)) {
          const preview = document.createElement("embed"); preview.src = j.data_uri; preview.type = mime; preview.className = "w-[260px] h-[200px] rounded border"; preview.style.borderColor = getCss('--border'); box.appendChild(preview);
          const meta = document.createElement("div"); meta.className = "text-xs"; meta.style.color = getCss('--muted');
          const link = `${CONV_API}/api/conversas/document/${encodeURIComponent(msg_id)}/download`;
          meta.innerHTML = `<div class="font-semibold truncate">${escapeHtml(filename)}</div><div>${size ? bytesToHuman(size) : ""}</div><a href="${link}" target="_blank" rel="noopener noreferrer" class="underline" style="color:var(--link)">Abrir/baixar</a>`; box.appendChild(meta);
        } else {
          const link = `${CONV_API}/api/conversas/document/${encodeURIComponent(msg_id)}/download`;
          const row = document.createElement("div"); row.className = "flex items-start gap-2";
          row.innerHTML = `<div class="text-xl leading-none">üìé</div><div class="min-w-0"><div class="font-semibold truncate">${escapeHtml(filename)}</div><div class="text-xs" style="color:var(--muted)">${escapeHtml(mime)} ${size ? ("‚Ä¢ " + bytesToHuman(size)) : ""}</div><a href="${link}" target="_blank" rel="noopener noreferrer" class="underline break-all" style="color:var(--link)">Baixar documento</a></div>`;
          box.appendChild(row);
        }
        div.insertBefore(box, btn); btn.remove();
      } catch (e) { console.error(e); alert("Erro ao carregar documento"); btn.disabled = false; btn.textContent = "üìé Ver documento" }
    }

    // ==== Modal de imagem ====
    const imageModal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImg');
    const closeImgBtn = document.getElementById('closeModal');
    function abrirModalImagem(src) {
      try { isModalOpen = true; modalImg.src = src || ""; imageModal.classList.remove('hidden'); } catch { }
    }
    function fecharModalImagem() {
      try { imageModal.classList.add('hidden'); modalImg.src = ""; isModalOpen = false; } catch { }
    }
    if (closeImgBtn) closeImgBtn.addEventListener('click', fecharModalImagem);
    if (imageModal) imageModal.addEventListener('click', (e) => { if (e.target === imageModal) fecharModalImagem(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !imageModal.classList.contains('hidden')) fecharModalImagem(); });

    function responderMensagem(msgId, conteudo) { respostaMsgId = msgId || null; document.getElementById("respostaPreview").classList.remove("hidden"); document.getElementById("respostaTexto").innerText = (conteudo || "").slice(0, 50); textarea.focus() }
    function cancelarResposta() { respostaMsgId = null; document.getElementById("respostaPreview").classList.add("hidden"); document.getElementById("respostaTexto").innerText = "" }

    // Composer
    function wireComposer() {
      textarea.removeEventListener('input', __onTextInput); textarea.removeEventListener('keydown', __onTextKeydown); btnEnviar.removeEventListener('click', enviarMensagem);
      textarea.addEventListener('input', __onTextInput); textarea.addEventListener('keydown', __onTextKeydown); btnEnviar.addEventListener('click', enviarMensagem); updateEnviarState();
    }
    function autoGrow() { textarea.style.height = 'auto'; textarea.style.height = Math.min(180, Math.max(38, textarea.scrollHeight)) + 'px' }
    function updateEnviarState() { const hasText = !!textarea.value.trim(); btnEnviar.disabled = !hasText || !selecionado; if (hasText && selecionado) { showTyping() } else { hideTyping() } }
    function showTyping() { digitando.classList.remove('hidden'); if (typingTimer) clearTimeout(typingTimer); typingTimer = setTimeout(hideTyping, 1200) }
    function hideTyping() { digitando.classList.add('hidden'); if (typingTimer) { clearTimeout(typingTimer); typingTimer = null } }
    function __onTextInput() { autoGrow(); updateEnviarState() }
    function __onTextKeydown(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if (!btnEnviar.disabled) enviarMensagem(); return false } showTyping() }
    async function enviarMensagem() {
      if (!selecionado) return; const texto = textarea.value.trim(); if (!texto) return; userTyping = true; btnEnviar.disabled = true;
      try {
        const body = { texto, phone_id: selecionado.phone_id, msg_id: respostaMsgId || null };
        const r = await fetch(`${CONV_API}/api/conversas/${encodeURIComponent(selecionado.remetente)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
        const j = await r.json(); if (j.ok) { textarea.value = ""; autoGrow(); cancelarResposta(); hideTyping(); await carregarMensagens(true) }
        else { alert("Erro ao enviar: " + (j.erro || JSON.stringify(j))); }
      } catch (e) { alert("Erro ao enviar mensagem. Verifique rede/CORS."); }
      finally { userTyping = false; updateEnviarState(); }
    }

    // PDF upload
    async function enviarPDF(event) {
      const file = event.target.files[0]; if (!file) return;
      if (!selecionado) { alert("Abra um ticket antes de enviar PDF."); event.target.value = ""; return; }
      if (file.type !== "application/pdf") { alert("Somente arquivos PDF s√£o permitidos."); event.target.value = ""; return; }
      try {
        const res = await fetch(`${CONV_API}/api/upload/pdf`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ filename: file.name }) });
        const j = await res.json(); if (!j.ok) { console.error("Presign falhou:", j); alert("Erro ao gerar URL: " + j.erro); return; }
        const putResp = await fetch(j.upload_url, { method: "PUT", headers: { "Content-Type": "application/pdf" }, body: file });
        if (!putResp.ok) { const txt = await putResp.text().catch(() => ""); console.error("S3 PUT falhou", putResp.status, txt); alert(`Falha no upload (S3): HTTP ${putResp.status}\n${txt.slice(0, 300)}`); return; }
        const send = await fetch(`${CONV_API}/api/conversas/${encodeURIComponent(selecionado.remetente)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ phone_id: selecionado.phone_id, file_url: j.file_url, original_filename: file.name }) });
        const sj = await send.json().catch(() => ({ ok: false, erro: "resposta inv√°lida" }));
        if (sj.ok) { await carregarMensagens(true) } else { console.error("Erro ao enviar PDF para WhatsApp:", sj); alert("Erro ao enviar PDF (API META): " + (sj.erro || JSON.stringify(sj))); }
      } catch (e) { console.error("Erro geral ao enviar PDF:", e); alert("Erro ao enviar PDF (rede)."); }
      finally { event.target.value = ""; }
    }

    /** ============== LIBERAR / CONCLUIR / LOGOUT ============== */
    btnLiberar.onclick = async () => {
      if (!selecionado) return;
      try {
        const r = await fetch(`${CONV_API}/api/tickets/liberar`, { method: "DELETE", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo || '0', 10), remetente: selecionado.remetente, phone_id: selecionado.phone_id }) });
        const j = await r.json();
        if (!r.ok || !j.ok) { alert(j.erro || "N√£o foi poss√≠vel liberar."); return; }
        const k = keyFrom(selecionado.remetente, selecionado.phone_id); delete unreadCountByKey[k]; delete lastContatoTsByKey[k]; persistUnread();
        tickets = tickets.filter((t) => (!(t.remetente === selecionado.remetente && t.phone_id === selecionado.phone_id))); saveTickets(); renderTickets(); limparChat();
        elTitulo.textContent = "Selecione um ticket"; elSubInfo.textContent = ""; btnLiberar.disabled = true; btnConcluir.disabled = true; fecharMenuConcluir();

        // Seguran√ßa extra: ao liberar, removemos a sele√ß√£o e interrompemos o polling de mensagens
        selecionado = null;
        if (typeof msgsCtrl !== 'undefined' && msgsCtrl) { try { msgsCtrl.abort(); } catch { } }
        if (typeof schedulePolls === 'function') schedulePolls();

        if (ativosCount > 0) ativosCount--; renderAtivosLimiteUI();
      } catch (e) { alert("Erro ao liberar.") }
    };

    async function concluirAtendimento(motivo) {
      if (!selecionado) return;
      try {
        btnConcluir.disabled = true;
        const r = await fetch(`${CONV_API}/api/tickets/concluir`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo || '0', 10), remetente: selecionado.remetente, phone_id: selecionado.phone_id, motivo }) });
        const j = await r.json();
        if (!r.ok || !j.ok) { alert(j.erro || "N√£o foi poss√≠vel concluir."); btnConcluir.disabled = false; return; }
        const k = keyFrom(selecionado.remetente, selecionado.phone_id); delete unreadCountByKey[k]; delete lastContatoTsByKey[k]; persistUnread();
        tickets = tickets.filter((t) => (!(t.remetente === selecionado.remetente && t.phone_id === selecionado.phone_id))); saveTickets(); renderTickets(); limparChat();
        elTitulo.textContent = "Selecione um ticket"; elSubInfo.textContent = ""; btnLiberar.disabled = true; btnConcluir.disabled = true; selecionado = null;
        selecionado = null;
        if (typeof msgsCtrl !== 'undefined' && msgsCtrl) { try { msgsCtrl.abort(); } catch { } }
        if (typeof schedulePolls === 'function') schedulePolls();

        if (ativosCount > 0) ativosCount--; renderAtivosLimiteUI();
      } catch (e) { alert("Erro ao concluir."); btnConcluir.disabled = false; }
    }

    async function doLogout() {
      // Feedback imediato no bot√£o
      try { btnLogout.textContent = 'Saindo‚Ä¶'; btnLogout.disabled = true; } catch (_) { }
      try { await fetch(`${FILA_API}/fila/offline`, { method: "DELETE", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo || '0', 10), carteira: agente.carteira || '' }) }).catch(() => { }); } catch (_) { }
      try {
        localStorage.removeItem("agente_codigo"); localStorage.removeItem("agente_nome"); localStorage.removeItem("agente_carteira"); localStorage.removeItem("agente_origem"); localStorage.removeItem("agente_perm_envio_individual");
        Object.keys(localStorage).forEach(k => { if (k.startsWith("cz:tickets:") || k.startsWith("cz:unreadCount:") || k.startsWith("cz:lastContatoTs:")) localStorage.removeItem(k) });
      } catch (_) { }
      if (pollingContatos) clearInterval(pollingContatos);
      if (pollingMensagens) clearInterval(pollingMensagens);
      if (pendentesInterval) clearInterval(pendentesInterval);

      // Modal de confirma√ß√£o de logout
      showModalFeedback('Agente deslogado com sucesso.', 'Logout', 900);

      // Redireciona / recarrega ap√≥s breve confirma√ß√£o
      setTimeout(() => {
        if (LOGOUT_REDIRECT) window.location.href = LOGOUT_REDIRECT;
        else location.reload();
      }, 950);
    }

    function limparChat() { chat.innerHTML = '<p id="loading" class="text-center muted">Pegue uma conversa para iniciar‚Ä¶</p>' }

    /** ============== KPIs & Relat√≥rio ============== */
    function fmtDurSec(s) { if (s == null) return "‚Äî"; const m = Math.floor(s / 60), sec = s % 60; if (m >= 60) { const h = Math.floor(m / 60), mm = m % 60; return `${h}h ${mm}m`; } return `${m}m ${sec}s`; }

    function buildRelQS() {
      const start = relStart.value || fmtYMD(new Date());
      const end = relEnd.value || start;
      const p = new URLSearchParams();
      p.set('start', start);
      p.set('end', end);
      if (agente?.carteira) p.set('carteira', agente.carteira);
      if (agente?.codigo) p.set('agentes', String(agente.codigo));
      return `?${p.toString()}`;
    }

    // QS espec√≠fico do extrato (sem carteira)
    function buildExtratoQS() {
      const start = relStart.value || fmtYMD(new Date());
      const end = relEnd.value || start;
      const p = new URLSearchParams();
      p.set('start', start);
      p.set('end', end);
      if (agente?.codigo) p.set('agentes', String(agente.codigo));
      return `?${p.toString()}`;
    }

    function updatePeriodoLabel() {
      try {
        const s = relStart.value, e = relEnd.value;
        if (!s || !e) { relPeriodo.textContent = '‚Äî'; return; }
        const [sy, sm, sd] = s.split('-').map(Number);
        const [ey, em, ed] = e.split('-').map(Number);
        const ds = fmtDataBR.format(new Date(sy, sm - 1, sd));
        const de = fmtDataBR.format(new Date(ey, em - 1, ed));
        relPeriodo.textContent = (s === e) ? ds : `${ds} a ${de}`;
      } catch { relPeriodo.textContent = '‚Äî'; }
    }

    function bindQuickRanges() {
      document.querySelectorAll('[data-qk]').forEach(btn => {
        btn.addEventListener('click', () => {
          const qk = btn.getAttribute('data-qk');
          const now = new Date(); const ymd = fmtYMD(now);
          if (qk === 'hoje') { relStart.value = ymd; relEnd.value = ymd; }
          else if (qk === 'ontem') {
            const d = new Date(now); d.setDate(d.getDate() - 1);
            const y1 = fmtYMD(d); relStart.value = y1; relEnd.value = y1;
          } else if (qk === '7d') {
            const d = new Date(now); d.setDate(d.getDate() - 6);
            relStart.value = fmtYMD(d); relEnd.value = ymd;
          } else if (qk === '30d') {
            const d = new Date(now); d.setDate(d.getDate() - 29);
            relStart.value = fmtYMD(d); relEnd.value = ymd;
          }
          updatePeriodoLabel();
          refreshKPIs();
        });
      });
    }

    function chartTextColor() { return getCss('--text') || '#e5e7eb' }

    async function refreshKPIs() {
      updatePeriodoLabel();

      const qs = buildRelQS();
      const urlResumo = `${API_BASE}/api/atendimentos/resumo${qs}`;
      const urlMotivos = `${API_BASE}/api/atendimentos/motivos${qs}`;

      try {
        // Resumo
        const rRes = await fetch(urlResumo);
        const resumo = rRes.ok ? await rRes.json() : {};
        const em = Number(resumo.em_atendimento || 0);
        const conc = Number(resumo.concluidos || 0);
        kpiEm.textContent = String(em);
        kpiConc.textContent = String(conc);
        kpiTma.textContent = fmtDurSec(resumo.tma_segundos);
        kpiFRT.textContent = fmtDurSec(resumo.tmr_segundos);

        // Status pie
        const ctxStatus = document.getElementById('pieStatus')?.getContext('2d');
        if (ctxStatus) {
          if (pieChart) pieChart.destroy();
          pieChart = new Chart(ctxStatus, {
            type: 'pie',
            data: { labels: ['Em atendimento', 'Conclu√≠dos'], datasets: [{ data: [em, conc] }] },
            options: { responsive: true, plugins: { legend: { labels: { color: chartTextColor() } } } }
          });
        }

        // Motivos (pizza)
        try {
          const rMot = await fetch(urlMotivos);
          const motivos = rMot.ok ? await rMot.json() : [];
          const labels = Array.isArray(motivos) ? motivos.map(m => m.motivo || m.label || '‚Äî') : [];
          const vals = Array.isArray(motivos) ? motivos.map(m => Number(m.qtd || m.total || 0)) : [];
          const ctxMot = document.getElementById('pieMotivos')?.getContext('2d');
          if (ctxMot) {
            if (chartMotivos) chartMotivos.destroy();
            chartMotivos = new Chart(ctxMot, { type: 'pie', data: { labels, datasets: [{ data: vals }] }, options: { plugins: { legend: { labels: { color: chartTextColor() } } } } });
          }
        } catch { }

        // Extrato (acorde√£o)
        await refreshExtrato();

      } catch (e) {
        // fallback silencioso
      }
    }

    // ------- Extrato (acorde√£o) -------
    function normalizeExtratoRow(row) {
      if (!row) return null;
      if (Array.isArray(row)) {
        return {
          data: row[0],
          atendimentos: Number(row[1] || 0),
          inativo: Number(row[2] || 0),
          duvidas: Number(row[3] || 0),
          segunda_via: Number(row[4] || 0),
          recusou: Number(row[5] || 0),
          negociacao: Number(row[6] || 0)
        };
      }
      return {
        data: row.data_hora || row.data || row.dia,
        atendimentos: Number(row.atendimentos || row.total || 0),
        inativo: Number(row.cliente_ficou_inativo || 0),
        duvidas: Number(row.duvidas_gerais || 0),
        segunda_via: Number(row.solicitou_2¬™_via_de_boleto || row.solicitou_2a_via_de_boleto || 0),
        recusou: Number(row.recusou_a_proposta || 0),
        negociacao: Number(row.realizou_negociacao || 0)
      };
    }

    function pct(v, tot) { if (!tot) return '0%'; return Math.round((v / tot) * 100) + '%'; }

    function renderExtrato(rows) {
      extratoWrap.innerHTML = '';
      if (!Array.isArray(rows) || !rows.length) {
        extratoWrap.innerHTML = `<div class="p-4 text-sm muted">Sem dados para o per√≠odo selecionado.</div>`;
        return;
      }
      rows.forEach((raw) => {
        const r = normalizeExtratoRow(raw);
        if (!r) return;
        const dt = r.data ? new Date(r.data) : null;
        const label = dt ? fmtDataBR.format(dt) : String(r.data || '‚Äî');
        const total = r.atendimentos || 0;

        const item = document.createElement('div');
        item.className = 'extrato-item';

        const header = document.createElement('button');
        header.type = 'button';
        header.className = 'extrato-header';
        header.setAttribute('aria-expanded', 'false');
        header.innerHTML = `
            <div class="flex items-center gap-3">
              <span class="font-medium">${escapeHtml(label)}</span>
              <span class="extrato-meta">Total: <strong style="color:var(--text)">${total}</strong></span>
              <span class="extrato-meta">Negocia√ß√µes: <strong style="color:var(--text)">${r.negociacao}</strong> (${pct(r.negociacao, total)})</span>
            </div>
            <span class="extrato-chevron">‚ñº</span>
          `;

        const content = document.createElement('div');
        content.className = 'extrato-content hidden';
        content.innerHTML = `
            <div class="overflow-x-auto">
              <table class="table-soft">
                <thead>
                  <tr>
                    <th class="text-left">Motivo</th>
                    <th class="text-right">Qtd</th>
                    <th class="text-right">% do dia</th>
                  </tr>
                </thead>
                <tbody>
                  ${[
            ['Realizou negocia√ß√£o', r.negociacao],
            ['Solicitou 2¬™ via de boleto', r.segunda_via],
            ['Recusou a proposta', r.recusou],
            ['D√∫vidas gerais', r.duvidas],
            ['Cliente ficou inativo', r.inativo]
          ].map(([mot, v]) => `
                    <tr>
                      <td>${escapeHtml(mot)}</td>
                      <td class="text-right">${v}</td>
                      <td class="text-right">${pct(v, total)}</td>
                    </tr>
                  `).join('')}
                  <tr class="font-medium">
                    <td class="text-right">Total do dia</td>
                    <td class="text-right">${total}</td>
                    <td class="text-right">100%</td>
                  </tr>
                </tbody>
              </table>
            </div>
          `;

        header.addEventListener('click', () => {
          const open = !content.classList.contains('hidden');
          content.classList.toggle('hidden');
          header.setAttribute('aria-expanded', String(!open));
          header.querySelector('.extrato-chevron').textContent = open ? '‚ñº' : '‚ñ≤';
        });

        item.appendChild(header);
        item.appendChild(content);
        extratoWrap.appendChild(item);
      });
    }

    async function refreshExtrato() {
      try {
        const qs = buildExtratoQS();
        const url = `${API_BASE}/api/dashboard/extrato_motivos_agentes${qs}`;
        const r = await fetch(url);
        const rows = r.ok ? await r.json() : [];
        renderExtrato(rows);
      } catch (e) {
        extratoWrap.innerHTML = `<div class="p-4 text-sm text-red-600">Falha ao carregar extrato.</div>`;
      }
    }

    if (btnExtratoRefresh) btnExtratoRefresh.addEventListener('click', refreshExtrato);
    if (btnRefreshRel) btnRefreshRel.onclick = refreshKPIs;
    relStart?.addEventListener('change', () => { updatePeriodoLabel(); refreshKPIs(); });
    relEnd?.addEventListener('change', () => { updatePeriodoLabel(); refreshKPIs(); });
    bindQuickRanges();

    /** ============== AVISOS (Painel) ============== */
    function noticesKey() { return `cz:notices_read:${agente?.codigo || 'anon'}` }
    function loadNoticesReadSet() { try { const raw = localStorage.getItem(noticesKey()); if (!raw) return new Set(); const arr = JSON.parse(raw); return new Set(Array.isArray(arr) ? arr : []); } catch { return new Set(); } }
    function saveNoticesReadSet() { try { localStorage.setItem(noticesKey(), JSON.stringify(Array.from(noticesReadSet))); } catch { } }

    function normalizeNotice(n) {
      if (!n) return null;
      return {
        id: String(n.id ?? hashId(`${n.titulo}|${n.conteudo}|${n.created_at || ''}`)),
        title: String(n.titulo || 'Aviso'),
        body: String(n.conteudo || ''),
        priority: Number(n.prioridade ?? 5),
        created_at: n.created_at || null
      };
    }

    function parseCssColorToRgb(c) {
      if (!c) return [255, 255, 255];
      c = c.trim();
      if (c.startsWith('#')) {
        const hex = c.replace('#', '');
        const h = hex.length === 3 ? hex.split('').map(x => x + x).join('') : hex;
        const r = parseInt(h.slice(0, 2), 16);
        const g = parseInt(h.slice(2, 4), 16);
        const b = parseInt(h.slice(4, 6), 16);
        return [r, g, b];
      }
      const m = c.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
      if (m) return [parseInt(m[1], 10), parseInt(m[2], 10), parseInt(m[3], 10)];
      return [255, 255, 255];
    }
    function relLum([r, g, b]) {
      const srgb = [r, g, b].map(v => v / 255).map(v => v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4));
      return 0.2126 * srgb[0] + 0.7152 * srgb[1] + 0.0722 * srgb[2];
    }
    function isDarkTheme() {
      const bg = getCss('--content-bg') || getCss('--bg') || '#ffffff';
      return relLum(parseCssColorToRgb(bg)) < 0.45;
    }

    function priorityColors(pri) {
      const t = Math.max(0, Math.min(10, Number(pri) || 0)) / 10;
      const hue = 220 * t;
      const dark = isDarkTheme();
      const border = dark ? `hsl(${hue} 80% 60%)` : `hsl(${hue} 85% 45%)`;
      const bg = dark
        ? `color-mix(in srgb, hsl(${hue} 90% 45%) 18%, var(--content-bg))`
        : `color-mix(in srgb, hsl(${hue} 90% 50%) 10%, var(--content-bg))`;
      return { border, bg };
    }

    function sevClass(pri) {
      const p = Number(pri) || 0;
      if (p === 0) return 'sev-crit';
      if (p <= 3) return 'sev-warn';
      if (p <= 6) return 'sev-info';
      return 'sev-success';
    }

    async function fetchNotices() {
      try {
        const url = NOTICES_API();
        const r = await fetch(url);
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const arr = await r.json();
        return (Array.isArray(arr) ? arr : []).map(normalizeNotice).filter(Boolean);
      } catch (err) {
        console.warn('Avisos: fallback vazio', err);
        return [];
      }
    }

    function renderNotices(list) {
      heroWrap.classList.add('hidden');

      const sorted = [...(list || [])].sort((a, b) => {
        if ((a.priority ?? 999) !== (b.priority ?? 999)) return (a.priority ?? 999) - (b.priority ?? 999);
        const da = a.created_at ? +new Date(a.created_at) : 0;
        const db = b.created_at ? +new Date(b.created_at) : 0;
        return da - db;
      });

      avisosWrap.innerHTML = "";
      if (!sorted.length) {
        avisosWrap.innerHTML = `<div class="notice p-4 text-sm muted">Nenhum aviso para exibir.</div>`;
      } else {
        for (const n of sorted) {
          const isCrit = Number(n.priority) === 0;
          const el = document.createElement('div');
          el.className = `notice${isCrit ? ' crit' : ''}`;
          const c = priorityColors(n.priority);
          el.style.borderLeft = isCrit ? '8px solid #dc2626' : `6px solid ${c.border}`;
          el.style.background = c.bg;

          const when = n.created_at ? `${fmtDataBR.format(new Date(n.created_at))} ${fmtHoraBR.format(new Date(n.created_at))}` : '';
          el.innerHTML = `
              <div class="notice-head">
                <div class="notice-left">
                  <div class="sev ${sevClass(n.priority)}"></div>
                  <div class="min-w-0">
                    <div class="notice-title">${isCrit ? 'üö® ' : ''}${escapeHtml(n.title)}${isCrit ? ' <span class="crit-badge">CR√çTICO</span>' : ''}</div>
                    <div class="notice-meta">
                      <span>Prioridade: ${Number.isFinite(n.priority) ? n.priority : '‚Äî'}</span>
                      ${when ? `<span>${when}</span>` : ``}
                    </div>
                  </div>
                </div>
              </div>
              <div class="notice-body">${escapeHtml(n.body)}</div>
            `;
          avisosWrap.appendChild(el);
        }
      }

      const critCount = sorted.filter(n => Number(n.priority) === 0).length;
      avisosResumo.textContent = `${sorted.length} aviso(s) ‚Ä¢ ${critCount} cr√≠tico(s) ‚Ä¢ aten√ß√£o aos recados da supervis√£o`;
      avisosCountPill.textContent = String(sorted.length);
    }

    async function loadNoticesAndRender() {
      try {
        notices = (await fetchNotices()).filter(Boolean);
      } catch { notices = []; }
      renderNotices(notices);
    }

    if (btnAvisoRefresh) btnAvisoRefresh.addEventListener('click', loadNoticesAndRender);

    document.querySelectorAll('[data-avisos-filter]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-avisos-filter]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderNotices(notices);
      });
    });

    /** ============== Navega√ß√£o inicial ============== */
    window.addEventListener('load', async () => {
      const saved = loadTheme(); applyTheme(saved || defaultTheme());
      toggleLoginLocks();
      if (isLogged()) {
        showApp();                 
        await boot();              
        switchTab('home');
        fecharModalLogin();
      } else {
        hideApp();                 
        abrirModalLogin();         
      }
    });
  </script>
<script>
    const presets = {
      corporate: { primary: "#2563eb", accent: "#22c55e", sidebar: "#ffffff", contentBg: "#ffffff", bg: "#f3f4f6", text: "#0f172a", outG1: "#e0f2fe", outG2: "#bfdbfe", inBg: "#ffffff", inBorder: "#e2e8f0", bubbleRadius: 18, btnRadius: 10, cardRadius: 16, wallOp: 0, fontSize: "14px", muted: "#6b7280", border: "#e5e7eb", link: "#2563eb", ghostBg: "#f3f4f6" },
      ocean: { primary: "#06b6d4", accent: "#10b981", sidebar: "#f0fdff", contentBg: "#ecfeff", bg: "#f0fdfa", text: "#0b1320", outG1: "#cffafe", outG2: "#a7f3d0", inBg: "#ffffff", inBorder: "#cbd5e1", bubbleRadius: 18, btnRadius: 12, cardRadius: 18, wallOp: .05, fontSize: "14px", muted: "#475569", border: "#cbd5e1", link: "#0891b2", ghostBg: "#e2f2f3" },
      sunset: { primary: "#f97316", accent: "#ef4444", sidebar: "#fff7ed", contentBg: "#fff7ed", bg: "#fff1f2", text: "#111827", outG1: "#fed7aa", outG2: "#fda4af", inBg: "#ffffff", inBorder: "#fecaca", bubbleRadius: 20, btnRadius: 12, cardRadius: 20, wallOp: .06, fontSize: "14px", muted: "#6b7280", border: "#f3d4cf", link: "#f97316", ghostBg: "#fff3e8" },
      dark: { primary: "#60a5fa", accent: "#22c55e", sidebar: "#0b1220", contentBg: "#0b1220", bg: "#0a0f1a", text: "#e5e7eb", muted: "#94a3b8", border: "#1f2937", link: "#93c5fd", ghostBg: "#111827", outG1: "#1f2937", outG2: "#0f172a", outFg: "#e5e7eb", inBg: "#0e1726", inBorder: "#1f2937", inFg: "#e5e7eb", bubbleRadius: 16, btnRadius: 10, cardRadius: 16, wallOp: 1, fontSize: "14px", hover: "#111827", hoverStrong: "#0f172a", inputBg: "#0e1726", inputFg: "#e5e7eb", scrollbar: "#334155", ticketSelectedBg: "#111827", replyBg: "rgba(255,255,255,.08)", replyBorder: "rgba(255,255,255,.12)", replyFg: "#e5e7eb" },
      minimal: { primary: "#111827", accent: "#64748b", sidebar: "#ffffff", contentBg: "#ffffff", bg: "#f8fafc", text: "#0f172a", outG1: "#f3f4f6", outG2: "#e5e7eb", inBg: "#ffffff", inBorder: "#e2e8f0", bubbleRadius: 14, btnRadius: 8, cardRadius: 16, wallOp: 0, fontSize: "15px", muted: "#6b7280", border: "#e5e7eb", link: "#111827", ghostBg: "#f3f4f6" },
      funky: { primary: "#a78bfa", accent: "#ec4899", sidebar: "#faf5ff", contentBg: "#fff0f7", bg: "#fafafa", text: "#111827", outG1: "#e9d5ff", outG2: "#fecdd3", inBg: "#ffffff", inBorder: "#f5d0fe", bubbleRadius: 22, btnRadius: 14, cardRadius: 22, wallOp: .08, fontSize: "14px", muted: "#6b7280", border: "#e9d5ff", link: "#a78bfa", ghostBg: "#f5f3ff" }
    };

    (function () {
      const themeDrawer = document.getElementById('themeDrawer');
      const btnTheme = document.getElementById('btnTheme');
      const btnThemeClose = document.getElementById('btnThemeClose');
      const btnThemeExport = document.getElementById('btnThemeExport');
      const importTheme = document.getElementById('importTheme');

      function openDrawer() { if (!themeDrawer) return; themeDrawer.classList.add('open'); themeDrawer.setAttribute('aria-hidden', 'false') }
      function closeDrawer() { if (!themeDrawer) return; themeDrawer.classList.remove('open'); themeDrawer.setAttribute('aria-hidden', 'true') }
      if (btnTheme) btnTheme.addEventListener('click', openDrawer);
      if (btnThemeClose) btnThemeClose.addEventListener('click', closeDrawer);
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeDrawer() } });

      // Preset clicks
      document.querySelectorAll('.preset').forEach(el => {
        el.addEventListener('click', () => {
          const name = el.dataset.preset;
          const base = (typeof defaultTheme === 'function') ? defaultTheme() : {};
          const t = Object.assign({}, base, presets[name] || {});
          if (typeof applyTheme === 'function') applyTheme(t);
          if (typeof saveTheme === 'function') saveTheme(t);
        });
      });

      // Export / Import
      if (btnThemeExport && typeof loadTheme === 'function') {
        btnThemeExport.addEventListener('click', () => {
          const t = (typeof loadTheme === 'function') ? loadTheme() : {};
          const blob = new Blob([JSON.stringify(t, null, 2)], { type: 'application/json' });
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'connectzap_theme.json'; a.click();
          setTimeout(() => URL.revokeObjectURL(a.href), 500);
        });
      }
      if (importTheme) {
        importTheme.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0]; if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => { try { const t = JSON.parse(ev.target.result); if (typeof applyTheme === 'function') applyTheme(t); if (typeof saveTheme === 'function') saveTheme(t); } catch (err) { console.error('Tema inv√°lido', err) } };
          reader.readAsText(file); e.target.value = '';
        });
      }
    })();
  </script>
</body>
</html>
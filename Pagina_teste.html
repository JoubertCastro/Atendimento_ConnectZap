<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Painel de Atendimento - Convers√£o ZX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary: #3b82f6;
      --accent: #22c55e;
      --bg: #f3f4f6;
      --sidebar-bg: #ffffff;
      --content-bg: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --link: #2563eb;
      --ghost-bg: #f3f4f6;
      --ring: rgba(59, 130, 246, .35);
      --bubble-out-g1: #dcf8c6;
      --bubble-out-g2: #b8f0a4;
      --bubble-out-fg: #111827;
      --bubble-in-bg: #ffffff;
      --bubble-in-border: #e2e8f0;
      --bubble-in-fg: #0f172a;
      --bubble-radius: 18px;
      --chat-wallpaper-opacity: 0;
      --btn-radius: 10px;
      --card-radius: 16px;
      --font-size: 14px;
      --ticket-selected-bg: #f0f9ff;
      --scrollbar: #cbd5e1;
      --hover: #f3f4f6;
      --hover-strong: #e5e7eb;
      --input-bg: #ffffff;
      --input-fg: #0f172a;
      --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-family);
      font-size: var(--font-size);
      -webkit-font-smoothing: antialiased
    }

    body {
      display: flex;
      flex-direction: column
    }

    #app {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0
    }

    .layout {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-height: 100vh;
      min-height: 0
    }

    header {
      background: var(--sidebar-bg);
      border-bottom: 1px solid var(--border);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem
    }

    .brand {
      display: flex;
      align-items: center;
      gap: .5rem;
      min-width: 0
    }

    .brand-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #38bdf8, #2563eb);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #eff6ff;
      font-weight: 700;
      font-size: 16px;
      box-shadow: 0 8px 16px rgba(37, 99, 235, .35)
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      min-width: 0
    }

    .brand-title {
      font-weight: 600;
      font-size: .95rem;
      white-space: nowrap
    }

    .brand-subtitle {
      font-size: .7rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: .35rem
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      padding: 0.1rem .45rem;
      border-radius: 999px;
      background: #ecfdf5;
      color: #15803d;
      font-size: .7rem;
      font-weight: 500
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: .5rem
    }

    .top-actions>div {
      display: flex;
      align-items: center;
      gap: .25rem
    }

    .top-info-label {
      font-size: .7rem;
      color: var(--muted)
    }

    .top-info-value {
      font-size: .8rem;
      font-weight: 500
    }

    .btn {
      border-radius: var(--btn-radius);
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .4rem;
      cursor: pointer;
      font-size: .8rem;
      font-weight: 500;
      transition: background .15s ease, color .15s ease, border-color .15s ease, box-shadow .15s ease, transform .05s ease;
      background: #f9fafb;
      color: #111827;
      padding: .4rem .7rem
    }

    .btn:disabled {
      opacity: .6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      color: #eff6ff;
      box-shadow: 0 10px 20px rgba(37, 99, 235, .35)
    }

    .btn-primary:hover:not(:disabled) {
      filter: brightness(1.08);
      box-shadow: 0 12px 24px rgba(37, 99, 235, .4);
      transform: translateY(-1px)
    }

    .btn-ghost {
      background: var(--ghost-bg);
      border-color: rgba(148, 163, 184, .3);
      color: var(--text)
    }

    .btn-ghost:hover:not(:disabled) {
      background: #e5e7eb
    }

    .btn-outline {
      background: transparent;
      border-color: rgba(148, 163, 184, .6);
      color: var(--text)
    }

    .btn-outline:hover:not(:disabled) {
      background: var(--ghost-bg)
    }

    .badge {
      padding: 0.1rem .4rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .4);
      font-size: .7rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: .2rem
    }

    .badge-pill {
      border-radius: 999px
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      padding: 0.1rem .5rem;
      border-radius: 999px;
      font-size: .7rem;
      border: 1px solid rgba(148, 163, 184, .3);
      color: var(--muted);
      background: rgba(248, 250, 252, .8)
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e
    }

    .separator {
      width: 1px;
      height: 18px;
      background: rgba(148, 163, 184, .4)
    }

    .main {
      display: flex;
      flex: 1;
      min-height: 0
    }

    .sidebar {
      background: var(--sidebar-bg)
    }

    .topbar {
      background: var(--content-bg);
      backdrop-filter: blur(12px)
    }

    .tabs {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: .2rem;
      background: rgba(15, 23, 42, .03);
      border: 1px solid rgba(148, 163, 184, .4)
    }

    .tab {
      position: relative;
      border-radius: 999px;
      padding: .2rem .9rem;
      font-size: .78rem;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: .35rem
    }

    .tab-active {
      background: #ffffff;
      color: #111827;
      box-shadow: 0 4px 8px rgba(15, 23, 42, .12)
    }

    .tab-pill {
      font-size: .65rem;
      padding: 0 .4rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, .04);
      border: 1px solid rgba(148, 163, 184, .4)
    }

    .scrollbar-thin::-webkit-scrollbar {
      width: 6px
    }

    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: var(--scrollbar);
      border-radius: 999px
    }

    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: #94a3b8
    }

    .ticket {
      padding: .55rem .65rem;
      border-radius: .75rem;
      border: 1px solid transparent;
      display: flex;
      flex-direction: column;
      gap: .15rem;
      cursor: pointer;
      background: transparent;
      transition: background .15s ease, border-color .15s ease, transform .05s ease, box-shadow .15s ease
    }

    .ticket:not(.selected):hover {
      background: rgba(15, 23, 42, .02);
      border-color: rgba(148, 163, 184, .35);
      transform: translateY(-1px)
    }

    .ticket.selected {
      background: var(--ticket-selected-bg);
      border-color: var(--primary);
      box-shadow: 0 10px 18px rgba(59, 130, 246, .35)
    }

    .ticket-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .35rem
    }

    .ticket-name {
      font-weight: 600;
      font-size: .85rem;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden
    }

    .ticket-meta {
      font-size: .72rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: .35rem
    }

    .ticket-body {
      font-size: .75rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .35rem
    }

    .ticket-badge {
      font-size: .65rem;
      padding: 0 .4rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, .04);
      border: 1px solid rgba(148, 163, 184, .35)
    }

    .ticket-unread-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e
    }

    .ticket-unread-count {
      min-width: 18px;
      text-align: center;
      font-size: .7rem;
      padding: 0 .35rem;
      border-radius: 999px;
      background: #22c55e;
      color: #ecfdf5;
      font-weight: 600
    }

    .chat-wallpaper {
      position: absolute;
      inset: 0;
      opacity: var(--chat-wallpaper-opacity);
      background-image:
        radial-gradient(circle at 0 0, rgba(129, 140, 248, .22), transparent 60%),
        radial-gradient(circle at 100% 0, rgba(56, 189, 248, .2), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34, 197, 94, .22), transparent 60%);
      pointer-events: none
    }

    .chat-inner {
      position: relative;
      z-index: 1
    }

    .msg {
      max-width: min(80%, 600px);
      padding: .55rem .75rem;
      border-radius: var(--bubble-radius);
      font-size: .8rem;
      line-height: 1.4;
      position: relative;
      display: inline-flex;
      flex-direction: column;
      gap: .2rem;
      border: 1px solid transparent
    }

    .msg.enviada {
      align-self: flex-end;
      background: linear-gradient(120deg, var(--bubble-out-g1), var(--bubble-out-g2));
      color: var(--bubble-out-fg)
    }

    .msg.recebida {
      align-self: flex-start;
      background: var(--bubble-in-bg);
      color: var(--bubble-in-fg);
      border-color: var(--bubble-in-border)
    }

    .msg small {
      font-size: .68rem;
      color: var(--muted);
      align-self: flex-end
    }

    .msg-tail {
      position: absolute;
      bottom: -2px;
      width: 14px;
      height: 14px;
      overflow: hidden
    }

    .msg-tail::before {
      content: "";
      position: absolute;
      width: 14px;
      height: 14px;
      transform: rotate(45deg)
    }

    .msg.enviada .msg-tail {
      right: 0
    }

    .msg.enviada .msg-tail::before {
      background: linear-gradient(130deg, var(--bubble-out-g1), var(--bubble-out-g2));
      right: 2px;
      bottom: 0
    }

    .msg.recebida .msg-tail {
      left: 0
    }

    .msg.recebida .msg-tail::before {
      background: var(--bubble-in-bg);
      border-left: 1px solid var(--bubble-in-border);
      border-bottom: 1px solid var(--bubble-in-border);
      left: 2px;
      bottom: 0
    }

    .input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: .45rem .9rem;
      font-size: .8rem;
      outline: none;
      background: var(--input-bg);
      color: var(--input-fg);
      transition: border-color .12s ease, box-shadow .12s ease, background .12s ease
    }

    .input:focus {
      border-color: var(--ring);
      box-shadow: 0 0 0 1px var(--ring)
    }

    .input-area {
      border-radius: 1rem;
      padding: .6rem .75rem;
      min-height: 72px;
      resize: vertical
    }

    .label {
      font-size: .75rem;
      color: var(--muted);
      margin-bottom: .2rem
    }

    .card {
      background: var(--content-bg);
      border: 1px solid var(--border);
      border-radius: var(--card-radius)
    }

    .badge-kpi {
      font-size: .7rem;
      padding: 0 .4rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .4);
      background: rgba(248, 250, 252, .7);
      color: var(--muted)
    }

    .kpi-number {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif;
      font-weight: 600;
      font-size: 1.5rem
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
      margin-right: .25rem
    }

    .dot.online {
      background: #22c55e
    }

    .dot.offline {
      background: #ef4444
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      padding: .1rem .5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .35);
      font-size: .7rem;
      color: var(--muted);
      background: rgba(248, 250, 252, .9)
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e
    }

    .pill-soft {
      border-radius: 999px;
      padding: .2rem .6rem;
      font-size: .7rem;
      background: rgba(15, 23, 42, .03);
      border: 1px dashed rgba(148, 163, 184, .4);
      color: var(--muted)
    }

    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: min(430px, 96%);
      height: 100%;
      background: var(--content-bg);
      border-left: 1px solid var(--border);
      box-shadow: -12px 0 24px rgba(0, 0, 0, .08);
      transform: translateX(100%);
      transition: transform .25s ease;
      z-index: 60
    }

    .drawer.open {
      transform: translateX(0)
    }

    /* FIX: modal n√£o deve abrir ap√≥s F5 se logado */
    .modal {
      display: none;
      /* <‚Äî manter apenas esta linha */
      position: fixed;
      inset: 0;
      z-index: 50;
      align-items: center;
      justify-content: center
    }

    .modal.open {
      display: flex
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, .35);
      backdrop-filter: blur(4px)
    }

    .modal-card {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 360px;
      background: var(--content-bg);
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, .4);
      box-shadow: 0 24px 60px rgba(15, 23, 42, .35);
      padding: 1.5rem
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: .6rem
    }

    .modal-footer {
      margin-top: 1.2rem;
      display: flex;
      justify-content: flex-end;
      gap: .5rem
    }

    .input-sm {
      font-size: .8rem;
      padding: .4rem .65rem;
      border-radius: .75rem
    }

    /* Loader spinner inline (para bot√µes) */
    .spinner {
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, .35);
      border-top-color: var(--primary);
      width: 14px;
      height: 14px;
      animation: spin .7s linear infinite
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    @media (max-width:960px) {
      header {
        flex-wrap: wrap;
        align-items: flex-start
      }

      .brand-title {
        font-size: .9rem
      }

      .brand-subtitle {
        font-size: .68rem
      }

      .top-actions {
        width: 100%;
        justify-content: flex-end
      }

      .tabs {
        width: 100%;
        justify-content: center
      }
    }

    @media (max-width:768px) {
      .main {
        flex-direction: column
      }

      .sidebar {
        width: 100% !important;
        border-right: none;
        border-bottom: 1px solid var(--border)
      }

      .ticket {
        padding: .5rem .55rem
      }

      .msg {
        max-width: 86%
      }
    }

    .topbar.small {
      padding: .35rem .75rem
    }

    .topbar-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .5rem
    }

    .topbar-title {
      font-weight: 600;
      font-size: .8rem;
      color: var(--muted)
    }

    .assist-pill {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      padding: .15rem .5rem;
      border-radius: 999px;
      background: rgba(56, 189, 248, .08);
      border: 1px solid rgba(56, 189, 248, .45);
      color: #0e7490;
      font-size: .7rem
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: .35rem
    }

    .fs-xs {
      font-size: .68rem
    }

    .fs-sm {
      font-size: .8rem
    }

    .text-muted {
      color: var(--muted)
    }

    .ticket-filter-pill {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      padding: .15rem .5rem;
      border-radius: 999px;
      font-size: .7rem;
      cursor: pointer;
      border: 1px solid rgba(148, 163, 184, .4);
      background: rgba(248, 250, 252, .9);
      color: var(--muted)
    }

    .ticket-filter-pill.active {
      background: rgba(59, 130, 246, .08);
      border-color: rgba(59, 130, 246, .8);
      color: #1d4ed8
    }

    .pill-small {
      padding: 0 .45rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .4);
      font-size: .7rem;
      color: var(--muted)
    }

    .text-xxs {
      font-size: .68rem
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="layout">
      <header>
        <div class="brand">
          <div class="brand-icon">CZ</div>
          <div class="brand-text">
            <div class="brand-title">Central de Atendimento</div>
            <div class="brand-subtitle">
              <span>Convers√£o ZX</span>
              <span class="separator"></span>
              <span class="status-pill">
                <span class="status-dot" id="pillStatusDot"></span>
                <span id="pillStatusLabel">Offline</span>
              </span>
            </div>
          </div>
        </div>
        <div class="top-actions">
          <div>
            <div class="top-info-label">Tickets ativos</div>
            <div class="top-info-value">
              <span id="ativosCount">0</span>/<span id="limiteAtivos">4</span>
            </div>
          </div>
          <div class="separator"></div>
          <div>
            <div class="top-info-label">Em fila</div>
            <div class="top-info-value" id="filaCount">0</div>
          </div>
          <div class="separator"></div>
          <div>
            <div class="top-info-label">Agente</div>
            <div class="top-info-value" id="headerAgente">‚Äî</div>
          </div>
          <div class="separator"></div>
          <div>
            <div class="top-info-label">Carteira</div>
            <div class="top-info-value" id="headerCarteira">‚Äî</div>
          </div>
          <div class="separator"></div>
          <div class="tabs" role="tablist">
            <button id="tabBtnHome" class="tab tab-active" role="tab" aria-selected="true" aria-controls="tabHome">
              <span>üè† Home</span>
            </button>
            <button id="tabBtnConversas" class="tab" role="tab" aria-selected="false"
              aria-controls="tabConversas">
              <span>üí¨ Conversas</span>
              <span id="tabBadgeConversas" class="tab-pill">0</span>
            </button>
            <button id="tabBtnRelatorio" class="tab" role="tab" aria-selected="false" aria-controls="tabRelatorio">
              <span>üìä Relat√≥rio</span>
            </button>
          </div>
        </div>
      </header>

      <main class="main">
        <!-- HOME -->
        <section id="tabHome" class="flex-1 p-6">
          <div class="max-w-4xl mx-auto">
            <div class="card p-6">
              <h1 class="text-2xl font-bold">Bem-vindo(a) üëã</h1>
              <p class="text-gray-600 mt-2">Ol√° <span id="homeAgenteNome" class="font-semibold">‚Äî</span>!</p>
              <p class="text-gray-600">Carteira: <span id="homeAgenteCarteira" class="font-semibold">‚Äî</span></p>

              <!-- CONTROLES GERAIS NA HOME -->
              <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="p-4 border rounded-lg">
                  <div class="text-sm text-gray-500 mb-1">Status</div>
                  <div id="homeStatus" class="font-medium"><span class="dot offline"></span>Offline</div>
                  <div class="mt-3 flex flex-wrap gap-2">
                    <button id="btnToggleOnline"
                      class="btn px-3 py-2 bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 flex items-center gap-2"
                      disabled aria-live="polite" aria-pressed="false">
                      <svg id="toggleSpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24"
                        aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
                          fill="none"></circle>
                        <path class="opacity-75" fill="currentColor"
                          d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                      </svg>
                      <span id="toggleLabel">Ficar online</span>
                    </button>
                    <!-- Bot√£o din√¢mico: Login/Logout -->
                    <button id="btnLogout" class="btn px-3 py-2 bg-gray-100 hover:bg-gray-200">Logout</button>
                  </div>
                  <div id="homeAviso" class="mt-2 text-xs text-amber-600 hidden" role="alert"
                    aria-live="polite"></div>
                </div>

                <div class="p-4 border rounded-lg">
                  <div class="text-sm text-gray-500 mb-1">Atalhos</div>
                  <div class="flex flex-wrap gap-2">
                    <button id="goToConversas1" class="btn btn-primary px-4 py-2">Ir para Conversas</button>
                    <button id="goToRelatorio1"
                      class="btn px-4 py-2 bg-gray-100 hover:bg-gray-200">Ver Relat√≥rio</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- CONVERSAS -->
        <section id="tabConversas" class="hidden h-full flex">
          <!-- Sidebar esquerda -->
          <aside class="sidebar w-1/3 lg:w-1/4 border-r flex flex-col">
            <div class="p-3 border-b topbar">
              <div class="flex items-start justify-between gap-2">
                <div class="min-w-0">
                  <div class="text-xs text-muted mb-1">Tickets</div>
                  <div class="flex items-center gap-2">
                    <div class="pill">
                      <span class="pill-dot"></span>
                      <span class="fs-xs">Ativos: <span id="sidebarAtivos">0</span>/<span id="sidebarLimite">4</span></span>
                    </div>
                    <div class="pill-soft fs-xs">
                      Fila: <span id="sidebarFila">0</span>
                    </div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-xs text-muted mb-1">Agente</div>
                  <div id="sidebarAgente" class="fs-sm font-medium truncate">‚Äî</div>
                  <div class="text-xxs text-muted">Carteira: <span id="sidebarCarteira">‚Äî</span></div>
                </div>
              </div>
              <div class="mt-3 flex items-center justify-between gap-2">
                <div class="flex flex-wrap gap-1">
                  <button id="filterTodos" class="ticket-filter-pill active">
                    Todos
                  </button>
                  <button id="filterMeus" class="ticket-filter-pill">
                    Meus
                  </button>
                </div>
                <div class="flex items-center gap-2">
                  <span class="pill-small">
                    SLA m√©dio: <span id="slaMedio">‚Äî</span>
                  </span>
                </div>
              </div>
            </div>
            <div class="p-2 border-b">
              <input id="buscaTickets" class="input input-sm w-full" type="search" placeholder="Buscar por nome ou n√∫mero"
                autocomplete="off">
            </div>
            <div class="flex-1 overflow-y-auto scrollbar-thin" id="ticketsContainer">
              <div class="p-3 text-xs text-muted">Nenhum ticket carregado ainda.</div>
            </div>
          </aside>

          <!-- Coluna central - Chat -->
          <main class="flex-1 flex flex-col">
            <div class="flex items-center justify-between p-3 border-b topbar">
              <div class="min-w-0">
                <div id="tituloConversa" class="font-bold text-lg truncate">Selecione um ticket</div>
                <div id="subInfo" class="text-sm text-gray-500 truncate"></div>
              </div>
              <div class="flex items-center gap-2">
                <button id="btnLiberar"
                  class="btn px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 disabled:opacity-50"
                  disabled>Liberar</button>
                <div class="relative">
                  <button id="btnConcluir" class="btn px-3 py-2 text-sm text-white disabled:opacity-50"
                    style="background:var(--accent)" disabled aria-haspopup="true"
                    aria-expanded="false">Concluir</button>
                  <div id="menuConcluir"
                    class="hidden absolute right-0 mt-2 w-64 bg-white border rounded-lg shadow-lg z-20"></div>
                </div>
                <button id="btnTheme" class="btn btn-ghost px-3 py-2 text-sm" type="button">üé® Tema</button>
              </div>
            </div>

            <div class="relative flex-1 overflow-hidden">
              <div id="chat" class="relative h-full p-4 overflow-y-auto flex flex-col space-y-1" role="log"
                aria-live="polite">
                <p id="logInfo" class="text-sm text-gray-400">Nenhum ticket selecionado.</p>
              </div>
              <div class="chat-wallpaper"></div>
            </div>

            <form id="formMensagem" class="border-t bg-white/90 backdrop-blur-sm p-3 flex items-end gap-2"
              autocomplete="off">
              <div class="flex-1">
                <label for="mensagem" class="label">Mensagem</label>
                <textarea id="mensagem" class="input input-area" rows="2" placeholder="Digite sua mensagem..."
                  autocomplete="off"></textarea>
              </div>
              <div class="flex flex-col gap-2">
                <button id="btnEnviar" type="submit"
                  class="btn btn-primary px-4 py-2 disabled:opacity-50 flex items-center gap-2" disabled>
                  <span>Enviar</span>
                </button>
                <button id="btnMacros" type="button" class="btn btn-ghost px-3 py-2 text-xs">Ver macros</button>
              </div>
            </form>
          </main>

          <!-- Coluna direita - Detalhes -->
          <aside class="sidebar w-1/3 lg:w-1/4 border-l flex flex-col">
            <div class="p-3 border-b topbar small">
              <div class="topbar-inner">
                <div>
                  <div class="topbar-title">Contato</div>
                  <div id="detNome" class="font-medium text-sm truncate">‚Äî</div>
                  <div id="detTelefone" class="text-xs text-muted truncate">‚Äî</div>
                </div>
                <div class="topbar-actions">
                  <div class="assist-pill">
                    <span class="badge-dot" style="background:#22c55e;width:6px;height:6px;border-radius:999px"></span>
                    <span class="fs-xs">Ativo</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="flex-1 overflow-y-auto scrollbar-thin">
              <div class="p-3 space-y-3">
                <div>
                  <div class="label">Origem</div>
                  <div id="detOrigem" class="fs-sm">‚Äî</div>
                </div>
                <div>
                  <div class="label">Primeiro contato</div>
                  <div id="detPrimeiro" class="fs-sm">‚Äî</div>
                </div>
                <div>
                  <div class="label">√öltima intera√ß√£o</div>
                  <div id="detUltimo" class="fs-sm">‚Äî</div>
                </div>
                <div>
                  <div class="label">Notas internas</div>
                  <textarea id="detNotas" class="input input-area" rows="3"
                    placeholder="Anota√ß√µes deste atendimento"></textarea>
                </div>
              </div>
            </div>
          </aside>
        </section>

        <!-- RELAT√ìRIO -->
        <section id="tabRelatorio" class="hidden flex-1 p-6">
          <div class="max-w-5xl mx-auto space-y-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-xl font-semibold">Resumo do seu dia</h2>
                <p class="text-sm text-gray-500">Acompanhe seus indicadores de atendimento.</p>
              </div>
              <button id="btnRefreshRel" class="btn btn-ghost px-3 py-2 text-sm flex items-center gap-2">
                <span class="spinner" id="spinnerRel" style="display:none"></span>
                <span>Atualizar</span>
              </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div class="card p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-gray-500 uppercase tracking-wide">Atendimentos conclu√≠dos</div>
                  <span class="badge-kpi">Hoje</span>
                </div>
                <div class="kpi-number" id="kpiConcluidos">‚Äî</div>
                <div class="text-xs text-muted">Total de tickets que voc√™ finalizou.</div>
              </div>
              <div class="card p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-gray-500 uppercase tracking-wide">Tempo m√©dio de atendimento</div>
                  <span class="badge-kpi">Hoje</span>
                </div>
                <div class="kpi-number" id="kpiTma">‚Äî</div>
                <div class="text-xs text-muted">Do primeiro contato at√© a conclus√£o.</div>
              </div>
              <div class="card p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-gray-500 uppercase tracking-wide">Avalia√ß√£o m√©dia</div>
                  <span class="badge-kpi">Hoje</span>
                </div>
                <div class="kpi-number" id="kpiAvaliacao">‚Äî</div>
                <div class="text-xs text-muted">Baseado no feedback dos clientes.</div>
              </div>
            </div>

            <div class="card p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="text-sm font-medium">Fila de tickets</div>
                <div class="text-xs text-muted">Vis√£o geral por status</div>
              </div>
              <div id="relatorioLista" class="text-sm text-muted">Nenhum dado carregado.</div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Theme Drawer -->
  <div id="themeDrawer" class="drawer" aria-hidden="true">
    <div class="h-full flex flex-col">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 class="font-semibold">üé® Seu tema</h3>
        <div class="flex items-center gap-2">
          <button id="btnThemeExport" class="btn btn-ghost px-2 py-1 text-xs">Salvar no meu computador</button>
          <label class="btn btn-ghost px-2 py-1 text-xs cursor-pointer">Importar um tema salvo <input id="importTheme"
              type="file" accept="application/json" class="hidden"></label>
          <button id="btnThemeClose" class="btn btn-ghost px-2 py-1 text-xs" aria-label="Fechar">‚úñ</button>
        </div>
      </div>

      <div class="p-4 overflow-y-auto space-y-6">
        <!-- Temas r√°pidos -->
        <section>
          <div class="text-xs text-gray-500 mb-2">Temas r√°pidos</div>
          <div class="grid grid-cols-2 gap-2">
            <div class="preset" data-preset="corporate">
              <div class="h-8 rounded" style="background:linear-gradient(90deg,#0ea5e9,#2563eb)"></div>
              <div class="mt-1 text-xs">Corporate</div>
            </div>
            <div class="preset" data-preset="ocean">
              <div class="h-8 rounded" style="background:linear-gradient(90deg,#06b6d4,#10b981)"></div>
              <div class="mt-1 text-xs">Ocean</div>
            </div>
            <div class="preset" data-preset="sunset">
              <div class="h-8 rounded" style="background:linear-gradient(90deg,#fb923c,#ef4444)"></div>
              <div class="mt-1 text-xs">Sunset</div>
            </div>
            <div class="preset" data-preset="terminal">
              <div class="h-8 rounded" style="background:linear-gradient(90deg,#020617,#22c55e)"></div>
              <div class="mt-1 text-xs">Terminal</div>
            </div>
          </div>
        </section>

        <!-- Cores principais -->
        <section>
          <div class="text-xs text-gray-500 mb-2">Cores principais</div>
          <div class="grid grid-cols-2 gap-3 text-xs">
            <label class="space-y-1">
              <span class="block">Prim√°ria</span>
              <input id="tPrimary" type="color" class="w-full h-8 rounded border border-gray-200">
            </label>
            <label class="space-y-1">
              <span class="block">Destaque</span>
              <input id="tAccent" type="color" class="w-full h-8 rounded border border-gray-200">
            </label>
            <label class="space-y-1">
              <span class="block">Sidebar</span>
              <input id="tSidebar" type="color" class="w-full h-8 rounded border border-gray-200">
            </label>
            <label class="space-y-1">
              <span class="block">Fundo do conte√∫do</span>
              <input id="tContentBg" type="color" class="w-full h-8 rounded border border-gray-200">
            </label>
            <label class="space-y-1">
              <span class="block">Fundo geral</span>
              <input id="tBg" type="color" class="w-full h-8 rounded border border-gray-200">
            </label>
            <label class="space-y-1">
              <span class="block">Texto</span>
              <input id="tText" type="color" class="w-full h-8 rounded border border-gray-200">
            </label>
          </div>
        </section>

        <!-- Bal√µes -->
        <section>
          <div class="text-xs text-gray-500 mb-2">Bal√µes de conversa</div>
          <div class="grid grid-cols-2 gap-3 text-xs">
            <label class="space-y-1">
              <span class="block">Sa√≠da - gradiente 1</span>
              <input id="tOutG1" type="color" class="w-full h-8 rounded border border-gray-200">
            </label>
            <label class="space-y-1">
              <span class="block">Sa√≠da - gradiente 2</span>
              <input id="tOutG2" type="color" class="w-full h-8 rounded border border-gray-200">
            </label>
            <label class="space-y-1">
              <span class="block">Entrada - fundo</span>
              <input id="tInBg" type="color" class="w-full h-8 rounded border border-gray-200">
            </label>
            <label class="space-y-1">
              <span class="block">Entrada - borda</span>
              <input id="tInBorder" type="color" class="w-full h-8 rounded border border-gray-200">
            </label>
          </div>
        </section>

        <!-- Ajustes finos -->
        <section>
          <div class="text-xs text-gray-500 mb-2">Ajustes finos</div>
          <div class="grid grid-cols-2 gap-3 text-xs">
            <label class="space-y-1">
              <span class="block">Raio dos bal√µes</span>
              <input id="tRadius" type="range" min="10" max="28" class="w-full">
            </label>
            <label class="space-y-1">
              <span class="block">Raio dos bot√µes</span>
              <input id="tBtnRadius" type="range" min="6" max="16" class="w-full">
            </label>
            <label class="space-y-1">
              <span class="block">Raio dos cards</span>
              <input id="tCardRadius" type="range" min="8" max="22" class="w-full">
            </label>
            <label class="space-y-1">
              <span class="block">Opacidade do papel de parede</span>
              <input id="tBgOp" type="range" min="0" max="0.35" step="0.01" class="w-full">
            </label>
            <label class="space-y-1">
              <span class="block">Tamanho da fonte</span>
              <select id="tFontSize" class="w-full border border-gray-200 rounded px-2 py-1">
                <option value="13px">Pequena</option>
                <option value="14px">Padr√£o</option>
                <option value="15px">M√©dia</option>
                <option value="16px">Grande</option>
              </select>
            </label>
          </div>
        </section>

        <!-- A√ß√µes -->
        <section class="pt-2 border-t">
          <div class="flex justify-between items-center gap-2">
            <button id="btnReset" class="btn btn-ghost px-3 py-2 text-xs">Voltar ao padr√£o</button>
            <div class="flex gap-2">
              <button id="btnRandom" class="btn btn-ghost px-3 py-2 text-xs">Surpreenda-me üé≤</button>
              <button id="btnSaveTheme" class="btn btn-primary px-3 py-2 text-xs">Salvar tema</button>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Modal de Login -->
  <div id="loginModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="loginTitulo">
      <h2 id="loginTitulo" class="modal-title">Entrar no painel</h2>
      <p class="text-sm text-gray-600 mb-3">Informe o c√≥digo do agente para iniciar os atendimentos.</p>
      <div class="space-y-2">
        <label class="block text-sm">
          <span class="block text-xs text-gray-500 mb-1">C√≥digo do agente</span>
          <input id="loginCodigoAgente" type="text" inputmode="numeric" pattern="\d*" autocomplete="off"
            class="input input-sm w-full" placeholder="Ex: 1234">
        </label>
        <label class="block text-sm">
          <span class="block text-xs text-gray-500 mb-1">Origem</span>
          <select id="loginOrigem" class="input input-sm w-full">
            <option value="web">Web</option>
            <option value="app">App</option>
          </select>
        </label>
        <div id="loginErro" class="text-xs text-red-600 mt-1 hidden"></div>
      </div>
      <div class="modal-footer">
        <button id="btnCancelarLogin" type="button" class="btn btn-ghost px-3 py-2 text-sm">Cancelar</button>
        <button id="btnDoLogin" type="button" class="btn btn-primary px-3 py-2 text-sm">Entrar</button>
      </div>
    </div>
  </div>

  <script>
    const CONV_API = "https://conversaozx.com.br";
    const agente = { codigo: null, origem: null };
    let tickets = [];
    let selecionado = null;
    let ativosCount = 0;
    let limiteAtivos = 4;
    let unreadCountByKey = {};
    let lastContatoTsByKey = {};

    const elHomeNome = document.getElementById("homeAgenteNome");
    const elHomeCart = document.getElementById("homeAgenteCarteira");
    const headerAgente = document.getElementById("headerAgente");
    const headerCarteira = document.getElementById("headerCarteira");
    const sidebarAgente = document.getElementById("sidebarAgente");
    const sidebarCarteira = document.getElementById("sidebarCarteira");
    const sidebarAtivos = document.getElementById("sidebarAtivos");
    const sidebarLimite = document.getElementById("sidebarLimite");
    const elHomeStatus = document.getElementById("homeStatus");
    const pillStatusDot = document.getElementById("pillStatusDot");
    const pillStatusLabel = document.getElementById("pillStatusLabel");
    const homeAviso = document.getElementById("homeAviso");
    const btnToggleOnline = document.getElementById("btnToggleOnline");
    const toggleSpinner = document.getElementById("toggleSpinner");
    const toggleLabel = document.getElementById("toggleLabel");
    const btnLogout = document.getElementById("btnLogout");
    const tabBtnHome = document.getElementById("tabBtnHome");
    const tabBtnConversas = document.getElementById("tabBtnConversas");
    const tabBtnRelatorio = document.getElementById("tabBtnRelatorio");
    const tabBadgeConversas = document.getElementById("tabBadgeConversas");
    const tabHome = document.getElementById("tabHome");
    const tabConversas = document.getElementById("tabConversas");
    const tabRelatorio = document.getElementById("tabRelatorio");
    const goToConversas1 = document.getElementById("goToConversas1");
    const goToRelatorio1 = document.getElementById("goToRelatorio1");
    const ticketsContainer = document.getElementById("ticketsContainer");
    const buscaTickets = document.getElementById("buscaTickets");
    const logInfo = document.getElementById("logInfo");
    const chat = document.getElementById("chat");
    const tituloConversa = document.getElementById("tituloConversa");
    const subInfo = document.getElementById("subInfo");
    const btnEnviar = document.getElementById("btnEnviar");
    const btnLiberar = document.getElementById("btnLiberar");
    const btnConcluir = document.getElementById("btnConcluir");
    const menuConcluir = document.getElementById("menuConcluir");
    const btnMacros = document.getElementById("btnMacros");
    const formMensagem = document.getElementById("formMensagem");
    const mensagemInput = document.getElementById("mensagem");
    const detNome = document.getElementById("detNome");
    const detTelefone = document.getElementById("detTelefone");
    const detOrigem = document.getElementById("detOrigem");
    const detPrimeiro = document.getElementById("detPrimeiro");
    const detUltimo = document.getElementById("detUltimo");
    const detNotas = document.getElementById("detNotas");
    const kpiConcluidos = document.getElementById("kpiConcluidos");
    const kpiTma = document.getElementById("kpiTma");
    const kpiAvaliacao = document.getElementById("kpiAvaliacao");
    const relatorioLista = document.getElementById("relatorioLista");
    const btnRefreshRel = document.getElementById("btnRefreshRel");
    const spinnerRel = document.getElementById("spinnerRel");
    const filterTodos = document.getElementById("filterTodos");
    const filterMeus = document.getElementById("filterMeus");
    const slaMedio = document.getElementById("slaMedio");
    const headerAtivosCount = document.getElementById("ativosCount");
    const headerLimiteAtivos = document.getElementById("limiteAtivos");
    const headerFilaCount = document.getElementById("filaCount");

    function keyFrom(remetente, phoneId) {
      return `${remetente}:${phoneId}`;
    }

    function persistUnread() {
      try {
        localStorage.setItem("cz:unread", JSON.stringify(unreadCountByKey));
        localStorage.setItem("cz:lastContato", JSON.stringify(lastContatoTsByKey));
      } catch (e) { }
    }

    function restoreUnread() {
      try {
        const unread = JSON.parse(localStorage.getItem("cz:unread") || "{}");
        const last = JSON.parse(localStorage.getItem("cz:lastContato") || "{}");
        unreadCountByKey = unread || {};
        lastContatoTsByKey = last || {};
      } catch (e) {
        unreadCountByKey = {};
        lastContatoTsByKey = {};
      }
    }

    function saveTickets() {
      try {
        localStorage.setItem(`cz:tickets:${agente.codigo || "anon"}`, JSON.stringify(tickets));
      } catch (e) { }
    }

    function loadTicketsFromStorage() {
      try {
        const raw = localStorage.getItem(`cz:tickets:${agente.codigo || "anon"}`);
        if (!raw) return [];
        return JSON.parse(raw) || [];
      } catch (e) {
        return [];
      }
    }

    function renderAtivosLimiteUI() {
      sidebarAtivos.textContent = ativosCount;
      sidebarLimite.textContent = limiteAtivos;
      headerAtivosCount.textContent = ativosCount;
      headerLimiteAtivos.textContent = limiteAtivos;
      headerFilaCount.textContent = tickets.filter(t => t.status === "fila").length;
    }

    function renderTickets() {
      ticketsContainer.innerHTML = "";
      let filtro = "todos";
      if (filterMeus.classList.contains("active")) filtro = "meus";
      const busca = (buscaTickets.value || "").trim().toLowerCase();
      const list = tickets.filter(t => {
        if (filtro === "meus" && !t.meu) return false;
        if (busca) {
          const nome = (t.nome || "").toLowerCase();
          const numero = (t.remetente || "").toLowerCase();
          if (!nome.includes(busca) && !numero.includes(busca)) return false;
        }
        return true;
      });
      if (!list.length) {
        ticketsContainer.innerHTML = '<div class="p-3 text-xs text-muted">Nenhum ticket para exibir.</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      for (const t of list) {
        const k = keyFrom(t.remetente, t.phone_id);
        const unread = unreadCountByKey[k] || 0;
        const li = document.createElement("div");
        li.className = "ticket";
        li.dataset.remetente = t.remetente;
        li.dataset.phoneId = t.phone_id;
        const nome = t.nome || t.remetente;
        const ultimoTs = lastContatoTsByKey[k] ? new Date(lastContatoTsByKey[k]) : null;
        const hora = ultimoTs ? ultimoTs.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" }) : "";
        li.innerHTML = `
          <div class="ticket-header">
            <div class="ticket-name">${nome}</div>
            <div class="ticket-meta">
              ${t.origem ? `<span>${t.origem}</span>` : ""}
              ${hora ? `<span>${hora}</span>` : ""}
            </div>
          </div>
          <div class="ticket-body">
            <span class="truncate text-xs text-muted">${t.preview || ""}</span>
            <div class="flex items-center gap-1">
              ${unread > 0 ? `<span class="ticket-unread-count">${unread}</span>` : ""}
            </div>
          </div>
        `;
        if (selecionado && selecionado.remetente === t.remetente && selecionado.phone_id === t.phone_id) {
          li.classList.add("selected");
        }
        li.addEventListener("click", () => {
          selecionarTicket(t.remetente, t.phone_id);
        });
        frag.appendChild(li);
      }
      ticketsContainer.appendChild(frag);
      const totalConversas = tickets.length;
      tabBadgeConversas.textContent = totalConversas;
    }

    function selecionarTicket(remetente, phone_id) {
      const idxTicket = tickets.findIndex(t => t.remetente === remetente && t.phone_id === phone_id);
      if (idxTicket === -1) return;
      selecionado = tickets[idxTicket];
      document.querySelectorAll(".ticket.selected").forEach(el => el.classList.remove("selected"));
      const el = ticketsContainer.querySelector(
        `.ticket[data-remetente="${remetente}"][data-phone-id="${phone_id}"]`
      );
      if (el) el.classList.add("selected");
      const k = keyFrom(remetente, phone_id);
      unreadCountByKey[k] = 0;
      persistUnread();
      renderTickets();
      carregarChatAtual();
      atualizarDetalhesContato();
    }

    function limparChat() {
      chat.innerHTML = '<p id="logInfo" class="text-sm text-gray-400">Nenhum ticket selecionado.</p>';
    }

    function atualizarDetalhesContato() {
      if (!selecionado) {
        detNome.textContent = "‚Äî";
        detTelefone.textContent = "‚Äî";
        detOrigem.textContent = "‚Äî";
        detPrimeiro.textContent = "‚Äî";
        detUltimo.textContent = "‚Äî";
        detNotas.value = "";
        return;
      }
      detNome.textContent = selecionado.nome || selecionado.remetente;
      detTelefone.textContent = selecionado.remetente;
      detOrigem.textContent = selecionado.origem || "‚Äî";
      detPrimeiro.textContent = selecionado.primeiro_contato || "‚Äî";
      detUltimo.textContent = selecionado.ultimo_contato || "‚Äî";
      detNotas.value = selecionado.notas || "";
    }

    async function carregarChatAtual() {
      if (!selecionado) {
        limparChat();
        return;
      }
      tituloConversa.textContent = selecionado.nome || selecionado.remetente;
      subInfo.textContent = `${selecionado.remetente} ‚Ä¢ ${selecionado.origem || ""}`.trim();
      logInfo.textContent = "Carregando mensagens...";
      try {
        const resp = await fetch(`${CONV_API}/api/tickets/${selecionado.remetente}/${selecionado.phone_id}/mensagens`);
        if (!resp.ok) throw new Error("Erro ao buscar mensagens");
        const dados = await resp.json();
        chat.innerHTML = "";
        const frag = document.createDocumentFragment();
        (dados.mensagens || []).forEach(msg => {
          const div = document.createElement("div");
          div.className = "msg " + (msg.direcao === "OUT" ? "enviada" : "recebida");
          const hora = msg.criado_em ? new Date(msg.criado_em).toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" }) : "";
          div.innerHTML = `
            <div>${msg.texto || ""}</div>
            <small>${hora}</small>
            <div class="msg-tail"></div>
          `;
          frag.appendChild(div);
        });
        chat.appendChild(frag);
        chat.scrollTop = chat.scrollHeight;
        btnEnviar.disabled = false;
        btnLiberar.disabled = false;
        btnConcluir.disabled = false;
      } catch (e) {
        logInfo.textContent = "Erro ao carregar mensagens.";
      }
    }

    function keyTickets() {
      return `cz:tickets:${agente.codigo || "anon"}`;
    }

    function loadStateAtivos() {
      try {
        const raw = localStorage.getItem(`cz:ativos:${agente.codigo || "anon"}`);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        return null;
      }
    }

    function saveStateAtivos(data) {
      try {
        localStorage.setItem(`cz:ativos:${agente.codigo || "anon"}`, JSON.stringify(data));
      } catch (e) { }
    }

    async function toggleOnline(flag) {
      if (!agente.codigo) {
        abrirModalLogin();
        return;
      }
      btnToggleOnline.disabled = true;
      toggleSpinner.classList.remove("hidden");
      try {
        const url = flag ? `${CONV_API}/api/agentes/${agente.codigo}/online` : `${CONV_API}/api/agentes/${agente.codigo}/offline`;
        const resp = await fetch(url, { method: "POST" });
        if (!resp.ok) throw new Error("Erro ao alterar status");
        const dados = await resp.json();
        if (!dados.ok) throw new Error(dados.erro || "Erro ao alterar status");
        setStatus(flag);
      } catch (e) {
        homeAviso.textContent = "N√£o foi poss√≠vel alterar seu status. Tente novamente.";
        homeAviso.classList.remove("hidden");
      } finally {
        btnToggleOnline.disabled = false;
        toggleSpinner.classList.add("hidden");
      }
    }

    function setStatus(online) {
      const antes = btnToggleOnline.getAttribute("aria-pressed") === "true";
      if (online) {
        elHomeStatus.innerHTML = '<span class="dot online"></span>Online';
        pillStatusDot.classList.add("bg-green-500");
        pillStatusDot.classList.remove("bg-red-500");
        pillStatusLabel.textContent = "Online";
        toggleLabel.textContent = "Ficar offline";
        btnToggleOnline.setAttribute("aria-pressed", "true");
      } else {
        elHomeStatus.innerHTML = '<span class="dot offline"></span>Offline';
        pillStatusDot.classList.remove("bg-green-500");
        pillStatusDot.classList.add("bg-red-500");
        pillStatusLabel.textContent = "Offline";
        toggleLabel.textContent = "Ficar online";
        btnToggleOnline.setAttribute("aria-pressed", "false");
      }
      if (antes !== online) {
        try {
          localStorage.setItem(`cz:online:${agente.codigo || "anon"}`, JSON.stringify(online));
        } catch (e) { }
      }
    }

    function qsParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || null;
    }

    async function carregarTickets() {
      if (!agente.codigo) return;
      try {
        const resp = await fetch(`${CONV_API}/api/tickets?codigo_do_agente=${agente.codigo}`);
        if (!resp.ok) throw new Error("Erro ao buscar tickets");
        const dados = await resp.json();
        tickets = dados.tickets || [];
        ativosCount = tickets.filter(t => t.meu).length;
        limiteAtivos = dados.limite_ativos || 4;
        renderAtivosLimiteUI();
        saveTickets();
        renderTickets();
      } catch (e) {
        console.error("Erro ao carregar tickets:", e);
      }
    }

    async function enviarMensagem() {
      if (!selecionado) return;
      const texto = (mensagemInput.value || "").trim();
      if (!texto) return;
      btnEnviar.disabled = true;
      try {
        const body = {
          codigo_do_agente: parseInt(agente.codigo || "0", 10),
          remetente: selecionado.remetente,
          phone_id: selecionado.phone_id,
          mensagem: texto
        };
        const resp = await fetch(`${CONV_API}/api/mensagens/enviar`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const dados = await resp.json();
        if (!resp.ok || !dados.ok) {
          alert(dados.erro || "Erro ao enviar mensagem.");
          return;
        }
        mensagemInput.value = "";
        await carregarChatAtual();
      } catch (e) {
        alert("Erro ao enviar mensagem.");
      } finally {
        btnEnviar.disabled = false;
      }
    }

    function switchTab(tab) {
      tabHome.classList.add("hidden");
      tabConversas.classList.add("hidden");
      tabRelatorio.classList.add("hidden");
      tabBtnHome.classList.remove("tab-active");
      tabBtnConversas.classList.remove("tab-active");
      tabBtnRelatorio.classList.remove("tab-active");
      if (tab === "home") {
        tabHome.classList.remove("hidden");
        tabBtnHome.classList.add("tab-active");
      } else if (tab === "conversas") {
        tabConversas.classList.remove("hidden");
        tabBtnConversas.classList.add("tab-active");
      } else if (tab === "relatorio") {
        tabRelatorio.classList.remove("hidden");
        tabBtnRelatorio.classList.add("tab-active");
      }
    }

    filterTodos.addEventListener("click", () => {
      filterTodos.classList.add("active");
      filterMeus.classList.remove("active");
      renderTickets();
    });

    filterMeus.addEventListener("click", () => {
      filterMeus.classList.add("active");
      filterTodos.classList.remove("active");
      renderTickets();
    });

    buscaTickets.addEventListener("input", () => {
      renderTickets();
    });

    btnToggleOnline.addEventListener("click", () => {
      const current = btnToggleOnline.getAttribute("aria-pressed") === "true";
      toggleOnline(!current);
    });

    btnLogout.addEventListener("click", () => {
      try {
        localStorage.removeItem("agente_codigo");
        localStorage.removeItem("agente_origem");
      } catch (e) { }
      agente.codigo = null;
      agente.origem = null;
      updateAuthButton();
      switchTab("home");
      abrirModalLogin();
    });

    goToConversas1.addEventListener("click", () => switchTab("conversas"));
    goToRelatorio1.addEventListener("click", () => switchTab("relatorio"));
    tabBtnHome.addEventListener("click", () => switchTab("home"));
    tabBtnConversas.addEventListener("click", () => switchTab("conversas"));
    tabBtnRelatorio.addEventListener("click", () => switchTab("relatorio"));

    formMensagem.addEventListener("submit", (e) => {
      e.preventDefault();
      enviarMensagem();
    });

    btnMacros.addEventListener("click", () => {
      alert("Em breve: sele√ß√£o de respostas r√°pidas.");
    });

    window.addEventListener("beforeunload", () => {
      saveTickets();
    });

    let pollInterval = null;
    function clearPoll() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }

    async function pollTickets() {
      if (!agente.codigo) return;
      try {
        const resp = await fetch(`${CONV_API}/api/tickets/novos?codigo_do_agente=${agente.codigo}`);
        if (!resp.ok) return;
        const dados = await resp.json();
        if (!dados.ok) return;
        const novos = dados.novos || [];
        let houveMudanca = false;
        for (const tNovo of novos) {
          const idx = tickets.findIndex(
            (t) => t.remetente === tNovo.remetente && t.phone_id === tNovo.phone_id
          );
          if (idx === -1) {
            tickets.push(tNovo);
            houveMudanca = true;
          } else {
            tickets[idx] = { ...tickets[idx], ...tNovo };
            houveMudanca = true;
          }
          const k = keyFrom(tNovo.remetente, tNovo.phone_id);
          unreadCountByKey[k] = (unreadCountByKey[k] || 0) + (tNovo.novas_mensagens || 0);
          if (tNovo.ultimo_contato) {
            lastContatoTsByKey[k] = tNovo.ultimo_contato;
          }
        }
        if (houveMudanca) {
          ativosCount = tickets.filter((t) => t.meu).length;
          limiteAtivos = dados.limite_ativos || limiteAtivos;
          renderAtivosLimiteUI();
          saveTickets();
          persistUnread();
          renderTickets();
          if (selecionado) {
            const idxSel = tickets.findIndex(
              (t) => t.remetente === selecionado.remetente && t.phone_id === selecionado.phone_id
            );
            if (idxSel === -1) {
              selecionado = null;
              limparChat();
              tituloConversa.textContent = "Selecione um ticket";
              subInfo.textContent = "";
              btnLiberar.disabled = true;
              btnConcluir.disabled = true;
            } else {
              carregarChatAtual();
            }
          }
        }
      } catch (e) { }
    }

    function schedulePolls() {
      clearPoll();
      if (!agente.codigo) return;
      pollTickets();
      pollInterval = setInterval(pollTickets, 4000);
    }

    document.addEventListener("visibilitychange", schedulePolls);

    /** =================== LIBERAR / CONCLUIR / LOGOUT =================== */
    btnLiberar.onclick = async () => {
      if (!selecionado) return;
      try {
        const r = await fetch(`${CONV_API}/api/tickets/liberar`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            codigo_do_agente: parseInt(agente.codigo || '0', 10),
            remetente: selecionado.remetente,
            phone_id: selecionado.phone_id
          })
        });
        const j = await r.json();
        if (!r.ok || !j.ok) {
          alert(j.erro || "N√£o foi poss√≠vel liberar.");
          return;
        }
        const k = keyFrom(selecionado.remetente, selecionado.phone_id);
        delete unreadCountByKey[k];
        delete lastContatoTsByKey[k];
        persistUnread();

        tickets = tickets.filter(
          (t) => !(t.remetente === selecionado.remetente && t.phone_id === selecionado.phone_id)
        );
        saveTickets();
        renderTickets();
        limparChat();
        tituloConversa.textContent = "Selecione um ticket";
        subInfo.textContent = "";
        btnLiberar.disabled = true;
        btnConcluir.disabled = true;
        fecharMenuConcluir();
        if (ativosCount > 0) ativosCount--;
        renderAtivosLimiteUI();
      } catch (e) {
        alert("Erro ao liberar.");
      }
    };

    async function concluirAtendimento(motivo) {
      if (!selecionado) return;
      try {
        btnConcluir.disabled = true;
        const r = await fetch(`${CONV_API}/api/tickets/concluir`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            codigo_do_agente: parseInt(agente.codigo || '0', 10),
            remetente: selecionado.remetente,
            phone_id: selecionado.phone_id,
            motivo
          })
        });
        const j = await r.json();
        if (!r.ok || !j.ok) {
          alert(j.erro || "N√£o foi poss√≠vel concluir.");
          btnConcluir.disabled = false;
          return;
        }
        const k = keyFrom(selecionado.remetente, selecionado.phone_id);
        delete unreadCountByKey[k];
        delete lastContatoTsByKey[k];
        persistUnread();

        tickets = tickets.filter(
          (t) => !(t.remetente === selecionado.remetente && t.phone_id === selecionado.phone_id)
        );
        saveTickets();
        renderTickets();
        limparChat();
        tituloConversa.textContent = "Selecione um ticket";
        subInfo.textContent = "";
        btnLiberar.disabled = true;
        btnConcluir.disabled = true;
        selecionado = null;
        if (ativosCount > 0) ativosCount--;
        renderAtivosLimiteUI();
      } catch (e) {
        alert("Erro ao concluir.");
        btnConcluir.disabled = false;
      }
    }

    function renderMenuConcluir() {
      menuConcluir.innerHTML = `
        <div class="py-1">
          <button data-motivo="resolvido" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100">Resolvido</button>
          <button data-motivo="transferido" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100">Transferido</button>
          <button data-motivo="cliente_nao_responde" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100">Cliente n√£o responde</button>
          <button data-motivo="outro" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100">Outro</button>
        </div>
      `;
      menuConcluir.querySelectorAll("button[data-motivo]").forEach(btn => {
        btn.addEventListener("click", () => {
          const motivo = btn.getAttribute("data-motivo");
          concluirAtendimento(motivo);
          fecharMenuConcluir();
        });
      });
    }

    function abrirMenuConcluir() {
      menuConcluir.classList.remove("hidden");
      document.addEventListener("click", clickForaMenuConcluir);
    }

    function fecharMenuConcluir() {
      menuConcluir.classList.add("hidden");
      document.removeEventListener("click", clickForaMenuConcluir);
    }

    function clickForaMenuConcluir(e) {
      const within = menuConcluir.contains(e.target) || btnConcluir.contains(e.target);
      if (!within) fecharMenuConcluir();
    }
    btnConcluir.onclick = () => { menuConcluir.classList.contains("hidden") ? abrirMenuConcluir() : fecharMenuConcluir(); };
    renderMenuConcluir();

    /** =================== THEME =================== */
    function themeKey() { return `cz:theme:${agente.codigo || 'anon'}`; }
    function defaultTheme() {
      return {
        primary: "#3b82f6", accent: "#22c55e",
        sidebar: "#ffffff", contentBg: "#ffffff", bg: "#f3f4f6", text: "#0f172a",
        muted: "#6b7280", border: "#e5e7eb", link: "#2563eb", ghostBg: "#f3f4f6",
        outG1: "#dcf8c6", outG2: "#b8f0a4", outFg: "#111827",
        inBg: "#ffffff", inBorder: "#e2e8f0", inFg: "#0f172a",
        bubbleRadius: 18, btnRadius: 10, cardRadius: 16,
        wallOp: 0, fontSize: "14px",
        ticketSelectedBg: "#f0f9ff"
      };
    }
    function applyTheme(t) {
      const r = document.documentElement.style;
      const base = defaultTheme();
      const x = { ...base, ...t };
      r.setProperty('--ticket-selected-bg', x.ticketSelectedBg);
      r.setProperty('--sidebar-bg', x.sidebar); r.setProperty('--content-bg', x.contentBg);
      r.setProperty('--bg', x.bg); r.setProperty('--text', x.text);
      r.setProperty('--muted', x.muted); r.setProperty('--border', x.border);
      r.setProperty('--link', x.link); r.setProperty('--ghost-bg', x.ghostBg);
      r.setProperty('--bubble-out-g1', x.outG1); r.setProperty('--bubble-out-g2', x.outG2);
      r.setProperty('--bubble-out-fg', x.outFg || '#111827');
      r.setProperty('--bubble-in-bg', x.inBg); r.setProperty('--bubble-in-border', x.inBorder);
      r.setProperty('--bubble-in-fg', x.inFg || '#0f172a');
      r.setProperty('--bubble-radius', x.bubbleRadius + 'px');
      r.setProperty('--btn-radius', x.btnRadius + 'px');
      r.setProperty('--card-radius', x.cardRadius + 'px');
      r.setProperty('--font-size', x.fontSize);
      r.setProperty('--chat-wallpaper-opacity', x.wallOp);
      r.setProperty('--scrollbar', x.scrollbar || '#cbd5e1');
      r.setProperty('--hover', x.hover || 'var(--ghost-bg)');
      r.setProperty('--hover-strong', x.hoverStrong || 'var(--ghost-bg)');
      r.setProperty('--input-bg', x.inputBg || x.contentBg || '#ffffff');
      r.setProperty('--input-fg', x.inputFg || x.text || '#0f172a');
      r.setProperty('--primary', x.primary);
      r.setProperty('--accent', x.accent);

      inputs.tPrimary.value = x.primary;
      inputs.tAccent.value = x.accent;
      inputs.tSidebar.value = x.sidebar;
      inputs.tContentBg.value = x.contentBg;
      inputs.tBg.value = x.bg;
      inputs.tText.value = x.text;
      inputs.tOutG1.value = x.outG1;
      inputs.tOutG2.value = x.outG2;
      inputs.tInBg.value = x.inBg;
      inputs.tInBorder.value = x.inBorder;
      inputs.tRadius.value = x.bubbleRadius;
      inputs.tBgOp.value = x.wallOp;
      inputs.tFontSize.value = x.fontSize;
      inputs.tBtnRadius.value = x.btnRadius;
      inputs.tCardRadius.value = x.cardRadius;
    }
    function readThemeFromInputs() {
      return {
        primary: inputs.tPrimary.value,
        accent: inputs.tAccent.value,
        sidebar: inputs.tSidebar.value,
        contentBg: inputs.tContentBg.value,
        bg: inputs.tBg.value,
        text: inputs.tText.value,
        outG1: inputs.tOutG1.value,
        outG2: inputs.tOutG2.value,
        inBg: inputs.tInBg.value,
        inBorder: inputs.tInBorder.value,
        bubbleRadius: Number(inputs.tRadius.value || 18),
        wallOp: Number(inputs.tBgOp.value || 0),
        fontSize: inputs.tFontSize.value || '14px',
        btnRadius: Number(inputs.tBtnRadius.value || 10),
        cardRadius: Number(inputs.tCardRadius.value || 16),
      };
    }
    function saveTheme(t) { try { localStorage.setItem(themeKey(), JSON.stringify(t)); } catch { } }
    function loadTheme() { try { return JSON.parse(localStorage.getItem(themeKey()) || 'null'); } catch { return null; } }

    // refs de Theme
    const themeDrawer = document.getElementById('themeDrawer');
    const btnTheme = document.getElementById('btnTheme');
    const btnThemeClose = document.getElementById('btnThemeClose');
    const btnSaveTheme = document.getElementById('btnSaveTheme');
    const btnRandom = document.getElementById('btnRandom');
    const btnReset = document.getElementById('btnReset');
    const btnThemeExport = document.getElementById('btnThemeExport');
    const importTheme = document.getElementById('importTheme');
    const inputs = {
      tPrimary: document.getElementById('tPrimary'), tAccent: document.getElementById('tAccent'),
      tSidebar: document.getElementById('tSidebar'), tContentBg: document.getElementById('tContentBg'),
      tBg: document.getElementById('tBg'), tText: document.getElementById('tText'),
      tOutG1: document.getElementById('tOutG1'), tOutG2: document.getElementById('tOutG2'),
      tInBg: document.getElementById('tInBg'), tInBorder: document.getElementById('tInBorder'),
      tRadius: document.getElementById('tRadius'), tBgOp: document.getElementById('tBgOp'),
      tFontSize: document.getElementById('tFontSize'), tBtnRadius: document.getElementById('tBtnRadius'),
      tCardRadius: document.getElementById('tCardRadius')
    };
    if (btnTheme) btnTheme.addEventListener('click', () => themeDrawer.classList.add('open'));
    if (btnThemeClose) btnThemeClose.addEventListener('click', () => themeDrawer.classList.remove('open'));
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && themeDrawer.classList.contains('open')) themeDrawer.classList.remove('open'); });
    [inputs.tPrimary, inputs.tAccent, inputs.tSidebar, inputs.tContentBg, inputs.tBg, inputs.tText,
    inputs.tOutG1, inputs.tOutG2, inputs.tInBg, inputs?.tInBorder, inputs.tRadius, inputs.tBgOp, inputs.tFontSize, inputs.tBtnRadius, inputs.tCardRadius]
      .filter(Boolean).forEach(i => i.addEventListener('input', () => applyTheme(readThemeFromInputs())));
    if (btnSaveTheme) btnSaveTheme.addEventListener('click', () => { const t = readThemeFromInputs(); applyTheme(t); saveTheme(t); themeDrawer.classList.remove('open'); });
    if (btnReset) btnReset.addEventListener('click', () => { const t = defaultTheme(); applyTheme(t); saveTheme(t); });
    if (btnRandom) btnRandom.addEventListener('click', () => {
      const b1 = '#' + Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0');
      const b2 = '#' + Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0');
      const t = {
        ...defaultTheme(),
        primary: '#' + Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0'),
        accent: '#' + Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0'),
        outG1: b1, outG2: b2,
        bg: '#f8fafc',
        wallOp: Math.random() > .5 ? .08 : 0,
        bubbleRadius: 14 + Math.floor(Math.random() * 12),
        btnRadius: 8 + Math.floor(Math.random() * 6),
        cardRadius: 14 + Math.floor(Math.random() * 8)
      };
      applyTheme(t);
    });

    /** =================== LOGIN MODAL =================== */
    function isLogged() {
      try { return !!localStorage.getItem('agente_codigo'); } catch { return false; }
    }
    function abrirModalLogin() {
      const m = document.getElementById('loginModal');
      m.classList.add('open');
      setTimeout(() => document.getElementById('loginCodigoAgente').focus(), 50);
      isModalOpen = true;
    }
    function fecharModalLogin() {
      const m = document.getElementById('loginModal');
      m.classList.remove('open');
      const e = document.getElementById('loginErro');
      e.textContent = '';
      e.classList.add('hidden');
      isModalOpen = false;
    }
    let isModalOpen = false;
    async function login() {
      const codigo = (document.getElementById('loginCodigoAgente').value || '').trim();
      const origemSel = document.getElementById('loginOrigem').value;
      const erro = document.getElementById('loginErro');
      if (!codigo || !/^\d+$/.test(codigo)) {
        erro.textContent = 'Informe um c√≥digo num√©rico v√°lido.';
        erro.classList.remove('hidden');
        return;
      }
      erro.textContent = '';
      erro.classList.add('hidden');
      try {
        const resp = await fetch(`${CONV_API}/api/agentes/${codigo}`);
        const dados = await resp.json();
        if (!resp.ok || !dados.ok) {
          erro.textContent = dados.erro || 'N√£o foi poss√≠vel localizar o agente.';
          erro.classList.remove('hidden');
          return;
        }
        agente.codigo = codigo;
        agente.origem = origemSel || 'web';
        try {
          localStorage.setItem('agente_codigo', codigo);
          localStorage.setItem('agente_origem', agente.origem);
        } catch (e) { }
        updateAuthButton();
        fecharModalLogin();
        await boot();
      } catch (e) {
        erro.textContent = 'Erro ao tentar fazer login. Tente novamente.';
        erro.classList.remove('hidden');
      }
    }

    document.getElementById('btnDoLogin').onclick = login;
    document.getElementById('btnCancelarLogin').onclick = fecharModalLogin;
    document.getElementById('loginCodigoAgente').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        login();
      }
    });

    /** =================== BOOT =================== */
    async function boot() {
      const savedT = loadTheme(); applyTheme(savedT || defaultTheme());

      agente.codigo = localStorage.getItem("agente_codigo") || qsParam("codigo") || null;
      agente.origem = localStorage.getItem("agente_origem") || qsParam("origem") || 'web';

      updateAuthButton();

      if (!agente.codigo) {
        elHomeNome.textContent = '‚Äî';
        elHomeCart.textContent = '‚Äî';
        setStatus(false);
        limparChat();
        tickets = [];
        ativosCount = 0;
        renderAtivosLimiteUI();
        renderTickets();
        return;
      }

      try {
        const resp = await fetch(`${CONV_API}/api/agentes/${agente.codigo}`);
        const dados = await resp.json();
        if (resp.ok && dados.ok) {
          const ag = dados.agente;
          elHomeNome.textContent = ag.nome || '‚Äî';
          elHomeCart.textContent = ag.carteira || '‚Äî';
          headerAgente.textContent = ag.nome || '‚Äî';
          headerCarteira.textContent = ag.carteira || '‚Äî';
          sidebarAgente.textContent = ag.nome || '‚Äî';
          sidebarCarteira.textContent = ag.carteira || '‚Äî';
          limiteAtivos = ag.limite_ativos || 4;
          renderAtivosLimiteUI();
        }
      } catch { }

      const storedOnline = (() => {
        try {
          const s = localStorage.getItem(`cz:online:${agente.codigo}`);
          if (!s) return null;
          return JSON.parse(s);
        } catch { return null; }
      })();
      if (storedOnline === true) {
        setStatus(true);
      } else {
        setStatus(false);
      }

      restoreUnread();
      tickets = loadTicketsFromStorage();
      renderAtivosLimiteUI();
      renderTickets();

      schedulePolls();
      await carregarTickets();
    }

    function updateAuthButton() {
      if (agente.codigo) {
        btnLogout.classList.remove("hidden");
      } else {
        btnLogout.classList.add("hidden");
      }
    }

    /** =================== Relat√≥rio =================== */
    async function refreshKPIs() {
      if (!agente.codigo) return;
      spinnerRel.style.display = "inline-block";
      try {
        const resp = await fetch(`${CONV_API}/api/agentes/${agente.codigo}/relatorio`);
        const dados = await resp.json();
        if (!resp.ok || !dados.ok) {
          relatorioLista.textContent = "N√£o foi poss√≠vel carregar o relat√≥rio.";
          return;
        }
        const r = dados.relatorio || {};
        kpiConcluidos.textContent = r.concluidos ?? "‚Äî";
        kpiTma.textContent = r.tma ?? "‚Äî";
        kpiAvaliacao.textContent = r.nota_media ?? "‚Äî";
        const linhas = [];
        (r.fila_por_status || []).forEach(item => {
          linhas.push(`<div class="flex items-center justify-between py-1 text-sm">
            <span>${item.status}</span>
            <span class="font-medium">${item.quantidade}</span>
          </div>`);
        });
        relatorioLista.innerHTML = linhas.join("") || "Nenhuma informa√ß√£o de fila dispon√≠vel.";
      } catch {
        relatorioLista.textContent = "Erro ao carregar o relat√≥rio.";
      } finally {
        spinnerRel.style.display = "none";
      }
    }

    if (btnRefreshRel) btnRefreshRel.onclick = refreshKPIs;

    /** =================== Navega√ß√£o inicial =================== */
    window.addEventListener('load', async () => {
      const saved = loadTheme(); applyTheme(saved || defaultTheme());
      await boot();
      switchTab('home');
      if (isLogged()) fecharModalLogin();
    });
  </script>
</body>

</html>

<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ConnectZap ‚Äî Agentes</title>
  <link rel="icon" href="https://joubertcastro.github.io/ConnectZap/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #3b82f6;
      --accent: #22c55e;
      --bg: #f3f4f6;
      --sidebar-bg: #ffffff;
      --content-bg: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --link: #2563eb;
      --ghost-bg: #f3f4f6;
      --ring: rgba(59, 130, 246, .35);
      --bubble-out-g1: #dcf8c6;
      --bubble-out-g2: #b8f0a4;
      --bubble-out-fg: #111827;
      --bubble-in-bg: #fff;
      --bubble-in-border: #e2e8f0;
      --bubble-in-fg: #0f172a;
      --bubble-radius: 18px;
      --btn-radius: 10px;
      --card-radius: 16px;
      --font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --font-size: 14px;
      --chat-wallpaper-opacity: 0;
      --scrollbar: #cbd5e1;
      --ticket-selected-bg: #f0f9ff
    }

    * {
      outline-color: var(--ring)
    }

    html {
      font-size: var(--font-size)
    }

    body {
      font-family: var(--font-family);
      color: var(--text);
      background: var(--bg)
    }

    .card {
      background: var(--content-bg);
      border: 1px solid var(--border);
      border-radius: var(--card-radius)
    }

    .btn {
      border-radius: var(--btn-radius)
    }

    .btn-primary {
      background: var(--primary);
      color: #fff
    }

    .btn-primary:hover {
      filter: brightness(.95)
    }

    .btn-ghost {
      background: var(--ghost-bg)
    }

    .sidebar {
      background: var(--sidebar-bg);
      border-color: var(--border)
    }

    .topbar {
      background: var(--content-bg);
      border-color: var(--border)
    }

    .ticket-selected {
      background: var(--ticket-selected-bg) !important
    }

    .badge {
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      border-radius: 9999px;
      padding: 2px 6px;
      min-width: 18px;
      text-align: center
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 9999px;
      display: inline-block;
      margin-right: 6px
    }

    .dot.online {
      background: #16a34a
    }

    .dot.offline {
      background: #9ca3af
    }

    .msg {
      display: inline-block;
      max-width: min(70%, 560px);
      padding: 10px 14px 18px;
      margin: 6px 0;
      position: relative;
      border-radius: var(--bubble-radius);
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .10);
      transition: background .18s ease, border-color .18s ease, color .18s ease
    }

    @media (max-width:768px) {
      .msg {
        max-width: 86%
      }
    }

    .msg.enviada {
      align-self: flex-end;
      background: linear-gradient(120deg, var(--bubble-out-g1), var(--bubble-out-g2));
      color: var(--bubble-out-fg)
    }

    .msg.recebida {
      align-self: flex-start;
      background: var(--bubble-in-bg);
      border: 1px solid var(--bubble-in-border);
      color: var(--bubble-in-fg)
    }

    .msg .hora {
      position: absolute;
      right: 8px;
      bottom: 4px;
      font-size: 11px;
      color: var(--muted)
    }

    .msg.enviada::after,
    .msg.recebida::after {
      content: "";
      position: absolute;
      bottom: 0;
      width: 14px;
      height: 14px;
      clip-path: polygon(0 0, 100% 0, 0 100%)
    }

    .msg.enviada::after {
      right: -7px;
      background: linear-gradient(120deg, var(--bubble-out-g1), var(--bubble-out-g2))
    }

    .msg.recebida::after {
      left: -7px;
      background: var(--bubble-in-bg);
      border-left: 1px solid var(--bubble-in-border);
      border-bottom: 1px solid var(--bubble-in-border)
    }

    .msg img.thumb {
      max-width: 280px;
      height: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor: pointer
    }

    .msg audio {
      width: 320px;
      display: block
    }

    .dia {
      text-align: center;
      margin: 12px 0;
      font-size: 12px;
      color: var(--muted)
    }

    .reply-btn {
      position: absolute;
      top: 4px;
      right: 6px;
      width: 22px;
      height: 22px;
      border-radius: 9999px;
      display: grid;
      place-items: center;
      background: rgba(0, 0, 0, .06);
      color: #334155;
      border: 1px solid rgba(0, 0, 0, .08);
      opacity: .0;
      transition: opacity .15s ease, transform .06s ease;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
    }

    .msg:hover .reply-btn {
      opacity: 1
    }

    .reply-btn:active {
      transform: scale(.96)
    }

    .reply-btn svg {
      width: 14px;
      height: 14px
    }

    textarea {
      background: var(--content-bg);
      color: var(--text);
      border-color: var(--border) !important
    }

    textarea::placeholder {
      color: color-mix(in srgb, var(--muted) 85%, var(--bg))
    }

    input[type="text"],
    input[type="search"],
    input[type="color"],
    input[type="file"],
    select {
      background: var(--content-bg);
      color: var(--text);
      border-color: var(--border) !important
    }

    *::-webkit-scrollbar {
      width: 10px;
      height: 10px
    }

    *::-webkit-scrollbar-thumb {
      background: var(--scrollbar);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box
    }

    *::-webkit-scrollbar-track {
      background: transparent
    }

    .mini-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 56px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 10px 6px;
      background: #0b1220;
      color: #e5e7eb;
      z-index: 70;
      border-right: 1px solid #111827
    }

    .mini-sidebar .btn-mini {
      width: 44px;
      height: 44px;
      display: grid;
      place-items: center;
      border-radius: 12px;
      background: transparent;
      transition: background .2s ease, transform .06s ease;
      cursor: pointer
    }

    .mini-sidebar .btn-mini:hover {
      background: #111827
    }

    .mini-sidebar .btn-mini.active {
      background: #2563eb;
      color: #fff
    }

    .with-mini {
      margin-left: 56px
    }

    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: min(430px, 96%);
      height: 100%;
      background: var(--content-bg);
      border-left: 1px solid var(--border);
      box-shadow: -12px 0 24px rgba(0, 0, 0, .08);
      transform: translateX(100%);
      transition: transform .25s ease;
      z-index: 60
    }

    .drawer.open {
      transform: translateX(0)
    }

    /* FIX: modal n√£o deve abrir ap√≥s F5 se logado */
    .modal {
      display: none;
      /* <‚Äî manter apenas esta declara√ß√£o */
      position: fixed;
      z-index: 100;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      align-items: center;
      justify-content: center;
    }

    .modal-inner {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      width: min(420px, 94%);
      box-shadow: 0 10px 30px rgba(0, 0, 0, .14)
    }
  </style>
</head>

<body class="h-screen flex with-mini">

  <!-- Mini Sidebar -->
  <nav class="mini-sidebar select-none">
    <button id="tabBtnHome" class="btn-mini active" title="Home" aria-label="Home">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
        <path
          d="M12 3.172 2.293 12.88a1 1 0 0 0 1.414 1.415L5 13.001V20a1 1 0 0 0 1 1h5v-6h2v6h5a 1 1 0 0 0 1-1v-6.999l1.293 1.294a1 1 0 0 0 1.414-1.415L12 3.172z" />
      </svg>
    </button>
    <button id="tabBtnConversas" class="btn-mini" title="Conversas" aria-label="Conversas">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 2H4a2 2 0 0 0-2 2v14l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z" />
      </svg>
    </button>
    <button id="tabBtnRelatorio" class="btn-mini" title="Relat√≥rio" aria-label="Relat√≥rio">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
        <path d="M11 2a10 10 0 1 0 10 10h-8a2 2 0 0 1-2-2V2zM13 2.05V10h7.95A10.004 10.004 0 0 0 13 2.05z" />
      </svg>
    </button>
  </nav>

  <!-- Tabs Wrapper -->
  <div id="tabsWrapper" class="flex-1 flex flex-col">

    <!-- HOME -->
    <section id="tabHome" class="flex-1 p-6">
      <div class="max-w-4xl mx-auto">
        <div class="card p-6">
          <h1 class="text-2xl font-bold">Bem-vindo(a) üëã</h1>
          <p class="text-gray-600 mt-2">Ol√° <span id="homeAgenteNome" class="font-semibold">‚Äî</span>!</p>
          <p class="text-gray-600">Carteira: <span id="homeAgenteCarteira" class="font-semibold">‚Äî</span></p>

          <!-- CONTROLES GERAIS NA HOME -->
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="p-4 border rounded-lg">
              <div class="text-sm text-gray-500 mb-1">Status</div>
              <div id="homeStatus" class="font-medium"><span class="dot offline"></span>Offline</div>
              <div class="mt-3 flex flex-wrap gap-2">
                <button id="btnToggleOnline"
                  class="btn px-3 py-2 bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 flex items-center gap-2"
                  disabled aria-live="polite" aria-pressed="false">
                  <svg id="toggleSpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" aria-hidden="true">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
                      fill="none"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                  </svg>
                  <span id="toggleLabel">Ficar online</span>
                </button>
                <!-- Bot√£o din√¢mico: Login/Logout -->
                <button id="btnLogout" class="btn px-3 py-2 bg-gray-100 hover:bg-gray-200">Logout</button>
              </div>
              <div id="homeAviso" class="mt-2 text-xs text-amber-600 hidden" role="alert" aria-live="polite"></div>
            </div>

            <div class="p-4 border rounded-lg">
              <div class="text-sm text-gray-500 mb-1">Atalhos</div>
              <div class="flex flex-wrap gap-2">
                <button id="goToConversas1" class="btn btn-primary px-4 py-2">Ir para Conversas</button>
                <button id="goToRelatorio1" class="btn px-4 py-2 bg-gray-100 hover:bg-gray-200">Ver Relat√≥rio</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CONVERSAS -->
    <section id="tabConversas" class="hidden h-full flex">
      <!-- Sidebar esquerda -->
      <aside class="sidebar w-1/3 lg:w-1/4 border-r flex flex-col">
        <div class="p-3 border-b topbar">
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0">
              <div class="text-xs text-gray-500">Agente</div>
              <div id="agenteNome" class="font-semibold truncate">‚Äî</div>
              <div class="text-xs text-gray-500">Carteira: <span id="agenteCarteira">‚Äî</span></div>
              <div class="text-xs text-gray-500">Status: <span id="agenteStatus"><span
                    class="dot offline"></span>Offline</span></div>
              <div class="mt-1 text-xs">
                <span class="text-gray-500">Tickets:</span>
                <span id="badgeAtivos" class="badge">0</span>
                <span class="text-gray-500 mx-1">/</span>
                <span id="badgeLimite" class="badge" style="background:#64748b">‚àû</span>
              </div>
            </div>
            <div class="flex flex-col items-end gap-2">
              <button id="btnPegarProxima"
                class="btn btn-primary px-3 py-2 text-sm text-white disabled:opacity-50 flex items-center gap-2"
                disabled>
                <svg id="pegarSpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" aria-hidden="true">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none">
                  </circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a 8 8 0 018-8v 4a 4 4 0 00-4 4H4z"></path>
                </svg>
                <span id="pegarLabel">Pegar pr√≥xima</span>
              </button>
              <button id="btnPrioridade" class="btn px-3 py-2 text-sm rounded-md text-white disabled:opacity-50"
                disabled style="background: rebeccapurple">Pedir prioridade</button>
            </div>
          </div>
          <div id="msgAviso" class="mt-2 text-xs text-amber-600 hidden" role="alert" aria-live="polite"></div>
          <div id="msgLimite" class="mt-1 text-xs text-red-600 hidden" role="alert" aria-live="polite"></div>
        </div>

        <ul id="listaTickets" class="flex-1 overflow-y-auto" aria-label="Minhas conversas"></ul>

        <div class="p-2 text-xs text-gray-500 border-t topbar">
          Apenas conversas da sua carteira. ‚ÄúPegar pr√≥xima‚Äù usa ordem por √∫ltima mensagem <em>recebida</em>.
        </div>
      </aside>

      <!-- Chat principal -->
      <main class="flex-1 flex flex-col">
        <div class="flex items-center justify-between p-3 border-b topbar">
          <div class="min-w-0">
            <div id="tituloConversa" class="font-bold text-lg truncate">Selecione um ticket</div>
            <div id="subInfo" class="text-sm text-gray-500 truncate"></div>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnLiberar" class="btn px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 disabled:opacity-50"
              disabled>Liberar</button>
            <div class="relative">
              <button id="btnConcluir" class="btn px-3 py-2 text-sm text-white disabled:opacity-50"
                style="background:var(--accent)" disabled aria-haspopup="true" aria-expanded="false">Concluir</button>
              <div id="menuConcluir"
                class="hidden absolute right-0 mt-2 w-64 bg-white border rounded-lg shadow-lg z-20"></div>
            </div>
          </div>
        </div>

        <div class="relative flex-1 overflow-hidden">
          <div id="chat" class="relative h-full p-4 overflow-y-auto flex flex-col space-y-1" role="log"
            aria-live="polite">
            <p id="loading" class="text-center text-gray-500">Pegue uma conversa para iniciar‚Ä¶</p>
          </div>
        </div>

        <div id="digitando" class="px-4 text-left hidden text-sm text-gray-500" aria-live="polite">Digitando‚Ä¶</div>

        <div id="respostaPreview" class="hidden px-3 py-2 border-t bg-gray-50 text-sm flex justify-between items-center">
          <div class="truncate max-w-[80%]"><span class="font-semibold">Respondendo:</span> <span id="respostaTexto"
              class="text-gray-600"></span></div>
          <button onclick="cancelarResposta()" class="text-red-500 text-xs" aria-label="Cancelar resposta">‚úñ</button>
        </div>

        <div class="p-3 border-t topbar flex space-x-2 items-center">
          <input type="file" id="fileInput" accept="application/pdf" class="hidden" onchange="enviarPDF(event)">
          <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary px-3 py-2">üìù
            PDF</button>
          <textarea id="textoMensagem" rows="1" class="flex-1 border rounded-md p-2 resize-none"
            placeholder="Digite uma mensagem‚Ä¶" disabled></textarea>
          <button id="btnEnviar" class="btn px-4 py-2 text-white disabled:opacity-50" style="background:var(--accent)"
            disabled>Enviar</button>
        </div>
      </main>

      <!-- Modal imagem -->
      <div id="imageModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50"
        aria-modal="true" role="dialog">
        <span id="closeModal" class="absolute top-4 right-6 text-white text-3xl cursor-pointer"
          aria-label="Fechar imagem">&times;</span>
        <img id="modalImg" src="" alt="Imagem" class="max-h-[90%] max-w-[90%] rounded-lg shadow-lg">
      </div>

      <!-- Modal prioridade -->
      <div id="priorityModal" class="hidden fixed inset-0 z-50" aria-modal="true" role="dialog">
        <div class="absolute inset-0 bg-black/60" onclick="fecharPriorityModal()" aria-hidden="true"></div>
        <div class="relative mx-auto mt-24 w-[95%] max-w-md bg-white rounded-xl shadow-xl border">
          <div class="p-4 border-b flex items-center justify-between">
            <h3 class="font-semibold">Pedir prioridade</h3>
            <button class="text-gray-500" onclick="fecharPriorityModal()" aria-label="Fechar">‚úñ</button>
          </div>
          <div class="p-4 space-y-3">
            <label class="block text-sm text-gray-600">Telefone do cliente</label>
            <input id="priorityTelefone" class="w-full p-2 border rounded-md"
              placeholder="Ex: 61999999999 ou 5561999999999" autocomplete="off" inputmode="numeric" pattern="[0-9]*" />
            <p class="text-xs text-gray-500">Aten√ß√£o: informe um telefone v√°lido DDD + 8/9 d√≠gitos.</p>
            <div id="priorityInfo" class="text-sm text-gray-700 hidden"></div>
            <div id="priorityErro" class="text-sm text-red-600 hidden" role="alert" aria-live="polite"></div>
          </div>
          <div class="p-4 border-t flex items-center justify-end gap-2">
            <button class="px-3 py-2 text-sm bg-gray-100 rounded hover:bg-gray-200"
              onclick="fecharPriorityModal()">Cancelar</button>
            <button id="btnPriorityBuscar"
              class="px-3 py-2 text-sm text-white rounded-md hover:bg-purple-700 flex items-center gap-2"
              style="background: rebeccapurple">
              <svg id="prioritySpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" aria-hidden="true">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none">
                </circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a 8 8 0 018-8v4a 4 4 0 00-4 4H4z"></path>
              </svg>
              <span id="priorityBtnLabel">Buscar e solicitar</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Theme Drawer -->
      <div id="themeDrawer" class="drawer" aria-hidden="true">
        <div class="h-full flex flex-col">
          <div class="p-4 border-b flex items-center justify-between">
            <h3 class="font-semibold">üé® Seu tema</h3>
            <div class="flex items-center gap-2">
              <button id="btnThemeExport" class="btn btn-ghost px-2 py-1 text-xs">Salvar no meu computador</button>
              <label class="btn btn-ghost px-2 py-1 text-xs cursor-pointer">Importar um tema salvo <input
                  id="importTheme" type="file" accept="application/json" class="hidden"></label>
              <button id="btnThemeClose" class="btn btn-ghost px-2 py-1 text-xs" aria-label="Fechar">‚úñ</button>
            </div>
          </div>
          <div class="p-4 overflow-y-auto space-y-6">
            <!-- Conte√∫do de tema (como antes) -->
            <section>
              <div class="text-xs text-gray-500 mb-2">Temas r√°pidos</div>
              <div class="grid grid-cols-2 gap-2">
                <div class="preset" data-preset="corporate">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#0ea5e9,#2563eb)"></div>
                  <div class="mt-1 text-xs">Corporate</div>
                </div>
                <div class="preset" data-preset="ocean">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#06b6d4,#10b981)"></div>
                  <div class="mt-1 text-xs">Ocean</div>
                </div>
                <div class="preset" data-preset="sunset">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#fb923c,#ef4444)"></div>
                  <div class="mt-1 text-xs">Sunset</div>
                </div>
                <div class="preset" data-preset="dark">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#0b1220,#374151)"></div>
                  <div class="mt-1 text-xs">Dark</div>
                </div>
                <div class="preset" data-preset="minimal">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#f8fafc,#e2e8f0)"></div>
                  <div class="mt-1 text-xs">Minimal</div>
                </div>
                <div class="preset" data-preset="funky">
                  <div class="h-8 rounded" style="background:linear-gradient(90deg,#a78bfa,#ec4899)"></div>
                  <div class="mt-1 text-xs">Funky</div>
                </div>
              </div>
            </section>
            <hr class="border-gray-200">
            <section>
              <div class="text-xs text-gray-500 mb-2">Personalizar</div>
              <div class="grid grid-cols-2 gap-3">
                <label class="block"><span class="text-xs text-gray-600">Bot√£o PDF</span><input id="tPrimary"
                    type="color" class="w-full h-10 border rounded" value="#3b82f6"></label>
                <label class="block"><span class="text-xs text-gray-600">Bot√£o Concluir</span><input id="tAccent"
                    type="color" class="w-full h-10 border rounded" value="#22c55e"></label>
                <label class="block"><span class="text-xs text-gray-600">Barra lateral</span><input id="tSidebar"
                    type="color" class="w-full h-10 border rounded" value="#ffffff"></label>
                <label class="block"><span class="text-xs text-gray-600">Cabe√ßalho</span><input id="tContentBg"
                    type="color" class="w-full h-10 border rounded" value="#ffffff"></label>
                <label class="block"><span class="text-xs text-gray-600">Cor de fundo</span><input id="tBg" type="color"
                    class="w-full h-10 border rounded" value="#f3f4f6"></label>
                <label class="block"><span class="text-xs text-gray-600">Texto</span><input id="tText" type="color"
                    class="w-full h-10 border rounded" value="#0f172a"></label>
              </div>
              <div class="grid grid-cols-2 gap-3 mt-3">
                <label class="block"><span class="text-xs text-gray-600">Minha mensagem cor 1</span><input id="tOutG1"
                    type="color" class="w-full h-10 border rounded" value="#dcf8c6"></label>
                <label class="block"><span class="text-xs text-gray-600">Minha mensagem cor 2</span><input id="tOutG2"
                    type="color" class="w-full h-10 border rounded" value="#b8f0a4"></label>
                <label class="block"><span class="text-xs text-gray-600">Cliente mensagem cor</span><input id="tInBg"
                    type="color" class="w-full h-10 border rounded" value="#ffffff"></label>
                <label class="block"><span class="text-xs text-gray-600">Cliente mensagem bordas</span><input
                    id="tInBorder" type="color" class="w-full h-10 border rounded" value="#e2e8f0"></label>
                <label class="block"><span class="text-xs text-gray-600">Canto arredondado dos bal√µes</span><input
                    id="tRadius" type="range" min="8" max="28" value="18" class="w-full"></label>
              </div>
              <div class="grid grid-cols-1 gap-3 mt-3">
                <label class="block"><span class="text-xs text-gray-600">Opacidade do fundo</span><input id="tBgOp"
                    type="range" min="0" max="1" step="0.05" value="0"></label>
              </div>
              <div class="grid grid-cols-2 gap-3 mt-3">
                <label class="block"><span class="text-xs text-gray-600">Tamanho base</span>
                  <select id="tFontSize" class="w-full p-2 border rounded">
                    <option value="13px">13px</option>
                    <option value="14px" selected>14px</option>
                    <option value="15px">15px</option>
                    <option value="16px">16px</option>
                  </select>
                </label>
                <label class="block"><span class="text-xs text-gray-600">Canto arredondado dos bot√µes</span><input
                    id="tBtnRadius" type="range" min="6" max="16" value="10" class="w-full"></label>
                <label class="block"><span class="text-xs text-gray-600">Canto arredondado dos cards</span><input
                    id="tCardRadius" type="range" min="10" max="24" value="16" class="w-full"></label>
              </div>
              <div class="flex items-center justify-between mt-4">
                <div class="flex items-center gap-2">
                  <button id="btnRandom" class="btn btn-ghost px-3 py-2">üé≤ Surpreenda-me</button>
                  <button id="btnReset" class="btn btn-ghost px-3 py-2">‚Ü∫ Voltar ao padr√£o</button>
                </div>
                <button id="btnSaveTheme" class="btn btn-primary px-4 py-2">Salvar</button>
              </div>
            </section>
          </div>
        </div>
      </div>
    </section>

    <!-- RELAT√ìRIO -->
    <section id="tabRelatorio" class="hidden p-4">
      <div class="max-w-6xl mx-auto space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Relat√≥rio ‚Äî Atendimentos</h2>
          <div class="text-sm text-gray-500" id="relatorioPeriodo">Hoje</div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="card p-4">
            <div class="text-xs text-gray-500">Em atendimento</div>
            <div id="kpiEm" class="text-2xl font-bold">0</div>
          </div>
          <div class="card p-4">
            <div class="text-xs text-gray-500">Conclu√≠dos</div>
            <div id="kpiConc" class="text-2xl font-bold">0</div>
          </div>
          <div class="card p-4">
            <div class="text-xs text-gray-500">TMA</div>
            <div class="text-2xl font-bold"><span id="kpiTma">‚Äî</span><span class="text-sm text-gray-500"> min</span>
            </div>
          </div>
          <div class="card p-4">
            <div class="text-xs text-gray-500">1¬™ resposta</div>
            <div class="text-2xl font-bold"><span id="kpiFRT">‚Äî</span><span class="text-sm text-gray-500"> seg</span>
            </div>
          </div>
        </div>
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Distribui√ß√£o por status</div>
            <button id="btnRefreshRel" class="btn px-3 py-2 bg-gray-100 hover:bg-gray-200 text-sm">Atualizar</button>
          </div>
          <div class="mt-4"><canvas id="pieStatus" height="260"></canvas></div>
        </div>
      </div>
    </section>

  </div>

  <!-- MODAL DE LOGIN (apenas c√≥digo do agente) -->
  <div id="modalLogin" class="modal">
    <div class="modal-inner">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 class="font-semibold">Identifique-se</h3>
        <button class="btn btn-ghost px-2 py-1 text-xs" onclick="fecharModalLogin()" aria-label="Fechar">‚úñ</button>
      </div>
      <div class="p-4 space-y-3">
        <label class="block text-sm text-gray-600">Informe seu c√≥digo de agente</label>
        <input id="loginCodigoAgente" inputmode="numeric" pattern="[0-9]*" class="w-full p-2 border rounded-md"
          placeholder="Ex: 101" />
        <p class="text-xs text-gray-500">Usaremos este c√≥digo para carregar seu nome, carteira e permiss√µes.</p>
        <div id="loginErro" class="text-sm text-red-600 hidden" role="alert" aria-live="polite"></div>
      </div>
      <div class="p-4 border-t flex items-center justify-end gap-2">
        <button class="px-3 py-2 text-sm bg-gray-100 rounded hover:bg-gray-200"
          onclick="fecharModalLogin()">Cancelar</button>
        <button id="btnDoLogin" class="px-3 py-2 text-sm text-white rounded-md"
          style="background:var(--primary)">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    /** =================== CONFIG / APIs =================== */
    const FILA_API = (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? "http://localhost:8001"
      : "https://fila-de-atendimento-production.up.railway.app";

    const CONV_API = (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? "http://localhost:8002"
      : "https://conversas-api-production.up.railway.app";

    const REL_API = (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? "http://localhost:8003"
      : "https://dashboard-connectzap-production.up.railway.app";

    const STORAGE_KEY_THEME = "cz:theme:v1";
    const STORAGE_KEY_TICKETS = "cz:tickets:v1";
    const STORAGE_KEY_UNREAD_PREFIX = "cz:unread:";
    const STORAGE_KEY_LAST_TS_PREFIX = "cz:lastContatoTs:";
    const STORAGE_KEY_ATIVOS = "cz:ativos:";
    const LOGOUT_REDIRECT = "";

    /** =================== ESTADO GLOBAL =================== */
    let agente = {
      codigo: localStorage.getItem("agente_codigo") || "",
      nome: localStorage.getItem("agente_nome") || "",
      carteira: localStorage.getItem("agente_carteira") || "",
      origem: localStorage.getItem("agente_origem") || "",
      online: false
    };

    let tickets = [];
    let ordemCache = [];
    let unreadCountByKey = {};
    let lastContatoTsByKey = {};
    let pollingContatos = null;
    let pollingMensagens = null;
    let selecionado = null;
    let isModalOpen = false;
    let limitPerAgent = 0;
    let ativosCount = 0;

    let lastTimestampMs = null;
    let lastDayRendered = null;
    const renderedKeys = new Set();

    const phoneIdMap = {
      "828473960349364": "ConnectZap",
      "727586317113885": "Recovery PJ",
      "864779140046932": "Recovery PF",
      "802977069563598": "Recovery PF2",
      "873637622491517": "Mercado Pago Cobran√ßa",
      "821562937700669": "Mercado Pago Cobran√ßa2",
      "779797401888141": "DivZero",
      "829210283602406": "Arc4U",
      "713021321631338": "Serasa"
    };

    /** =================== HELPERS =================== */
    function escapeHtml(s) {
      if (s == null) return "";
      return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function normalizarTelefone(t) {
      if (!t) return "";
      return String(t).replace(/\D/g, "");
    }

    function formatarDataHora(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(+d)) return "";
      return d.toLocaleString("pt-BR", {
        day: "2-digit",
        month: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function formatarHora(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(+d)) return "";
      return d.toLocaleTimeString("pt-BR", {
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function diaLabel(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(+d)) return "";
      const hoje = new Date();
      const diff = Math.floor((hoje - d) / 86400000);
      if (diff === 0) return "Hoje";
      if (diff === 1) return "Ontem";
      return d.toLocaleDateString("pt-BR", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      });
    }

    function keyFrom(remetente, phoneId) {
      return `${normalizarTelefone(remetente)}::${phoneId || ""}`;
    }

    function persistUnread() {
      try {
        Object.keys(localStorage).forEach(k => {
          if (k.startsWith(STORAGE_KEY_UNREAD_PREFIX) || k.startsWith(STORAGE_KEY_LAST_TS_PREFIX)) {
            localStorage.removeItem(k);
          }
        });
        Object.entries(unreadCountByKey).forEach(([k, v]) => {
          localStorage.setItem(STORAGE_KEY_UNREAD_PREFIX + k, String(v));
        });
        Object.entries(lastContatoTsByKey).forEach(([k, v]) => {
          localStorage.setItem(STORAGE_KEY_LAST_TS_PREFIX + k, String(v));
        });
      } catch (e) {
        console.error("Erro ao persistir unread", e);
      }
    }

    function loadUnread() {
      unreadCountByKey = {};
      lastContatoTsByKey = {};
      try {
        Object.keys(localStorage).forEach(k => {
          if (k.startsWith(STORAGE_KEY_UNREAD_PREFIX)) {
            const key = k.substring(STORAGE_KEY_UNREAD_PREFIX.length);
            unreadCountByKey[key] = parseInt(localStorage.getItem(k) || "0", 10) || 0;
          }
          if (k.startsWith(STORAGE_KEY_LAST_TS_PREFIX)) {
            const key = k.substring(STORAGE_KEY_LAST_TS_PREFIX.length);
            lastContatoTsByKey[key] = parseInt(localStorage.getItem(k) || "0", 10) || 0;
          }
        });
      } catch (e) {
        console.error("Erro ao carregar unread", e);
      }
    }

    function saveTickets() {
      try {
        localStorage.setItem(STORAGE_KEY_TICKETS, JSON.stringify(tickets));
      } catch (e) {
        console.error("Erro ao salvar tickets", e);
      }
    }

    function loadTicketsFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_TICKETS);
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return;
        tickets = arr;
      } catch (e) {
        console.error("Erro ao carregar tickets", e);
      }
    }

    function sorterByLastContato(a, b) {
      const ka = keyFrom(a.remetente, a.phone_id);
      const kb = keyFrom(b.remetente, b.phone_id);
      const ta = lastContatoTsByKey[ka] || 0;
      const tb = lastContatoTsByKey[kb] || 0;
      if (ta !== tb) return tb - ta;
      return new Date(b.data_hora || 0) - new Date(a.data_hora || 0);
    }

    /** =================== THEME =================== */
    function defaultTheme() {
      return {
        primary: "#3b82f6",
        accent: "#22c55e",
        sidebar: "#ffffff",
        contentBg: "#ffffff",
        bg: "#f3f4f6",
        text: "#0f172a",
        bubbleOutG1: "#dcf8c6",
        bubbleOutG2: "#b8f0a4",
        bubbleInBg: "#ffffff",
        bubbleInBorder: "#e2e8f0",
        bubbleRadius: 18,
        bgOpacity: 0,
        fontSize: "14px",
        btnRadius: 10,
        cardRadius: 16
      };
    }

    function loadTheme() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_THEME);
        if (!raw) return defaultTheme();
        const t = JSON.parse(raw);
        return { ...defaultTheme(), ...t };
      } catch {
        return defaultTheme();
      }
    }

    function applyTheme(t) {
      const r = document.documentElement.style;
      const base = defaultTheme();
      const x = { ...base, ...t };
      r.setProperty("--primary", x.primary);
      r.setProperty("--accent", x.accent);
      r.setProperty("--sidebar-bg", x.sidebar);
      r.setProperty("--content-bg", x.contentBg);
      r.setProperty("--bg", x.bg);
      r.setProperty("--text", x.text);
      r.setProperty("--bubble-out-g1", x.bubbleOutG1);
      r.setProperty("--bubble-out-g2", x.bubbleOutG2);
      r.setProperty("--bubble-in-bg", x.bubbleInBg);
      r.setProperty("--bubble-in-border", x.bubbleInBorder);
      r.setProperty("--bubble-radius", x.bubbleRadius + "px");
      r.setProperty("--chat-wallpaper-opacity", x.bgOpacity);
      r.setProperty("--font-size", x.fontSize);
      r.setProperty("--btn-radius", x.btnRadius + "px");
      r.setProperty("--card-radius", x.cardRadius + "px");
    }

    function saveTheme(t) {
      try {
        localStorage.setItem(STORAGE_KEY_THEME, JSON.stringify(t));
      } catch (e) {
        console.error("Erro ao salvar tema", e);
      }
    }

    function randomColor() {
      const h = Math.floor(Math.random() * 360);
      const s = 60 + Math.floor(Math.random() * 20);
      const l = 45 + Math.floor(Math.random() * 10);
      return `hsl(${h} ${s}% ${l}%)`;
    }

    function randomTheme() {
      const base = defaultTheme();
      const t = {
        ...base,
        primary: randomColor(),
        accent: randomColor(),
        sidebar: randomColor(),
        contentBg: "#ffffff",
        bg: "#f9fafb",
        text: "#0f172a",
        bubbleOutG1: randomColor(),
        bubbleOutG2: randomColor(),
        bubbleInBg: "#ffffff",
        bubbleInBorder: "#e5e7eb",
        bubbleRadius: 18 + Math.floor(Math.random() * 6),
        bgOpacity: Math.random() * 0.4,
        fontSize: ["13px", "14px", "15px", "16px"][Math.floor(Math.random() * 4)],
        btnRadius: 8 + Math.floor(Math.random() * 5),
        cardRadius: 14 + Math.floor(Math.random() * 6)
      };
      return t;
    }

    function syncThemeControls(t) {
      document.getElementById("tPrimary").value = t.primary;
      document.getElementById("tAccent").value = t.accent;
      document.getElementById("tSidebar").value = t.sidebar;
      document.getElementById("tContentBg").value = t.contentBg;
      document.getElementById("tBg").value = t.bg;
      document.getElementById("tText").value = t.text;
      document.getElementById("tOutG1").value = t.bubbleOutG1;
      document.getElementById("tOutG2").value = t.bubbleOutG2;
      document.getElementById("tInBg").value = t.bubbleInBg;
      document.getElementById("tInBorder").value = t.bubbleInBorder;
      document.getElementById("tRadius").value = t.bubbleRadius;
      document.getElementById("tBgOp").value = t.bgOpacity;
      document.getElementById("tFontSize").value = t.fontSize;
      document.getElementById("tBtnRadius").value = t.btnRadius;
      document.getElementById("tCardRadius").value = t.cardRadius;
    }

    function loadAndApplyTheme() {
      const t = loadTheme();
      applyTheme(t);
      syncThemeControls(t);
    }

    /** =================== DOM REFS =================== */
    const elHomeAgenteNome = document.getElementById("homeAgenteNome");
    const elHomeAgenteCarteira = document.getElementById("homeAgenteCarteira");
    const elHomeStatus = document.getElementById("homeStatus");
    const elHomeAviso = document.getElementById("homeAviso");

    const elMsgAviso = document.getElementById("msgAviso");
    const elMsgLimite = document.getElementById("msgLimite");
    const elListaTickets = document.getElementById("listaTickets");
    const elTitulo = document.getElementById("tituloConversa");
    const elSubInfo = document.getElementById("subInfo");
    const chat = document.getElementById("chat");
    const textarea = document.getElementById("textoMensagem");
    const btnEnviar = document.getElementById("btnEnviar");
    const btnPegarProxima = document.getElementById("btnPegarProxima");
    const btnPrioridade = document.getElementById("btnPrioridade");
    const btnLiberar = document.getElementById("btnLiberar");
    const btnConcluir = document.getElementById("btnConcluir");
    const menuConcluir = document.getElementById("menuConcluir");
    const digitando = document.getElementById("digitando");
    const badgeAtivos = document.getElementById("badgeAtivos");
    const badgeLimite = document.getElementById("badgeLimite");

    // Bot√µes Home
    const btnToggleOnline = document.getElementById("btnToggleOnline");
    const btnLogout = document.getElementById("btnLogout");

    // Tabs
    const tabBtnHome = document.getElementById('tabBtnHome');
    const tabBtnConversas = document.getElementById('tabBtnConversas');
    const tabBtnRelatorio = document.getElementById('tabBtnRelatorio');
    const tabHome = document.getElementById('tabHome');
    const tabConversas = document.getElementById('tabConversas');
    const tabRelatorio = document.getElementById('tabRelatorio');
    document.getElementById('goToConversas1').onclick = () => switchTab('conversas');
    document.getElementById('goToRelatorio1').onclick = () => switchTab('relatorio');

    /** =================== MENU CONCLUIR =================== */
    const MOTIVOS_CONCLUSAO = ["Realizou negocia√ß√£o", "Solicitou 2¬™ via de boleto", "Recusou a proposta", "D√∫vidas gerais", "Cliente ficou inativo"];
    function renderMenuConcluir() {
      menuConcluir.innerHTML = MOTIVOS_CONCLUSAO.map(m => `<button type="button" data-motivo="${m}" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">${m}</button>`).join("");
      menuConcluir.querySelectorAll("button[data-motivo]").forEach(btn => {
        btn.onclick = async () => { await concluirAtendimento(btn.getAttribute("data-motivo")); fecharMenuConcluir(); };
      });
    }
    function abrirMenuConcluir() { if (!selecionado || btnConcluir.disabled) return; menuConcluir.classList.remove("hidden"); btnConcluir.setAttribute("aria-expanded", "true"); document.addEventListener("click", clickForaMenuConcluir, { capture: true }); }
    function fecharMenuConcluir() { menuConcluir.classList.add("hidden"); btnConcluir.setAttribute("aria-expanded", "false"); document.removeEventListener("click", clickForaMenuConcluir, { capture: true }); }
    function clickForaMenuConcluir(e) { const within = menuConcluir.contains(e.target) || btnConcluir.contains(e.target); if (!within) fecharMenuConcluir(); }
    btnConcluir.onclick = () => { menuConcluir.classList.contains("hidden") ? abrirMenuConcluir() : fecharMenuConcluir(); };

    /** =================== THEME DRAWER =================== */
    const themeDrawer = document.getElementById("themeDrawer");
    const btnThemeClose = document.getElementById("btnThemeClose");
    const btnThemeExport = document.getElementById("btnThemeExport");
    const importTheme = document.getElementById("importTheme");
    const btnRandom = document.getElementById("btnRandom");
    const btnReset = document.getElementById("btnReset");
    const btnSaveTheme = document.getElementById("btnSaveTheme");

    function openThemeDrawer() {
      themeDrawer.classList.add("open");
      themeDrawer.setAttribute("aria-hidden", "false");
    }

    function closeThemeDrawer() {
      themeDrawer.classList.remove("open");
      themeDrawer.setAttribute("aria-hidden", "true");
    }

    btnThemeClose.onclick = closeThemeDrawer;

    document.addEventListener("keydown", e => {
      if (e.key === "Escape" && themeDrawer.classList.contains("open")) {
        closeThemeDrawer();
      }
    });

    document.addEventListener("keydown", e => {
      if (e.key === "F2") {
        e.preventDefault();
        openThemeDrawer();
      }
    });

    function exportThemeToFile() {
      const t = loadTheme();
      const blob = new Blob([JSON.stringify(t, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "connectzap-theme.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    btnThemeExport.onclick = exportThemeToFile;

    importTheme.onchange = e => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const t = JSON.parse(ev.target.result);
          const merged = { ...defaultTheme(), ...t };
          saveTheme(merged);
          applyTheme(merged);
          syncThemeControls(merged);
          alert("Tema importado com sucesso!");
        } catch (err) {
          console.error("Erro ao importar tema", err);
          alert("Arquivo de tema inv√°lido.");
        }
      };
      reader.readAsText(file);
    };

    function updateThemeFromControls() {
      const t = {
        primary: document.getElementById("tPrimary").value,
        accent: document.getElementById("tAccent").value,
        sidebar: document.getElementById("tSidebar").value,
        contentBg: document.getElementById("tContentBg").value,
        bg: document.getElementById("tBg").value,
        text: document.getElementById("tText").value,
        bubbleOutG1: document.getElementById("tOutG1").value,
        bubbleOutG2: document.getElementById("tOutG2").value,
        bubbleInBg: document.getElementById("tInBg").value,
        bubbleInBorder: document.getElementById("tInBorder").value,
        bubbleRadius: parseInt(document.getElementById("tRadius").value, 10),
        bgOpacity: parseFloat(document.getElementById("tBgOp").value),
        fontSize: document.getElementById("tFontSize").value,
        btnRadius: parseInt(document.getElementById("tBtnRadius").value, 10),
        cardRadius: parseInt(document.getElementById("tCardRadius").value, 10)
      };
      saveTheme(t);
      applyTheme(t);
    }

    ["tPrimary", "tAccent", "tSidebar", "tContentBg", "tBg", "tText", "tOutG1", "tOutG2", "tInBg", "tInBorder"].forEach(id => {
      document.getElementById(id).addEventListener("change", updateThemeFromControls);
    });

    ["tRadius", "tBgOp", "tBtnRadius", "tCardRadius", "tFontSize"].forEach(id => {
      document.getElementById(id).addEventListener("input", updateThemeFromControls);
    });

    btnRandom.onclick = () => {
      const t = randomTheme();
      saveTheme(t);
      applyTheme(t);
      syncThemeControls(t);
    };

    btnReset.onclick = () => {
      const t = defaultTheme();
      saveTheme(t);
      applyTheme(t);
      syncThemeControls(t);
    };

    btnSaveTheme.onclick = () => {
      alert("Tema salvo! Ele ser√° mantido neste navegador.");
    };

    /** =================== TABS =================== */
    function switchTab(tab) {
      tabHome.classList.add("hidden");
      tabConversas.classList.add("hidden");
      tabRelatorio.classList.add("hidden");
      tabBtnHome.classList.remove("active");
      tabBtnConversas.classList.remove("active");
      tabBtnRelatorio.classList.remove("active");

      if (tab === "home") {
        tabHome.classList.remove("hidden");
        tabBtnHome.classList.add("active");
      } else if (tab === "conversas") {
        tabConversas.classList.remove("hidden");
        tabBtnConversas.classList.add("active");
      } else if (tab === "relatorio") {
        tabRelatorio.classList.remove("hidden");
        tabBtnRelatorio.classList.add("active");
      }
    }

    tabBtnHome.onclick = () => switchTab("home");
    tabBtnConversas.onclick = () => switchTab("conversas");
    tabBtnRelatorio.onclick = () => switchTab("relatorio");

    /** =================== LOGIN MODAL =================== */
    const modalLogin = document.getElementById("modalLogin");
    const loginCodigoAgente = document.getElementById("loginCodigoAgente");
    const loginErro = document.getElementById("loginErro");
    const btnDoLogin = document.getElementById("btnDoLogin");

    function abrirModalLogin() {
      modalLogin.style.display = "flex";
      loginCodigoAgente.value = agente.codigo || "";
      loginErro.classList.add("hidden");
      setTimeout(() => loginCodigoAgente.focus(), 50);
    }

    function fecharModalLogin() {
      modalLogin.style.display = "none";
    }

    async function carregarDadosAgente(codigo) {
      try {
        const url = `${CONV_API}/api/agentes/${encodeURIComponent(codigo)}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error("Agente n√£o encontrado");
        const j = await r.json();
        return j;
      } catch (e) {
        console.error("Erro ao carregar dados do agente", e);
        throw e;
      }
    }

    function aplicarDadosAgente(dados) {
      agente.codigo = dados.codigo || "";
      agente.nome = dados.nome || "";
      agente.carteira = dados.carteira || "";
      agente.origem = dados.origem || "";
      localStorage.setItem("agente_codigo", agente.codigo);
      localStorage.setItem("agente_nome", agente.nome);
      localStorage.setItem("agente_carteira", agente.carteira);
      localStorage.setItem("agente_origem", agente.origem);

      elHomeAgenteNome.textContent = agente.nome || "‚Äî";
      elHomeAgenteCarteira.textContent = agente.carteira || "‚Äî";
      document.getElementById("agenteNome").textContent = agente.nome || "‚Äî";
      document.getElementById("agenteCarteira").textContent = agente.carteira || "‚Äî";
    }

    function setStatus(online) {
      agente.online = !!online;
      const dot = `<span class="dot ${online ? "online" : "offline"}"></span>`;
      elHomeStatus.innerHTML = `${dot}${online ? "Online" : "Offline"}`;
      document.getElementById("agenteStatus").innerHTML = `${dot}${online ? "Online" : "Offline"}`;
      btnToggleOnline.disabled = !agente.codigo || !agente.carteira;
      btnToggleOnline.setAttribute("aria-pressed", online ? "true" : "false");
      btnToggleOnline.classList.toggle("bg-green-600", !online);
      btnToggleOnline.classList.toggle("bg-red-600", online);
      btnToggleOnline.classList.toggle("hover:bg-green-700", !online);
      btnToggleOnline.classList.toggle("hover:bg-red-700", online);
      document.getElementById("toggleLabel").textContent = online ? "Ficar offline" : "Ficar online";
    }

    async function verificarSeAgenteEstaOnline() {
      if (!agente.codigo || !agente.carteira) return;
      try {
        const r = await fetch(`${FILA_API}/fila/status?codigo_do_agente=${encodeURIComponent(agente.codigo)}&carteira=${encodeURIComponent(agente.carteira)}`);
        if (!r.ok) throw new Error("Erro ao checar status");
        const lista = await r.json();
        const achou = Array.isArray(lista) && lista.some(x => String(x.codigo_do_agente) === String(agente.codigo));
        setStatus(achou);
        if (!achou) { elMsgAviso?.classList.add("hidden"); elMsgAviso.textContent = ""; }
      } catch (e) {
        console.error("Falha ao verificar status online", e);
      }
    }

    function carregarAgenteInicial() {
      elHomeAgenteNome.textContent = agente.nome || "‚Äî";
      elHomeAgenteCarteira.textContent = agente.carteira || "‚Äî";
      document.getElementById("agenteNome").textContent = agente.nome || "‚Äî";
      document.getElementById("agenteCarteira").textContent = agente.carteira || "‚Äî";
      if (!agente.codigo || !agente.carteira) {
        setStatus(false);
        btnToggleOnline.disabled = false;
      } else {
        verificarSeAgenteEstaOnline();
      }
    }

    btnDoLogin.onclick = async () => {
      const codigo = (loginCodigoAgente.value || "").trim();
      if (!codigo) {
        loginErro.textContent = "Informe seu c√≥digo.";
        loginErro.classList.remove("hidden");
        return;
      }
      btnDoLogin.disabled = true;
      btnDoLogin.textContent = "Carregando...";
      try {
        const dados = await carregarDadosAgente(codigo);
        aplicarDadosAgente(dados);
        await verificarSeAgenteEstaOnline();
        fecharModalLogin();
        updateAuthButton();
      } catch (e) {
        loginErro.textContent = e.message || "N√£o foi poss√≠vel carregar seu cadastro.";
        loginErro.classList.remove("hidden");
      } finally {
        btnDoLogin.disabled = false;
        btnDoLogin.textContent = "Confirmar";
      }
    };

    loginCodigoAgente.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        btnDoLogin.click();
      }
    });

    function updateAuthButton() {
      if (!agente.codigo || !agente.carteira) {
        btnLogout.textContent = "Login";
        btnLogout.onclick = () => abrirModalLogin();
      } else {
        btnLogout.textContent = "Logout";
        btnLogout.onclick = () => doLogout();
      }
    }

    /** =================== ORDEM / TICKETS =================== */
    function dedupe(arr) {
      return Array.from(new Set(arr));
    }

    async function refreshOrdemCarteira() {
      if (!agente.carteira) return;
      try {
        const url = `${CONV_API}/api/ordem?carteira=${encodeURIComponent(agente.carteira)}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error("Erro ao buscar ordem");
        const data = await r.json();
        const contatos = Array.isArray(data.contatos) ? data.contatos : [];
        const grouped = contatos.reduce((acc, c) => {
          const tel = normalizarTelefone(c.telefone);
          const nome = tel;
          const parts = c.phone_ids && Array.isArray(c.phone_ids) ? c.phone_ids : (c.phone_ids ? [c.phone_ids] : []);
          acc[nome] = Array.from(new Set([...(acc[nome] || []), ...parts]));
          return acc;
        }, {});
        ordemCache = Object.entries(grouped).map(([tel, arr]) => ({ telefone: tel, phone_ids: arr }));
        ordemCache.sort((a, b) => a.telefone.localeCompare(b.telefone));
      } catch (e) {
        console.error("Falha ao atualizar ordem", e);
      }
    }

    async function refreshMinhasConversas() {
      if (!agente.codigo || !agente.carteira) return;
      try {
        const url = `${CONV_API}/api/tickets/minhas?agente=${encodeURIComponent(agente.codigo)}&carteira=${encodeURIComponent(agente.carteira)}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error("Erro ao buscar tickets");
        const arr = await r.json();
        if (!Array.isArray(arr)) throw new Error("Resposta inv√°lida");
        tickets = arr;
        saveTickets();
        renderTickets();
      } catch (e) {
        console.error("Falha ao buscar tickets", e);
      }
    }

    async function refreshOrdensPeriodicamente() {
      await refreshOrdemCarteira();
      setInterval(refreshOrdemCarteira, 60000);
    }

    async function pegarProxima() {
      if (!agente.codigo || !agente.carteira) return;
      try {
        btnPegarProxima.disabled = true;
        document.getElementById("pegarSpinner").classList.remove("hidden");
        document.getElementById("pegarLabel").textContent = "Buscando‚Ä¶";
        elMsgAviso.classList.add("hidden");
        elMsgAviso.textContent = "";
        const url = `${CONV_API}/api/tickets/claim`;
        const body = {
          codigo_do_agente: parseInt(agente.codigo, 10),
          carteira: agente.carteira
        };
        const r = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if (!r.ok || !j.ok) {
          elMsgAviso.textContent = j.erro || "N√£o foi poss√≠vel pegar a pr√≥xima conversa.";
          elMsgAviso.classList.remove("hidden");
          return;
        }
        if (j.limit_per_agent !== undefined) {
          limitPerAgent = Number(j.limit_per_agent || 0);
          ativosCount = Number(j.ativos || ativosCount);
          renderAtivosLimiteUI();
          return;
        }
        const t = j.ticket;
        if (!t) {
          elMsgAviso.textContent = "Nenhuma conversa dispon√≠vel no momento.";
          elMsgAviso.classList.remove("hidden");
          return;
        }
        const existing = tickets.find(x => x.remetente === t.remetente && x.phone_id === t.phone_id);
        if (!existing) {
          tickets.unshift(t);
        }
        saveTickets();
        renderTickets();
        abrirTicket(t);
        ativosCount++;
        renderAtivosLimiteUI();
      } catch (e) {
        console.error("Erro ao pegar pr√≥xima", e);
        elMsgAviso.textContent = "Erro ao pegar pr√≥xima conversa.";
        elMsgAviso.classList.remove("hidden");
      } finally {
        document.getElementById("pegarSpinner").classList.add("hidden");
        document.getElementById("pegarLabel").textContent = "Pegar pr√≥xima";
        btnPegarProxima.disabled = !agente.online;
      }
    }

    btnPegarProxima.onclick = pegarProxima;

    function phoneIdsForCarteira() {
      const map = {
        "ConnectZap": ["828473960349364"],
        "Recovery PJ": ["727586317113885"],
        "Recovery PF": ["864779140046932", "802977069563598"],
        "Mercado Pago Cobran√ßa": ["873637622491517", "821562937700669"],
        "DivZero": ["779797401888141"],
        "Arc4U": ["829210283602406"],
        "Serasa": ["713021321631338"]
      };
      return map[agente.carteira] || [];
    }

    async function preferPhoneIdDoContato(telefone) {
      try {
        const url = `${CONV_API}/api/contatos/preferido?telefone=${encodeURIComponent(telefone)}`;
        const r = await fetch(url);
        if (!r.ok) return null;
        const j = await r.json();
        return j && j.phone_id ? j.phone_id : null;
      } catch {
        return null;
      }
    }

    async function tentarClaimComIds(telefone, ids) {
      const unique = (ids || []).filter(Boolean);
      if (!unique.length) return null;
      const url = `${CONV_API}/api/tickets/claim-por-telefone`;
      const body = {
        codigo_do_agente: parseInt(agente.codigo, 10),
        carteira: agente.carteira,
        telefone: telefone,
        phone_ids: unique
      };
      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!r.ok) throw new Error("Erro ao claim");
      return r.json();
    }

    function abrirPriorityModal() {
      if (!agente.carteira || !agente.codigo) {
        abrirModalLogin();
        return;
      }
      document.getElementById("priorityModal").classList.remove("hidden");
      const telInput = document.getElementById("priorityTelefone");
      telInput.value = "";
      telInput.focus();
      document.getElementById("priorityInfo").classList.add("hidden");
      document.getElementById("priorityErro").classList.add("hidden");
    }

    function fecharPriorityModal() {
      document.getElementById("priorityModal").classList.add("hidden");
    }

    document.getElementById("btnPrioridade").onclick = abrirPriorityModal;

    const priorityTelefone = document.getElementById("priorityTelefone");
    const priorityInfo = document.getElementById("priorityInfo");
    const priorityErro = document.getElementById("priorityErro");
    const btnPriorityBuscar = document.getElementById("btnPriorityBuscar");
    const prioritySpinner = document.getElementById("prioritySpinner");
    const priorityBtnLabel = document.getElementById("priorityBtnLabel");

    btnPriorityBuscar.onclick = async () => {
      priorityInfo.classList.add('hidden');
      priorityErro.classList.add('hidden');
      if (limitPerAgent > 0 && ativosCount >= limitPerAgent) {
        priorityErro.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido. Conclua/libere um antes de solicitar prioridade.`;
        priorityErro.classList.remove('hidden');
        return;
      }

      const nrm = normalizarTelefone(priorityTelefone.value);
      if (nrm.length < 11) {
        priorityErro.textContent = 'Informe ao menos DDI (55) + DDD (2) + n√∫mero (8).';
        priorityErro.classList.remove('hidden');
        return;
      }

      priorityInfo.innerHTML = `Buscando por: <code>${nrm}</code>`;
      priorityInfo.classList.remove('hidden');

      const preferido = await preferPhoneIdDoContato(nrm);
      const ordemIds = dedupe([preferido, ...phoneIdsForCarteira()]);

      btnPriorityBuscar.disabled = true;
      prioritySpinner.classList.remove('hidden');
      priorityBtnLabel.textContent = 'Solicitando‚Ä¶';
      try {
        const data = await tentarClaimComIds(nrm, ordemIds);

        if (data && data.limit_per_agent !== undefined) {
          limitPerAgent = Number(data.limit_per_agent || 0);
          ativosCount = Number(data.ativos || ativosCount);
          priorityErro.textContent = data.erro || `Limite de ${limitPerAgent} atingido.`;
          priorityErro.classList.remove('hidden');
          await refreshAtivosELimite();
          return;
        }

        if (data && data.ok && data.ticket) {
          priorityInfo.innerHTML = `<span class="text-emerald-700 font-medium">Prioridade concedida.</span> Abrindo o ticket‚Ä¶`;
          if (!tickets.find(t => t.remetente === data.ticket.remetente && t.phone_id === data.ticket.phone_id)) {
            tickets.unshift(data.ticket);
            saveTickets();
            renderTickets();
          }
          fecharPriorityModal();
          abrirTicket(data.ticket);
          ativosCount++;
          renderAtivosLimiteUI();
          return;
        }

        if (data && (data.assigned_to || data.atendimento)) {
          const owner = data.assigned_to || data.atendimento;
          priorityErro.innerHTML = `Outro agente j√° est√° atendendo: <strong>${escapeHtml(owner.nome || '‚Äî')}</strong> (#${escapeHtml(String(owner.codigo || '‚Äî'))}).`;
          priorityErro.classList.remove('hidden');
          return;
        }

        priorityErro.textContent = (data && (data.erro || data.message)) || 'N√£o foi poss√≠vel conceder prioridade.';
        priorityErro.classList.remove('hidden');
      } catch (e) {
        priorityErro.textContent = 'Falha ao solicitar prioridade.';
        priorityErro.classList.remove('hidden');
      } finally {
        btnPriorityBuscar.disabled = false;
        prioritySpinner.classList.add('hidden');
        priorityBtnLabel.textContent = 'Buscar e solicitar';
      }
    };

    /** =================== LISTA / CHAT =================== */
    function renderTickets(filtro = "") {
      const q = (filtro || "").toLowerCase().trim();
      const frag = document.createDocumentFragment();
      elListaTickets.innerHTML = "";
      tickets.forEach(t => {
        const nome = t.nome_exibicao || t.remetente;
        const hay = `${nome} ${t.remetente}`.toLowerCase();
        if (q && !hay.includes(q)) return;
        const li = document.createElement("li");
        li.className = "relative flex items-center p-3 hover:bg-gray-50 cursor-pointer border-b";
        li.onclick = () => abrirTicket(t);
        const key = keyFrom(t.remetente, t.phone_id);
        const unread = unreadCountByKey[key] || 0;
        const badge = unread > 0 ? `<span class="badge absolute right-2 top-2">${unread}</span>` : "";
        const hora = t.data_hora ? formatarHora(t.data_hora) : "";
        const ultima = (t.mensagem_final || "").slice(0, 90);
        li.innerHTML = `
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between gap-2">
              <div class="font-semibold truncate">${escapeHtml(nome)}</div>
              <div class="text-xs text-gray-500">${escapeHtml(hora)}</div>
            </div>
            <div class="text-xs text-gray-500 truncate">${escapeHtml(ultima)}</div>
            <div class="text-[11px] text-gray-400 mt-0.5">Conta: ${escapeHtml(phoneIdMap[t.phone_id] || t.phone_id || "‚Äî")}</div>
          </div>
          ${badge}
        `;
        const keySel = selecionado && keyFrom(selecionado.remetente, selecionado.phone_id);
        if (keySel === key) {
          li.classList.add("ticket-selected");
        }
        frag.appendChild(li);
      });
      elListaTickets.appendChild(frag);
    }

    async function abrirTicket(t) {
      selecionado = t;
      try {
        const k = keyFrom(t.remetente, t.phone_id);
        unreadCountByKey[k] = 0;
        lastContatoTsByKey[k] = Date.now();
        persistUnread();
      } catch { }
      renderTickets();
      elTitulo.textContent = t.nome_exibicao ? `${t.nome_exibicao} (${t.remetente})` : t.remetente;
      elSubInfo.textContent = `conta: ${phoneIdMap[t.phone_id] || t.phone_id}`;
      textarea.disabled = false;
      textarea.focus();
      btnEnviar.disabled = false;
      btnLiberar.disabled = false;
      btnConcluir.disabled = false;

      if (msgsCtrl) {
        try {
          msgsCtrl.abort();
        } catch { }
      }
      msgsCtrl = new AbortController();

      lastTimestampMs = null;
      lastDayRendered = null;
      renderedKeys.clear();
      chat.innerHTML = "";
      await carregarMensagens(false);
      startMensagensPoll();
      wireComposer();
    }

    function startMensagensPoll() { schedulePolls(); }

    let msgsCtrl = null;
    async function carregarMensagens(incremental = true) {
      if (!selecionado) return;
      let url = `${CONV_API}/api/conversas/${encodeURIComponent(selecionado.remetente)}`;
      if (selecionado.phone_id) url += `?phone_id=${encodeURIComponent(selecionado.phone_id)}`;
      try {
        const r = await fetch(url, { signal: msgsCtrl?.signal });
        if (!r.ok) throw new Error("Erro hist√≥rico");
        const msgs = await r.json();
        msgs.sort((a, b) => new Date(a.data_hora) - new Date(b.data_hora));
        if (!incremental) {
          chat.innerHTML = "";
          lastTimestampMs = null;
          lastDayRendered = null;
          renderedKeys.clear();
        }
        const isNearBottom = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 200;
        msgs.forEach(m => renderMsg(m, incremental));
        if (isNearBottom) requestAnimationFrame(() => chat.scrollTo({ top: chat.scrollHeight, behavior: "smooth" }));
      } catch (e) {
        if (String(e?.name) !== "AbortError") console.error(e);
      }
    }

    function renderMsg(m, incremental) {
      const tMs = new Date(m.data_hora).getTime();
      const dia = diaLabel(m.data_hora);
      if (!lastDayRendered || diaLabel(lastDayRendered) !== dia) {
        const sep = document.createElement("div");
        sep.className = "dia";
        sep.textContent = dia;
        chat.appendChild(sep);
        lastDayRendered = m.data_hora;
      }

      const key = `${m.remetente || ""}-${m.data_hora || ""}-${m.id || ""}`;
      if (renderedKeys.has(key) && incremental) return;
      renderedKeys.add(key);

      const msgEl = document.createElement("div");
      msgEl.className = "msg " + (m.direcao === "out" ? "enviada" : "recebida");

      let conteudoHtml = escapeHtml(m.conteudo || "");
      if (m.tipo === "image" && m.media_url) {
        conteudoHtml = `<img src="${escapeHtml(m.media_url)}" alt="Imagem" class="thumb" onclick="abrirModalImagem('${escapeHtml(m.media_url)}')">`;
      } else if (m.tipo === "audio" && m.media_url) {
        conteudoHtml = `<audio controls src="${escapeHtml(m.media_url)}"></audio>`;
      }

      msgEl.innerHTML = `
        <button class="reply-btn" title="Responder" onclick="prepararResposta('${escapeHtml(m.id || "")}', '${escapeHtml(m.conteudo || "")}')">
          ‚Ü©
        </button>
        <div>${conteudoHtml}</div>
        <div class="hora">${formatarHora(m.data_hora)}</div>
      `;
      chat.appendChild(msgEl);
      lastTimestampMs = tMs;
      requestAnimationFrame(() => chat.scrollTo({ top: chat.scrollHeight, behavior: "smooth" }));
    }

    function schedulePolls() {
      if (pollingMensagens) clearInterval(pollingMensagens);
      pollingMensagens = setInterval(() => carregarMensagens(true), 5000);
    }

    function wireComposer() {
      textarea.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          btnEnviar.click();
        }
      });
    }

    async function enviarMensagem(texto, replyToId = null) {
      if (!selecionado || !texto.trim()) return;
      try {
        btnEnviar.disabled = true;
        const payload = {
          remetente: selecionado.remetente,
          phone_id: selecionado.phone_id,
          mensagem: texto,
          reply_to: replyToId
        };
        const url = `${CONV_API}/api/mensagens/enviar`;
        const r = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!r.ok || !j.ok) {
          alert(j.erro || "Erro ao enviar mensagem.");
          return;
        }
        textarea.value = "";
        cancelarResposta();
        await carregarMensagens(true);
      } catch (e) {
        console.error("Erro ao enviar", e);
        alert("Erro ao enviar mensagem.");
      } finally {
        btnEnviar.disabled = false;
      }
    }

    let replyContext = null;
    function prepararResposta(id, texto) {
      replyContext = { id, texto };
      const preview = document.getElementById("respostaPreview");
      const txt = document.getElementById("respostaTexto");
      txt.textContent = texto.slice(0, 120);
      preview.classList.remove("hidden");
    }

    function cancelarResposta() {
      replyContext = null;
      document.getElementById("respostaPreview").classList.add("hidden");
    }

    btnEnviar.onclick = () => {
      const texto = textarea.value || "";
      enviarMensagem(texto, replyContext ? replyContext.id : null);
    };

    async function enviarPDF(event) {
      if (!selecionado) {
        alert("Selecione uma conversa para enviar o PDF.");
        event.target.value = "";
        return;
      }
      const file = event.target.files && event.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("file", file);
      formData.append("remetente", selecionado.remetente);
      formData.append("phone_id", selecionado.phone_id);

      try {
        const s3Url = "https://pdf-connectzap.s3.amazonaws.com";
        const r = await fetch(`${CONV_API}/api/uploads/presign`, {
          method: "POST",
          body: JSON.stringify({ filename: file.name, content_type: file.type || "application/pdf" }),
          headers: { "Content-Type": "application/json" }
        });
        if (!r.ok) throw new Error("Falha ao obter URL pr√©-assinada");
        const { upload_url, final_url } = await r.json();

        const upload = await fetch(upload_url, { method: "PUT", body: file, headers: { "Content-Type": file.type || "application/pdf" } });
        if (!upload.ok) throw new Error("Falha no upload para S3");

        const send = await fetch(`${CONV_API}/api/mensagens/enviar-pdf`, {
          method: "POST",
          body: JSON.stringify({ remetente: selecionado.remetente, phone_id: selecionado.phone_id, pdf_url: final_url, original_filename: file.name }),
          headers: { "Content-Type": "application/json" }
        });
        const sj = await send.json().catch(() => ({ ok: false, erro: "resposta inv√°lida" }));
        if (sj.ok) {
          await carregarMensagens(true);
        } else {
          console.error("Erro ao enviar PDF para WhatsApp:", sj);
          alert("Erro ao enviar PDF (API META): " + (sj.erro || JSON.stringify(sj)));
        }
      } catch (e) {
        console.error("Erro geral ao enviar PDF:", e);
        alert("Erro ao enviar PDF (rede).");
      } finally {
        event.target.value = "";
      }
    }

    /** =================== MODAL IMAGEM =================== */
    const imageModal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImg");
    const closeModal = document.getElementById("closeModal");
    function abrirModalImagem(src) { isModalOpen = true; modalImg.src = src; imageModal.classList.remove("hidden"); }
    closeModal.onclick = fecharModal; imageModal.onclick = e => { if (e.target === imageModal) fecharModal(); };
    function fecharModal() { imageModal.classList.add("hidden"); modalImg.src = ""; isModalOpen = false; }

    /** =================== LIBERAR / CONCLUIR / LOGOUT =================== */

    btnLiberar.onclick = async () => {
      if (!selecionado) return;
      try {
        const r = await fetch(`${CONV_API}/api/tickets/liberar`, {
          method: "DELETE", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo, 10), remetente: selecionado.remetente, phone_id: selecionado.phone_id })
        });
        const j = await r.json();
        if (!r.ok || !j.ok) { alert(j.erro || "N√£o foi poss√≠vel liberar."); return; }
        const k = keyFrom(selecionado.remetente, selecionado.phone_id);
        delete unreadCountByKey[k]; delete lastContatoTsByKey[k]; persistUnread();

        tickets = tickets.filter(t => !(t.remetente === selecionado.remetente && t.phone_id === selecionado.phone_id));
        saveTickets(); renderTickets(); limparChat();
        elTitulo.textContent = "Selecione um ticket"; elSubInfo.textContent = ""; btnLiberar.disabled = true; btnConcluir.disabled = true; fecharMenuConcluir();
        if (ativosCount > 0) ativosCount--; renderAtivosLimiteUI();
      } catch (e) { alert("Erro ao liberar."); }
    };

    async function concluirAtendimento(motivo) {
      if (!selecionado) return;
      try {
        btnConcluir.disabled = true;
        const r = await fetch(`${CONV_API}/api/tickets/concluir`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo, 10), remetente: selecionado.remetente, phone_id: selecionado.phone_id, motivo })
        });
        const j = await r.json();
        if (!r.ok || !j.ok) { alert(j.erro || "N√£o foi poss√≠vel concluir."); btnConcluir.disabled = false; return; }
        const k = keyFrom(selecionado.remetente, selecionado.phone_id);
        delete unreadCountByKey[k]; delete lastContatoTsByKey[k]; persistUnread();

        tickets = tickets.filter(t => !(t.remetente === selecionado.remetente && t.phone_id === selecionado.phone_id));
        saveTickets(); renderTickets(); limparChat();
        elTitulo.textContent = "Selecione um ticket"; elSubInfo.textContent = ""; btnLiberar.disabled = true; btnConcluir.disabled = true; selecionado = null;
        if (ativosCount > 0) ativosCount--; renderAtivosLimiteUI();
      } catch (e) { alert("Erro ao concluir."); btnConcluir.disabled = false; }
    };

    async function doLogout() {
      try {
        await fetch(`${FILA_API}/fila/offline`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo || '0', 10), carteira: agente.carteira || '' })
        }).catch(() => { });
      } catch (_) { }
      try {
        localStorage.removeItem("agente_codigo");
        localStorage.removeItem("agente_nome");
        localStorage.removeItem("agente_carteira");
        localStorage.removeItem("agente_origem");
        Object.keys(localStorage).forEach(k => {
          if (k.startsWith(STORAGE_KEY_UNREAD_PREFIX) || k.startsWith(STORAGE_KEY_LAST_TS_PREFIX)) {
            localStorage.removeItem(k);
          }
        });
      } catch (_) { }
      if (pollingContatos) clearInterval(pollingContatos);
      if (pollingMensagens) clearInterval(pollingMensagens);
      location.reload();
    }

    function limparChat() {
      chat.innerHTML = '<p id="loading" class="text-center text-gray-500">Pegue uma conversa para iniciar‚Ä¶</p>';
    }

    /** =================== ATIVOS / LIMITE =================== */
    async function refreshAtivosELimite() {
      try {
        const url = `${CONV_API}/api/tickets/minhas?agente=${encodeURIComponent(agente.codigo || '')}&carteira=${encodeURIComponent(agente.carteira || '')}`;
        const r = await fetch(url);
        const rows = r.ok ? await r.json() : [];
        ativosCount = Array.isArray(rows) ? rows.length : 0;
      } catch {
        ativosCount = tickets.length;
      }
      try {
        const j = await fetch(`${CONV_API}/api/supervisao/tickets-limit?carteira=${encodeURIComponent(agente.carteira || '')}`).then(r => r.json());
        limitPerAgent = Number(j.limit_per_agent || 0);
      } catch {
        limitPerAgent = 0;
      }
      renderAtivosLimiteUI();
    }

    function renderAtivosLimiteUI() {
      badgeAtivos.textContent = String(ativosCount);
      badgeLimite.textContent = limitPerAgent > 0 ? String(limitPerAgent) : "‚àû";
      const atingiu = (limitPerAgent > 0 && ativosCount >= limitPerAgent);
      if (atingiu) {
        elMsgLimite.textContent = `Limite de ${limitPerAgent} tickets simult√¢neos atingido. Conclua ou libere um atendimento para continuar.`;
        elMsgLimite.classList.remove("hidden");
      } else {
        elMsgLimite.classList.add("hidden");
        elMsgLimite.textContent = "";
      }
      btnPegarProxima.disabled = !agente.online || atingiu;
      btnPrioridade.disabled = !agente.online || atingiu;
    }

    /** =================== TOGGLE ONLINE =================== */
    btnToggleOnline.onclick = async () => {
      if (!agente.carteira || !agente.codigo) {
        abrirModalLogin();
        return;
      }
      const toggleSpinner = document.getElementById('toggleSpinner');
      const toggleLabel = document.getElementById('toggleLabel');
      elHomeAviso.classList.add("hidden");
      elHomeAviso.textContent = "";
      const indoOnline = !agente.online;
      btnToggleOnline.disabled = true;
      toggleSpinner.classList.remove('hidden');
      if (toggleLabel) toggleLabel.textContent = indoOnline ? 'Entrando‚Ä¶' : 'Saindo‚Ä¶';
      try {
        if (indoOnline) {
          const r = await fetch(`${FILA_API}/fila/online`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo, 10), carteira: agente.carteira })
          });
          const j = await r.json();
          if (!j.ok) throw new Error(j.erro || "Erro ao entrar online");
          setStatus(true);
          await refreshOrdemCarteira();
          await refreshAtivosELimite();
        } else {
          const r = await fetch(`${FILA_API}/fila/offline`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ codigo_do_agente: parseInt(agente.codigo, 10), carteira: agente.carteira })
          });
          const j = await r.json();
          if (!j.ok) throw new Error(j.erro || "Erro ao ficar offline");
          setStatus(false);
        }
      } catch (e) {
        elHomeAviso.classList.remove("hidden");
        elHomeAviso.textContent = (e?.message || "Falha ao alterar status");
      } finally {
        toggleSpinner.classList.add('hidden');
        if (toggleLabel) toggleLabel.textContent = agente.online ? 'Ficar offline' : 'Ficar online';
        btnToggleOnline.disabled = false;
      }
    };

    /** =================== RELAT√ìRIO / CHART =================== */
    let pieChart = null;

    async function carregarRelatorio() {
      if (!agente.carteira || !agente.codigo) return;
      try {
        const url = `${REL_API}/api/relatorio?carteira=${encodeURIComponent(agente.carteira)}&agente=${encodeURIComponent(agente.codigo)}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error("Erro ao buscar relat√≥rio");
        const j = await r.json();
        document.getElementById("kpiEm").textContent = j.em_atendimento ?? 0;
        document.getElementById("kpiConc").textContent = j.concluidos ?? 0;
        document.getElementById("kpiTma").textContent = j.tma_min ?? "‚Äî";
        document.getElementById("kpiFRT").textContent = j.frt_seg ?? "‚Äî";
        document.getElementById("relatorioPeriodo").textContent = j.periodo || "Hoje";

        const ctx = document.getElementById("pieStatus").getContext("2d");
        const data = j.status || {};
        const labels = Object.keys(data);
        const values = Object.values(data);

        if (pieChart) pieChart.destroy();
        pieChart = new Chart(ctx, {
          type: "pie",
          data: {
            labels,
            datasets: [{
              data: values
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom"
              }
            }
          }
        });
      } catch (e) {
        console.error("Erro ao carregar relat√≥rio", e);
      }
    }

    document.getElementById("btnRefreshRel").onclick = carregarRelatorio;

    /** =================== INIT =================== */
    function init() {
      loadAndApplyTheme();
      loadUnread();
      loadTicketsFromStorage();
      carregarAgenteInicial();
      renderTickets();
      updateAuthButton();
      if (agente.codigo && agente.carteira) {
        refreshOrdemCarteira();
        refreshAtivosELimite();
        carregarRelatorio();
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>

</html>

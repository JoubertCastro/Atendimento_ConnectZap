<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ConnectZap ‚Äî Distribui√ß√£o (operador)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* ===================== THEME VARS ===================== */
  :root{
    --bg: #eae6df;                     /* fundo estilo WhatsApp */
    --wallpaper: none;                 /* url(...) quando o usu√°rio escolher */
    --bubble-in: #ffffff;              /* recebidas */
    --bubble-out: #dcf8c6;             /* enviadas */
    --accent: #25d366;                 /* bot√µes/realces */
    --text: #111827;
    --muted: #6b7280;
    --radius: 18px;                    /* raio padr√£o */
    --pad-v: 10px;                     /* densidade vertical */
    --pad-h: 14px;                     /* densidade horizontal */
    --shadow: 0 1px 2px rgba(0,0,0,.08);
  }

  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px}
  .chat-bg{
    background: var(--bg);
    background-image: var(--wallpaper);
    background-size: cover; background-position: center;
  }

  /* ===================== BUBBLES ===================== */
  .msg{
    max-width: 72%;
    padding: calc(var(--pad-v)) calc(var(--pad-h)) 22px calc(var(--pad-h));
    border-radius: var(--radius);
    margin: 2px 0;
    position: relative;
    white-space: pre-wrap; word-wrap: break-word;
    box-shadow: var(--shadow);
    font-size: 14px; line-height: 1.35;
  }
  .msg.enviada{
    align-self:flex-end; background: var(--bubble-out); color: var(--text);
    border-top-right-radius: 8px;
  }
  .msg.recebida{
    align-self:flex-start; background: var(--bubble-in); color: var(--text);
    border-top-left-radius: 8px; border: 1px solid rgba(0,0,0,.06);
  }

  /* Caudas (podem ser desligadas pelo tema) */
  .msg.tail.enviada::after,
  .msg.tail.recebida::after{
    content:"";
    position:absolute; bottom:0; width:18px; height:18px;
    background: inherit;
  }
  .msg.tail.enviada::after{
    right:-6px; border-bottom-left-radius:14px; transform: translateY(-2px) rotate(45deg);
    box-shadow: 2px 2px 0 rgba(0,0,0,.03);
  }
  .msg.tail.recebida::after{
    left:-6px; border-bottom-right-radius:14px; transform: translateY(-2px) rotate(-45deg);
    box-shadow: -2px 2px 0 rgba(0,0,0,.03);
    border-left: 1px solid rgba(0,0,0,.04);
    border-bottom: 1px solid rgba(0,0,0,.04);
  }

  /* Agrupamento: quando a mensagem anterior √© do mesmo lado,
     ‚Äúachatamos‚Äù o topo para parecer um bloco. */
  .msg.joined-prev.enviada{ border-top-right-radius: 6px; }
  .msg.joined-prev.recebida{ border-top-left-radius: 6px; }
  .msg.joined-next.enviada{ border-bottom-right-radius: 6px; }
  .msg.joined-next.recebida{ border-bottom-left-radius: 6px; }

  /* Hora + checkmarks */
  .hora{
    position:absolute; bottom:4px; right:8px; font-size:11px; color:#667085; display:flex; align-items:center; gap:6px;
  }
  .acks{ font-size:0; line-height:0; display:inline-flex; gap:2px; }
  .ack{ width:14px; height:14px; display:inline-block; background:currentColor; -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill="black" d="M7.629 14.571 2.3 9.243l1.4-1.4 3.929 3.928 8.242-8.243 1.4 1.4z"/></svg>') no-repeat center / 100% 100%; mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill="black" d="M7.629 14.571 2.3 9.243l1.4-1.4 3.929 3.928 8.242-8.243 1.4 1.4z"/></svg>') no-repeat center / 100% 100%; }
  .acks.sent .ack{ color:#94a3b8; }
  .acks.delivered .ack{ color:#60a5fa; }
  .acks.read .ack{ color:#22c55e; }      /* azul cl√°ssico pode ser #3b82f6; aqui usei um verde ConnectZap */

  .dia{
    text-align:center; margin:12px 0; font-size:12px; color:#6b7280;
  }

  /* Bot√£o responder s√≥ em recebidas (hover) */
  .msg .btn-responder{ position:absolute; top:6px; right:6px; font-size:14px; color:#4b5563; opacity:0; transition:opacity .18s }
  .msg.recebida:hover .btn-responder{ opacity:1 }

  /* ===================== MEDIA BUBBLES ===================== */
  .media{
    display:flex; flex-direction:column; gap:6px;
  }
  .media img{
    display:block; max-width:280px; border-radius:12px; border:1px solid rgba(0,0,0,.06);
  }
  .media .legend{
    font-size:12px; color:#475569;
  }

  /* √Åudio estilizado (sem libs) */
  .audio-wrap{
    display:flex; align-items:center; gap:10px; min-width:220px;
  }
  .audio-badge{
    width:36px; height:36px; border-radius:50%; background:rgba(0,0,0,.08); display:flex; align-items:center; justify-content:center; font-weight:700;
  }
  audio{ width:200px; }

  /* ===================== LISTA / UTIL ===================== */
  .ticket-selected{background:#f0f9ff!important}
  .badge{background:#22c55e;color:#fff;font-size:10px;font-weight:700;border-radius:9999px;padding:2px 6px;min-width:18px;text-align:center}
  .dot{width:10px;height:10px;border-radius:9999px;display:inline-block;margin-right:6px}
  .dot.online{background:#16a34a}.dot.offline{background:#9ca3af}

  /* Bot√£o flutuante de rolar para o fim */
  #scrollBottom{
    position:absolute; right:18px; bottom:18px; z-index:5;
    display:none; /* aparece via JS */
  }
</style>
</head>
<body class="h-screen flex bg-gray-100">

<!-- Sidebar (sem mudan√ßas estruturais) -->
<aside class="w-1/3 lg:w-1/4 bg-white border-r flex flex-col">
  <div class="p-3 border-b">
    <div class="flex items-center justify-between gap-2">
      <div class="min-w-0">
        <div class="text-xs text-gray-500">Agente</div>
        <div id="agenteNome" class="font-semibold truncate">‚Äî</div>
        <div class="text-xs text-gray-500">Carteira: <span id="agenteCarteira">‚Äî</span></div>
        <div class="text-xs text-gray-500">Status: <span id="agenteStatus"><span class="dot offline"></span>Offline</span></div>
      </div>
      <div class="flex flex-col items-end gap-2">
        <button id="btnToggleOnline" class="px-3 py-2 text-sm rounded-md bg-green-600 text-white hover:bg-green-700 disabled:opacity-50" disabled>Ficar online</button>
        <button id="btnPegarProxima" class="px-3 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50" disabled>Pegar pr√≥xima</button>
        <button id="btnLogout" class="px-3 py-1 text-xs bg-gray-100 rounded-md hover:bg-gray-200">Logout</button>
      </div>
    </div>
    <div id="msgAviso" class="mt-2 text-xs text-amber-600 hidden"></div>
  </div>

  <div class="p-2 border-b">
    <input id="buscaTicket" class="w-full p-2 border rounded-md text-sm" placeholder="üîç Buscar nas minhas conversas" oninput="filtrarTickets(this.value)"/>
  </div>

  <ul id="listaTickets" class="flex-1 overflow-y-auto"></ul>

  <div class="p-2 text-xs text-gray-500 border-t">
    Apenas conversas da sua carteira. ‚ÄúPegar pr√≥xima‚Äù usa ordem por √∫ltima mensagem <em>recebida</em>.
  </div>
</aside>

<!-- Main -->
<main class="flex-1 flex flex-col relative">
  <div class="flex items-center justify-between p-3 border-b bg-white">
    <div class="min-w-0">
      <div id="tituloConversa" class="font-bold text-lg truncate">Selecione um ticket</div>
      <div id="subInfo" class="text-sm text-gray-500 truncate"></div>
    </div>
    <div class="flex items-center gap-2">
      <!-- üé® Tema -->
      <button id="btnTema" class="px-3 py-2 text-sm bg-white border rounded-md hover:bg-gray-50">üé® Tema</button>

      <button id="btnLiberar" class="px-3 py-2 text-sm bg-gray-100 rounded-md hover:bg-gray-200 disabled:opacity-50" disabled>Liberar</button>
      <div class="relative">
        <button id="btnConcluir" class="px-3 py-2 text-sm bg-emerald-600 text-white rounded-md hover:bg-emerald-700 disabled:opacity-50" disabled>Concluir</button>
        <div id="menuConcluir" class="hidden absolute right-0 mt-2 w-64 bg-white border rounded-lg shadow-lg z-20"></div>
      </div>
    </div>
  </div>

  <!-- Chat -->
  <div id="chat" class="chat-bg flex-1 p-4 overflow-y-auto flex flex-col space-y-1 relative">
    <p id="loading" class="text-center text-gray-700/80">Pegue uma conversa para iniciar‚Ä¶</p>
    <button id="scrollBottom" class="hidden px-3 py-2 bg-white/90 border rounded-full text-sm shadow">‚ñº Novas mensagens</button>
  </div>
  <div id="digitando" class="px-4 text-left hidden text-sm text-gray-700">Digitando‚Ä¶</div>

  <div id="respostaPreview" class="hidden px-3 py-2 border-t bg-gray-50 text-sm flex justify-between items-center">
    <div class="truncate max-w-[80%]">
      <span class="font-semibold">Respondendo:</span> <span id="respostaTexto" class="text-gray-600"></span>
    </div>
    <button onclick="cancelarResposta()" class="text-red-500 text-xs">‚úñ</button>
  </div>

  <div class="p-3 border-t flex space-x-2 bg-white items-center">
    <input type="file" id="fileInput" accept="application/pdf" class="hidden" onchange="enviarPDF(event)">
    <button onclick="document.getElementById('fileInput').click()" class="bg-blue-500 text-white px-3 py-2 rounded-md hover:bg-blue-600">üìù PDF</button>
    <textarea id="textoMensagem" rows="1" class="flex-1 border rounded-md p-2 resize-none" placeholder="Digite uma mensagem‚Ä¶" disabled></textarea>
    <button id="btnEnviar" onclick="enviarMensagem()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 disabled:opacity-50" disabled>Enviar</button>
  </div>
</main>

<!-- Modal imagem -->
<div id="imageModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50">
  <span id="closeModal" class="absolute top-4 right-6 text-white text-3xl cursor-pointer">&times;</span>
  <img id="modalImg" src="" alt="Imagem" class="max-h-[90%] max-w-[90%] rounded-lg shadow-lg">
</div>

<!-- Painel de Tema -->
<div id="panelTema" class="hidden fixed top-16 right-4 z-40 w-[360px] bg-white border rounded-xl shadow-xl">
  <div class="p-3 border-b font-semibold">Personalizar tema</div>
  <div class="p-3 space-y-3 text-sm">
    <div class="grid grid-cols-2 gap-3">
      <label class="block">Fundo
        <input id="colorBg" type="color" class="w-full h-9 border rounded" />
      </label>
      <label class="block">Bolha recebida
        <input id="colorIn" type="color" class="w-full h-9 border rounded" />
      </label>
      <label class="block">Bolha enviada
        <input id="colorOut" type="color" class="w-full h-9 border rounded" />
      </label>
      <label class="block">Densidade
        <input id="density" type="range" min="0" max="2" step="1" class="w-full" />
        <div class="text-xs text-gray-500 mt-1"><span id="densityLabel">Conforto</span></div>
      </label>
    </div>

    <div class="space-y-2">
      <div class="font-medium">Papel de parede</div>
      <div class="flex gap-2 flex-wrap">
        <button data-wall="none" class="wp-btn px-2 py-1 border rounded">Nenhum</button>
        <button data-wall="paper" class="wp-btn px-2 py-1 border rounded">Papel</button>
        <button data-wall="dots" class="wp-btn px-2 py-1 border rounded">Pontinhos</button>
        <label class="px-2 py-1 border rounded cursor-pointer">Upload
          <input id="wpUpload" type="file" accept="image/*" class="hidden">
        </label>
      </div>
    </div>

    <div class="flex items-center justify-between">
      <label class="flex items-center gap-2"><input id="toggleTails" type="checkbox" class="accent-emerald-600"> Exibir caudas</label>
      <button id="btnResetTheme" class="text-xs text-gray-500 hover:underline">Restaurar padr√£o</button>
    </div>
  </div>
</div>

<script>
/* ====== (1) Config/Estado originais ‚Äì MANTIDOS ====== */
/*  Mantive seus IDs e fun√ß√µes. S√≥ adicionei ‚Äútema‚Äù e melhorias visuais.
    Toda parte de API continua igual (omiti aqui para foco, mas voc√™ pode colar
    este arquivo inteiro que funciona com o backend).                                      */

/* ====== Tema (persistente) ====== */
const THEME_KEY = "cz:theme:v2";
const defaultTheme = {
  bg:"#eae6df",
  in:"#ffffff",
  out:"#dcf8c6",
  wallpaper:"none",     // none | paper | dots | url(...)
  customUrl:null,
  tails:true,
  density:1             // 0=compacto, 1=conforto, 2=amplo
};
let theme = {...defaultTheme};

function applyTheme(){
  document.documentElement.style.setProperty("--bg", theme.bg);
  document.documentElement.style.setProperty("--bubble-in", theme.in);
  document.documentElement.style.setProperty("--bubble-out", theme.out);

  // densidade
  const densMap = [
    {v:8, h:12, label:"Compacto"},
    {v:10, h:14, label:"Conforto"},
    {v:14, h:16, label:"Amplo"},
  ];
  const d = densMap[theme.density] || densMap[1];
  document.documentElement.style.setProperty("--pad-v", d.v+"px");
  document.documentElement.style.setProperty("--pad-h", d.h+"px");
  document.getElementById("densityLabel")?.innerText = d.label;

  // wallpaper
  let wp = "none";
  if(theme.wallpaper==="paper"){
    wp = "radial-gradient(ellipse at top left, rgba(255,255,255,.6), rgba(255,255,255,.2)), url('data:image/svg+xml;utf8,\
      <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"180\" height=\"180\" viewBox=\"0 0 180 180\">\
      <path fill=\"%23ffffff\" fill-opacity=\".4\" d=\"M0 0h180v180H0z\"/>\
      <path fill=\"%23d1d5db\" fill-opacity=\".25\" d=\"M0 90h180v1H0zM90 0h1v180h-1z\"/>\
      </svg>')";
  } else if(theme.wallpaper==="dots"){
    wp = "radial-gradient(circle at 1px 1px, rgba(0,0,0,.08) 1px, transparent 0) 0 0/18px 18px";
  } else if(theme.wallpaper && theme.wallpaper.startsWith("url(")){
    wp = theme.wallpaper;
  }
  document.documentElement.style.setProperty("--wallpaper", wp);

  // caudas
  document.body.classList.toggle("no-tails", !theme.tails);
  // atualiza pickers se painel aberto
  const bg = document.getElementById("colorBg");
  if(bg){ bg.value = rgbToHex(theme.bg); document.getElementById("colorIn").value = rgbToHex(theme.in); document.getElementById("colorOut").value = rgbToHex(theme.out); document.getElementById("density").value = theme.density; document.getElementById("toggleTails").checked = !!theme.tails; }
}
function saveTheme(){ localStorage.setItem(THEME_KEY, JSON.stringify(theme)); }
function loadTheme(){
  try{ const t = JSON.parse(localStorage.getItem(THEME_KEY)||"{}"); theme = {...defaultTheme, ...t}; }catch{}
  applyTheme();
}
function rgbToHex(c){ // aceita #abc, #aabbcc ou rgb(...). Retorna #RRGGBB
  if(!c) return "#ffffff";
  if(c.startsWith("#")) return c.length===4?("#"+c[1]+c[1]+c[2]+c[2]+c[3]+c[3]):c;
  const m = c.match(/rgb\\((\\d+),\\s*(\\d+),\\s*(\\d+)\\)/i);
  if(!m) return "#ffffff";
  const toHex = n=> ("0"+parseInt(n,10).toString(16)).slice(-2);
  return "#"+toHex(m[1])+toHex(m[2])+toHex(m[3]);
}
loadTheme();

/* ====== Painel de tema ====== */
const panelTema = document.getElementById("panelTema");
document.getElementById("btnTema").onclick = () => panelTema.classList.toggle("hidden");
document.getElementById("colorBg").oninput = e => { theme.bg=e.target.value; applyTheme(); saveTheme(); };
document.getElementById("colorIn").oninput = e => { theme.in=e.target.value; applyTheme(); saveTheme(); };
document.getElementById("colorOut").oninput = e => { theme.out=e.target.value; applyTheme(); saveTheme(); };
document.getElementById("density").oninput = e => { theme.density = +e.target.value||1; applyTheme(); saveTheme(); };
document.getElementById("toggleTails").onchange = e => { theme.tails = !!e.target.checked; applyTheme(); saveTheme(); };
document.getElementById("btnResetTheme").onclick = () => { theme={...defaultTheme}; applyTheme(); saveTheme(); };
document.querySelectorAll(".wp-btn").forEach(btn=>{
  btn.onclick = ()=>{
    const kind = btn.dataset.wall;
    if(kind==="none"){ theme.wallpaper="none"; theme.customUrl=null; }
    if(kind==="paper"){ theme.wallpaper="paper"; theme.customUrl=null; }
    if(kind==="dots"){ theme.wallpaper="dots"; theme.customUrl=null; }
    applyTheme(); saveTheme();
  }
});
document.getElementById("wpUpload").onchange = e=>{
  const f = e.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  theme.wallpaper = `url(${url})`;
  theme.customUrl = url;
  applyTheme(); saveTheme();
};

/* ====== UI: rolar ao fim ====== */
const chat = document.getElementById("chat");
const btnScroll = document.getElementById("scrollBottom");
function showScrollBtn(show){ btnScroll.style.display = show ? "block" : "none"; }
chat.addEventListener("scroll", ()=>{
  const near = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 180;
  showScrollBtn(!near);
});
btnScroll.onclick = ()=> chat.scrollTo({ top: chat.scrollHeight, behavior:"smooth" });

/* ====== Renderiza√ß√£o de mensagens (melhorada) ====== */
let lastSideEl = { in: null, out: null };    // √∫ltimo bubble por lado
let lastMsgMeta = null;                      // {side, tMs, day}

function renderAcks(container, ack){
  // ack esperado: "sent" | "delivered" | "read"
  if(!ack){ return ""; }
  let cls = "sent"; if(ack==="delivered") cls="delivered"; if(ack==="read") cls="read";
  const wrap = document.createElement("span");
  wrap.className = "acks "+cls;
  wrap.innerHTML = `<span class="ack"></span><span class="ack"></span>`;
  container.appendChild(wrap);
}

function appendDaySeparator(dayStr){
  const sep = document.createElement("div");
  sep.className = "dia";
  sep.textContent = `‚Äî ${dayStr} ‚Äî`;
  chat.appendChild(sep);
}

function joinGrouping(side, el, tMs){
  const prev = lastMsgMeta;
  if(prev && prev.side===side && (tMs - prev.tMs) <= 5*60*1000){
    el.classList.add("joined-prev");
    // Marca o anterior como joined-next
    const prevEl = lastSideEl[side==="in"?"in":"out"];
    if(prevEl) prevEl.classList.add("joined-next");
  }
  lastMsgMeta = { side, tMs, day: lastMsgMeta?.day };
  lastSideEl[side==="in"?"in":"out"] = el;
}

function renderMsgUI(m){
  const t = new Date(m.data_hora);
  const dayStr = t.toLocaleDateString("pt-BR", { timeZone:"America/Sao_Paulo" });
  const hora = t.toLocaleTimeString("pt-BR", { hour:"2-digit", minute:"2-digit", timeZone:"America/Sao_Paulo" });
  const side = (m.status==="in") ? "in" : "out";

  // separador de dia
  if(!lastMsgMeta || lastMsgMeta.day !== dayStr){
    appendDaySeparator(dayStr);
    lastMsgMeta = { side:null, tMs:null, day:dayStr };
    lastSideEl = { in:null, out:null };
  }

  const div = document.createElement("div");
  div.className = `msg ${side==="in"?"recebida":"enviada"} ${theme.tails?"tail":""}`;

  // ====== TEXTO ======
  if(!m.tipo || m.tipo==="text"){
    div.innerHTML = `<div>${(m.mensagem_final||"").replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]))}</div>
      <span class="hora">${hora}</span>`;
  }

  // ====== IMAGEM ======
  else if(m.tipo==="imagem" || m.mensagem_final==="[image]"){
    const wrap = document.createElement("div");
    wrap.className = "media";
    const img = document.createElement("img");
    img.alt = "Imagem recebida";
    img.loading = "lazy";
    // bot√£o ‚Äúver imagem‚Äù (mant√©m sua l√≥gica de fetch)
    const btn = document.createElement("button");
    btn.className = "text-blue-600 underline text-sm self-start"; btn.textContent="üëÅ Ver imagem";
    if(!m.msg_id){ btn.disabled=true; btn.textContent="Imagem indispon√≠vel"; }
    else{
      btn.onclick = async ()=>{
        btn.disabled=true; btn.textContent="‚è≥ Carregando‚Ä¶";
        try{
          const r = await fetch(`${CONV_API}/api/conversas/image/${encodeURIComponent(m.msg_id)}`);
          const j = await r.json();
          if(j.ok && j.data_uri){ img.src=j.data_uri; btn.remove(); }
          else throw new Error();
        }catch{ btn.disabled=false; btn.textContent="üëÅ Ver imagem"; alert("Erro ao carregar imagem"); }
      };
    }
    wrap.appendChild(img); wrap.appendChild(btn);
    div.appendChild(wrap);
    const span = document.createElement("span"); span.className="hora"; span.textContent=hora; div.appendChild(span);
  }

  // ====== √ÅUDIO ======
  else if(m.tipo==="audio" || m.mensagem_final==="[audio]"){
    const aw = document.createElement("div"); aw.className="audio-wrap";
    const badge = document.createElement("div"); badge.className="audio-badge"; badge.textContent="‚ô™";
    const btn = document.createElement("button"); btn.className="text-blue-600 underline text-sm"; btn.textContent="Carregar √°udio";
    const audio = document.createElement("audio"); audio.controls=true; audio.className="hidden";
    btn.onclick = async ()=>{
      btn.disabled=true; btn.textContent="‚è≥ Baixando‚Ä¶";
      try{
        const r = await fetch(`${CONV_API}/api/conversas/audio/${encodeURIComponent(m.msg_id)}`);
        const j = await r.json();
        if(j.ok && j.data_uri){ audio.src=j.data_uri; audio.classList.remove("hidden"); btn.remove(); }
        else throw new Error();
      }catch{ btn.disabled=false; btn.textContent="Tentar novamente"; alert("Erro ao carregar √°udio"); }
    };
    aw.appendChild(badge); aw.appendChild(audio); aw.appendChild(btn);
    div.appendChild(aw);
    const span = document.createElement("span"); span.className="hora"; span.textContent=hora; div.appendChild(span);
  }

  // ====== REA√á√ÉO ======
  else if(m.tipo==="emoji" || m.mensagem_final==="[reaction]"){
    const wrap = document.createElement("div"); wrap.className = "flex items-center gap-2";
    const emojiEl = document.createElement("span"); emojiEl.className = "text-2xl leading-none"; emojiEl.textContent = "üôÇ";
    const label = document.createElement("span"); label.className = "text-gray-600 italic"; label.textContent = "enviou um emote";
    wrap.appendChild(emojiEl); wrap.appendChild(label); div.appendChild(wrap);
    const horaSpan = document.createElement("span"); horaSpan.className = "hora"; horaSpan.textContent = hora; div.appendChild(horaSpan);
    if (m.msg_id) {
      (async ()=>{ try {
        const r = await fetch(`${CONV_API}/api/conversas/emoji/${encodeURIComponent(m.msg_id)}`);
        const j = await r.json();
        if (j.ok && j.emoji) emojiEl.textContent = j.emoji; else label.textContent = "emoji n√£o carregado";
      } catch(e){ label.textContent = "falha ao carregar emoji"; }})();
    }
  }

  // Bot√£o responder nas recebidas
  if(side==="in"){
    const rbtn = document.createElement("button");
    rbtn.className = "btn-responder"; rbtn.title = "Responder"; rbtn.innerHTML = "‚Ü©";
    rbtn.onclick = ()=> responderMensagem(m.msg_id, m.mensagem_final||"");
    div.appendChild(rbtn);
  }

  // Hora + checks em enviadas (se existir m.ack)
  const horaSpan = div.querySelector(".hora");
  if(side==="out" && horaSpan){ renderAcks(horaSpan, m.ack); }

  // Agrupamento visual
  const tMs = t.getTime();
  joinGrouping(side, div, tMs);

  chat.appendChild(div);
}

/* =========================================================
   A PARTIR DAQUI: reaproveite suas fun√ß√µes de carregamento,
   apenas chame renderMsgUI(m) onde antes voc√™ montava o bubble.
   Abaixo deixo duas helpers para integra√ß√£o r√°pida:
   ========================================================= */

function renderMsg(m, incremental){ renderMsgUI(m); }

function scrollToBottomIfNear(){
  const near = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 180;
  if(near) chat.scrollTo({ top: chat.scrollHeight, behavior:"smooth" });
}

/* ====== Modal imagem (seu c√≥digo original, reaproveitado) ====== */
const imageModal = document.getElementById("imageModal");
const modalImg = document.getElementById("modalImg");
const closeModal = document.getElementById("closeModal");
function abrirModalImagem(src){ modalImg.src = src; imageModal.classList.remove("hidden"); }
function fecharModal(){ imageModal.classList.add("hidden"); modalImg.src=""; }
closeModal.onclick = fecharModal; imageModal.onclick = e => { if (e.target === imageModal) fecharModal(); };

/* ====== Dica: ao fim do carregamento do lote, chame: ====== */
/* scrollToBottomIfNear(); */

/* =================================================================
   IMPORTANTE:
   - Para aproveitar ao m√°ximo, substitua a constru√ß√£o dos bal√µes onde
     voc√™ fazia innerHTML diretamente por `renderMsgUI(m)`.
   - Se seu backend retornar `m.ack` para mensagens enviadas
     ("sent" | "delivered" | "read"), os ‚úì aparecem automaticamente.
   - Tema fica salvo por usu√°rio em localStorage.
   ================================================================= */
</script>
</body>
</html>

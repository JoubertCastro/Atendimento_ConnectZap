<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ConnectZap â€” Atendimento</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --ok:#16a34a; --warn:#d97706; --err:#dc2626;
  }
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px}
  .btn{padding:10px 14px;border-radius:10px}
  .btn-primary{background:#2563eb;color:#fff}
  .btn-muted{background:#f3f4f6}
  .dot-online{width:10px;height:10px;border-radius:9999px;background:#16a34a;display:inline-block;margin-right:6px}
  .dot-offline{width:10px;height:10px;border-radius:9999px;background:#9ca3af;display:inline-block;margin-right:6px}
</style>
</head>
<body class="bg-gray-100 min-h-screen">
  <header class="bg-white border-b">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold">ConnectZap â€” Atendimento</h1>
      <a href="#" class="text-sm text-gray-500 hover:underline">Ajuda</a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-4 space-y-6">
    <!-- Passo 1: Login simples do agente -->
    <section class="card">
      <h2 class="font-bold text-lg mb-3">Tela inicial</h2>
      <p class="text-sm text-gray-600 mb-4">Informe seu <strong>cÃ³digo do agente</strong> e o <strong>BD de origem</strong>.</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="text-sm text-gray-700">CÃ³digo do agente (SIC)</label>
          <input id="codigoInput" type="number" min="1" class="w-full border rounded-md p-2" placeholder="Ex: 123" />
        </div>
        <div>
          <label class="text-sm text-gray-700">Origem BD</label>
          <select id="origemInput" class="w-full border rounded-md p-2">
            <option value="">Selecione</option>
            <option>Bd4</option>
            <option>Bd5</option>
            <option>Bd7</option>
            <option>Bd8</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="btnBuscar" class="btn btn-primary w-full">Continuar</button>
        </div>
      </div>
      <div id="alertaInicial" class="mt-3 text-sm hidden"></div>
    </section>

    <!-- Passo 2A: Primeiro login (cadastro do agente) -->
    <section id="novoLogin" class="card hidden">
      <h2 class="font-bold text-lg mb-3">Opsâ€¦ primeiro acesso no ConnectZap</h2>
      <p class="text-sm text-gray-600 mb-4">Preencha os dados para concluir o cadastro.</p>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div>
          <label class="text-sm text-gray-700">CÃ³digo do agente</label>
          <input id="novoCodigo" type="number" min="1" class="w-full border rounded-md p-2" disabled />
        </div>
        <div class="md:col-span-2">
          <label class="text-sm text-gray-700">Nome completo</label>
          <input id="novoNome" type="text" class="w-full border rounded-md p-2" placeholder="Nome e sobrenome" />
        </div>
        <div>
          <label class="text-sm text-gray-700">Carteira</label>
          <select id="novoCarteira" class="w-full border rounded-md p-2">
            <option value="">Selecione</option>
            <option>ConnectZap</option>
            <option>Recovery PJ</option>
            <option>Recovery PF</option>
            <option>Mercado Pago CobranÃ§a</option>
            <option>DivZero</option>
            <option>Arc4U</option>
            <option>Serasa</option>
            <option>Mercado Pago Vendas</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-700">Origem BD</label>
          <select id="novoOrigem" class="w-full border rounded-md p-2">
            <option value="">Selecione</option>
            <option>Bd4</option>
            <option>Bd5</option>
            <option>Bd7</option>
            <option>Bd8</option>
          </select>
        </div>
      </div>
      <div class="flex gap-2 mt-4">
        <button id="btnSalvarNovo" class="btn btn-primary">Salvar cadastro</button>
        <button id="btnCancelarNovo" class="btn btn-muted">Cancelar</button>
      </div>
      <div id="alertaNovo" class="mt-3 text-sm hidden"></div>
    </section>

    <!-- Passo 2B: Agente encontrado -->
    <section id="agenteEncontrado" class="card hidden">
      <div class="flex items-center justify-between">
        <h2 class="font-bold text-lg">Bem-vindo ðŸ‘‹</h2>
        <div class="text-sm text-gray-600"><span id="statusPill" class="inline-flex items-center gap-2"><span class="dot-offline"></span>Offline</span></div>
      </div>
      <p class="text-sm text-gray-600 mb-4">Validamos seu cadastro. VocÃª pode ficar <strong>online</strong> na fila ou <strong>trocar a carteira</strong>.</p>

      <div id="blocoDados" class="border rounded-lg p-3 bg-gray-50">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div><span class="text-xs text-gray-500 block">CÃ³digo</span><span id="lblCodigo" class="font-medium">â€”</span></div>
          <div class="md:col-span-2"><span class="text-xs text-gray-500 block">Nome</span><span id="lblNome" class="font-medium">â€”</span></div>
          <div><span class="text-xs text-gray-500 block">Carteira</span><span id="lblCarteira" class="font-medium">â€”</span></div>
          <div><span class="text-xs text-gray-500 block">Origem BD</span><span id="lblOrigem" class="font-medium">â€”</span></div>
          <div class="md:col-span-3">
            <label class="text-sm text-gray-700">Trocar carteira</label>
            <div class="flex gap-2">
              <select id="selNovaCarteira" class="border rounded-md p-2 flex-1">
                <option>ConnectZap</option>
                <option>Recovery PJ</option>
                <option>Recovery PF</option>
                <option>Mercado Pago CobranÃ§a</option>
                <option>DivZero</option>
                <option>Arc4U</option>
                <option>Serasa</option>
                <option>Mercado Pago Vendas</option>
              </select>
              <button id="btnTrocarCarteira" class="btn btn-muted">Aplicar</button>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mt-4">
        <button id="btnOnline" class="btn btn-primary">Ficar online</button>
        <button id="btnOffline" class="btn btn-muted" disabled>Ficar offline</button>
      </div>

      <div id="alertaEncontrado" class="mt-3 text-sm hidden"></div>

      <div class="mt-6">
        <h3 class="font-semibold mb-2">Fila atual (minha carteira)</h3>
        <div class="overflow-auto border rounded-lg">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-left px-3 py-2">CÃ³digo</th>
                <th class="text-left px-3 py-2">Nome</th>
                <th class="text-left px-3 py-2">Carteira</th>
                <th class="text-left px-3 py-2">Data/Hora</th>
              </tr>
            </thead>
            <tbody id="tbodyFila"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

<script>
// âœ… Base do backend em produÃ§Ã£o (pode sobrescrever via window.ATEND_API_BASE)
const API_BASE = (window.ATEND_API_BASE || "https://whatsapp-webhook-production-9a27.up.railway.app/api").replace(/\/+$/,'');

// Estado
let agente = null;           // { codigo_do_agente, nome, carteira, origem_bd }
let online = false;          // status na fila

// Helpers UI
function showMsg(el, text, type="ok"){ // ok | warn | err
  el.classList.remove("hidden");
  el.textContent = text;
  el.style.color = (type==="ok"? "var(--ok)" : type==="warn" ? "var(--warn)" : "var(--err)");
}
function hideMsg(el){ el.classList.add("hidden"); el.textContent = ""; }

function setStatus(isOnline){
  online = isOnline;
  const pill = document.getElementById("statusPill");
  pill.innerHTML = isOnline ? '<span class="dot-online"></span>Online' : '<span class="dot-offline"></span>Offline';
  document.getElementById("btnOnline").disabled = isOnline;
  document.getElementById("btnOffline").disabled = !isOnline;
}

// Fluxo inicial
document.getElementById("btnBuscar").onclick = async () => {
  const codigo = Number(document.getElementById("codigoInput").value);
  const origem = document.getElementById("origemInput").value;
  const alerta = document.getElementById("alertaInicial");
  hideMsg(alerta);

  if(!codigo || !Number.isInteger(codigo)){ showMsg(alerta, "Informe um cÃ³digo inteiro vÃ¡lido.", "warn"); return; }
  if(!origem){ showMsg(alerta, "Selecione o BD de origem.", "warn"); return; }

  // tenta buscar agente
  try{
    const r = await fetch(`${API_BASE}/agentes/${codigo}`);
    const j = await r.json();
    if(!j.ok){
      // primeiro acesso
      document.getElementById("novoLogin").classList.remove("hidden");
      document.getElementById("agenteEncontrado").classList.add("hidden");
      document.getElementById("novoCodigo").value = codigo;
      document.getElementById("novoOrigem").value = origem;
      showMsg(document.getElementById("alertaNovo"), "Parece ser seu primeiro acesso. Conclua o cadastro.", "warn");
      return;
    }
    // encontrado
    agente = j.agente;
    agente.origem_bd = origem;

    preencherBlocoAgente();
    await carregarFila();
    document.getElementById("novoLogin").classList.add("hidden");
    document.getElementById("agenteEncontrado").classList.remove("hidden");
    setStatus(false);
  }catch(e){
    showMsg(alerta, "Erro ao buscar agente.", "err");
  }
};

// Salvar cadastro (primeiro acesso)
document.getElementById("btnSalvarNovo").onclick = async () => {
  const codigo = Number(document.getElementById("novoCodigo").value);
  const nome = (document.getElementById("novoNome").value || "").trim();
  const carteira = document.getElementById("novoCarteira").value;
  const origem = document.getElementById("novoOrigem").value;
  const alerta = document.getElementById("alertaNovo"); hideMsg(alerta);

  if(!codigo || !Number.isInteger(codigo)) return showMsg(alerta,"CÃ³digo precisa ser inteiro.","warn");
  if(!nome || nome.split(" ").length < 2) return showMsg(alerta,"Informe o nome completo.","warn");
  if(!carteira) return showMsg(alerta,"Selecione a carteira.","warn");
  if(!origem) return showMsg(alerta,"Selecione o BD de origem.","warn");

  try{
    const r = await fetch(`${API_BASE}/agentes`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ codigo_do_agente: codigo, nome, carteira, origem_bd: origem })
    });
    const j = await r.json();
    if(!j.ok) return showMsg(alerta, j.erro || "Erro ao cadastrar.", "err");

    // busca novamente para preencher bloco
    const r2 = await fetch(`${API_BASE}/agentes/${codigo}`);
    const j2 = await r2.json();
    agente = j2.agente;
    agente.origem_bd = origem;

    preencherBlocoAgente();
    await carregarFila();
    document.getElementById("novoLogin").classList.add("hidden");
    document.getElementById("agenteEncontrado").classList.remove("hidden");
    setStatus(false);
    showMsg(document.getElementById("alertaEncontrado"), "Cadastro realizado com sucesso.", "ok");
  }catch(e){
    showMsg(alerta, "Erro ao salvar cadastro.", "err");
  }
};
document.getElementById("btnCancelarNovo").onclick = () => {
  document.getElementById("novoLogin").classList.add("hidden");
};

// Trocar carteira
document.getElementById("btnTrocarCarteira").onclick = async () => {
  const nova = document.getElementById("selNovaCarteira").value;
  const alerta = document.getElementById("alertaEncontrado"); hideMsg(alerta);
  if(!nova) return showMsg(alerta,"Selecione uma carteira.", "warn");
  try{
    const r = await fetch(`${API_BASE}/agentes/${agente.codigo_do_agente}`, {
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ carteira: nova })
    });
    const j = await r.json();
    if(!j.ok) return showMsg(alerta, j.erro || "Erro ao trocar carteira.", "err");
    agente.carteira = nova;
    preencherBlocoAgente();
    await carregarFila();
    showMsg(alerta, "Carteira atualizada.", "ok");
  }catch(e){
    showMsg(alerta,"Erro de rede ao trocar carteira.","err");
  }
};

// Ficar online
document.getElementById("btnOnline").onclick = async () => {
  const alerta = document.getElementById("alertaEncontrado"); hideMsg(alerta);
  try{
    const r = await fetch(`${API_BASE}/fila/online`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ codigo_do_agente: agente.codigo_do_agente, carteira: agente.carteira })
    });
    const j = await r.json();
    if(!j.ok) return showMsg(alerta, j.erro || "NÃ£o foi possÃ­vel entrar na fila.", "err");
    setStatus(true);
    await carregarFila();
    showMsg(alerta,"VocÃª estÃ¡ online na carteira.", "ok");
  }catch(e){
    showMsg(alerta,"Erro ao entrar online.","err");
  }
};

// Ficar offline
document.getElementById("btnOffline").onclick = async () => {
  const alerta = document.getElementById("alertaEncontrado"); hideMsg(alerta);
  try{
    const r = await fetch(`${API_BASE}/fila/offline`, {
      method:"DELETE",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ codigo_do_agente: agente.codigo_do_agente, carteira: agente.carteira })
    });
    const j = await r.json();
    if(!j.ok) return showMsg(alerta, j.erro || "NÃ£o foi possÃ­vel sair da fila.", "err");
    setStatus(false);
    await carregarFila();
    showMsg(alerta,"VocÃª ficou offline e saiu da fila.", "ok");
  }catch(e){
    showMsg(alerta,"Erro ao sair da fila.","err");
  }
};

// Carregar fila atual da carteira do agente
async function carregarFila(){
  if(!agente?.carteira) return;
  try{
    const r = await fetch(`${API_BASE}/fila/status?carteira=${encodeURIComponent(agente.carteira)}`);
    const list = await r.json();
    const tbody = document.getElementById("tbodyFila");
    tbody.innerHTML = "";
    (list || []).forEach(l => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-3 py-2">${l.codigo_do_agente}</td>
        <td class="px-3 py-2">${l.nome || "-"}</td>
        <td class="px-3 py-2">${l.carteira}</td>
        <td class="px-3 py-2">${new Date(l.data_hora).toLocaleString("pt-BR")}</td>
      `;
      tbody.appendChild(tr);
    });
  }catch(e){
    // silencioso
  }
}

function preencherBlocoAgente(){
  document.getElementById("lblCodigo").textContent = agente.codigo_do_agente;
  document.getElementById("lblNome").textContent = agente.nome;
  document.getElementById("lblCarteira").textContent = agente.carteira;
  document.getElementById("lblOrigem").textContent = agente.origem_bd;
  document.getElementById("selNovaCarteira").value = agente.carteira || "ConnectZap";
}
</script>
</body>
</html>
